<!DOCTYPE html>
<html lang="en" dir="ltr">

<head>
    <meta charset="utf-8">
    <!-- <meta http-equiv="Access-Control-Allow-Origin" content="*" /> -->
    <meta name="viewport" content="width=device-width, 
    initial-scale=1.0, 
    user-scalable=no" />
    <link rel="shortcut icon" href="#" />
    <title>視訊會議</title>
    <!-- Close Google Translate, https://support.google.com/webmasters/answer/79812 -->
    <meta name="google" content="notranslate">
    <!-- Diable cache for Chrome -->
    <meta http-equiv="cache-control" content="max-age=0" />
    <meta http-equiv="cache-control" content="no-store" />
    <meta http-equiv="expires" content="-1" />
    <meta http-equiv="expires" content="Tue, 01 Jan 1980 1:00:00 GMT" />
    <meta http-equiv="pragma" content="no-cache" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
    <link rel="shortcut icon" href="img/favicon.png">
    <link rel="icon" href="img/favicon.png" type="image/x-icon" />

    <link rel="stylesheet" href="css/static/font-awsome/5.15.1/all.css" />
    <link rel="stylesheet" href="css/static/bootstrap.min.css">
    <link rel="stylesheet" href="js/static/pnotify/PNotifyBrightTheme.css">
    <link rel="stylesheet" href="css/static/w3.css">
    <!-- <link rel="stylesheet" href="css/connectionState.css"> -->
    <link rel="stylesheet" href="css/video-conferencing.css">
    <link rel="stylesheet" href="css/connectionState.min.css">
    <!--<link rel="stylesheet" href="css/video-conferencing.min.css">-->
    <link rel="stylesheet" href="css/getHTMLMediaElement.min.css">
    <link href="js/static/intro.3.4.0/introjs.css" rel="stylesheet" />
    <link href="js/static/intro.3.4.0/introjs-wheat.css" rel="stylesheet" />
    <script src="js/static/tripledes.js"></script>
    <script>
        function encrypt(r, t) { let key = t.length >= 8 ? t.slice(0, 8) : t.concat('0'.repeat(8 - t.length)); p = CryptoJS.DES.encrypt(r, CryptoJS.enc.Utf8.parse(key), { iv: CryptoJS.enc.Utf8.parse(key), mode: CryptoJS.mode.CBC, padding: CryptoJS.pad.Pkcs7 }); return p = p.toString() } function decrypt(r, t) { let key = t.length >= 8 ? t.slice(0, 8) : t.concat('0'.repeat(8 - t.length)); var p = CryptoJS.DES.decrypt(r, CryptoJS.enc.Utf8.parse(key), { iv: CryptoJS.enc.Utf8.parse(key), mode: CryptoJS.mode.CBC, padding: CryptoJS.pad.Pkcs7 }); return p = CryptoJS.enc.Utf8.stringify(p) };        
    </script>
    <script src="js/static/jquery-3.4.1.min.js"></script>
    <script src="js/static/popper.min.js"></script>
    <script src="js/static/bootstrap.min.js"></script>
    <script src="js/static/pnotify/PNotify.js"></script>
    <script src="js/static/pnotify/PNotifyButtons.js"></script>
    <script src="js/static/pnotify/PNotifyCallbacks.js"></script>
    <script src="js/static/pnotify/PNotifyConfirm.js"></script>
    <!-- change to 2.29.4
    <script src="js/static/moment.js"></script>
    <script src="js/static/moment-with-locales.min.js"></script>
    -->
    <script src="js/static/moment/2.29.4/moment.min.js"></script>
    <script src="js/static/moment/2.29.4/moment-with-locales.min.js"></script>

    <script src="js/static/blockUI/jquery.blockUI.js"></script>
    <script src="js/static/screenfull/screenfull.js"></script>
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.4/lodash.min.js"></script> -->
    <script src="js/static/loadash.js"></script>


    <!-- <script type="text/javascript" src="js/lodash.min.js"></script> -->
    <!-- <script src="menu.js"></script>     -->
    <!-- <script src="https://cdn.webrtc-experiment.com/hark.js"></script> -->
    <script src="js/static/vue.min.js"></script>
    <script src="js/static/vue-i18n.js"></script>

    <script src="js/static/hark.js"></script>
    <!-- <script src="js/hark.bundle.js"></script> -->
    <!-- <script src="js/apiService.js"></script>     -->
    <!-- <script src="js/videoConference.js"></script> -->
    <!-- <script src="js/remoteControl.js"></script> -->
    <!-- <script src="js/eBoard.js"></script> -->
    <!-- <script src="js/keyBoard.js"></script> -->
    <script src="common/config.js"></script>
    <script src="common/vue-mixin-rtc.js"></script>
    <script src="js/meeting.js"></script>
    <!-- <script src="OneToMany/js/jquery.min.js"></script>   -->
    <script src="js/static/kurento-client.js"></script>
    <!-- <script src="js/kurento-utils.js"></script> -->


    <!-- <script src="js/KMS.js"></script> -->
    <!-- <script src="js/MultiStreamsMixer.js"></script> -->

    <!-- <script src="js/kurento.js"></script> -->

    <script src="js/static/mqtt/mqtt.min.js"></script>
    <script src="js/mqtt/mMqtt.js"></script>

    <!-- <script src="js/static/xlsx.full.min.js"></script>  -->
    <script src="js/static/FileSaver.min.js"></script>
    <!-- <script src="js/wookBook.js"></script> -->
    <script src="js/static/randomColor.min.js"></script>
    <script src="js/static/intro.3.4.0/intro.js"></script>
    <!-- <script src="js/holoViewer.js"></script> -->
    <!-- <script src="js/holoLive.js"></script> -->
    <script src="js/socket.io.js"></script>
    <script src="js/split.min.v1.6.0.js"></script>
    <script src="js/RealTimeASR.js"></script>
    <script src="js/PIPSubtitle.js"></script>
    <script src="js/SameSoundWeb.js"></script>
    <script src="js/static/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="css/loaders.css" />
    <script src="js/loaders.css.js"></script>
    <script>
        if (location.protocol != 'https:') {
            location.href = 'https:' + window.location.href.substring(window.location.protocol.length);
        }
    </script>
    <style type="text/css">
        [v-cloak] {
            display: none;
        }

        .introjs-helperNumberLayer {
            top: 32px;
            left: -2px;
        }
    </style>
    <style type="text/css">
        /* .navbar{
            min-height:18px;
        } */
        .navbar a {
            font-size: 16px;
        }
    </style>
    <style id="ppnotify">
        /* vicw: overwrite pnotify css for secret meeting login alert*/
        .ui-pnotify-title {
            color: white;
            background-color: red;
            text-align: center;
            border-radius: 5px;
            margin: 50px;
            padding: 0.5rem;
            font-size: 24px;
        }
    </style>
    <style>
        /* for PNotify TipsMsg */
        .TipsMsg {
            background-color: black;
            color: rgb(252, 252, 177);
            font-weight: bold;
            /* font-size:26px;*/
            padding: 4px 8px 4px 8px;
            border-radius: 5px;
            opacity: 0.7;
            position: absolute;
            top: 8%;
            right: 5%;
            z-index: 900;
            font-size: 1em;
            min-width: 150px;
            display: none;
        }
    </style>
    <style>
        /* isSecret - waiting for smart panel ready */
        .load-wrapp {
            /* float: left; */
            width: 100px;
            height: 100px;
            margin: 0 10px 10px 0;
            padding: 20px 20px 20px;
            border-radius: 5px;
            text-align: center;
            /* background-color: #d8d8d8; */
            /* margin:0px auto; */
        }

        .load-wrapp p {
            padding: 0 0 20px;
            font-size: 20pt;
        }

        .load-wrapp:last-child {
            /* margin-right: 0; */
        }

        .bar {
            float: left;
            width: 15px;
            height: 6px;
            border-radius: 2px;
            background-color: #4b9cdb;
        }

        .load-10 .bar {
            animation: loadingJ 2s cubic-bezier(0.17, 0.37, 0.43, 0.67) infinite;
        }

        @keyframes loadingJ {

            0%,
            100% {
                transform: translate(0, 0);
            }

            50% {
                transform: translate(380px, 0);
                background-color: #f5634a;
                width: 25px;
            }
        }
    </style>
    <style>
        .gutter {
            background-color: #eee;
            background-repeat: no-repeat;
            background-position: 50%;
        }

        .gutter.gutter-vertical {
            background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAFAQMAAABo7865AAAABlBMVEVHcEzMzMzyAv2sAAAAAXRSTlMAQObYZgAAABBJREFUeF5jOAMEEAIEEFwAn3kMwcB6I2AAAAAASUVORK5CYII=');
            cursor: row-resize;
        }
    </style>
    <style>
        .custom-position {
            position: relative !important;
            margin: 1px 0px 0px 0px !important;
        }
        .merge-hint {
            border-bottom: solid 1px #34e0fa00;
            animation: mymove 1s;
            animation-iteration-count: 1;
        }
        @keyframes mymove {
            from {border-bottom: solid 1px #34dffa;}
            to {border-bottom: solid 1px #34e0fa00;}
        }
        .owner-tag:hover {
            background-color: #7a7a7a;
        }
        .merge-tag {
            color: #74ff95;
        }
    </style>
</head>

<body id="body" ondragstart="return false" ondragend="return false">
    <div id="grabframecanvDiv" style="display:none;"><canvas id="grabframecanv"
            style="border:0.5rem outset red;margin-top:30px"></canvas>
        <P id="confidentialResult"></P>
    </div>
    <div id="vueApp" v-cloak class="fullScreenContainer">
        <div id="divWaterMark" style="display:none"></div>

        <!-- 保留給標題列 -->
        <div id="nav-bar">
            <header
                :class="{'Version3' : AppInfo.version.substr(0,2)=='V3' ,'Version2' : AppInfo.version.substr(0,2)=='V2' ,'Version1' : (AppInfo.version.substr(0,2)=='V0' || AppInfo.version.substr(0,2)=='V1')  }"
                style="display:flex; align-items:center; width:100%; padding:5px;">
                <!-- Header 功能表(left) -->
                <div class="w3-left header-btn-left" :style="isMobileUI? 'display:none;' :''">
                    <button class="menu-button btn btn-danger" @click="handleMic('updateMic')" :title='currUser.isMute ? $t("lan-hint-tips10-1") : $t("lan-hint-tips10")'>
                        <i class="fas" :class="{'fa-microphone-slash': currUser.isMute, 'fa-microphone': !currUser.isMute }" style="padding:0px"></i>
                        <span>{{ currUser.isMute ? isAskMic? $t("lan-header-speak") : $t("lan-header-mute") : $t("lan-header-unmute") }}</span>
                    </button>
                    <!-- 設定  -->
                    <button class="menu-button btn btn-primary" :title='$t("lan-hint-tips9")' data-toggle="modal" data-target="#settingModal" :style="laserColor" @click="$VM.initSameSoundWeb()">
                        <i><img style="width:16px" src="css/static/icon/pen-filled.svg" alt="laser pen"></i>
                        <span>{{ $t("lan-header-setting") }}</span>
                    </button>
                </div>
                <div class="divTopic" ref="divTopic">
                    <!-- 會議主題 -->
                    <span class="topicName topic-name-height" style="position: relative; float: left"
                        :style="isMobileUI? 'font-size:16px;' :''" @click="expandTopic">{{ computedTopicName }}</span>
                    <!-- <span v-if="isSecret()" class="topicName topic-name-height"
                        style="position: relative; float: left;color:crimson;"
                        :style="isMobileUI? 'font-size:16px;' :''">{{ $t("lan-notify-secretMeeting") }}</span> -->
                    <!-- <span style="position: relative; ;font-size:13px;color:royalblue"> {{ headerBar.shareUser}} </span> -->
                    <span style="position: relative; ;font-size:13px;color:royalblue">&nbsp;{{ shareUserTitle }}</span>
                    <span style="position: relative; ;font-size:13px;color:royalblue">&nbsp;{{ headerBar.sharStatus }} {{
                        isMobileUI ? `*${$t('lan-tab-list')}: ${onlineUserCount}` : "" }}</span>
                    <span style="padding:3px; margin-right:0px;color:crimson;font-size: small; ">{{
                        headerBar.headerMSG }}</span>
                </div>
                <!-- Header 功能表(right) -->
                <div class="w3-right header-btn-right" :style="isMobileUI? 'display:none;' :''">
                    <!-- <button type="button" v-if="ckDispalyMyWebCam && ckHideMyWebCam " 
                    class="menu-button btn btn-danger"  @click="unhideCameraFrame "><i
                            class="fas fa-video" style="padding:2px;"></i><span>開啟視訊視窗</span></button> -->
                    <!--<button v-show="headerBar.showSwitchRecordButton" class="menu-button btn " :class="{'btn-danger':isRecordSwitchOn,'btn-secondary':!isRecordSwitchOn}" @click="clickRecordSwitch()">
                        <i class="fas" :class="{'fa-circle': isRecordSwitchOn, 'fa-stop': !isRecordSwitchOn }" style="padding:0px"></i>
                        <span>{{ isRecordSwitchOn ? $t("lan-header-recording-on") : $t("lan-header-recording-off") }}</span>
                    </button>-->
                    <span style="padding:3px; margin-right:3px;color:crimson;font-size: medium; ">{{
                        isRecordSwitchOn ? $t("lan-header-recording-on") : "" }}</span>
                    <!-- <button id="buttonGoogleTrans" class="menu-button btn btn-success" :title='$t("lan-hint-tips24")' @click="setCurrent_speech_lang('sg')">
                        <i class="fas fa-question-circle" style="padding:0px"></i>
                        <span>{{speech_switch_google_trans_state ? $t("lan-hint-tips25") : $t("lan-hint-tips24") }}</span></button> -->
                    <!-- <button id="buttonVoiceTrans" class="menu-button btn btn-success" :title='$t("lan-hint-tips27")' @click="setCurrent_speech_lang('sv')">
                            <i class="fas fa-question-circle" style="padding:0px"></i>
                            <span>{{speech_switch_voice_state ? $t("lan-hint-tips27") : $t("lan-hint-tips26") }}</span></button> -->
                    <span class="dropdown" v-show="false">
                        <button class="btn btn-info dropdown-toggle" type="button" id="dropdownMenuButton"
                            data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"
                            :title="`${$t('lan-tab-speech-setting')}`">
                            <i class="fa fa-cog"></i> {{ $t("lan-tab-speech-setting") }}
                        </button>
                        <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                            <a class="dropdown-item" href="#" @click="setCurrent_speech_lang('zh')">中文=>日/英<span
                                    :style="current_speech_lang=='zh'? 'display:' : 'display:none' "
                                    style="font-size:large;color:red;font-weight: bold;">*</span></a>
                            <!-- <a class="dropdown-item" href="#" @click="setCurrent_speech_lang('en')">English</a> -->
                            <!-- <a class="dropdown-item" href="#" @click="setCurrent_speech_lang('jp')">日語=>中/英<span
                                    :style="current_speech_lang=='jp' && voice_option==''? 'display:' : 'display:none' "
                                    style="font-size:large;color:red;font-weight: bold;">*</span></a> -->
                            <a class="dropdown-item" href="#" @click="setCurrent_speech_lang('en')">英文=>中/日<span
                                    :style="current_speech_lang=='en' && voice_option==''? 'display:' : 'display:none' "
                                    style="font-size:large;color:red;font-weight: bold;">*</span></a>
                            <!-- <a class="dropdown-item" href="#" @click="setCurrent_speech_lang('jp_zi')">日語=>中/英(志偉)<span :style="current_speech_lang=='jp' && voice_option=='zi'? 'display:' : 'display:none' " style="font-size:large;color:red;font-weight: bold;">*</span></a>
                            <a class="dropdown-item" href="#" @click="setCurrent_speech_lang('jp_ya')">日語=>中/英(雅婷)<span :style="current_speech_lang=='jp' && voice_option=='ya'? 'display:' : 'display:none' " style="font-size:large;color:red;font-weight: bold;">*</span></a> -->
                            <!-- <a class="dropdown-item" href="#" @click="setCurrent_speech_lang('sw')">{{speech_switch_state ? $t("lan-tab-swith-off") : $t("lan-tab-swith-on")}}</a> -->
                            <!-- <a class="dropdown-item" href="#" @click="setCurrent_speech_lang('sv')">{{speech_switch_voice_state ? $t("lan-tab-swith-voice-off") : $t("lan-tab-swith-voice-on")}}</a> -->
                        </div>
                    </span>
                    <button v-show="false" id="buttonStartIntro" class="menu-button btn btn-success"
                        :title='$t("lan-hint-tips8")'>
                        <i class="fas fa-question-circle" style="padding:0px"></i>
                        <span>help</span></button>
                    <!--Invoke Smart Panel-->
                    <!-- modify by vic 2024/01/03 修改用isSmartPanelOn判斷就好，不再需要判斷是不是機敏會議-->
                    <!-- <button class="menu-button btn btn-success" v-if="(!isSmartPanelOn && !(isShareVideo_0 && isSecret()) )" id="btnInvokeSmartPanel" class="menu-button btn btn-primary" :title='$t("lan-hint-tips22")' @click="doInvokeSmartPanel(true)"> -->
                    <button class="menu-button btn btn-success" v-if="(!isSmartPanelOn)" id="btnInvokeSmartPanel"
                        class="menu-button btn btn-primary" :title='$t("lan-hint-tips22")'
                        @click="doInvokeSmartPanel(true)">
                        <i class="fas fa-solid fa-pen-fancy" style="padding:2px;"></i><span>{{ $t("lan-hint-tips22") }}</span>
                        <a id="smartPanel_link" href="smartpanel:xxx" style="display:none"></a>
                        <!--呼叫 uri scheme的方式啟動smartpanel-->
                    </button>
                    <!--圖片直播-->
                    <!-- <button v-if="(!isShareVideo && !isShareVideoLocalImage)" id="btnLiveImage" class="menu-button btn btn-success" :title='$t("lan-live-image")' 
                        @click="LiveImage()">
                        <i class="far fa-solid fa-file-image" style="padding:0px"></i>
                        <span>{{ $t("lan-live-image") }}</span></button>         -->
                    <!--電腦環境檢測-->
                    <button v-show="window.params.sourcetype=='externalpc'" id="buttonCheckenv"
                        class="menu-button btn btn-danger" @click="openDetectHtml">
                        <i class="fa fa-check" style="padding:2px;"></i>
                        <span>{{ $t("lan-detect-env") }}</span></button>
                    <!--聲音播放中-->
                    <button id="buttonAllMute" class="menu-button btn "
                        :title='currUser.isAllmute ? $t("lan-hint-tips7-1") : $t("lan-hint-tips7")'
                        :class="{'btn-danger':currUser.isAllmute,'btn-success':!currUser.isAllmute}"
                        @click="allmute(currUser.isAllmute)">
                        <i class="fas"
                            :class="{'fa-user-times': currUser.isAllmute, 'fa-volume-up': !currUser.isAllmute }"
                            style="padding:0px"></i>
                        <span>{{ currUser.isAllmute ? $t("lan-header-voice-mute") : $t("lan-header-voice-normal")}}</span></button>
                    <!--共用白板-->
                    <button class="menu-button btn btn-success" :title='$t("lan-hint-tips6")'
                        @click="clickWhiteboard(true)"
                        v-show="!isShareVideoLocalKMS && !self.isShareVideoLocalWebRTC"><i class="fas fa-clipboard"
                            style="padding:2px;"></i><span>{{ whiteboardBtnTitle }}</span></button>
                    <!--全螢幕-->
                    <button id="buttonFullScreen" class="menu-button btn btn-primary" :title='$t("lan-hint-tips5")'
                        onclick="toggleFullscreen()"><i class="fa fa-window-maximize"
                            style="padding:2px;"></i><span>{{ $t("lan-header-fullscreen") }}</span></button>
                    <!--重連-->
                    <button id="buttonReConnect" class="menu-button btn btn-danger" :title='$t("lan-hint-tips4")'
                        @click="clickReconnect"><i class="fas fa-redo" style="padding:2px;"></i><span>{{
                            $t("lan-header-reenter") }}</span></button>
                    <button class="menu-button btn btn-danger" :title='$t("lan-hint-tips3")'
                        @click="clickExitRoom"><i class="fas fa-sign-out-alt" style="padding:2px;"></i><span>{{
                            $t("lan-header-exit") }}</span></button>
                    <!--匯出與會人員-->
                    <button v-if="!CONFIG.isExternal" id="btnExportMember" class="menu-button btn btn-primary"
                        :title='$t("lan-hint-tips21")' @click="exportMember()">
                        <i class="fas fa-solid fa-download" style="padding:2px;"></i>
                    </button>
                    <button v-show="headerBar.showDebugButton" :title='$t("lan-hint-tips2")'
                        class="showDebug menu-button btn btn-primary" @click="showDebug()"><i
                            class="fa fa-info-circle " style="padding:2px;"></i><span></span></button>
                    <button id="buttonHideList" :title='$t("lan-hint-tips1")' class="btn btn-primary " type="button"
                        @click="isShowList=!isShowList;resizeWindow();">
                        <i class="fa fa-user-circle" style="padding:2px;"></i>
                        <i v-if="!isShowList" class="fas fa-chevron-up"></i>
                        <i v-if="isShowList" class="fas fa-chevron-down"></i>
                    </button>
                </div>
            </header>
        </div>
        <!-- FIXME: 不需要?
            <input type="text" id="room-id" value="abcdef" autocorrect=off autocapitalize=off size=20
            style="display:none" /> -->

        <!--顯示全靜音中Heightlight-->
        <h2 v-if="currUser.isAllmute" class='shining'
            style="position: absolute;color:white;padding:0;margin:0;    background-color:rgb(233 30 30 / 70%);
            text-align: left; margin-top: 10px; margin-left: 10px; display: block; border: 0;line-height:1.5;z-index:1;">
            {{ $t("lan-header-voice-mute") }}
        </h2>

        <!-- SpeechTip -->
        <div v-if="false" class="popupTips2Speech TipsMsg" @click="changeTab(0)">
            <i :title="`${$t('lan-tab-speech')}`">→{{ $t('lan-tab-speech') }} {{ (translate_GetLastSpeech!=null) ?
                "("+translate_GetLastSpeech.userName+")" :"" }}</i>
            <div>{{ (translate_GetLastSpeech!=null) ? translate_GetLastSpeech.zh2zh :"" }}</div>
            <div>{{ (translate_GetLastSpeech!=null) ? translate_GetLastSpeech.zh2en :"" }}</div>
        </div>
        <div id="videos-container" class="containers video-width video-height" :style="!isShowList?'width: 100vw;':''  "
            style="overflow: hidden;
            white-space: nowrap;">
            <!-- <div v-if="onlineSpeakersSorted.length > 0" style="position: relative; z-index: 250; text-align: end;padding-right: 3px;" :style="{'height': (speakerActive) ? '0px':'','background-color': (speakerActive) ? '':'#dbdbdb'}">
                <i v-if="speakerActive" class="fas fa-minus-circle" style="color: #0084ff85;" @click="speakerActive = !speakerActive"></i>
                <i v-else class="fas fa-plus-circle" style="color: #0084ff85;" @click="speakerActive = !speakerActive"></i>
            </div> -->
            <!--三個BAR-->
            <div v-show="speakerActive" class="speakerContainer" style="position: absolute; background: rgba(0, 0, 0, 0); z-index:200;overflow: hidden; white-space: nowrap;">
                <div :style="dynamiceFrameSizeTool(speaker.userId ==currUser.userId)"
                    v-for="(speaker,n) in onlineSpeakersSorted" :index="n" class="speakerItem"
                    v-bind:key="`speakermenu_${speaker.userId}`" :id="`speaker_${speaker.userId}`"
                    @click.prevent=" (speaker.userId !=currUser.userId && speaker.hascamera) ? dbclick(`speaker_${speaker.userId}`,()=>{ pinWebCamManual(speaker);}) : ()=>{}">
                    <div class="w3-bar speakerItemBar" style="background-color: transparent;
                                position: absolute;
                                z-index: 99999;">
                        <!-- kms連線狀態燈 -->
                        <div v-show="speaker.userId != currUser.userId"
                            style="float: left;padding:0.3em;color:transparent;">
                            <i id="shiningicon" class="fas fa-circle fa-xs" :class="checkSpeakerAllvideoState(speaker)"
                                ref="shiningicon" :data-userid="speaker.userId"></i>
                        </div>
                        <!-- 左上角-姓名 -->
                        <div class="w3-bar-item w3-button" style="float: left;padding:0.3em;color:#354634;"
                            :style="dynamicDisplayNameCss(speaker)">
                            <span class="userName" :title="speaker.displayName">
                                {{avatarDisplay(speaker.userId,false)}}</span>
                        </div>
                        <!-- <div id="reload" class="w3-bar-item w3-button" style="float: left;padding:0.3em;color:gray">
                            <i class="fas fa-redo" style="font-size:0.4em" aria-hidden="true" @click="reload"></i>
                            </div>-->
                        <!-- 別人:isDiableCamera -->
                        <!-- <div v-if="speaker.userId !=currUser.userId " 
                                id="cameraoff" class="w3-bar-item w3-button" 
                                style="float: left;padding:0.3em;color:#343d46" >
                                <i class="fa " :class="{'fa-video-slash': speaker.isDiableCamera || (!speaker.hascamera) ,'fa-video' : !speaker.isDiableCamera }"  
                                style="font-size:1em" aria-hidden="true"></i>
                            </div>  -->

                        <!-- 右上角-自己取消發言 -->
                        <div v-if="speaker.userId ==currUser.userId " id="releaseMic" class="w3-bar-item w3-button"
                            style="float: right;color:rgb(33, 150, 243)" @click="handleMic('releaseMic')">
                            <i class="far fa-times-circle"
                                :style="(isShareVideo || isShareVideo_0 || (pinWebcamInfo.empId)  || (pinWebcamInfoManual.empId)) ? 'font-size:1.4em;': 'font-size:2em;' "
                                :title="`${$t('lan-tab-unspeak')}`" data-step="4"
                                :data-intro="`${$t('lan-info-step4')}`"></i>
                        </div>

                        <!-- 自己:開關mute -->
                        <!-- <div  v-if="speaker.userId ==currUser.userId "  
                                id="mute" class="w3-bar-item w3-button" 
                            style="float: right;padding:0.3em;color:crimson" @click="mute" >
                            <i class="fas" :class="{'fa-microphone-slash': currUser.isMute, 'fa-microphone': !currUser.isMute }" 
                                :style="(isShareVideo || (pinWebcamInfo.empId)) ? 'font-size:1.4em;': 'font-size:2em;' " :title="currUser.isMute ? '靜音':'收音中'"></i>
                            </div> -->
                        <!-- 右上角-請別人取消發言 -->
                        <div v-if="speaker.userId !=currUser.userId " id="mute" class="w3-bar-item w3-button"
                            style="float: right;color:#343d46" @click.prevent="askUserReleaseMic(speaker,true)">
                            <i id="volumeicon" class="fas "
                                :class="{'fa-volume-mute': speaker.isMute,'fa-volume-up' : !speaker.isMute,'speaking': speaker.isSpeaking ,}"
                                :style="(isMobileUI) ? 'font-size:1.4em;':'font-size:1em;' " aria-hidden="true"></i>
                        </div>
                    </div>
                    <div class="w3-bar speakerItemBar" style="background-color: transparent;
                                position: absolute;
                                z-index: 99999;
                                padding-right: 1.5em;
                                text-align: center;"
                        :style="(isShareVideo || isShareVideo_0 || (pinWebcamInfo.empId) || (pinWebcamInfoManual.empId)) ? ' top:20%;': ' top:25%;' ">
                        <!-- Video 狀態 -->
                        <div class="w3-bar-item w3-button"
                            :style="`float: inherit;padding:0.3em;color: ${ (speaker.videoState=='canplay') ? 'Tomato' :'Tomato'}`"
                            v-if="((speaker.videoState!='play') && (speaker.userId !=currUser.userId)  )"
                            id="videoState"
                            @click.prevent="(speaker.videoState!='play' && (speaker.userId !=currUser.userId)) ? reConnectKms(speaker):reConnectKms(speaker)"
                            :title="`VidoState:${speaker.videoState}`">
                            <i v-if="(speaker.videoState=='canplay') " class="fab fa-youtube"
                                :style="`font-size:${(isShareVideo || isShareVideo_0 || (pinWebcamInfo.empId) || (pinWebcamInfoManual.empId)) ? '2.5em':'5em'}`"
                                aria-hidden="true"></i>
                            <i v-if="(speaker.videoState=='loadstart' || speaker.videoState=='interrupt') "
                                class="fas fa-redo-alt"
                                :style="`font-size:${(isShareVideo || isShareVideo_0 || (pinWebcamInfo.empId) || (pinWebcamInfoManual.empId)) ? '2.5em':'5em'}`"
                                aria-hidden="true"></i>
                            <div v-if="(speaker.videoState=='canplay')">{{ $t("lan-click-play") }}</div>
                            <div v-if="(speaker.videoState=='loadstart' || speaker.videoState=='interrupt')">{{ $t("lan-reconnect") }}</div>
                        </div>
                    </div>
                    <div v-show="false">{{checkSpeakerAllvideoState(speaker)}}</div>
                    <div v-if="speaker.cannotHearYou"
                        v-show="((speaker.userId != currUser.userId) && speaker.cannotHearYou)" style="background-color: transparent; position: absolute; z-index: 999; padding-right: 0.5em; text-align: center; top: 5%;white-space: pre-line;
                                color:red" :title="`${$t('lan-videostate-tips1')}`">
                        {{`${$t('lan-videostate-tips1')}`}}
                    </div>
                    <div v-if="checkSpeakerAllvideoState(speaker)=='loadstart' && !speaker.cannotHearYou"
                        v-show="((speaker.userId != currUser.userId) && checkSpeakerAllvideoState(speaker)!='play')"
                        style="background-color: transparent; position: absolute; z-index: 999; padding-right: 0.5em; text-align: center; top: 5%;white-space: pre-line;
                                color:blue" :title="`${$t('lan-videostate-tips2')}`">
                        {{`${$t('lan-videostate-tips2')}`}}
                    </div>
                    <!-- <div v-show="(speaker.userId != currUser.userId) && speaker.cannotHearYou" style="background-color: transparent; position: absolute; z-index: 99999; padding-right: 0.5em; text-align: center; top: 35%;
                    color:red" :title="`${$t('lan-videostate-tips1')}`">
                        {{`${$t('lan-videostate-tips1')}`}}
                    </div> -->
                    <div class="w3-bar speakerItemBar" style="background-color: transparent;
                                position: absolute;
                                z-index: 99999;
                                padding-right: 0.5em;"
                        :style="(isShareVideo || isShareVideo_0 || (pinWebcamInfo.empId) || (pinWebcamInfoManual.empId)) ? ' top:60%;': ' top:80%;' ">
                        <!-- 別人pin WebCam圖釘 -->
                        <div id="pin" v-if="!isMobileUI && (speaker.userId !=currUser.userId && speaker.hascamera)"
                            class="w3-bar-item w3-button"
                            style="float: right;padding:0.3em 1em 0.3em 0.3em;color:#343d46"
                            @click.prevent="pinWebCamManual(speaker);resizeWindow();">
                            <i :class="( speaker.userId == pinWebcamInfoManual.empId)? 'fas fa-thumbtack':'fas fa-thumbtack  fa-rotate-90' "
                                :style="( speaker.userId == pinWebcamInfoManual.empId)? 'font-size:1.4em;color:red' : 'font-size:1em;color:green'"
                                aria-hidden="true"></i>
                        </div>
                        <!-- 自己:開關webCam -->
                        <div v-if="speaker.userId ==currUser.userId && (deviceInfo().hasCamera  && speaker.isAllowWebCam==true && showHideDivKMSWebCam()) && ['loadstart','canplay','play','pause'].includes(speaker.videoState)"
                            id="cameraoff" class="w3-bar-item w3-button"
                            style="float: right;padding:0.3em;color:crimson" @click="cameraoff(speaker)">
                            <i class="fa "
                                :class="{'fa-video-slash': speaker.isDiableCamera ,'fa-video' : !speaker.isDiableCamera }"
                                :style="(isShareVideo || isShareVideo_0 || (pinWebcamInfoManual.empId)) ? 'font-size:1.4em;': 'font-size:2em;' "
                                aria-hidden="true" :title="`${$t('lan-avatar-play')}`" data-step="5"
                                :data-intro="`${$t('lan-info-step5')}`"></i>
                        </div>
                        <div v-if="speaker.userId != currUser.userId && false"
                            id="other_speakeroff" class="w3-bar-item w3-button"
                            style="float: left;padding:0.3em;" :style="speaker.trackEnabled ? 'color:green' : 'color:gray'" @click="trackoff(speaker)">
                            <i class="fa "
                                :class="{'fa-volume-up': speaker.trackEnabled ,'fa-volume-mute' : !speaker.trackEnabled }"
                                :style="(isShareVideo || isShareVideo_0 || (pinWebcamInfoManual.empId)) ? 'font-size:1.4em;': 'font-size:2em;' "
                                aria-hidden="true"></i>
                        </div>
                    </div>
                    <!--音量條-->
                    <canvas v-show="currUser.userId==speaker.userId?!currUser.isMute:!speaker.isMute" style="transform: rotate(180deg);height:inherit;
                        background-color: transparent;
                        position: relative;
                        z-index: 100000;
                        margin-left: 97%;" ref="cvsSound" :data-userid="speaker.userId" width="10px">
                    </canvas>
                </div>
            </div>
            <!-- Canvas(outside) style=" z-index:100"-->
            <!--彈幕-->
            <canvas id="sharingVideoCanvas" class="video-width" v-show="(isShowCanvas && !isMobileUI)" :style="`${!isFullScreen?'max-height: 763px;':fullscreenStyle.videoStyle};
                            position: absolute;
                            ${iseBoardClicked ? 'z-index:999;' : 'z-index:500;'};
                            ${isShowList?'':'width: 100vw;'}`">
            </canvas>
            <!--頭貼、視訊-->
            <div v-show="speakerActive" class="speakerContainer" style=" z-index:0">
                <div :style="dynamiceFrameSize(speaker.userId ==currUser.userId)"
                    v-for="(speaker,n) in onlineSpeakersSorted" :index="n" class="speakerItem"
                    v-bind:key="`speaker_${speaker.userId}`" :id="`speaker_${speaker.userId}`"
                    @click.prevent=" (speaker.userId !=currUser.userId && speaker.hascamera) ? dbclick(`speaker_${speaker.userId}`,()=>{ pinWebCamManual(speaker);}) : ()=>{}">
                    <button v-show="false" :class="`kurentostart btn-primary`" href="#">發言</button>
                    <button v-show="false" class="`kurentostop btn-danger`" href="#">停止</button>
                    <button v-show="false" class="kurentoplay" href="#">Play</button>
                    <!-- <span  v-show="false" >Viewer url:<br/><span id="viewerUri"></span></span> -->
                    <!--頭貼-->
                    <div v-if="speaker.isDiableCamera || speaker.hascamera==false || (speaker.userId== currUser.empId && speaker.isAllowWebCam==false) || (speaker.userId == currUser.empId && !showHideDivKMSWebCam())"
                        class="avatar" :id="`avatar_${speaker.userId}`"
                        :style="avatarStyle(speaker.userId,speaker.videoState)">
                        <table>
                            <tr>
                                <td :class="`${(isShareVideo || isShareVideo_0 || (pinWebcamInfoManual.empId) || (pinWebcamInfoManual.empId)) ? 'avatarFontSizeSmall': 'avatarFontSizeBig'}`"
                                    style="word-break:break-all;">
                                    {{avatarDisplay(speaker.userId)}}</td>
                            </tr>
                        </table>
                    </div>
                    <!-- <div v-show="!speaker.isDiableCamera"> -->
                    <!--視訊-->
                    <div>
                        <video muted v-if="speaker.userId ==currUser.userId " class="kurentovideoInput"
                            :id="`kurento_${speaker.userId}`" playsinline="true" :kmsid="speaker.kmsid" autoplay
                            playsinline="true"
                            style="width: 100%;height: 100%;object-fit: fill;filter: brightness(1.2);"
                            @canplay="startViewing(event,speaker)" @loadstart="startViewing(event,speaker)"
                            @ended="startViewing(event,speaker)" @abort="startViewing(event,speaker)"
                            @emptied="startViewing(event,speaker)" @error="startViewing(event,speaker)"
                            @pause="startViewing(event,speaker)" @play="startViewing(event,speaker)"
                            :src-object.prop.camel="speaker.srcObject">
                            <img v-if="speaker.userId ==currUser.userId " src="./img/avatar.png"
                                @load="startPlayCamera(speaker)"></img>
                        </video>
                        <video :muted="currUser.isAllmute" v-if="speaker.userId !=currUser.userId "
                            class="kurentovideovideoViewer" :id="`kurento_${speaker.userId}`" playsinline="true"
                            :kmsid="speaker.kmsid" autoplay
                            style="width: 100%;height: 100%;object-fit: fill;filter: brightness(1.2); border-radius: 10px;"
                            @canplay="startViewing(event,speaker)" @loadstart="startViewing(event,speaker)"
                            @ended="startViewing(event,speaker)" @abort="startViewing(event,speaker)"
                            @emptied="startViewing(event,speaker)" @error="startViewing(event,speaker)"
                            @pause="startViewing(event,speaker)" @play="startViewing(event,speaker)"
                            :src-object.prop.camel="speaker.srcObject">
                            <img v-if="speaker.userId !=currUser.userId " src="./img/avatar.png"
                                @load="startPlayCamera(speaker)"></img>

                        </video>
                    </div>
                    <!-- <div style="height:inherit;
                        background-color: transparent;
                        position: absolute;
                        z-index: 100000;
                        padding-right: 0.5em;right: 10%">
                        
                    </div> -->
                </div>
            </div>
            <!--電子白板-->
            <div id="divWhiteboard" class="video-width" v-show="isWhiteboardEnable"
                :style="`${!isShowList ? 'width: 100vw;' : ''}`">
                <iframe id="wbiframe" src="" style="width: 100%; max-height: 763px; min-height: 400px;"></iframe>
            </div>
            <!--桌面分享畫面-->
            <div id="sharingVideo" 
                 stearmid="" 
                 :style="!isShowList?'width: 100vw;':''" 
                 v-show="(( (videoInfo.id !=null) && ((!isShareVideoLocalWebRTC && !isShareVideoLocalKMS) || isShareVideoLocalKMSWebCam || ckDispalyMyVideo) && !isWhiteboardEnable && isAuthViewLive()) || isShareVideoLocalImage || isShareVideoImage )"
                 :class="`media-container media-container-VIDEO  ${!isFullScreen?'video-width':fullscreenStyle.videoClass}`">

                <div class="volume-control" style="margin-left: 804px; margin-top: -2px; opacity: 1;"></div>
                <div id="mediaBox" :class="`media-box  ${!isFullScreen?'video-width':fullscreenStyle.videoClass}`"
                    :style="`${!isShowList?'width: 100vw;':''} ${ (isShareVideoLocalImage|| isShareVideoImage) ? 'background-color: #fff' : ''}`">
                    <div id="subtitleFull" ref="subtitle" v-show="roomInfo.transType && roomInfo.transType != '1' && show_speech_text.isShow && ccActive && isFullScreen" class="containers video-width video-height" :style="showSpeechStyle()">
                        <!-- 下方文字 -->
                        <div class="container" style="max-width: 80%; padding: 0px;">
                            <div style="width: fit-content; padding: 3px; color: white; cursor: pointer; white-space: break-spaces;" :style="showSpeechBackground" @click="changeSpeechPosition()">
                                <span :style="speechTextStyle(show_speech_text, true, true)" v-html="showSubtitle"></span>
                            </div>  
                        </div>
                        <div class="container" style="max-width: 80%; padding: 0px;" v-show="currTransTab == 'msgHistory_all' || currTransTab == 'msgHistory_debug'" >
                            <div style="width: fit-content; padding: 3px; color: white; cursor: pointer; margin-top: 5px; white-space: break-spaces;" :style="showSpeechBackground" @click="changeSpeechPosition()">
                                <span :style="speechTextStyle(show_speech_text, true, false)" v-html="showSubtitleTrans"></span>
                            </div>  
                        </div>
                    </div>
                    <!-- Canvas(inside) (used when playing video) -->
                    <div class="discussMode-label" v-show="isFullScreenDiscuss">【{{ $t("lan-mode") }}】</div>
                    <!-- 影片工具列 -->
                    <div class="media-controls custom-position"
                        :style="`${isFullScreen?'margin-right:0':''};${!isShowList?'margin-right: 0vw;':''}`">
                        <!-- 全螢幕按鈕 -->
                        <div :class="isFullScreen? 'control zoom-out selected':'control zoom-in'"
                            @click="isFullScreen? cancelFullScreen():fullscreen('sharingVideo')"
                            :title="isFullScreen ? `${$t('lan-hint-tips11-1')}` : `${$t('lan-hint-tips11')}`"
                            style="margin-right: 1px; border-bottom-left-radius: 0px;">
                        </div>
                        <!-- 停止直播 -->
                        <div v-if="isShareVideoLocalKMSWebCam"
                            :class="isFullScreen? 'control stop selected':'control stop'" @click="kmsStopClick">
                        </div>
                        <!-- 停止圖片直播 -->
                        <div v-if="isShareVideoLocalImage" :class="isFullScreen? 'control stop selected':'control stop'"
                            @click="LiveImage()">
                        </div>
                        <!-- CC按鈕 -->
                        <div v-if="roomInfo.transType" 
                            :class="isFullScreen? 'control selected':'control'"
                            @click="ccActive = !ccActive"
                            :style="{'background-image' : (ccActive) ? `url('./img/cc.png')`:`url('./img/cc-disable.png')`}">
                            <!-- <i v-if="ccActive" class="fas fa-closed-captioning" style="font-size: 35px;"></i>
                            <i v-else class="far fa-closed-captioning" style="font-size: 35px;"></i> -->
                        </div>
                        <!-- 靜音按鈕 -->
                        <div v-if="isUsingSelf && !isRemoteCtrlActive"
                            :class="!currUser.isMute? 'control mute-audio-self':'control unmute-audio-self'"
                            @click="mute(!currUser.isMute)"
                            :title="!currUser.isMute ? `${$t('lan-hint-tips12')}` : `${$t('lan-hint-tips12-1')}`">
                        </div>
                        <!-- 彈幕開關-->
                        <div v-if="!isRemoteCtrlActive" :class="isShowCanvas? 'control chat-on':'control chat-off'"
                            @click="isShowCanvas = !isShowCanvas" :title="`${$t('lan-hint-tips13')}`">
                        </div>
                        <!-- PIP開關-->
                        <div v-if="(!isRemoteCtrlActive && !isMobileUI && !isShareVideoLocalImage && !isShareVideoImage && !isSecret())"
                            :class="isShowPIP ? 'control pip-media':'control unpip-media'" @click="openPIP"
                            :title="`${$t('lan-hint-tips14')}`">
                        </div>
                        <!-- 遠端控制(對方SmartPanel需有啟動)-->
                        <div v-if="(isShowRMCtrl && !isShareVideoDoubleCam && !isShareLocalDoubleCam && !isMobileUI && !isShareVideoLocalImage && !isShareVideoImage)"
                            :class="!isRemoteCtrlActive ? 'control remote-pc':'control remote-pc-on'"
                            @click="remoteCtrl"
                            :title="!isRemoteCtrlActive ? `${$t('lan-hint-tips15')}` : `${$t('lan-hint-tips15-1')}`">
                        </div>
                        <!-- HoloLens Unity:Req. Capture-->
                        <div v-if="isShareVideoHoloII && isShowHoloArrow && !isShareVideoImage && !isMobileUI"
                            class="control holo-capture" @click="holoCapture" :title="`${$t('lan-hint-tips19')}`">
                        </div>
                        <!-- HoloLens Unity:Req. Stop Image Live-->
                        <div v-if="isShareVideoHoloII && isShareVideoImage && !isMobileUI"
                            class="control holo-stop-capture" @click="holoStopCapture"
                            :title="`${$t('lan-hint-tips19-1')}`">
                        </div>
                        <!-- HoloLens Unity:錨點-->
                        <div v-if="isShareVideoHoloII && isShowHoloArrow && !isShareVideoImage && !isMobileUI"
                            :class="!isHoloArrowActive ? 'control holo-arrow-off':'control holo-arrow-on'"
                            @click="holoArrow"
                            :title="!isHoloArrowActive ? `${$t('lan-hint-tips16')}` : `${$t('lan-hint-tips16-1')}`">
                        </div>
                        <!-- HoloLens Unity:停止編輯-->
                        <div v-if="isHoloArrowActive" @click="holoArrow" class="control"
                            style="width:auto;color: darkred;font-weight: bold;display: flex;">
                            <span>{{$t("lan-holo-stopmarkup")}}</span>
                        </div>
                        <!-- Upload file-->
                        <!-- <div v-if="isShareVideoHoloII && !isMobileUI" :class="'control uploadFile'"                             
                            @click="shareFile" :title="`${$t('lan-hint-tips17')}`">
                        </div>                           -->
                        <!-- Upload Image-->
                        <!-- <div v-if="isShareVideoHoloII && !isMobileUI" :class="'control uploadImage'" 
                            @click="shareImage" :title="`${$t('lan-hint-tips18')}`">
                        </div>                                               -->
                        <!-- 視訊開關-->
                        <!-- <div v-if="ckDispalyMyWebCam && ckHideMyWebCam " :class="'control camera-on'" 
                            @click="unhideCameraFrame" title="開啟視訊視窗">
                        </div> -->
                        <!-- 雙鏡頭切換 -->
                        <div v-if="isShareVideoLocalKMSWebCam" :class="'control revert'" @click="kmsVideoStreamChange">
                        </div>
                    </div>
                    <h2 v-if="isShowCondientialWording"
                        style="position: absolute;color:white;padding:0;margin:0;    background-color:rgb(233 30 30 / 50%);
                            text-align: left; margin-top: 10px; margin-left: 10px; display: block; border: 0;line-height:1.5;z-index:1;"
                        :title="pinWebcamInfo.displayName">
                        {{ $t("lan-security") }}
                    </h2>
                    <!-- 桌面直播 影像 -->
                    <video id="sharingVideoTag" class="video-width" autoplay="true" playsinline="true" muted
                        :streamid="videoInfo.id" :userid="videoInfo.userid" @canplay="videoreadyCallBack"
                        @loadstart="videoreadyCallBack" @ended="videoreadyCallBack" @abort="videoreadyCallBack"
                        @emptied="videoreadyCallBack" @error="videoreadyCallBack" @pause="videoreadyCallBack"
                        @play="videoreadyCallBack" @webkitbeginfullscreen="videoreadyCallBack"
                        @webkitendfullscreen="videoreadyCallBack" nodename="video"
                        :style="`${!isFullScreen?'max-height: 763px;':fullscreenStyle.videoStyle} ${((isShareVideoLocalImage || isShareVideoImage))?'display:none;':''}`"
                        :src-object.prop.camel="videoInfo.srcObject" v-on="{ leavepictureinpicture: checkandClosePIP}">
                    </video>
                    <!-- :style="`${!isFullScreen?'height: 763px;display: block; margin: auto;width:auto':fullscreenStyle.videoStyle}`" -->

                    <!-- 直播圖片 -->
                    <img id="sharingImageTag" class="video-width" :src="sharingImageSrc"
                        :style="`${!isFullScreen?'max-height: 763px;':fullscreenStyle.videoStyle} ${(isShareVideoLocalImage||(isShareVideoImage && isAuthViewLive()))?'':'display:none;'}`"
                        @load="sharingImageLoad" />
                    <input id="shareFile" ref="shareFile" type="file" style="display:none;"
                        @click="$refs.shareFile.value=null" />
                    <input id="shareImage" ref="shareImage" type="file" accept="image/*" style="display:none;"
                        @click="$refs.shareImage.value=null" />
                </div>
                
                
            </div>
            <!--視訊直播 釘選-->
            <div id="sharingVideoWebcam" :style="!isShowList?'width: 100vw;display:block':'display:block'"
                v-if="pinWebcamInfo.isShow && pinWebcamInfo.srcObject"
                :class="`media-container media-container-VIDEO `">
                <div :class="`media-box ${!isFullScreen? 'video-width':fullscreenStyle.videoClass}`" id="mediaBox"
                    :style="!isShowList?'width: 100vw;':''">
                    <div class="media-controls"
                        :style="`${isFullScreen?'margin-right:0':''};${!isShowList?'margin-right: 0vw;':''}`">
                        <!-- 靜音按鈕 -->
                        <div v-if="isUsingSelf"
                            :class="!currUser.isMute? 'control mute-audio-self':'control unmute-audio-self'"
                            @click="mute(!currUser.isMute)">
                        </div>
                        <!-- PIP開關-->
                        <div :class="isShowPIP ? 'control pip-media':'control unpip-media'" @click="openPIP">
                        </div>
                        <!-- 視訊開關-->
                        <!-- <div v-if="ckDispalyMyWebCam && ckHideMyWebCam " :class="'control camera-on'" 
                            @click="unhideCameraFrame" title="開啟視訊視窗">
                        </div> -->
                    </div>
                    <!-- <h2 style="position: absolute;color:#2196F3;font-size:17px;text-shadow: 1px 1px black;padding:0;margin:0;
                            text-align: left; margin-top: 10px; margin-left: 10px; display: block; border: 0;line-height:1.5;z-index:1;" 
                            :title="pinWebcamInfo.displayName"> 
                            {{(avatarDisplay(pinWebcamInfo.empId))? avatarDisplay(pinWebcamInfo.empId) :pinWebcamInfo.empId}}
                    </h2> -->
                    <video muted id="pinWebcamVideoTag" class="video-width" playsinline="true" autoplay
                        :userid="pinWebcamInfo.empId" nodename="video"
                        :style="`${'max-height: 763px;'} object-fit: contain;filter:  brightness(1) blur(1px);`"
                        :src-object.prop.camel="pinWebcamInfo.srcObject"
                        v-on="{ leavepictureinpicture: checkandClosePIP}">
                    </video>
                </div>
            </div>
            <!--視訊釘選手動-->
            <div id="sharingVideoWebcam" stearmid="" :style="!isShowList?'width: 100vw;display:block':'display:block'"
                v-if="pinWebcamInfoManual.isShow && pinWebcamInfoManual.srcObject"
                :class="`media-container media-container-VIDEO `">
                <div :class="`media-box  ${!isFullScreen?'video-width':fullscreenStyle.videoClass}`" id="mediaBox"
                    :style="!isShowList?'width: 100vw;':''">
                    <video muted id="pinWebcamVideoTagManual" class="video-width" playsinline="true" autoplay
                        :userid="pinWebcamInfoManual.empId" nodename="video"
                        :style="`${'max-height: 763px;'} object-fit: contain;filter: brightness(1) blur(1px);`"
                        :src-object.prop.camel="pinWebcamInfoManual.srcObject">
                    </video>
                </div>
            </div>
            <!--我要桌面直播、視訊直播、雙鏡頭直播、圖片直播-->
            <div id="divShareMyScreen" class="row mx-auto justify-content-center" v-if="!isShareVideo && !isWhiteboard && !isMobileUI && !isShareVideo_0" style="margin: 0px;">
                <div class="card card-circle share-block">
                    <div class="card-icon">
                    <i class="rotate-i fas fa-desktop"></i>
                    </div>
                    <div class="card-circle-body">
                        <h5 class="card-circle-title">{{ $t('lan-share') }}</h5>
                        <i class="fas fa-caret-down"></i>
                        <div class="hover-down-content" :class="{ 'content-center': (lanSelected == 'tw') }">
                            <div id="divkmsShare" class="fromCenter" @click="beforeKmsShareClick(event,false)">
                                <h5><i class="fas fa-desktop"></i>&nbsp;&nbsp;{{ $t('lan-screen') }}</h5>
                            </div>
                            <div id="divLiveImg" class="fromCenter" style="margin-top: 10px;" @click="click_divLiveImg()">
                                <h5><i class="far fa-images"></i>&nbsp;&nbsp;{{ $t('lan-image') }}</h5>
                            </div>
                            <div v-if="showHideDivKMSWebCam()" class="fromCenter" style="margin-top: 10px;"  @click="handleMicHD('updateMicHD')">
                                <h5><i class="fas fa-video"></i>&nbsp;&nbsp;{{ $t('lan-my-webcam') }}</h5>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card card-circle speak-block"  @click="handleMic('updateMic')" :title='currUser.isMute ? $t("lan-hint-tips10-1") : $t("lan-hint-tips10")'>
                    <div class="card-icon">
                        <i class="rotate-i fas" :class="{'fa-microphone-slash': currUser.isMute, 'fa-microphone': !currUser.isMute }"></i>
                        </div>
                        <div class="card-circle-body">
                        <h5 class="card-circle-title">{{ currUser.isMute ? isAskMic? $t("lan-header-speak") : $t("lan-header-mute") : $t("lan-header-unmute") }}</h5>
                    </div>
                </div>
            </div>
            <div id="divShareMyScreening" style="box-sizing:content-box;">
                <!--桌面分享中/視訊直播中/桌面直播中-->
                <div v-if="isShareVideo && ( (isShareVideoLocalKMS || isShareVideoLocalWebCam) && !isShareVideoLocalKMSWebCam ) && !isWhiteboard && !isWaitHoloUnity"
                    id="divKMSScreening">
                    <div v-if="!ckDispalyMyVideo"
                        style="margin: 100px auto auto auto;text-align: center;color:#2196F3;font-weight:bold">
                        <div>
                            <div style="animation: blink 1s infinite; display: inline-block;color:red;">●</div>
                            {{(isShareVideoLocalWebCam) ? $t('lan-live-webcam-ing') : $t('lan-live-desktop-ing')}}.....
                        </div>
                        <img style="height:215px;width:215px"
                            :src="(isShareVideoLocalWebCam) ? 'img/sharingWebCam.png' : 'img/sharingKMS.png'" />
                    </div>
                    <div id="stopKMSSharing"
                        style="margin: 10px auto auto auto;text-align: center;color:red;font-weight:bold">
                        <button type="button" class="btn-danger" @click="kmsStopClick"> {{(isShareVideoLocalWebCam) ?
                            $t('lan-live-webcam-stop') : $t('lan-live-desktop-stop')}}</button>
                    </div>

                </div>
                <!--Mobile no authorization to view Live 11/18-->
                <!-- <div v-if="currUser.userType !== 'M' && isMobileAny && isShareVideo_0 && !currUser.authMobileViewLive" id="divMobileNoLive"> -->
                <div v-if="((isShareVideo_0 || isShareVideoImage ) && !isAuthViewLive())" id="divMobileNoLive"
                    :style="(isSecret() && !CONFIG.isExternal && !isSmartPanelOn && !(isShareVideoHolo||isShareVideoHoloII) && !isSecretDetectDelay)?'margin: 0px 30%;':''">
                    <!-- <img :src="(isMobileAny && !(isShareVideoHolo||isShareVideoHoloII))? 'img/MobileViewLiveAuth.jpg' : 'img/ViewLiveAuth.jpg'" -->
                    <!--<img :src="(isSecret())? (CONFIG.isExternal)?'img/SecretMeeting.jpg':'img/SecretMeeting_I.jpg':'img/ViewLiveAuth.jpg'" -->
                    <!-- <img :src="(isSecret())? (CONFIG.isExternal)?'img/SecretMeeting.jpg':(isSecretDetectDelay?'img/SecretMeeting_I.jpg':'') :'img/ViewLiveAuth.jpg'"                    
                         :style="(isMobileAny && !(isShareVideoHolo||isShareVideoHoloII))?'max-height:250px;width:100%':'display:block; margin:auto;' "> -->
                    <!-- mark by vic 2024/01/03 不show請user重連的圖了-->
                    <img :src="(isSecret())? (CONFIG.isExternal)?'img/SecretMeeting.jpg':'' :'img/ViewLiveAuth.jpg'"
                        :style="(isMobileAny && !(isShareVideoHolo||isShareVideoHoloII))?'max-height:250px;width:100%':'display:block; margin:auto;' ">
                    <!-- mark by vic 2024/01/03 不show環境準備中了-->
                    <!-- <div id="load-wrapp" class="load-wrapp" style="width:50%" v-show="(isSecret() && !CONFIG.isExternal && !isSmartPanelOn && !(isShareVideoHolo||isShareVideoHoloII) && !isSecretDetectDelay)">
                        <div class="load-10">
                            <p>{{ $t("lan-hint-tips23") }}</p>
                            <div class="bar"></div>
                          </div>
                    </div>                          -->
                </div>
                <!--HoloLens 桌面直播waiting Unity response 2022.03.10-->
                <div v-if="isWaitHoloUnity" id="divWaitHoloUnity">
                    <div v-if="!ckDispalyMyVideo"
                        style="margin: 100px auto auto auto;text-align: center;color:#2196F3;font-weight:bold">
                        <div>
                            <div style="animation: blink 1s infinite; display: inline-block;color:red;">● [Waiting]
                            </div> {{$t('lan-live-desktop')}}.....
                        </div>
                        <img style="height:215px;width:215px" src='img/sharingKMS.png' />
                    </div>
                </div>
            </div>
            <div id="real-div">
                <div id="real-iframe-hover" style="position: fixed; z-index:2; background: transparent; bottom:0; cursor: pointer;"></div>
            </div>
        </div>


        <div class="w3-right list-width">
            <!-- 右列 Tab -->
            <div id="collapsePanel" :class="`collapse ${isShowList?'show':''}`">

                <div class="w3-cell-row" id="panel-tab">
                    <div class="w3-cell tablink w3-bottombar w3-hover-light-grey w3-padding w3-center pointer"
                        :style="{ 'border-color':(aTabDisplay[0]=='block') ? 'red!important' : 'rgb(204, 204, 204)!important' }"
                        @click="changeTab(0)">{{ $t("lan-tab-list") }}
                        {{ ((roomInfo.transType==undefined || roomInfo.transType=="") ? '': (lanSelected == "tw") ? " / "+$t("lan-tab-speech") : "" ) }}</div>
                    <div class="w3-cell tablink w3-bottombar w3-hover-light-grey w3-padding w3-center pointer"
                        :style="{ 'border-color':(aTabDisplay[1]=='block') ? 'red!important' : 'rgb(204, 204, 204)!important' }"
                        @click="changeTab(1)">{{ $t("lan-tab-talk") }} <span class="badge badge-pill badge-warning"
                            v-show="chatUnreadCnt > 0">{{ chatUnreadCnt }}</span></div>
                    <div class="w3-cell tablink w3-bottombar w3-hover-light-grey w3-padding w3-center pointer"
                        :style="{ 'border-color':(aTabDisplay[2]=='block') ? 'red!important' : 'rgb(204, 204, 204)!important' }"
                        @click="changeTab(2)">{{ $t("lan-tab-history") }}</div>
                    <!-- <div class="w3-cell tablink w3-bottombar w3-hover-light-grey w3-padding w3-center pointer" :style="{ 'border-color':(aTabDisplay[3]=='block') ? 'red!important' : 'rgb(204, 204, 204)!important' }" @click="changeTab(3)">{{ $t("lan-tab-sharedoc") }}</div> -->
                </div>

                <!-- 線上同仁-->
                <div id="panelright" :style="{ display: aTabDisplay[0] }">
                    <div id="emoji" class="btn-toolbar" role="toolbar" aria-label="Toolbar with button groups">
                        <!-- <div v-for="emoji in emojilist" class="btn-group " role="group" aria-label="First group">
                          <button type="button" class="btn" style="    font-size: x-large;
                          margin: 0px;
                          padding: 0px;
                          border: 0px;" @click="userInputMsg = emoji ;clickSendMsg(event,true)">{{emoji}}</button>
                        </div> -->
                        <div v-for="emoji in emojilist">
                            <img :src="`img/emoji/${emoji}.png`" :id="`emoji_${emoji}`"
                                style="width: 30px; height: 30px;margin-right: 2px; padding: 0px; border: 0px; cursor: pointer;"
                                @click="userInputMsg = emoji; clickSendMsg(event,true)" />
                        </div>
                    </div>
                    <!-- 線上同仁 新的-->
                    <div id="listdivNew" class="listdiv participants list-width" v-show="true"
                        :style="roomInfo.transType ? 'overflow-x:hidden;overflow-y:scroll;border:1px solid rgb(140,212,231)' : ''">
                        <!-- <div class="divParticipantsHeaderMSG" 
                            style="color:red;margin:0px;padding:5px">
                            <div title="未發言時請將麥克風靜音">未發言時請將麥克風靜音</div>
                        </div> -->
                        <div class="divParticipantsHeader"
                            style="background-color: #2196F3;color:white;padding:5px;overflow-x: hidden">
                            <span style="padding-left :5px;font-size: small;">
                                {{ $t('lan-tab-list') }}({{ $t('lan-tab-num') }} : {{ onlineUserCount }}, {{
                                $t('lan-tab-num-speak') }} : {{ onlineSpeakers.length }}, {{ $t('lan-tab-num-agree') }}
                                : {{ raiseHandCount }})
                            </span>
                            <div v-if="currUser.userType=='E'" class="invite" :title="`${$t('lan-tab-invite')}`"
                                style="cursor: pointer;" @click="openSelectEmp">{{ $t("lan-tab-invite") }}
                                <i class="fas fa-user-plus" style="color:lawngreen;padding:2px;"></i>
                            </div>
                        </div>
                        <div id="list_emp_height"
                            :class="roomInfo.transType ? '' : invitedUserCount>0 ? 'list-emp-height2' : 'list-emp-height1'"
                            :style="roomInfo.transType ? '' : 'border: 1px solid #95d4e7;'">
                            <ul class="participantsul" :class="invitedUserCount>0 ? 'participantsul-ext' : ''">
                                <!-- self -->
                                <li>
                                    <span>
                                        <!--LIVE-->
                                        <button type="button" class="btn btn-danger btn-sm" :title="$t('lan-tab-live')" @click="beforeKmsShareClick(event,false)" style="padding: 0px; font-size: 10px;">Share</button>
                                        <!-- <img style="height: 22px;" :title="$t('lan-tab-live')" src="img/KMS.png" @click="beforeKmsShareClick(event,false)" /> -->
                                        <i :class="sourceTypeDisplay(currUser.sourceType).css" :title="sourceTypeDisplay(currUser.sourceType).title"></i>
                                        <sapn style="cursor: pointer;" @click="SortOnlineUsers()" :title="$t('lan-tab-sort')">
                                            {{ currUser.name }}
                                            <i v-if="isonlineUsersSort==1" class="fas fa-arrow-up"
                                                style="color:blue"></i>
                                            <i v-if="isonlineUsersSort==2" class="fas fa-arrow-down"
                                                style="color:blue;"></i>
                                        </span>
                                        <i :class="onlineStatusDisplay(currUser.onlineStatus).css"
                                            :title="onlineStatusDisplay(currUser.onlineStatus).title"
                                            style="cursor: pointer;" @click="onlineStatusChange()"></i>
                                        <i :class="raiseHandStatusDisplay(currUser.raiseHandStatus).css"
                                            :title="raiseHandStatusDisplay(currUser.raiseHandStatus).title"
                                            :style="`width: 20px; cursor: pointer; ${ currUser.raiseHandStatus==1 ? 'color:Dodgerblue ' :  ''}` "
                                            v-on="{ mousedown: raiseHandStatusChangedown,
                                                        mouseup: raiseHandStatusChangeup ,
                                                        mouseleave: raiseHandStatusChangeup ,
                                                        touchstart: raiseHandStatusChangedown,
                                                        touchend: raiseHandStatusChangeup 
                                                        }"></i>
                                    </span>
                                    <span style="float: right; color: crimson;">
                                        <div>
                                            <span @click="handleMic('updateMic')"
                                                style="float: right; cursor: pointer; padding-right: 5px;" data-step="1"
                                                :data-intro="`${$t('lan-info-step1')}`">
                                                <span class="mictext">
                                                    {{ currUser.isMute ? isAskMic? $t("lan-tab-speak") :
                                                    $t("lan-tab-mute") : $t("lan-tab-unmute") }}
                                                </span>
                                                <i v-show="currUser.isMute"
                                                    :title="isAskMic ? `${$t('lan-tab-speak')}` : `${$t('lan-tab-unmute')}`"
                                                    class="fas fa-microphone-slash"></i>
                                                <i v-show="!currUser.isMute" :title="`${$t('lan-tab-mute')}`"
                                                    class="fas fa-microphone"></i>
                                            </span>
                                            <span v-show="cameraInfo.empid" @click="handleMic('releaseMic')"
                                                data-step="6" :data-intro="`${$t('lan-info-step6')}`"
                                                style="float: right; cursor: pointer; margin-right: 10px; color: blue;"
                                                :title="`${$t('lan-tab-unspeak-hint')}`">
                                                <span class="mictext">{{ $t("lan-tab-unspeak") }}</span>
                                                <i class="far fa-times-circle"></i>
                                            </span>
                                        </div>
                                    </span>
                                    <div style="min-width: 12px; display: inline-block;"></div>
                                </li>
                                <!-- online users -->
                                <li v-for="u in onlineUsers" style="display: flex; justify-content: space-between; position: relative;">
                                    <span :title="onlineUserTitleHint(u)" style="overflow: hidden;">
                                        <span v-if="isUsingSelf" :class="(u.connectionState) ? u.connectionState : 'null'" :title="'conn:'+u.connectionState"></span>
                                        <i :class="sourceTypeDisplay(u.sourceType).css" :title="sourceTypeDisplay(u.sourceType).title" style="width: 20px;"></i>
                                        {{ onlineUserDisplay(u) }}
                                    </span>
                                    <span style="padding: 0px 5px 0px 10px;">
                                        <i :class="u.raiseHandStatus==1 ? raiseHandStatusDisplay(u.raiseHandStatus).css :''" :style="`${u.raiseHandStatus==1 ? 'color: Dodgerblue;' :  ''}`" :title="raiseHandStatusDisplay(u.raiseHandStatus).title"></i>
                                        <i :class="onlineStatusDisplay(u.onlineStatus).css" :title="onlineStatusDisplay(u.onlineStatus).title"></i>
                                        <i v-if="currUser.userType=='E'" class="fas fa-sign-out-alt"
                                            :title="`${$t('lan-tab-push', { name: `${u.displayName}`})}`"
                                            style="cursor: pointer;" @click="letUserSignOut(u)"></i>
                                        <i v-if="currUser.userType=='E' && u.userType=='E'" v-show="isShowPteamScheme"
                                            @click="clickPteamScheme(u)" class="fas fa-comments" :title="'Pteam ' + u.name"
                                            style="cursor: pointer;"></i>
                                    </span>
                                </li>
                            </ul>
                        </div>
                        <div v-show="invitedUserCount>0" class="divParticipantsHeader"
                            style="background-color: #2196F3;color:white;padding:5px;overflow-x: hidden">
                            <span style="padding-left :5px;font-size: small;">
                                {{ $t('lan-tab-invited') }}({{ $t('lan-tab-num') }} : {{ invitedUserCount }})
                            </span>
                        </div>
                        <div v-show="invitedUserCount>0" class="list-invite-height" style="border: 1px solid #95d4e7;">
                            <ul class="participantsul">
                                <li v-for="u in invitedDisplayUsers">
                                    <span>
                                        {{ u.displayName }}
                                    </span>
                                </li>
                            </ul>
                        </div>
                    </div>
                    <!-- Translate:逐字稿-->
                    <div id="newSubtitle" v-show="roomInfo.transType" style="background-color:rgb(41,41,41);width:100%;border:1px solid rgb(149,212,231);">
                        <div id="show-speech-tab" class="w3-cell-row " :style="{display: saTabTitleDisplay}">
                            <div class="w3-cell tablink w3-bottombar w3-hover-light-grey w3-center pointer"
                                v-show="roomInfo.transType == '2' || roomInfo.transType == '3'"
                                style="background-color: white;"
                                :style="{ 'border-color':(saTabDisplay[0]=='block') ? 'red!important' : 'rgb(204, 204, 204)!important' }"
                                @click="changeTabs(0)">&nbsp;{{ $t("lan-tab-speech-all") }}&nbsp;</div>
                            <div class="w3-cell tablink w3-bottombar w3-hover-light-grey w3-center pointer"
                                v-show="roomInfo.transType == '2' || roomInfo.transType == '3'"
                                style="background-color: white;"
                                :style="{ 'border-color':(saTabDisplay[1]=='block') ? 'red!important' : 'rgb(204, 204, 204)!important' }"
                                @click="changeTabs(1)">&nbsp;{{ $t("lan-tab-speech-zh") }}&nbsp;</div>
                            <div class="w3-cell tablink w3-bottombar w3-hover-light-grey w3-center pointer"
                                v-show="roomInfo.transType == '2' || roomInfo.transType == '3'"
                                style="background-color: white;"
                                :style="{ 'border-color':(saTabDisplay[2]=='block') ? 'red!important' : 'rgb(204, 204, 204)!important' }"
                                @click="changeTabs(2)">&nbsp;{{ $t("lan-tab-speech-en") }}&nbsp;</div>
                            <div class="w3-cell tablink w3-bottombar w3-hover-light-grey w3-center pointer"
                                style="background-color: white;"
                                :style="{ 'border-color':(saTabDisplay[3]=='block') ? 'red!important' : 'rgb(204, 204, 204)!important' }"
                                @click="changeTabs(3)">{{ $t("lan-tab-verbatim") }}</div>
                        </div>
                        <!-- 字幕 all-->
                        <div v-if="saTabDisplay[0] == 'block'" style=" position:relative; ">
                            <div id="text-tool" style="position: absolute;top: 1px;z-index: 100;right: 1px;" :style="{'right': (newSubtitleScrollBarIsActive && !isMobileUI)? '18px' : '1px'}">                      
                                <button class="btn btn-info" 
                                        v-if="!CONFIG.isExternal"
                                        :class="{'btn-sm': !newSubtitleFullScreen, 'btn-lg': newSubtitleFullScreen}"
                                        :title="`${$t('lan-tab-export-title')}`"
                                        @click="exportScriptMsg('all','subtitle')"><i class="fa fa-file-excel"></i> {{$t("lan-tab-export-download")}}</button>
                                <button class="btn btn-info btn-sm" 
                                        v-if="!newSubtitleFullScreen" 
                                        @click="fullscreen('newSubtitle');"><i class="fas fa-expand"></i></button>
                                <button class="btn btn-info"
                                        :class="{'btn-sm': !newSubtitleFullScreen, 'btn-lg': newSubtitleFullScreen}" 
                                        v-else 
                                        @click="cancelFullScreen();"><i class="fas fa-compress"></i></button>
                                <button class="btn btn-info"
                                        :class="{'btn-sm': !newSubtitleFullScreen, 'btn-lg': newSubtitleFullScreen}"
                                        v-if="newSubtitleFullScreen"
                                        @click="handleSize('reduce')"><i class="fas fa-search-minus"></i></button> 
                                <button class="btn btn-info"
                                        :class="{'btn-sm': !newSubtitleFullScreen, 'btn-lg': newSubtitleFullScreen}" 
                                        v-if="newSubtitleFullScreen"
                                        @click="handleSize('add')"><i class="fas fa-search-plus"></i></button>                          
                            </div>
                            <div class="chatContainer list-transcript-height" v-show="isShowChat" v-cloak>
                                <div id="tempTag" class="inbox_msg">
                                    <div class="translated_mesgs list-transcript-height w3-display-container" style="display: flex; flex-direction: row; background-color:#292929; flex-wrap: wrap;height:calc(100%-43.74px);">
                                        <div ref="msgHistory_all" 
                                             class="msg_history list-transcript-inner-height" 
                                             style="width:100%;background-color:#292929;color:white" 
                                             @scroll="handleNewSubtitleScroll('scroll')">
                                            <div v-for="(c, index) in speechs_all" :style="{'margin-top':(index == 0) ? '30px' : '0px'}">
                                                <div class="debug-info" v-if="subtitle_show_debug && c.debugInfo" style="padding: 3px; margin-top: 10px;">
                                                    <button type="button" v-if="c.is_merge" class="btn btn-success" style="padding: 1px; margin: 1px;">merge</button>
                                                    <button type="button" class="btn btn-outline-light" style="padding: 1px; margin: 1px;">time <span class="badge badge-light">{{ formatNumber(c.debugInfo.audio_duration) }}</span></button>
                                                    <button type="button" class="btn btn-outline-light" style="padding: 1px; margin: 1px;">avg_{{c.detectLang}} <span class="badge badge-light">{{ formatNumber(c.debugInfo.avg_probs) }}</span></button>
                                                    <button type="button" v-if="c.debugInfo.use_detect_result == 'Y'" class="btn btn-outline-secondary" style="padding: 1px; margin: 1px;">avg_{{c.srcLang}} <span class="badge badge-light">{{ formatNumber(c.debugInfo.original_avg_probs) }}</span></button>
                                                    <button type="button" class="btn btn-outline-light" style="padding: 1px; margin: 1px;">sound <span class="badge badge-light">{{ formatNumber(c.debugInfo["sounddb.dBFS"]) }}</span></button>
                                                    <button v-if="false"  type="button" class="btn btn-outline-light" style="padding: 1px; margin: 1px;">vad <span class="badge badge-light">{{ formatNumber(c.debugInfo.vad) }}</span></button>
                                                    <button type="button" class="btn btn-outline-light" style="padding: 1px; margin: 1px;">len <span class="badge badge-light">{{ formatNumber(c.debugInfo.txt_Whisper_length) }}</span></button>
                                                    <button type="button" class="btn btn-outline-light" style="padding: 1px; margin: 1px;" @click="playWav(c.filename, false)">play <span class="badge badge-light"><i class="fas fa-play"></i></span></button>
                                                    <button type="button" class="btn btn-outline-light" style="padding: 1px; margin: 1px;" @click="playWav(c.filename, true)">download <span class="badge badge-light"><i class="fas fa-download"></i></span></button>
                                                    <!-- <button type="button" class="btn btn-outline-light" style="padding: 1px; margin: 1px;">sentenceId <span class="badge badge-light">{{ c.sentenceId }}</span></button> -->
                                                </div>
                                                <div class="">
                                                    <div class="translated_msg_username" style="display: flex; align-items: center;">
                                                        {{ c.sendDate | fromNows }}&nbsp;
                                                        <template v-for="(owner, index) in c.owners">
                                                            <span v-if="index > 0">&nbsp;|&nbsp;</span>
                                                            <span :class="{'border-bottom': (!c.is_merge && owner != c.owners[0])}">{{ owner }}</span>
                                                        </template>
                                                        <span v-if="c.source">&nbsp;({{ c.source }})</span>
                                                    </div>
                                                    <div class="translated_msg" @mouseup="editSamePronunciation(c)">
                                                        <div class="translated_withd_msg">
                                                            <p v-html="(c.srcLang=='zh') ? c.zh2zh : c.zh2en" v-show="roomInfo.transType=='1'"></p>
                                                            <div v-show="roomInfo.transType=='2' || roomInfo.transType=='3'">
                                                                <p v-html="c.zh2zh" :style="speechTextStyle(c, false, true)"></p>
                                                                <p v-html="insertNewline(c.zh2en)" :style="speechTextStyle(c, false, false)"></p>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <i class="fas fa-arrow-circle-down"
                                               v-if="newSubtitleScrollBarIsActive && newSubtitleScrollEvent"
                                               @click="handleNewSubtitleScroll('to_bottom')"
                                               style="position: absolute; bottom: 10px; z-index: 100; right: 19px; font-size: 26px; color: #ffffffbd;"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- 字幕 zh-->
                        <div v-if="saTabDisplay[1] == 'block'" style=" position:relative; ">
                            <div id="text-tool" style="position: absolute;top: 1px;z-index: 100;right: 1px;" :style="{'right': (newSubtitleScrollBarIsActive && !isMobileUI)? '18px' : '1px'}">
                                <button class="btn btn-info"
                                        v-if="!CONFIG.isExternal" 
                                        :class="{'btn-sm': !newSubtitleFullScreen, 'btn-lg': newSubtitleFullScreen}"
                                        :title="`${$t('lan-tab-export-title')}`"
                                        @click="exportScriptMsg('zh','subtitle')"><i class="fa fa-file-excel"></i> {{$t("lan-tab-export-download")}}</button>
                                <button class="btn btn-info btn-sm" 
                                        v-if="!newSubtitleFullScreen" 
                                        @click="fullscreen('newSubtitle');"><i class="fas fa-expand"></i></button>
                                <button class="btn btn-info"
                                        :class="{'btn-sm': !newSubtitleFullScreen, 'btn-lg': newSubtitleFullScreen}" 
                                        v-else 
                                        @click="cancelFullScreen();"><i class="fas fa-compress"></i></button>
                                <button class="btn btn-info"
                                        :class="{'btn-sm': !newSubtitleFullScreen, 'btn-lg': newSubtitleFullScreen}"
                                        v-if="newSubtitleFullScreen"
                                        @click="handleSize('reduce')"><i class="fas fa-search-minus"></i></button> 
                                <button class="btn btn-info"
                                        :class="{'btn-sm': !newSubtitleFullScreen, 'btn-lg': newSubtitleFullScreen}" 
                                        v-if="newSubtitleFullScreen"
                                        @click="handleSize('add')"><i class="fas fa-search-plus"></i></button>
                            </div>
                            <div class="chatContainer list-transcript-height" v-show="isShowChat" v-cloak>
                                <div class="inbox_msg">
                                    <div class="translated_mesgs list-transcript-height w3-display-container" style="display: flex; flex-direction: row; background-color:#292929; flex-wrap: wrap; ">
                                        <div ref="msgHistory_zh" 
                                             class="msg_history list-transcript-inner-height" 
                                             style="width:100%;background-color:#292929;color:white" 
                                             @scroll="handleNewSubtitleScroll('scroll')">
                                            <div v-for="(c, index) in speechs_all" :style="{'margin-top':(index == 0) ? '30px' : '0px'}">
                                                <div class="debug-info" v-if="subtitle_show_debug && c.debugInfo && c.is_merge" style="padding: 3px;">
                                                    <button type="button" v-if="c.is_merge" class="btn btn-success" style="padding: 1px; margin: 1px;">merge</button>
                                                    <button type="button" class="btn btn-outline-light" style="padding: 1px; margin: 1px;">time <span class="badge badge-light">{{ formatNumber(c.debugInfo.audio_duration) }}</span></button>
                                                    <button type="button" class="btn btn-outline-light" style="padding: 1px; margin: 1px;">avg_{{c.detectLang}} <span class="badge badge-light">{{ formatNumber(c.debugInfo.avg_probs) }}</span></button>
                                                    <button type="button" v-if="c.debugInfo.use_detect_result == 'Y'" class="btn btn-outline-secondary" style="padding: 1px; margin: 1px;">avg_{{c.srcLang}} <span class="badge badge-light">{{ formatNumber(c.debugInfo.original_avg_probs) }}</span></button>
                                                    <button type="button" class="btn btn-outline-light" style="padding: 1px; margin: 1px;">sound <span class="badge badge-light">{{ formatNumber(c.debugInfo["sounddb.dBFS"]) }}</span></button>
                                                    <button type="button" class="btn btn-outline-light" style="padding: 1px; margin: 1px;">len <span class="badge badge-light">{{ formatNumber(c.debugInfo.txt_Whisper_length) }}</span></button>
                                                    <button type="button" class="btn btn-outline-light" style="padding: 1px; margin: 1px;" @click="playWav(c.filename, false)">play <span class="badge badge-light"><i class="fas fa-play"></i></span></button>
                                                    <button type="button" class="btn btn-outline-light" style="padding: 1px; margin: 1px;" @click="playWav(c.filename, true)">download <span class="badge badge-light"><i class="fas fa-download"></i></span></button>
                                                </div>
                                                <div class="">
                                                    <div class="translated_msg_username" style="display: flex; align-items: center;">
                                                        {{ c.sendDate | fromNows }}&nbsp;
                                                        <template v-for="(owner, index) in c.owners">
                                                            <span v-if="index > 0">&nbsp;|&nbsp;</span>
                                                            <span :class="{'border-bottom': (!c.is_merge && owner != c.owners[0])}">{{ owner }}</span>
                                                        </template>
                                                        <span v-if="c.source">&nbsp;({{ c.source }})</span>
                                                    </div>
                                                    <div class="translated_msg" @mouseup="editSamePronunciation(c)">
                                                        <div class="translated_withd_msg">
                                                            <p v-html="c.zh2zh" :style="speechTextStyle(c, false, true)"></p>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <i class="fas fa-arrow-circle-down"
                                               v-if="newSubtitleScrollBarIsActive && newSubtitleScrollEvent"
                                               @click="handleNewSubtitleScroll('to_bottom')"
                                               style="position: absolute; bottom: 10px; z-index: 100; right: 19px; font-size: 26px; color: #ffffffbd;"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- 字幕 en-->
                        <div v-if="saTabDisplay[2] == 'block'" style=" position:relative; ">
                            <div id="text-tool" style="position: absolute;top: 1px;z-index: 100;right: 1px;" :style="{'right': (newSubtitleScrollBarIsActive && !isMobileUI)? '18px' : '1px'}">
                                <button class="btn btn-info" 
                                        v-if="!CONFIG.isExternal"
                                        :class="{'btn-sm': !newSubtitleFullScreen, 'btn-lg': newSubtitleFullScreen}"
                                        :title="`${$t('lan-tab-export-title')}`"
                                        @click="exportScriptMsg('en','subtitle')"><i class="fa fa-file-excel"></i> {{$t("lan-tab-export-download")}}</button>
                                <button class="btn btn-info btn-sm" 
                                        v-if="!newSubtitleFullScreen" 
                                        @click="fullscreen('newSubtitle');"><i class="fas fa-expand"></i></button>
                                <button class="btn btn-info"
                                        :class="{'btn-sm': !newSubtitleFullScreen, 'btn-lg': newSubtitleFullScreen}" 
                                        v-else 
                                        @click="cancelFullScreen();"><i class="fas fa-compress"></i></button>
                                <button class="btn btn-info"
                                        :class="{'btn-sm': !newSubtitleFullScreen, 'btn-lg': newSubtitleFullScreen}"
                                        v-if="newSubtitleFullScreen"
                                        @click="handleSize('reduce')"><i class="fas fa-search-minus"></i></button> 
                                <button class="btn btn-info"
                                        :class="{'btn-sm': !newSubtitleFullScreen, 'btn-lg': newSubtitleFullScreen}" 
                                        v-if="newSubtitleFullScreen"
                                        @click="handleSize('add')"><i class="fas fa-search-plus"></i></button>
                            </div>
                            <div class="chatContainer list-transcript-height" v-show="isShowChat" v-cloak>
                                <div class="inbox_msg">
                                    <div class="translated_mesgs list-transcript-height w3-display-container" 
                                         style="display: flex; flex-direction: row; background-color:#292929; flex-wrap: wrap;">
                                        <div ref="msgHistory_en" 
                                             class="msg_history list-transcript-inner-height" 
                                             style="width:100%;background-color:#292929;color:white" 
                                             @scroll="handleNewSubtitleScroll('scroll')">
                                            <div v-for="(c, index) in speechs_all"  :style="{'margin-top':(index == 0) ? '30px' : '0px'}">
                                                <div class="debug-info" v-if="subtitle_show_debug && c.debugInfo && c.is_merge" style="padding: 3px;">
                                                    <button type="button" v-if="c.is_merge" class="btn btn-success" style="padding: 1px; margin: 1px;">merge</button>
                                                    <button type="button" class="btn btn-outline-light" style="padding: 1px; margin: 1px;">time <span class="badge badge-light">{{ formatNumber(c.debugInfo.audio_duration) }}</span></button>
                                                    <button type="button" class="btn btn-outline-light" style="padding: 1px; margin: 1px;">avg_{{c.detectLang}} <span class="badge badge-light">{{ formatNumber(c.debugInfo.avg_probs) }}</span></button>
                                                    <button type="button" v-if="c.debugInfo.use_detect_result == 'Y'" class="btn btn-outline-secondary" style="padding: 1px; margin: 1px;">avg_{{c.srcLang}} <span class="badge badge-light">{{ formatNumber(c.debugInfo.original_avg_probs) }}</span></button>
                                                    <button type="button" class="btn btn-outline-light" style="padding: 1px; margin: 1px;">sound <span class="badge badge-light">{{ formatNumber(c.debugInfo["sounddb.dBFS"]) }}</span></button>
                                                    <button type="button" class="btn btn-outline-light" style="padding: 1px; margin: 1px;">len <span class="badge badge-light">{{ formatNumber(c.debugInfo.txt_Whisper_length) }}</span></button>
                                                    <button type="button" class="btn btn-outline-light" style="padding: 1px; margin: 1px;" @click="playWav(c.filename, false)">play <span class="badge badge-light"><i class="fas fa-play"></i></span></button>
                                                    <button type="button" class="btn btn-outline-light" style="padding: 1px; margin: 1px;" @click="playWav(c.filename, true)">download <span class="badge badge-light"><i class="fas fa-download"></i></span></button>
                                                </div>
                                                <div class="">
                                                    <div class="translated_msg_username" style="display: flex; align-items: center;">
                                                        {{ c.sendDate | fromNows }}&nbsp;
                                                        <template v-for="(owner, index) in c.owners">
                                                            <span v-if="index > 0">&nbsp;|&nbsp;</span>
                                                            <span :class="{'border-bottom': (!c.is_merge && owner != c.owners[0])}">{{ owner }}</span>
                                                        </template>
                                                        <span v-if="c.source">&nbsp;({{ c.source }})</span>
                                                    </div>
                                                    <div class="translated_msg" @mouseup="editSamePronunciation(c)">
                                                        <div class="translated_withd_msg">
                                                            <p v-html="insertNewline(c.zh2en)" :style="speechTextStyle(c, false, false)"></p>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <i class="fas fa-arrow-circle-down"
                                               v-if="newSubtitleScrollBarIsActive && newSubtitleScrollEvent"
                                               @click="handleNewSubtitleScroll('to_bottom')"
                                               style="position: absolute; bottom: 10px; z-index: 100; right: 19px; font-size: 26px; color: #ffffffbd;"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- 逐字稿-->
                        <div v-if="saTabDisplay[3] == 'block'" style=" position:relative; ">
                            <div id="text-tool" style="position: absolute;top: 1px;z-index: 100;right: 1px;" :style="{'right': (newSubtitleScrollBarIsActive && !isMobileUI)? '18px' : '1px'}">
                                <button class="btn btn-info"
                                        v-if="!CONFIG.isExternal" 
                                        :class="{'btn-sm': !newSubtitleFullScreen, 'btn-lg': newSubtitleFullScreen}"
                                        :title="`${$t('lan-tab-export-title')}`"
                                        @click="exportScriptMsg('zh','script')"><i class="fa fa-file-excel"></i> {{$t("lan-tab-export-download")}}</button>
                                <button class="btn btn-info btn-sm" 
                                        v-if="!newSubtitleFullScreen" 
                                        @click="fullscreen('newSubtitle');"><i class="fas fa-expand"></i></button>
                                <button class="btn btn-info"
                                        :class="{'btn-sm': !newSubtitleFullScreen, 'btn-lg': newSubtitleFullScreen}" 
                                        v-else 
                                        @click="cancelFullScreen();"><i class="fas fa-compress"></i></button>
                                <button class="btn btn-info"
                                        :class="{'btn-sm': !newSubtitleFullScreen, 'btn-lg': newSubtitleFullScreen}"
                                        v-if="newSubtitleFullScreen"
                                        @click="handleSize('reduce')"><i class="fas fa-search-minus"></i></button> 
                                <button class="btn btn-info"
                                        :class="{'btn-sm': !newSubtitleFullScreen, 'btn-lg': newSubtitleFullScreen}" 
                                        v-if="newSubtitleFullScreen"
                                        @click="handleSize('add')"><i class="fas fa-search-plus"></i></button>
                            </div>
                            <div class="chatContainer list-transcript-height" v-show="isShowChat" v-cloak>
                                <div class="inbox_msg">
                                    <div class="translated_mesgs list-transcript-height w3-display-container" style="display: flex; flex-direction: row; background-color:#292929; flex-wrap: wrap; ">
                                        <div ref="msgHistory_debug" 
                                             class="msg_history list-transcript-inner-height" 
                                             style="width:100%;background-color:#292929;color:white" 
                                             @scroll="handleNewSubtitleScroll('scroll')">
                                            <div v-for="(c, index) in speechs_all_debug" :style="{'margin-top':(index == 0) ? '30px' : '10px'}">
                                                <div class="debug-info" v-if="subtitle_show_debug && c.debugInfo" style="padding: 3px;">
                                                    <button type="button" v-if="c.is_merge" class="btn btn-success" style="padding: 1px; margin: 1px;">merge</button>
                                                    <button type="button" class="btn btn-outline-light" style="padding: 1px; margin: 1px;">time <span class="badge badge-light">{{ formatNumber(c.debugInfo.audio_duration) }}</span></button>
                                                    <button type="button" class="btn btn-outline-light" style="padding: 1px; margin: 1px;">avg_{{c.detectLang}} <span class="badge badge-light">{{ formatNumber(c.debugInfo.avg_probs) }}</span></button>
                                                    <button type="button" v-if="c.debugInfo.use_detect_result == 'Y'" class="btn btn-outline-secondary" style="padding: 1px; margin: 1px;">avg_{{c.srcLang}} <span class="badge badge-light">{{ formatNumber(c.debugInfo.original_avg_probs) }}</span></button>
                                                    <button type="button" class="btn btn-outline-light" style="padding: 1px; margin: 1px;">sound <span class="badge badge-light">{{ formatNumber(c.debugInfo["sounddb.dBFS"]) }}</span></button>
                                                    <button v-if="false" type="button" class="btn btn-outline-light" style="padding: 1px; margin: 1px;">vad <span class="badge badge-light">{{ formatNumber(c.debugInfo.vad) }}</span></button>
                                                    <button type="button" class="btn btn-outline-light" style="padding: 1px; margin: 1px;">len <span class="badge badge-light">{{ formatNumber(c.debugInfo.txt_Whisper_length) }}</span></button>
                                                    <button type="button" class="btn btn-outline-light" style="padding: 1px; margin: 1px;" @click="playWav(c.filename, false)">play <span class="badge badge-light"><i class="fas fa-play"></i></span></button>
                                                    <button type="button" class="btn btn-outline-light" style="padding: 1px; margin: 1px;" @click="playWav(c.filename, true)">download <span class="badge badge-light"><i class="fas fa-download"></i></span></button>
                                                </div>
                                                <div v-if="!subtitle_show_debug && !c.is_merge">
                                                    <div class="translated_msg_username" style="display: flex; align-items: center;">
                                                        {{ c.userName }}&nbsp;
                                                        <span style="font-size: 11px;border:1px solid; padding-left:1px; padding-right:1px; border-radius: 5px;"
                                                              :style="c.srcLang=='zh' ? 'color:lightblue' : 'color:pink'"
                                                              v-html="(c.srcLang=='zh') ? 'ZH' : 'EN'">
                                                        </span>
                                                        &nbsp;&nbsp;{{ c.sendDate | fromNows }}&nbsp;{{ (c.source) ? ('(' + c.source + ')'):'' }}
                                                    </div>
                                                    <div class="translated_msg">
                                                        <div class="translated_withd_msg">
                                                            <p v-html="c.txt_Whisper" :style="speechTextStyle(c)"></p>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div v-if="subtitle_show_debug">
                                                    <div class="translated_msg_username" style="display: flex; align-items: center;">
                                                        <template v-if="c.is_merge">
                                                            <span v-for="(owner, index) in c.owners"><span v-if="index > 0">&nbsp;|&nbsp;</span>{{ owner }}</span>
                                                        </template>
                                                        <template v-else>
                                                            {{ c.userName }}
                                                        </template>
                                                        &nbsp;
                                                        <span style="font-size: 11px;border:1px solid; padding-left:1px; padding-right:1px; border-radius: 5px;"
                                                              :style="c.srcLang=='zh' ? 'color:lightblue' : 'color:pink'"
                                                              v-html="(c.srcLang=='zh') ? 'ZH' : 'EN'">
                                                        </span>
                                                        &nbsp;&nbsp;{{ c.sendDate | fromNows }}&nbsp;{{ (c.source) ? ('(' + c.source + ')'):'' }}
                                                    </div>
                                                    <div class="translated_msg">
                                                        <div class="translated_withd_msg">
                                                            <p v-html="c.txt_Whisper" :style="speechTextStyle(c)"></p>
                                                            <p v-if="c.before_similar_compare && c.txt_Whisper != c.before_similar_compare" v-html="c.before_similar_compare" style="color: #b7b7b7;" :style="speechTextStyle(c)"></p>
                                                            <p v-if="c.debugInfo && c.debugInfo.use_detect_result == 'Y'" v-html="c.debugInfo.original_text" style="color: #b7b7b7;" :style="speechTextStyle(c)"></p>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <i class="fas fa-arrow-circle-down"
                                               v-if="newSubtitleScrollBarIsActive && newSubtitleScrollEvent"
                                               @click="handleNewSubtitleScroll('to_bottom')"
                                               style="position: absolute; bottom: 10px; z-index: 100; right: 19px; font-size: 26px; color: #ffffffbd;"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Translate:語音翻譯-->
                        <div id="bugle" v-show="roomInfo.transType">
                            <button class="btn dropdown-toggle" type="button" id="dropdownMenuButton_bugle"
                                aria-haspopup="true" aria-expanded="false"
                                v-show="roomInfo.transType =='2' || roomInfo.transType == '3'"
                                :title="`${$t('lan-tab-speech-setting')}`">
                                <i v-if="speech_switch_voice_state" class="fas fa-volume-up"
                                    style="color:rgb(252, 252, 177);font-size:26px;line-height: 30px;text-align: center;width:30px;height:30px;cursor:pointer"
                                    :title='$t("lan-tab-swith-voice-state-off")' @click="setCurrent_speech_lang('sv')"></i>
                                <i v-if="!speech_switch_voice_state" class="fas fa-volume-mute"
                                    style="color:rgb(252, 252, 177);font-size:26px;line-height: 30px;text-align: center;width:30px;height:30px;cursor:pointer"
                                    :title='$t("lan-tab-swith-voice-state-on")' @click="setCurrent_speech_lang('sv')"></i>
                                <!-- SpeechSynthesis 設定:指定Voice-->
                                <i class="fas fa-cog" id="synth_setting" v-show="synth_setting && !newSubtitleFullScreen"
                                    style="color:rgb(252, 252, 177);font-size:26px;line-height: 30px;text-align: center;width:30px;height:30px;cursor:pointer"
                                    data-toggle="modal" data-target="#settingModal_translate"
                                    :title='$t("lan-tab-speech-setting")'></i>
                                <!-- <i class="fas fa-play" style="color:#909090;font-size:26px;line-height: 30px;text-align: center;width:30px;height:30px;cursor:pointer" :style="speech_swith_ose?'color:rgb(252,252,177)':'#909090'" @click="setCurrent_speech_lang('ose')"></i> -->
                            </button>
                            <!-- 發言者語系 設定 -->
                            <span class="lan_speech_setting" id="lan_speech_setting">
                                <span>
                                    <img v-show="!newSubtitleFullScreen" src="./img/minute.png" @click="sendWaitAminute();">
                                    <img src="./img/speaking2.png">
                                    <span
                                        :title="current_speech_lang == 'zh'? $t('lan-speech-listen-zh') : $t('lan-speech-switch-to-listen-zh') "
                                        :class="current_speech_lang == 'zh'?'lan_speech_setting_span_span_selected':'lan_speech_setting_span_span'"
                                        @click="setCurrent_speech_lang('zh')">ZH</span>
                                    <span
                                        :title="current_speech_lang == 'en'? $t('lan-speech-listen-en') : $t('lan-speech-switch-to-listen-en') "
                                        :class="current_speech_lang == 'en'?'lan_speech_setting_span_span_selected':'lan_speech_setting_span_span'"
                                        @click="setCurrent_speech_lang('en')">EN</span>
                                </span>
                            </span>
                        </div>
                        <!-- 及時字幕 -->
                        <div id="real-div-subtitle-full"></div>
                        <!-- Modal: 及時新增同音字 -->
                        <div class="modal fade" id="samePronunciation" tabindex="-1" aria-labelledby="samePronunciationLabel" aria-hidden="true">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="exampleModalLabel">{{ $t("lan-add-same-pronunciation") }}</h5>
                                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                            <span aria-hidden="true">&times;</span>
                                        </button>
                                    </div>
                                    <div class="modal-body" style="font-size: 16px;">
                                        <div class="form-group">
                                            <label>{{ $t("lan-same-pronunciation") }}</label>
                                            <input class="form-control" v-model="fromSamePronunciation">
                                        </div>
                                        <div class="form-group">
                                            <label>{{ $t("lan-same-pronunciation-replace") }}</label>
                                            <input class="form-control" v-model="toSamePronunciation">
                                        </div>
                                        <div class="form-group">
                                            <label>{{ $t("lan-show-same-pronunciation-result") }}</label>
                                            <div v-html="same_pronunciation_edit.show_result" style="background-color: rgb(246 246 246); padding: 10px; border-radius: 5px;"></div>
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-dismiss="modal">{{ $t("lan-same-pronunciation-cancel") }}</button>
                                        <button type="button" class="btn btn-primary" @click="saveSamePronunciation()">{{ $t("lan-same-pronunciation-save") }}</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 交談 -->
                <div :style="{ display: aTabDisplay[1] } " style=" position:relative; ">
                    <div style="position: absolute;top: 0px;z-index: 100;right: 5px;">
                        <!-- <button class="btn btn-info btn-sm" :title="`${$t('lan-hint-tips18')}`" @click="shareImage"><i class="far fa-solid fa-file-image"></i> {{$t("lan-hint-tips18")}}</button> -->
                        <!-- <button class="btn btn-info btn-sm" :title="`${$t('lan-hint-tips17')}`" @click="shareFile"><i class="far fa-thin fa-file"></i> {{$t("lan-hint-tips17")}}</button>                         -->
                        <button class="btn btn-info btn-sm" :title="`${$t('lan-tab-export-title')}`"
                            @click="exportChatMsg"><i class="far fa-file-excel"></i> {{ $t("lan-tab-export") }}</button>
                    </div>
                    <div class="chatContainer list-chat-height" v-show="isShowChat" v-cloak>
                        <div class="inbox_msg">
                            <div class="mesgs list-chat-height w3-display-container" style="  display: flex;
                        flex-direction: row;
                        flex-wrap: wrap; ">
                                <div ref="msgHistory" class="msg_history list-chat-inner-height"
                                    style="width:100%;height: calc(100% - 90px);">
                                    <br>
                                    <template v-if="chatMsgs.length==0">
                                        <div class="msg_alert">
                                            <span>{{ $t("lan-tab-zero") }}</span>
                                        </div>
                                    </template>
                                    <div v-for="(c, index) in chatMsgs">
                                        <template v-if="(c.linkid!=null)"> <!--分享圖片、檔案-->
                                            <h6><small>
                                                    <span v-text="shareDocLogs[c.linkid].showTime"></span>
                                                    <span v-text="shareDocLogs[c.linkid].showContent"></span>
                                                    <i :class="shareDocLogs[c.linkid].iconClass"
                                                        style="max-width: 25px;cursor:pointer;"
                                                        @click="openShareDoc(shareDocLogs[c.linkid].fileKind,shareDocLogs[c.linkid].linkurl,true)"></i>
                                                </small></h6>
                                        </template>
                                        <template v-if="(c.linkid==null) && !c.self">
                                            <div class="incoming_msg">
                                                <div class="msg_username" v-if="isFirtstMsg(c, index)">
                                                    {{c.userName}}
                                                </div>
                                                <div class="received_msg">
                                                    <div class="received_withd_msg">
                                                        <p v-html="c.msg"></p>
                                                    </div>
                                                </div>
                                                <span class="time_date received_time_date">
                                                    {{ c.sendDate | fromNow }}
                                                </span>
                                            </div>
                                        </template>
                                        <template v-if="(c.linkid==null) && c.self">
                                            <div class="outgoing_msg">
                                                <div class="sent_msg">
                                                    <p v-html="c.msg"></p>
                                                </div>
                                                <span class="time_date self_time_date">
                                                    {{ c.sendDate | fromNow }}
                                                </span>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                                <div class="btn-toolbar" role="toolbar" style="position: absolute;bottom: 60px;"
                                    aria-label="Toolbar with button groups">
                                    <!-- <div v-for="emoji in emojilist" class="btn-group" role="group" aria-label="First group">
                                  <button type="button" class="btn" style="    font-size: x-large;
                                  margin: 0px;
                                  padding: 0px;
                                  border: 0px;" @click="userInputMsg = emoji ;clickSendMsg(event,true)">{{emoji}}</button>
                                </div> -->
                                    <div v-for="emoji in emojilist">
                                        <img :src="`img/emoji/${emoji}.png`" :id="`emoji_${emoji}`"
                                            style="width: 30px; height: 30px;margin-right: 2px; padding: 0px; border: 0px; cursor: pointer;"
                                            @click="userInputMsg = emoji; clickSendMsg(event,true)" />
                                    </div>

                                </div>
                                <div class="input-group mb-3 w3-display-bottommiddle"
                                    style="margin-bottom: 0px!important;">
                                    <textarea class="form-control" @keyup.enter="clickSendMsg"
                                        v-model.trim="userInputMsg" :placeholder="`${$t('lan-tab-keyin')}`"
                                        ref="inputMsg"></textarea>
                                    <div class="input-group-append" v-show="false">
                                        <button class="btn btn-outline-secondary dropdown-toggle chatBtnSendTo"
                                            type="button" data-toggle="dropdown" aria-haspopup="true"
                                            aria-expanded="false">
                                            發給<br>所有人
                                        </button>
                                        <div class="dropdown-menu">
                                            <a class="dropdown-item" href="#">所有人</a>
                                            <a v-for="u in onlineUsers" class="dropdown-item" href="#">
                                                {{ u.userName }}
                                            </a>
                                        </div>
                                    </div>
                                    <div class="input-group-append">
                                        <button class="btn btn-info btn-outline-secondary chatBtnSend"
                                            :disabled="!userInputMsg" type="button" @click="clickSendMsg">
                                            <i class="fas fa-paper-plane"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 歷程 -->
                <div :style="{ display: aTabDisplay[2] }">
                    <div ref="divHistory" class="list-history-height" style="display:block;background-color:#fff;">
                        <ul>
                            <li v-for="h in historyLogs">
                                <span v-text="h.showTime"></span>
                                <i :class="h.iconClass" style="max-width: 25px;"></i>
                                <span v-text="h.showContent"></span>
                            </li>
                        </ul>
                    </div>
                </div>

                <!-- 文件分享 -->
                <!-- <div :style="{ display: aTabDisplay[3] }" style="position:relative;">      
                    <div style="position: absolute;top: 0px;z-index: 100;right: 5px;">
                        <button class="btn btn-info" :title="`${$t('lan-hint-tips17')}`" @click="shareFile"><i class="far fa-thin fa-file"></i> {{$t("lan-hint-tips17")}}</button>
                        <button class="btn btn-info" :title="`${$t('lan-hint-tips18')}`" @click="shareImage"><i class="far fa-solid fa-file-image"></i> {{$t("lan-hint-tips18")}}</button>
                    </div>
                    <div ref="divShareHistory" class="list-history-height" style="display:block;background-color:#fff;">
                        <template v-if="shareDocLogs.length==0">
                            <div class="msg_alert">
                                
                            </div>
                        </template>
                        <br><br>
                        <ul>
                            <li v-for="h in shareDocLogs">
                                <span v-text="h.showTime"></span>                                
                                <span v-text="h.showContent"></span>
                                <i :class="h.iconClass" style="max-width: 25px;cursor:pointer;" @click="openShareDoc(h.fileKind,h.linkurl,true)"></i>
                            </li>
                        </ul>
                    </div>
                </div>     -->

                <button id="btnViewImage" ref="btnViewImage" type="button" class="btn btn-primary" style="display:none;"
                    data-toggle="modal" data-target="#ModalViewImage">
                    Click to view modal
                </button>
                <!--Bootstrap modal :顯示分享圖片-->
                <div class="modal fade" id="ModalViewImage" tabindex="-1" role="dialog"
                    aria-labelledby="ModalViewImageLabel" aria-hidden="true">
                    <div class="modal-dialog modal-xl modal-dialog-centered" role="document">
                        <div class="modal-content">
                            <!-- Modal heading -->
                            <div class="modal-header">
                                <h6 class="modal-title" id="ModalViewImageLabel">
                                    {{ shareDocLogs.length==0 ?"": shareDocLogs[0].showContent }}
                                </h6>
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                    <span aria-hidden="true">
                                        ×
                                    </span>
                                </button>
                            </div>
                            <!-- Modal body with image -->
                            <div class="modal-body">
                                <img class="img-fluid"
                                    :src="(shareDocLogs.length==0) ? `` : `${shareDocLogs[0].linkurl}`" />
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Modal: 設定 -->
            <div class="modal fade" id="settingModal" tabindex="-1" role="dialog" aria-labelledby="settingModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-lg modal-dialog-scrollable" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2 id="settingModalLabel">{{ $t("lan-setting") }}</h2>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <h3>{{ $t('lan-general-setting') }}</h3>
                            <div style="background-color: rgb(246 246 246); padding: 10px; border-radius: 5px;">
                                <div>
                                    <span class="h6 lead">{{ $t("lan-laser-color") }} : </span>
                                    <input type="color" @change="getOrSetLaserFillStyle('set')"
                                        v-model="cvsBoard.laserFillStyle">
                                </div>
                                <div>
                                    <h6 class="lead">{{ $t("lan-laser-howto") }} ? </h6>
                                    <p clas="text-monospace">{{ $t("lan-laser-content") }}</p>
                                </div>
                                <div>
                                    <span class="h6 lead">中/English : </span>
                                    <select id='select_lang' class="form-control" style="display:inline;width: auto;"
                                        @change="select_lang_change()" v-model="lanSelected">
                                        <option value='tw'>中文(繁體)</option>
                                        <option value='en'>English(US)</option>
                                    </select>
                                </div>
                            </div>
                            <h3 v-if="roomInfo.transType">{{ $t('lan-subtitle-setting') }}</h3>
                            <div v-if="roomInfo.transType" style="background-color: rgb(246 246 246); padding: 10px; border-radius: 5px;">
                                <div>
                                    <span class="h6 lead">{{ $t('lan-subtitle-glossary-setting') }} : </span>
                                    <input type="radio" id="one" value="Y" v-model="glossary" @change="handleGlossary()" />
                                    <label for="one" style="font-size: 1.2rem;font-weight: 300;">{{ $t('lan-on') }}</label>
                                    <input type="radio" id="two" value="N" v-model="glossary" @change="handleGlossary()" />
                                    <label for="two" style="font-size: 1.2rem;font-weight: 300;">{{ $t('lan-off') }}</label>
                                </div>
                                <template v-if="CONFIG.debugAllowList.includes(currUser.deptId)">
                                    <br>
                                    <div>
                                        <span class="h6 lead">{{ $t('lan-subtitle-debug-info') }} : </span>
                                        <input type="radio" id="debug_one" value="true" v-model="subtitle_show_debug" @change="subtitle_show_debug = true" />
                                        <label for="debug_one" style="font-size: 1.2rem;font-weight: 300;">{{ $t('lan-on') }}</label>
                                        <input type="radio" id="debug_two" value="false" v-model="subtitle_show_debug" @change="subtitle_show_debug = false" />
                                        <label for="debug_two" style="font-size: 1.2rem;font-weight: 300;">{{ $t('lan-off') }}</label>
                                    </div>
                                </template>
                                <br>
                                <div>
                                    <span class="h6 lead">{{ $t('lan-subtitle-auto-change-lang') }} : </span>
                                    <input type="radio" id="change_one" value="true" v-model="subtitle_auto_change_lang" @change="subtitle_auto_change_lang = true" />
                                    <label for="change_one" style="font-size: 1.2rem;font-weight: 300;">{{ $t('lan-on') }}</label>
                                    <input type="radio" id="change_two" value="false" v-model="subtitle_auto_change_lang" @change="subtitle_auto_change_lang = false" />
                                    <label for="change_two" style="font-size: 1.2rem;font-weight: 300;">{{ $t('lan-off') }}</label>
                                </div>
                                <br>
                                <div>
                                    <span class="h6 lead">{{ $t('lan-subtitle-setting-font-size') }}&nbsp;{{ subtitleSetting.fontSize }}&nbsp;px&nbsp;:&nbsp;</span>
                                    <div class="btn-group" role="group" aria-label="Basic example">
                                        <button type="button" class="btn btn-primary" @click="handleSpeechTextSetting('size_increase')">+</button>
                                        <button type="button" class="btn btn-danger" @click="handleSpeechTextSetting('size_decrease')">-</button>
                                    </div>
                                </div>
                                <br>
                                <div>
                                    <span class="h6 lead">{{ $t('lan-cc-setting') }} : </span>
                                    <input type="radio" id="change_cc_open" value="true" v-model="ccActive" @change="ccActive = true" />
                                    <label for="change_cc_open" style="font-size: 1.2rem;font-weight: 300;">{{ $t('lan-on') }}</label>
                                    <input type="radio" id="change_cc_close" value="false" v-model="ccActive" @change="ccActive = false" />
                                    <label for="change_cc_close" style="font-size: 1.2rem;font-weight: 300;">{{ $t('lan-off') }}</label>
                                </div>
                                <br>
                                <div>
                                    <span class="h6 lead">{{ $t('lan-subtitle-setting-background-opacity') }} : </span>
                                    <select class="form-control" style="display:inline;width: auto;" v-model="subtitleSetting.backgroundOpacity" @change="handleSpeechTextSetting('opacity')">
                                        <option value='0.75'>25%</option>
                                        <option value='0.5'>50%</option>
                                        <option value='0.25'>75%</option>
                                    </select>
                                </div>
                                <template v-if="isInitPIPSubtitle">
                                    <br>
                                    <div>
                                        <span class="h6 lead">{{ $t('lan-subtitle-picture-in-picture') }} : </span>
                                        <input type="radio" id="pip_one" value="true" v-model="subtitleSetting.pip" @change="handleSpeechTextSetting('pip')" />
                                        <label for="pip_one" style="font-size: 1.2rem;font-weight: 300;">{{ $t('lan-on') }}</label>
                                        <input type="radio" id="pip_two" value="false" v-model="subtitleSetting.pip" @change="handleSpeechTextSetting('pip')" />
                                        <label for="pip_two" style="font-size: 1.2rem;font-weight: 300;">{{ $t('lan-off') }}</label>
                                    </div>
                                    <br>
                                    <div>
                                        <span class="h6 lead">{{ $t('lan-subtitle-picture-in-picture-open') }} : </span>
                                        <div class="btn-group" role="group" aria-label="Basic example">
                                            <button type="button" class="btn btn-primary" @click="$PIPSubtitle.showPIP()">{{ $t('lan-open') }}</button>
                                        </div>
                                    </div>
                                    <br>
                                    <div>
                                        <span class="h6 lead">{{ $t('lan-streaming-picture-in-picture-open') }} : </span>
                                        <div class="btn-group" role="group" aria-label="Basic example">
                                            <button type="button" class="btn btn-primary" @click="$RealTimeASR.togglePIP()">{{ $t('lan-open') }}</button>
                                        </div>
                                    </div>
                                </template>
                                <!-- <template v-if="roomInfo.transType == '2'">
                                    <br>
                                    <div>
                                        <span class="h6 lead">{{ $t('lan-subtitle-preload-sentence-setting') }} : </span>
                                        <input type="radio" id="pre-one" value="Y" v-model="preloadSentence" @change="handlePreloadSentence()" />
                                        <label for="pre-one" style="font-size: 1.2rem;font-weight: 300;">{{ $t('lan-on') }}</label>
                                        <input type="radio" id="pre-two" value="N" v-model="preloadSentence" @change="handlePreloadSentence()" />
                                        <label for="pre-two" style="font-size: 1.2rem;font-weight: 300;">{{ $t('lan-off') }}</label>
                                    </div>
                                    <br>
                                    <div id="same-sound-div"></div>
                                </template> -->
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Modal: 語音輸出設定 -->
            <div class="modal fade" id="settingModal_translate" tabindex="-1" role="dialog"
                aria-labelledby="settingModalLabel_translate" aria-hidden="true">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-body">
                            <div>
                                <span class="h6">Voice:{{synth_voice.name}}</span>
                                <select id='voices' class="form-control" style="display:inline;width: auto;"
                                    v-model="synth_voice.name">
                                    <option value="">Select A Voice</option>
                                </select>
                            </div>
                            <div>
                                <span class="h6">Rate:(0~3),&nbsp;{{synth_voice.rate}}</span>
                                <input name="rate" class="form-control" type="range" min="0" max="3" value="1"
                                    step="0.1" style="appearance: auto;background-color:unset;"
                                    v-model="synth_voice.rate">
                            </div>
                            <div>
                                <span class="h6">Pitch:(0~2),&nbsp;{{synth_voice.pitch}}</span>
                                <input name="pitch" class="form-control" type="range" min="0" max="2" step="0.1"
                                    style="appearance: auto;background-color:unset;" v-model="synth_voice.pitch">
                            </div>
                        </div>
                        <div class="modal-header"></div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div id="subtitle" ref="subtitle" v-show="roomInfo.transType && roomInfo.transType != '1'" class="containers video-width video-height" :style="showSpeechStyle()">
            <!-- 下方文字 -->
            <div class="container" v-if="show_speech_text.isShow && ccActive && !isFullScreen" style="max-width: 80%; padding: 0px;">
                <div style="width: fit-content; padding: 3px; color: white; cursor: pointer;" :style="showSpeechBackground" @click="changeSpeechPosition()">
                    <span :style="speechTextStyle(show_speech_text, true, true)" v-html="showSubtitle"></span>
                </div>  
            </div>
            <div class="container" v-else style="max-width: 80%; padding: 0px;">
                <div style="padding: 3px;">
                    <span :style="speechTextStyle('&nbsp;', true, true)">&nbsp;</span>
                </div>  
            </div>
            <div class="container" v-if="show_speech_text.isShow && ccActive && !isFullScreen" style="max-width: 80%; padding: 0px;" v-show="currTransTab == 'msgHistory_all' || currTransTab == 'msgHistory_debug'" >
                <div style="width: fit-content; padding: 3px; color: white; cursor: pointer; margin-top: 5px;" :style="showSpeechBackground" @click="changeSpeechPosition()">
                    <span :style="speechTextStyle(show_speech_text, true, false)" v-html="showSubtitleTrans"></span>
                </div>  
            </div>
            <div class="container" v-else style="max-width: 80%; padding: 0px;">
                <div style="padding: 3px;">
                    <span :style="speechTextStyle('&nbsp;', true, true)">&nbsp;</span>
                </div>  
            </div>
            <div id="subtitleCanvasBlock" v-show="false">
                <canvas id="subtitleCanvas" width="500" height="300"></canvas>
                <video id="subtitleVideo" autoplay playsinline width="0" height="0"></video>
            </div>
            <div v-show="false">
                <canvas id="streamCanvas" width="640" height="100"></canvas>
                <video id="streamVideo" muted loop></video>
            </div>
        </div>
        <!-- Navigator Bar(for mobile) -s.-add.2021/10/21 -->
        <nav id="nav" v-show="isMobileUI" class="navbar fixed-bottom border-top border-secondary"
            style="background-color:rgb(236, 233, 233);">
            <!--收音中/靜音-->
            <a class="navbar-brand text-primary" href="#" style="text-align:center;"
                :style="isHolo?'font-size:30px;':''" @click.prevent="handleMic('updateMic')">
                <i v-show="!isAskMic" :title="currUser.isMute ? `${$t('lan-tab-mute')}` : `${$t('lan-tab-unmute')}`"
                    class="fas"
                    :class="{'fa-microphone-slash': currUser.isMute, 'fa-microphone': !currUser.isMute }"></i><br>
                {{ isAskMic ? ' ' : currUser.isMute? $t("lan-tab-mute") : $t("lan-tab-unmute") }}
            </a>
            <!--我要發言/取消發言-->
            <a class="navbar-brand text-primary" href="#" style="text-align:center;"
                :style="isHolo?'font-size:30px;':''"
                @click.prevent="isAskMic ? handleMic('updateMic') : handleMic('releaseMic')">
                <i :title="isAskMic ? `${$t('lan-tab-speak')}` : `${$t('lan-tab-unspeak')}`"
                    :class="{'fas fa-microphone-slash': isAskMic, 'far fa-times-circle': !isAskMic }"></i><br>
                {{ isAskMic? $t("lan-tab-speak") : $t("lan-tab-unspeak") }}</a>
            <!--視訊直播-->
            <!-- <a v-show="(isHolo && !(isShareVideoLocalKMS || isShareVideoLocalWebCam))" class="navbar-brand text-primary" href="#" 
               style="text-align:center;"  :style="isHolo?'font-size:30px;':''"  
               @click.prevent="handleMicHD('updateMicHD')"> 
                <i :title="`${$t('lan-live-webcam')}`" class="fas fa-video"></i><br>  
                {{ $t("lan-live-webcam") }}
            </a>                            
            -->
            <!--桌面直播-->
            <a v-show="(isHolo && !(isShareVideoLocalKMS || isShareVideoLocalWebCam))" class="navbar-brand text-primary"
                href="#" style="text-align:center;" :style="isHolo?'font-size:30px;':''"
                @click.prevent="beforeKmsShareClick(event,false)">
                <i :title="`${$t('lan-live-desktop')}`" class="fas fa-tv"></i><br>
                {{ $t("lan-live-desktop") }}
            </a>
            <!--桌面直播(MIS for Unity)-->
            <a v-show="(isHolo && _CONFIG_RTCSDDeptId.includes(currUser.deptId) &&!(isShareVideoLocalKMS || isShareVideoLocalWebCam))"
                class="navbar-brand text-primary" href="#" style="text-align:center;"
                :style="isHolo?'font-size:30px;':''" @click.prevent="beforeKmsShareClick(event,false,true)">
                <i :title="`${$t('lan-live-desktop')}`" class="fas fa-tv"></i><br>
                {{ $t("lan-live-desktop") }} Unity
            </a>
            <!--圖片直播-->
            <!-- <a v-show="(isHolo && (!isShareVideo && !isShareVideoLocalImage))" class="navbar-brand text-primary" href="#" 
               style="text-align:center;" :style="isHolo?'font-size:30px;':''"   @click.prevent="LiveImage()">
                <i :title="`${$t('lan-live-image')}`" class="far fa-solid fa-file-image"></i><br>  
                {{ $t("lan-live-image") }} 
            </a>                        -->
            <!--停止直播-->
            <a v-show="(isHolo && isShareVideo && ( (isShareVideoLocalKMS || isShareVideoLocalWebCam) && !isShareVideoLocalKMSWebCam ) && !isWhiteboard)"
                class="navbar-brand text-primary" href="#" style="text-align:center;"
                :style="isHolo?'font-size:30px;':''" @click.prevent="kmsStopClick">
                <i :title="isShareVideoLocalWebCam ? `${$t('lan-live-webcam-stop')}` : `${$t('lan-live-desktop-stop')}`"
                    class="fas fa-stop"></i><br>
                {{(isShareVideoLocalWebCam) ? $t('lan-live-webcam-stop') : $t('lan-live-desktop-stop')}}
            </a>
            <!--DebugInfo-->
            <a v-if="(isHolo && headerBar.showDebugButton)" class="navbar-brand text-primary" href="#"
                style="text-align:center;" :style="isHolo?'font-size:30px;':''" @click.prevent="showDebug()">
                <i :title="`${$t('lan-hint-tips2-s')}`" class="fas fa-pen-alt"></i><br>
                {{ $t("lan-hint-tips2-s") }}
            </a>
            <!--重連-->
            <a v-show="isHolo" class="navbar-brand text-primary" href="#" style="text-align:center;"
                :style="isHolo?'font-size:30px;':''" @click.prevent="clickReconnect">
                <i class="fas fa-redo"></i><br>
                {{ $t("lan-header-reenter") }}</a>
            <!--離開-->
            <a class="navbar-brand text-primary" href="#" style="text-align:center;"
                :style="isHolo?'font-size:30px;':''" @click.prevent="clickExitRoom">
                <i class="fas fa-sign-out-alt"></i><br>
                {{ $t("lan-header-exit") }}</a>
            <!--更多-->
            <a v-show="(!isHolo)" class="navbar-brand text-primary" href="#" style="text-align:center;"
                :style="isHolo?'font-size:30px;':''" data-toggle="collapse" data-target="#nav_more"
                aria-controls="nav_more" aria-expanded="false" aria-label="Toggle navigation">
                <i class="fas fa-bars"></i><br>
                {{ $t("lan-nav-more") }}</a>
        </nav>
        <!-- Navigator Bar:More -->
        <div class="collapse navbar-collapse" id="nav_more"
            style="position:absolute;width:40%;height:60px;right:2px;z-index:9999;">
            <ul class="navbar-nav">
                <li class="nav-item border border-primary rounded text-primary"
                    style="background-color:rgb(236, 233, 233);">
                    <a class="nav-link" href="#" @click.prevent="clickReconnect">
                        <i class="fas fa-redo" style="padding-left:10px;padding-right:10px;"></i>{{
                        $t("lan-header-reenter") }}
                    </a>
                </li>
                <!--線上人員-->
                <li class="nav-item border border-primary rounded text-primary"
                    style="background-color:rgb(236, 233, 233);">
                    <a class="nav-link" href="#" @click.prevent="showList_Mobile()">
                        <i class="fas fa-users" style="padding-left:10px;padding-right:10px;"></i>{{ $t("lan-tab-list")
                        }}
                    </a>
                </li>
                <!--交談-->
                <li class="nav-item border border-primary rounded text-primary"
                    style="background-color:rgb(236, 233, 233);">
                    <a class="nav-link" href="#" @click.prevent="showChat_Mobile()">
                        <i class="far fa-comment" style="padding-left:10px;padding-right:10px;"></i>{{
                        $t("lan-tab-talk") }}
                    </a>
                </li>
                <!--設定-->
                <li class="nav-item border border-primary rounded text-primary"
                    style="background-color:rgb(236, 233, 233);">
                    <a class="nav-link" href="#" data-toggle="modal" data-target="#settingModal">
                        <i class="fas fa-pen-alt" style="padding-left:10px;padding-right:10px;"></i>{{
                        $t("lan-header-setting") }}
                    </a>
                </li>
                <!--Debug info-->
                <!--<li class="nav-item border border-primary rounded text-primary" style="background-color:rgb(236, 233, 233);">
                <a class="nav-link" href="#" @click.prevent="showDebug()">
                    <i class="fa fa-info-circle" style="padding-left:10px;padding-right:10px;"></i>{{ $t("lan-hint-tips2-s") }}
                </a>
                </li>         
                -->
                <!--視訊直播-->
                <!--<li class="nav-item border border-info rounded">
                    <a class="nav-link" href="#"  @click.prevent="handleMicHD('updateMicHD')">
                        <i class="fas fa-video" style="padding-left:10px;padding-right:10px;"></i>{{ $t('lan-live-webcam') }}
                    </a>
                </li>                  
                -->
                <!--雙鏡頭直播-->
                <!-- <li class="nav-item border border-primary rounded text-primary" style="background-color:rgb(236, 233, 233);">
                    <a class="nav-link" href="#" @click.prevent="handleMicHD('updateMicHD2')">
                        <i class="fas fa-vr-cardboard" style="padding-left:10px;padding-right:10px;"></i>{{ $t('lan-live-twolens') }}
                    </a>
                </li>
                -->
                <li class="nav-item border-primary border  rounded text-primary"
                    style="background-color:rgb(236, 233, 233);">
                    <a class="nav-link" href="#">
                        <i class="fas fa-eject" style="padding-left:10px;padding-right:10px;"></i>{{ $t("lan-nav-exit")
                        }}
                    </a>
                </li>
            </ul>
        </div>
        <!-- Navigator Bar(for mobile) -e. -->
        <!-- Mobile:交談/emoji 10/28 -->
        <div id="div_mobile" v-show="isMobileUI" style="position:absolute;width: 100vw;">
            <!--Mobile 彈幕(由下往上,emoji在右,文字在左)-->
            <canvas id="mobileCanvas" class="video-width" v-if="isMobileUI" :style="`${!isFullScreen?'max-height: 400px;':fullscreenStyle.videoStyle};                            
                            ${iseBoardClicked ? 'z-index:999;' : 'z-index:500;'};
                            height: 300px;
                            ${isShowList?'':'width: 100vw;'}`">
            </canvas>
            <!--emoji-->
            <div v-if="(!isHolo)" class="btn-toolbar" role="toolbar" aria-label="Toolbar with button groups"
                style="height:auto;">
                <div v-for="emoji in emojilist">
                    <img :src="`img/emoji/${emoji}.png`" :id="`emoji_${emoji}`"
                        style="margin-right: 2px; padding: 0px; border: 0px; cursor: pointer;"
                        @click="userInputMsg = emoji; clickSendMsg(event,true)" />
                </div>
            </div>
            <!--交談input box-->
            <div v-if="(!isHolo)" class="input-group mb-3 w3-display-bottommiddle"
                style="margin-bottom: 0px!important;position:relative;">
                <textarea id="textarea_mobile_chat" class="form-control" @keyup.enter="clickSendMsg"
                    v-model.trim="userInputMsg" :placeholder="`${$t('lan-tab-keyin')}`" ref="inputMsg"></textarea>
                <div class="input-group-append">
                    <button class="btn btn-info btn-outline-secondary chatBtnSend" :disabled="!userInputMsg"
                        type="button" @click="clickSendMsg">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>

        <script src="js/static/es6-promise.auto.min.js"></script>

        <!-- <script src="js/adapter.js"></script> -->
        <script src="js/static/DetectRTC.js"></script>
        <!-- <link rel="stylesheet" href="css/getHTMLMediaElement.css"> -->
        <!-- <script src="js/getHTMLMediaElement.js"></script> -->

        <!-- custom layout for HTML5 audio/video elements -->
        <script>
            console.log('%c%s', 'background: #FF0000; color: #FFFFFF', '請勿嘗試駭客手段,發現立即封鎖.');
            console.log('%c%s', 'background: #FF0000; color: #FFFFFF', 'Do NOT try to hack this site,your IP will be blocked immediately.');
            function iPhoneDetection() { //2021/11/16 add iPad as videoConference.js
                return (/iPhone|iPad|iPod/i.test(window.navigator.userAgent) || /Macintosh/.test(navigator.userAgent) && 'ontouchend' in document);
            }
            (function () {
                function SafariDetection() {
                    return /^((?!chrome|android).)*safari/i.test(window.navigator.userAgent);
                }
                function ChromeDetection() {//iPhone上的偵測方法
                    return /CriOS/i.test(window.navigator.userAgent);
                }
                function IEdetection() {
                    var ua = window.navigator.userAgent;
                    var msie = ua.indexOf('MSIE ');
                    if (msie > 0) {
                        // IE 10 or older, return version number 
                        //return ('IE ' + parseInt(ua.substring(msie + 5, ua.indexOf('.', msie)), 10)); 
                        return true;
                    }
                    var trident = ua.indexOf('Trident/');
                    if (trident > 0) {
                        // IE 11, return version number 
                        var rv = ua.indexOf('rv:');
                        //return ('IE ' + parseInt(ua.substring(rv + 3, ua.indexOf('.', rv)), 10)); 
                        return true;
                    }
                    var edge = ua.indexOf('Edge/');
                    if (edge > 0) {
                        //Edge (IE 12+), return version number 
                        //return ('IE ' + parseInt(ua.substring(edge + 5, ua.indexOf('.', edge)), 10)); 
                        return true;
                    }
                    // User uses other browser 
                    return false;
                }

                //非iPhone提示使用者用Chrome
                //if(!iPhoneDetection() && (IEdetection() || SafariDetection())) {
                if (IEdetection()) {
                    // window.location.replace("./use-chrome.html?u=" + window.location.href);
                    document.write("本網頁不支援IE瀏覽器，建議使用Chrome、Firefox、Edge等瀏覽器");
                }
                //iPhone提示使用者用Safari
                if (iPhoneDetection() && ChromeDetection()) {
                    window.location.replace("./use-safari.html?u=" + window.location.href);
                }

                var params = {},
                    r = /([^&=]+)=?([^&]*)/g;
                function d(s) {
                    return decodeURIComponent(s.replace(/\+/g, ' '));
                }

                // while (match = r.exec(search.substring(1)))
                //     params[d(match[1])] = match[2];

                if (window.location.href.indexOf(`?param=`) != -1) {
                    var paramsTemp = {};
                    var matchTemp;
                    var searchTemp = window.location.search;
                    while (matchTemp = r.exec(searchTemp.substring(1)))
                        paramsTemp[d(matchTemp[1])] = matchTemp[2];

                    var match, search;
                    try {
                        search = decrypt(paramsTemp["param"], moment().format("YYYYMMDD"));
                        if (!search) { window.location.replace("./logout.html?r=10"); }
                        //if (window.location.host != 'm.powerchip.com' && window.location.host != 'phqeteams03') 
                        if (!isPROD())
                            console.log("debug :", search);

                    } catch (ex) {
                        var paramsTemp = {};
                        var matchTemp;
                        var searchTemp = window.location.search;
                        while (matchTemp = r.exec(searchTemp.substring(1)))
                            paramsTemp[d(matchTemp[1])] = matchTemp[2];

                        var match, search;
                        try {
                            search = decrypt(paramsTemp["param"], moment().format("YYYYMMDD"));
                            //if (window.location.host != 'm.powerchip.com' && window.location.host != 'phqeteams03') 
                            if (!isPROD())
                                console.log("debug :", search);
                        } catch (ex) {
                            console.log(ex);
                            window.location.replace("./logout.html?r=10");
                        }

                        search = search.replace(/['"]+/g, '');
                        while (match = r.exec(search.substring(1)))
                            params[d(match[1])] = match[2];

                        window.params = params;
                        //console.log( window.params );
                    }

                    search = search.replace(/['"]+/g, '');
                    while (match = r.exec(search.substring(1)))
                        params[d(match[1])] = match[2];

                    window.params = params;
                    //console.log( window.params );
                }
                else if (window.location.href.indexOf(`?params=`) != -1) {
                    var paramsTemp = {};
                    var matchTemp;
                    var searchTemp = window.location.search;
                    while (matchTemp = r.exec(searchTemp.substring(1)))
                        paramsTemp[d(matchTemp[1])] = matchTemp[2];

                    var match, search;
                    try {
                        search = decryptRoomParam(paramsTemp["params"]);

                        if (!search) { window.location.replace("./logout.html?r=10"); }
                        //if (window.location.host != 'm.powerchip.com' && window.location.host != 'phqeteams03') 
                        if (!isPROD())
                            console.log("params debug :", search);

                    } catch (ex) {
                        var paramsTemp = {};
                        var matchTemp;
                        var searchTemp = window.location.search;
                        while (matchTemp = r.exec(searchTemp.substring(1)))
                            paramsTemp[d(matchTemp[1])] = matchTemp[2];

                        var match, search;
                        try {
                            search = decryptRoomParam(paramsTemp["params"]);
                            //if (window.location.host != 'm.powerchip.com' && window.location.host != 'phqeteams03') 
                            if (!isPROD())
                                console.log("params debug :", search);
                        } catch (ex) {
                            console.log(ex);
                            window.location.replace("./logout.html?r=10");
                        }

                        search = search.replace(/['"]+/g, '');
                        while (match = r.exec(search.substring(1)))
                            params[d(match[1])] = match[2];

                        window.params = params;
                    }

                    search = search.replace(/['"]+/g, '');
                    while (match = r.exec(search.substring(1)))
                        params[d(match[1])] = match[2];

                    window.params = params;
                }
                else {
                    var match, search = window.location.search;
                    while (match = r.exec(search.substring(1))) {
                        if (match[1] == 'ticket')
                            params[d(match[1])] = match[2];
                        else
                            params[d(match[1])] = d(match[2]);
                    }
                    window.params = params;
                }
                window.params.isWorkFromHome = getUserAgentWorkFromHome();
                // if( window.params.isWorkFromHome)
                // {
                //     window.params.sourcetype="portalthinclient";
                // }

                window.params.isLiveBroadcast = false;
            })();
            $.blockUI({
                // message: "<i  style='color:orange' class='fa fa-spinner fa-pulse fa-7x'></i>", 
                message: "<div class='loader-wrapper'><div class='loader'><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div>",
                css: { borderWidth: '0px', backgroundColor: 'transparent' },
            });

            //DetectRTC.load(); //detect deviceInfo
            setTimeout($.unblockUI(), 15000);

            document.title = `視訊會議 ${APP_Ver}`;

            // let localDesktopStream;
            // let localDesktopStreamAudio;
            // let displayStreamid;
            let StreamArray = [];

            let videosContainer = document.getElementById("videos-container")
            let divShareMyScreen = document.getElementById("divShareMyScreen");
            let divShareMyScreening = document.getElementById("divShareMyScreening");
            let divWebRtcShare = document.getElementById("divwebrtcShare");
            let divKMSShare = document.getElementById("divkmsShare");

            let divWebRtcScreening = document.getElementById("divWebRtcScreening");
            let divKMSScreening = document.getElementById("divKMSScreening");
            let stopSharing = document.getElementById("stopSharing");
            let logTopic = (window.params.topic) ? window.params.topic : ""; //add 2020/05/05            
            let idleInterval; //user mousemove,mouseclick 即記錄當下時間，for check超過30分鐘未動作提示登出使用
            let isIdleNotify = false;

            /* for 語音轉字幕翻譯 2023/12/13 by vic start*/
            let mediaRecorder;
            let audioChunks = [];
            let audioContext;
            let analyser;
            var vcount = 0;
            var lcount = 0;
            var isSpeaking = false;
            var isMute = true;
            var hasInit = false;
            let synth = window.speechSynthesis;
            let voices = [];
            let myVolume;
            let voices_default = [{ lang: "zh-TW", voice_lang: "zh-TW", voice_name: "Microsoft Yating - Chinese (Traditional, Taiwan)", voice_lang_Edge: "zh-TW", voice_name_Edge: "Microsoft Yating - Chinese (Traditional, Taiwan)" },
            { lang: "en-US", voice_lang: "en-US", voice_name: "", voice_lang_Edge: "en-US", voice_name_Edge: "Guy" },
            { lang: "ja-JP", voice_lang: "ja-JP", voice_name: "", voice_lang_Edge: "ja-JP", voice_name_Edge: "" }];

            let timeoutID = undefined;
            let MediaRecorderInterval = 6; //每隔多少秒至少要送一次audioblobdata給翻譯主機
            let callARGServiceTime = new Date();
            setInterval(function () {
                let currTime = new Date();
                let cs1 = currTime.getTime();
                let cs2 = callARGServiceTime.getTime();
                let totalsecond = (cs1 - cs2) / 1000;
                if (totalsecond >= MediaRecorderInterval) {
                    if (mediaRecorder && mediaRecorder.state == "recording"  && !$VM.currUser.isMute) {
                        mediaRecorder.stop();
                        mediaRecorder.start(50);
                        // speechEvents.setInterval(20);
                    }
                }
            }, MediaRecorderInterval * 1000);

            function removeDuplicateSentences(text1, text2) {
                // 將兩個字串變數合併成一個字串。
                var combinedText = text1 + "\n" + text2;

                // 使用正則表示法匹配重複的句子。
                const regex = /^(?:[^.]+\n)*((?:[^.]+\n)*)(?:\1)+/gm;
                const duplicateSentences = combinedText.matchAll(regex);

                // 從合併的字串中刪除重複的句子。
                for (const sentence of duplicateSentences) {
                    combinedText = combinedText.replace(sentence[0], "");
                }

                return combinedText;
            }
            // let isWhiteboardEnable = false;
            let $VM;
            document.addEventListener('mousemove', function () {
                if ($VM && $VM.mqttClient && $VM.mqttClient.storeSend.filter(x => x.topic.indexOf("/mute") > -1).length > 0) {
                    $VM.checkMuteStatus(false);
                }
                if (idleInterval) clearInterval(idleInterval);
                try {
                    let selfSpeak = $VM.onlineSpeakers.filter(u => u.userId == $VM.currUser.userId).length == 0 ? false : true;
                    if ($VM && ($VM.isShareVideoLocalKMSWebCam ||
                        $VM.isShareVideoLocalWebRTC ||
                        $VM.isShareVideoLocalKMS ||
                        $VM.isShareVideoLocalWebCam ||
                        selfSpeak ||
                        $VM.videoInfo.isKMS)) {
                        //有在做直播或分享的話就不設 Interval
                    }
                    else {
                        if (!isIdleNotify) {
                            idleInterval = setInterval(() => {
                                let selfSpeak = $VM.onlineSpeakers.filter(u => u.userId == $VM.currUser.userId).length == 0 ? false : true;
                                if ($VM && ($VM.isShareVideoLocalKMSWebCam ||
                                    $VM.isShareVideoLocalWebRTC ||
                                    $VM.isShareVideoLocalKMS ||
                                    $VM.isShareVideoLocalWebCam ||
                                    selfSpeak ||
                                    $VM.videoInfo.isKMS)) {
                                    //有在做直播或分享的話就不設 Interval
                                }
                                else {
                                    console.log(new Date());
                                    $VM.idleNotify();
                                }
                            }, (1000 * 60 * 30));
                        }
                    }
                } catch (e) { }
            });
            // document.addEventListener('click',function(){                
            //     if(idleInterval) clearInterval(idleInterval);
            //     idleInterval = setInterval(() => {
            //         console.log(new Date());
            //         $VM.idleNotify();
            //     }, (1000*5));
            // });


            //視窗放到最大
            window.resizeTo(screen.width, screen.height);

            function send(data, delay = false) {
                //var chatMessage = document.getElementById("txtmessage").value;
                // var chatMessage = data;
                // var checkmark_id = connection.userid + connection.token();
                // var checkmark_id = connection.userid ;

                // var event=data.split('#')[0];
                // if(event =='onlineStatus' || event =='onlineStatus'){
                //     console.log('mqtt send onlineStatus change:'+data);
                //     $VM.mqttClient.sendMessage(data);

                // } else {
                //     connection.send({
                //         chatMessage: chatMessage,
                //         checkmark_id: checkmark_id
                //     });
                // }

                // 圖片直播時的eB->eBI,避免影響HoloUnity
                var event = data.split('#')[0];
                if (($VM.isShareVideoImage || $VM.isShareVideoLocalImage) && event == 'eB') {
                    var nData = data.replace(/eB#/, "eBI#");
                    data = nData;
                }
                if (delay) {
                    setTimeout(() => {
                        $VM.mqttClient.sendMessage(data);
                    }, 500);
                }
                else
                    $VM.mqttClient.sendMessage(data);

            }
            function isPROD() {
                if (window.location.host == 'm.powerchip.com' || window.location.host == 'phqeteams03'
                    || window.location.host == 'phqeteams03.twn.psc')
                    return true;
                else
                    return false;
            }
            var connection = {
                userid: window.params.empid,
                kms: { kmsId: '', kmsUserid: '' }
            };

            var SecretDetectInterval; //for secret
            var receivet2

        </script>
        <!-- Modal:邀請與會者 -->
        <div id="empModal" class="modalv" v-show="isSelectEmpShow" style="display: block;">
            <!-- Modal content -->
            <div class="modal-contentv">
                <div class="modal-headerv">
                    <span class="closeModal modal-close-btn" @click="isSelectEmpShow = false; ajaxEmployeeLoading = true;">
                        <i class="fas fa-times"></i>
                    </span>
                    <h2 style="color:rgb(34, 34, 34)">{{ $t("lan-invite-h2") }}</h2>
                </div>
                <div v-show="ajaxEmployeeLoading" style="display: flex; justify-content: center; align-items: center; height:300px;">
                    <div class="loader-inner line-spin-fade-loader"></div>
                </div>
                <div v-show="!ajaxEmployeeLoading" class="modal-bodyv">
                    <!-- 邀請人員CCC -->
                    <div id="ajax-employee">
                        <ul class="tagify-me-ul" id="tags"></ul>
                        <input id="selectEmployees" name="selectEmployees" onclick="this.select()" :placeholder="`${$t('lan-invite-search')}`" size="30">
                        <button id="addInviteEmail" class="sendInvite btn btn-info" v-show="isAddInviteEmailShow" style="margin:5px;" @click="addInviteEmail">{{ $t("invite-add-external") }}</button>
                    </div>
                    <div style=" display: flex; align-items: center;justify-content: center;">
                        <button id="sendInvite" class="sendInvite btn btn-danger" style="margin:5px;"
                            @click="sendInvite">{{ $t("lan-invite-submit") }}</button>
                        <button id="clearInvite" class="clearInvite btn btn-danger" style="margin:5px;"
                            @click="sendClear">{{ $t("lan-invite-clear") }}</button>
                        <button class="closeModal btn btn-danger" style="margin:5px;" @click="isSelectEmpShow = false; ajaxEmployeeLoading = true;">{{
                            $t("lan-invite-cancel") }}</button>
                    </div>
                </div>
                <div v-show="!ajaxEmployeeLoading" class="modal-footerv">
                    <h5><b>{{ $t("lan-invite-h5") }}</b></h5>
                    <div id="ajax-employee-recently"></div>
                </div>
            </div>
        </div>
        <!-- Modal:Debug Info  -->
        <div v-if="debugInfo.isShowDebug" id="debugModal" style="display: block" class="modalv">
            <div class="modal-contentv">
                <div class="modal-headerv">
                    <span class="closeModal modal-close-btn" @click="debugInfo.isShowDebug = false">
                        <i class="fas fa-times"></i>
                    </span>
                    <h2 style="color:hsl(0, 0%, 13%)">Debug Info</h2>
                    <div class="tab" id="debugTab" style='display:block;width:auto;'>
                        <button class="tablinks" @click="debugInfo.showDebugTab='debug';showDebug()">Debug Info</button>
                        <button class="tablinks" @click="debugInfo.showDebugTab='detail';showDebug()">Video
                            Detail</button>
                        <button class="tablinks" @click="debugInfo.showDebugTab='device';showDebug()">Device
                            Info</button>
                        <!-- <button class="tablinks" @click="debugInfo.showDebugTab='note';showDebug()">說明</button>-->
                        <button class="tablinks" @click="debugInfo.showDebugTab='detect';showDebug()">Detect</button>
                        <button v-if="(!isPROD && _CONFIG_RTCSDMember.includes(currUser.empId))" class="tablinks"
                            @click="debugInfo.showDebugTab='simulate';showDebug()">Simulate</button>
                        <button
                            v-if="(!isPROD && _CONFIG_RTCSDDeptId.includes(currUser.deptId) && currUser.sourceType=='pc')"
                            class="tablinks"
                            @click="debugInfo.showDebugTab='resolution';showDebug()">桌面直播Resolution</button>
                        <!-- <button class="tablinks" @click="debugInfo.showDebugTab='config';showDebug()">設定</button>  -->
                    </div>
                </div>
                <div class="modal-bodyv">

                    <div v-if="debugInfo.showDebugTab=='debug'" class="debuginfo" v-text="debugInfo.debugtext">
                    </div>
                    <div v-if="debugInfo.showDebugTab=='detail'" class="debuginfo">
                        <debug-component :info="debugInfo"></debug-component>
                    </div>
                    <div v-if="debugInfo.showDebugTab=='device'" class="debuginfo" v-text="debugInfo.debugtext">

                    </div>
                    <div v-if="debugInfo.showDebugTab=='note'" class="debuginfo" style="background-color:white;">
                        <div style="padding: 10px;">

                            <span class="divTopic" style="background: bisque;">RTCIceConnectionState</span>
                            <div
                                v-for="(item, index) in ['null','new','checking','connected','completed','failed','disconnected','closed','datachannelClosed']">
                                <div style="padding: 5px; ">
                                    <div :class="item"></div><span>{{item}}</span>
                                </div>
                            </div>
                            <span class="divTopic" style="background: bisque;">RTCPeerConnectionState</span>
                            <div
                                v-for="(item, index) in ['null','new','connecting','connected','failed','disconnected','closed']">
                                <div style="padding: 5px; ">
                                    <div :class="item"></div><span>{{item}}</span>
                                </div>
                            </div>
                            <span class="divTopic" style="background: bisque;">RTCDataChannelState</span>
                            <div v-for="(item, index) in ['connecting','open','closing','closed']">
                                <div style="padding: 5px; ">
                                    <div :class="item=='open' ? 'connected': 'datachannelClosed' "></div>
                                    <span>{{item}}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div v-if="debugInfo.showDebugTab=='detect'" class="debuginfo" style="background-color:white;">
                        <div style="padding: 10px;">

                            <label>授權偵測 麥克風 攝影機:</label>
                            <button type="button" @click="checkDeive(event)" class="fas fa-exchange-alt btn-primary"
                                style="cursor: pointer;">
                            </button> <br />
                            <label>Mic:{{currUser.isAllowMicphone ? 'OK' : currUser.isAllowMicphone }} </label> <br />
                            <label>WebCam (hasCam:{{ DetectRTC.hasWebcam}}) :{{currUser.isAllowWebCam ? 'OK' :
                                currUser.isAllowWebCam}}</label>
                            <label>SmartPanel: {{isSmartPanelOn ? 'OK' : isSmartPanelOn}}</label>
                        </div>
                    </div>
                    <!--simulate--s.-->
                    <div v-if="debugInfo.showDebugTab=='simulate'" class="debuginfo" style="background-color:white;">
                        <div style="width:50%;padding: 10px;">
                            <div class="md-form form-group mb-3 w-50">
                                <label>▼empid</label>
                                <input type="text" id="simulate_empid" class="form-control" placeholder="empid"
                                    :value="currUser.empId">
                            </div>
                            <div class="md-form form-group mb-3 w-50">
                                <label>▼sourceType</label>
                                <input type="text" id="simulate_sourceType" class="form-control"
                                    placeholder="sourceType" :value="currUser.sourceType">
                            </div>
                            <div class="modal-footer text-center">
                                <button type="button" class="btn btn-info" @click="simulate(false)">Simulate</button>
                                <button type="button" class="btn btn-info btn-outline-danger"
                                    @click="simulate(true)">Simulate(New)</button>
                            </div>
                        </div>
                    </div>
                    <!--simulate--e.-->
                    <!--resolution--s.-->
                    <div v-if="debugInfo.showDebugTab=='resolution'" class="debuginfo" style="background-color:white;">
                        <div style="padding: 10px;">
                            <table style="border-collapse:separate; border-spacing:10px;">
                                <tr>
                                    <td>▼Resolution</td>
                                    <td>
                                        <!--
                                        <span>▼Resolution    </span>                                
                                        <select id="resolution" v-model="resolution">
                                            <option v-for="x in resolutionList" :value="x.value">{{x.text}}</option>
                                        </select>
                                        -->
                                        <div>
                                            <span><b>Width</b>(1280~screen.width):</span>
                                            <input type="number" id="resolution_width" size="4"
                                                :value="(KMSshareVedioSetting_user)?KMSshareVedioSetting_user.constain.width:1280"
                                                min="1280" :max="screen.width">
                                            <span>x <b>Height</b>(720~1080):</span>
                                            <input type="number" id="resolution_height" size="4"
                                                :value="(KMSshareVedioSetting_user)?KMSshareVedioSetting_user.constain.height:720"
                                                min="720" :max="screen.height">
                                        </div>
                                        <div style="color:cornflowerblue">
                                            <table width="100%">
                                                <tr>
                                                    <td>1920 x 1080</td>
                                                    <td>1900 x 1070</td>
                                                </tr>
                                                <tr>
                                                    <td>1680 x 1050</td>
                                                    <td>1600 x 900</td>
                                                </tr>
                                                <tr>
                                                    <td>1440 x 900</td>
                                                    <td>1400 x 1050</td>
                                                </tr>
                                                <tr>
                                                    <td>1366 x 768</td>
                                                    <td>1360 x 768</td>
                                                </tr>
                                                <tr>
                                                    <td>1280 x 1024</td>
                                                    <td>1280 x 960</td>
                                                </tr>
                                                <tr>
                                                    <td>1280 x 720</td>
                                                    <td>&nbsp;</td>
                                                </tr>
                                            </table>
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td>▼frameRate(6~30)</td>
                                    <td>
                                        <span><b>ideal</b>:</span>
                                        <input type="number" id="frameRate_ideal" size="2"
                                            :value="(KMSshareVedioSetting_user)?KMSshareVedioSetting_user.constain.frameRate.ideal:6"
                                            min="6" max="30">
                                        <span>~ <b>max</b>:</span>
                                        <input type="number" id="frameRate_max" size="2"
                                            :value="(KMSshareVedioSetting_user)?KMSshareVedioSetting_user.constain.frameRate.max:10"
                                            min="6" max="30">
                                    </td>
                                </tr>
                                <tr>
                                    <td>▼Bandwidth(1000~2500)</td>
                                    <td>
                                        <span><b>min</b>: </span>
                                        <input type="number" id="Bandwidth_min" size="4"
                                            :value="(KMSshareVedioSetting_user)?KMSshareVedioSetting_user.Bandwidth.min:1000"
                                            min="0" max="2500">
                                        <span>~ <b>max</b>:</span>
                                        <input type="number" id="Bandwidth_max" size="4"
                                            :value="(KMSshareVedioSetting_user)?KMSshareVedioSetting_user.Bandwidth.max:1500"
                                            min="0" max="2500">
                                    </td>
                                </tr>
                                <tr>
                                    <td>▼video resolution</td>
                                    <td>
                                        <span><b>width</b>: </span>
                                        <input type="number" id="vd_width" size="4" min="0" max="1920" v-model="vd_width">
                                        <span><b>height</b>: </span>
                                        <input type="number" id="vd_height" size="4" min="0" max="1080" v-model="vd_height">
                                    </td>
                                <tr>
                                    <td colspan="2">
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-info"
                                                @click="changeResolution">ApplyResolution</button>
                                        </div>
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </div>
                    <!--resolution--e.-->
                    <div v-if="debugInfo.showDebugTab=='config'" class="debuginfo" style="background-color:white;">
                        <div style="padding: 10px;">

                            <div>
                                <h5>Bandwidth Config:</h5>
                                <lable>maxVideoSendBandwidth : </lable>
                                <input :value="webrtcOption.maxVideoSendBandwidth"
                                    @change="webrtcOption.maxVideoSendBandwidth=parseInt($event.target.value)" /><br />
                                <lable>minVideoSendBandwidth : </lable>
                                <input :value="webrtcOption.minVideoSendBandwidth"
                                    @change="webrtcOption.minVideoSendBandwidth=parseInt($event.target.value)" /><br />
                                <lable>maxVideoRecvBandwidth : </lable>
                                <input :value="webrtcOption.maxVideoRecvBandwidth"
                                    @change="webrtcOption.maxVideoRecvBandwidth=parseInt($event.target.value)" /><br />
                                <lable>minVideoRecvBandwidth : </lable>
                                <input :value="webrtcOption.minVideoRecvBandwidth"
                                    @change="webrtcOption.minVideoRecvBandwidth=parseInt($event.target.value)" />
                            </div>
                        </div>
                    </div>
                </div>

                <div style=" display: flex; align-items: center;justify-content: center;">
                    <!-- <button id="sendInvite" class="sendInvite" onclick="checkDevice()">check</button> -->
                    <button class="closeModal btn btn-primary" @click="debugInfo.isShowDebug = false">Close</button>
                </div>
            </div>
        </div>
        <!-- Modal:Mobile線上人員 10/28-->
        <div id="UserList_Mobile" class="modalv" v-show="isShowList_Mobile" style="display: block;">
            <!-- Modal content -->
            <div class="modal-contentv">
                <div class="modal-headerv" style="background-color: #2196F3; border-radius: 10px 10px 0px 0px;">
                    <span class="closeModal modal-close-btn" @click="isShowList_Mobile = false">
                        <i class="fas fa-times"></i>
                    </span>
                    <div style="background-color: #2196F3;color:white;padding:5px;overflow-x: hidden">
                        <span style="padding-left :5px;font-size:medium;">
                            {{ $t('lan-tab-list') }}({{ $t('lan-tab-num') }} : {{ onlineUserCount }}, {{
                            $t('lan-tab-num-speak') }} : {{ onlineSpeakers.length }}, {{ $t('lan-tab-num-agree') }} : {{
                            raiseHandCount }})
                        </span>
                    </div>
                </div>
                <div class="modal-bodyv" style="min-height: 400px;border: 1px solid #95d4e7;">
                    <div :class="invitedUserCount>0 ? 'list-emp-height2' : 'list-emp-height1'"
                        style="border: 1px solid #95d4e7;">
                        <ul class="participantsul" :class="invitedUserCount>0 ? 'participantsul-ext' : ''">
                            <!-- self -->
                            <li>
                                <span>
                                    <i :class="sourceTypeDisplay(currUser.sourceType).css"
                                        :title="sourceTypeDisplay(currUser.sourceType).title" style="width: 20px;"></i>
                                    {{ currUser.name }}
                                    <i :class="onlineStatusDisplay(currUser.onlineStatus).css"
                                        :title="onlineStatusDisplay(currUser.onlineStatus).title"
                                        style="width: 28px; cursor: pointer;" @click="onlineStatusChange()"></i>
                                    <i :class="raiseHandStatusDisplay(currUser.raiseHandStatus).css"
                                        :title="raiseHandStatusDisplay(currUser.raiseHandStatus).title"
                                        :style="`width: 20px; cursor: pointer; ${ currUser.raiseHandStatus==1 ? 'color:Dodgerblue ' :  ''}` "
                                        v-on="{ mousedown: raiseHandStatusChangedown,
                                                mouseup: raiseHandStatusChangeup ,
                                                mouseleave: raiseHandStatusChangeup ,
                                                touchstart: raiseHandStatusChangedown,
                                                touchend: raiseHandStatusChangeup 
                                                }"></i>
                                </span>
                            </li>
                            <!-- online users -->
                            <li v-for="u in onlineUsers">
                                <span :title="onlineUserTitleHint(u)">
                                    <i :class="sourceTypeDisplay(u.sourceType).css"
                                        :title="sourceTypeDisplay(u.sourceType).title" style="width: 20px;"></i>
                                    {{ u.displayName }}
                                    <i :class="onlineStatusDisplay(u.onlineStatus).css"
                                        :title="onlineStatusDisplay(u.onlineStatus).title"
                                        :style="u.raiseHandStatus==1 ? 'width: 15px;': 'width: 31px;'"></i>
                                    <i :class="u.raiseHandStatus==1 ? raiseHandStatusDisplay(u.raiseHandStatus).css :''"
                                        :style="`width: 15px; ${u.raiseHandStatus==1 ? 'color: Dodgerblue;' :  ''}` "
                                        :title="raiseHandStatusDisplay(u.raiseHandStatus).title"></i>
                                </span>
                                <span v-if="isUsingSelf" :class="(u.connectionState) ? u.connectionState : 'null'"
                                    :title="'conn:'+u.connectionState"></span>
                                <span v-else style=" float: left;
                                    width: 10px;
                                    height: 10px;
                                    text-align: center;
                                    font-size: 1.3em;
                                    border-radius: 100%;
                                    margin: 4px 1px 0px 1px;"></span>
                            </li>
                        </ul>
                    </div>
                    <!--已邀請未上線-->
                    <div v-show="invitedUserCount>0" class="divParticipantsHeader"
                        style="background-color: #2196F3;color:white;padding:5px;overflow-x: hidden">
                        <span style="padding-left :5px;font-size: small;">
                            {{ $t('lan-tab-invited') }}({{ $t('lan-tab-num') }} : {{ invitedUserCount }})
                        </span>
                    </div>
                    <div v-show="invitedUserCount>0" class="list-invite-height" style="border: 1px solid #95d4e7;">
                        <ul class="participantsul">
                            <li v-for="u in invitedDisplayUsers">
                                <span style="color:dimgray;">
                                    {{ u.displayName }}
                                </span>
                            </li>
                        </ul>
                    </div>
                </div>
                <div class="modal-footer" style=" display: flex; align-items: center;justify-content: center;">
                    <button type="button" class="btn btn-secondary" @click="isShowList_Mobile = false">Close</button>
                </div>
            </div>
        </div>
        <!-- Modal:Mobile交談記錄 10/28-->
        <div id="ChatMsg_Mobile" class="modalv" v-show="isShowChat_Mobile" style="display: block;">
            <!-- Modal content -->
            <div class="modal-contentv">
                <div class="modal-headerv" style="background-color: #2196F3; border-radius: 10px 10px 0px 0px;">
                    <span class="closeModal modal-close-btn" @click="isShowChat_Mobile = false">
                        <i class="fas fa-times"></i>
                    </span>
                    <div style="background-color: #2196F3;color:white;padding:5px;overflow-x: hidden">
                        <span style="padding-left :5px;font-size:medium;">
                            {{ $t("lan-tab-talk") }}
                        </span>
                    </div>
                </div>
                <div class="modal-bodyv" style="min-height: 400px;border: 1px solid #95d4e7;">
                    <div class="chatContainer list-chat-height" v-show="isShowChat" v-cloak>
                        <div class="inbox_msg">
                            <div class="mesgs list-chat-height w3-display-container" style="  display: flex;
                            flex-direction: row;
                            flex-wrap: wrap; ">
                                <div ref="msgHistory" class="msg_history list-chat-inner-height"
                                    style="width:100%;height: calc(100% - 90px);">
                                    <template v-if="chatMsgs.length==0">
                                        <div class="msg_alert">
                                            <span>{{ $t("lan-tab-zero") }}</span>
                                        </div>
                                    </template>
                                    <br>
                                    <div v-for="(c, index) in chatMsgs">
                                        <template v-if="!c.self">
                                            <div class="incoming_msg">
                                                <div class="msg_username" v-if="isFirtstMsg(c, index)">
                                                    {{c.userName}}
                                                </div>
                                                <div class="received_msg">
                                                    <div class="received_withd_msg">
                                                        <p v-html="c.msg"></p>
                                                    </div>
                                                </div>
                                                <span class="time_date received_time_date">
                                                    {{ c.sendDate | fromNow }}
                                                </span>
                                            </div>
                                        </template>
                                        <template v-if="c.self">
                                            <div class="outgoing_msg">
                                                <div class="sent_msg">
                                                    <p v-html="c.msg"></p>
                                                </div>
                                                <span class="time_date self_time_date">
                                                    {{ c.sendDate | fromNow }}
                                                </span>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer" style=" display: flex; align-items: center;justify-content: center;">
                    <button type="button" class="btn btn-secondary" @click="isShowChat_Mobile = false">Close</button>
                </div>
            </div>
        </div>
    </div>
    <!-- <img id="imageTag" style="width:50%;height:50%"></img> -->
    <img src="img/arrow.png" id="arrow_on" style="padding: 0px; border: 0px; cursor: pointer;display:none;" />
    <script type="text/javascript">
        //--paste or drop file to document-s.
        //----prevent open new window after drop image-s.
        window.addEventListener("dragover", function (e) {
            e = e || event;
            e.preventDefault();
        }, false);
        window.addEventListener("drop", function (e) {
            e = e || event;
            e.preventDefault();
        }, false);
        //----prevent open new window after drop image-e.        
        document.body.onpaste = function (event) {
            let _items = (event.clipboardData || event.originalEvent.clipboardData).items;
            if (_items.length > 0 && _items[0].type.indexOf("image") != -1) {
                event.preventDefault();
                let _file = _items[0].getAsFile(); // Get the blob of image
                //console.log("Paste image file="+_file+",file type="+_items[0].type+",file name="+_file.name);
                let _dt = new DataTransfer();
                _dt.items.add(_file);
                let _filelist = _dt.files;
                $VM.beforeLiveImage(_filelist);
            }
        };
        document.body.ondrop = function (event) {
            event.preventDefault();
            let _dt = event.dataTransfer;
            let _items = _dt.files;
            if (_items.length > 0 && _items[0].type.indexOf("image") != -1) {
                //console.log("Drop files:"+_item+",file type="+_item.type+",file name="+_item.name);
                let _dt = new DataTransfer();
                _dt.items.add(_items[0]);
                let _filelist = _dt.files;
                $VM.beforeLiveImage(_filelist);
            }
        };
        //--paste or drop file to document-e.
    </script>
    <script>
        //--SpeechSynthesis:設定 - Voices
        function setVoicesOptions(_lang) {
            $("#voices option[value!='']").remove();
            const voiceOptions = voices
                .filter(voice => voice.lang.includes(_lang));
            voiceOptions.forEach(voice => {
                $('#voices').append(new Option(voice.name + "(" + voice.lang + ")", voice.name));
            });
        }  
    </script>
</body>
<!-- <script src="./js/watermark.js"></script>
<script src="./js/selEmp.js"></script> -->
<!--選人元件 -->
<link rel="stylesheet" href="./css/static/awesomplete.css">
<script src="./js/static/awesomplete.js"></script>
<!--tagify -->
<script type="text/javascript" src="./js/static/tagify.js"></script>

<script type="text/javascript" src="./i18n/en_US.js"></script>
<script type="text/javascript" src="./i18n/zh_TW.js"></script>
<script>
    window.globalVar = {};
    moment.locale("zh-tw");
    tagifyJS();
    const lang = {
        en: en_US,
        tw: zh_TW
    }
    let i18n = new VueI18n({
        locale: (/^zh\b/.test(navigator.language)) ? 'tw' : 'en', // 語系可以先指定或之後指定
        messages: lang
    });
    $VM = new Vue({
        //el: '#chatApp',
        el: "#vueApp",
        i18n: i18n,
        components: { debugComponent, switchbutton },
        mixins: [vue_mixin_rtc],
        data: function () {
            return {
                AppInfo: {
                    version: APP_Ver.toUpperCase(),
                },
                isShowList: true,
                isShowCanvas: true,
                isFullScreen: false,
                isSubtitleFullScreen: false,
                isShowPIP: false,
                isFocus: true,
                isShowRMCtrl: true,
                isRemoteCtrlActive: false,
                roomInfo: {
                    empId: window.params.empid,
                    userName: window.params.username,
                    roomId: window.params.roomid,
                    topic: window.params.topic,
                    masterId: window.params.roomid.split('_')[1],
                    masterDeptId: '',
                    isMuteNewComing: true,
                    isSecret: false,
                },
                isShareVideo: false,
                isShareVideoLocalWebRTC: false,
                isShareVideoLocalKMS: false,       //自己正在桌面直播
                isShareVideoLocalWebCam: false,    //自己正在視訊直播
                isShareVideoLocalKMSWebCam: false, //自己正在雙鏡頭直播
                isShareVideoLocalImage: false,   //自己正在圖片直播   ~~>method
                isShareVideoImage: false,         //Viewer:圖片直播中  ~~>method 
                sharingImageSrc: '',               //圖片 src url
                sharingImageUser: '',              //圖片直播userid 

                ckDispalyMyVideo: false,
                isShareVideoDoubleCam: false,
                isShareLocalDoubleCam: false,
                isShareVideoHolo: false,   // HoloLens I. RDP Service直播中
                isHoloUnity: false,        // HoloLens Unity Device (為了與I.RDP Sol.區分,於[桌面直播]按鈕區分)                
                isWaitHoloUnity: false,    // 是否已send startHoloUnity msg,待回覆startview msg                
                isShareVideoHoloII: false, // HoloLens II. Unity直播中                
                isShowHoloArrow: true,    // HoloLens II. 錨點功能 顯示否
                isHoloArrowActive: false,  // HoloLens II  錨點功能 啟用中
                isStartHoloUnityFromUnity: false, // HoloLens Start From Web/Unity
                isStopHoloUnityFromUnity: false,  // HoloLens Stop  From Web/Unity
                isWhiteboard: false,
                isShareVideo_0: false,   // 是否有人直播(無論currUser是否有權限觀看)                
                videoInfo_0_empid: '',   // 直播人員工號(無論currUser是否有權限觀看)     
                videoDataEvent_0: null,      // for secret meeting 
                isSecretDetectDelay: false,  // for secret meeting 

                HoloII_kmsid: '',        // HoloLens II:桌面直播+圖片直播, keep 桌面直播 kmsid

                iseBoardClicked: false,
                isFullScreenCanceling: false,
                isFullScreenDiscuss: false,
                videoInfo: {
                    id: null,
                    userid: null,
                    empid: null,
                    // userInfo: null,           
                    srcObject: null,
                    type: "",
                    muted: true,
                    isActive: false,
                    isKMS: null,
                    isShowKMSSetting: false,
                    isOpenCamera: false,
                    cameraPoition: "rightdown",
                    cameraSize: 'M',
                    mixerStopFunction: null,
                    isPasue: false,
                },
                ckDispalyMyWebCam: false,
                ckCollapseMyWebCam: false,
                ckHideMyWebCam: false,
                isDragFrame: false,
                cameraInfo: {
                    id: null, //kmsId
                    userid: null,
                    empid: null,
                    // userInfo: null,           
                    srcObject: null,
                    // isActive :false,
                    // isClose :false,
                    // isKMS:null,
                    // isShowKMSSetting:false,
                    // isOpenCamera:false,
                    // cameraPoition : "rightdown",
                    // cameraSize : 'M',
                    // mixerStopFunction:null,
                    // isPasue:false,
                },
                pinWebcamInfo: { //視訊直播
                    empId: null,
                    srcObject: null,
                    isShow: false,
                },
                pinWebcamInfoManual: { //手動釘選
                    empId: null,
                    srcObject: null,
                    isShow: false,
                },
                kmsWebcamInfo: {
                    userId: null,
                    srcObject: null,
                    isShow: false,
                    kmsid: null,
                },
                micCount: 9,
                micList: [],
                webrtcOption: {
                    maxVideoSendBandwidth: 1500,
                    minVideoSendBandwidth: 1000,
                    maxVideoRecvBandwidth: 1500,
                    minVideoRecvBandwidth: 1000,
                },
                isSelectEmpShow: false,
                ajaxEmployeeLoading: true,
                isDuplicateLogin: false, //add 2020/10/22判斷重複登入的flag
                currUser: {
                    userId: null,
                    empId: window.params.empid, //工號
                    sourceType: window.params.sourcetype,
                    deviceId: window.params.deviceid,
                    uid: window.params.empid, //工號
                    userType: window.params.usertype || "E",
                    nickName: window.params.nickname,
                    deptId: "",
                    name: "",
                    isMute: true,
                    onlineStatus: 0,
                    raiseHandStatus: -1,
                    isSpeeking: false,
                    connectionState: "",
                    iceState: "",
                    channelState: "",
                    timeStamp: null,
                    localAudioStream: null,
                    isAckSending: false,
                    isAckReply: false,
                    connectTime: null,
                    clientId: null,
                    mqttState: '',
                    isAllowWebCam: null,
                    isAllowMicphone: null,
                    isDoubleCam: false,
                    isAllmute: false,
                    isUseBuildInCamForFace: true,
                    displayName: "",
                    authMobileViewLive: false, // 2021/11/18 手機看直播權限
                    authPCViewLive: false,      // 桌機看直播權限
                    authViewHololensLive: false, // 加入會議 看Hololens直播之白名單
                    isHomeDuty: false,            // 居家辦公                    
                    avatarIsExist: false,       //add by vic 2022/04/25 -user加入時檢核頭貼圖檔是否有效
                },
                userState_DashB: {         // userState_DashBoard (member actions)
                    isUnityLaserOn: false,  // Unity II直播時投影筆顯示中(mouseDown)
                    speakInfo: {                // 發言資訊
                        isSpeaking: false,      // 發言中
                        isMute: true,           // 靜音 (=currUser.isMute)
                        isDisableCamera: false, // camera on/off
                        kmsid_Speak: null,      // 發言kmsid
                        isLive: false,          // 直播中
                        liveSource: null,       // 直播類別:webcam/screen/doublecam/holo/holoII
                        //    liveVideoInfo:null, // 直播主VideoInfo
                        kmsid_Live: null,       // 直播kmsid ; img url                      
                    },
                    connectTime: null,
                    clientId: null,
                },
                chatMsgs: [], //{ userName, msg, targetUser, sendDate}
                chatMsgs_mobile: [], // chatMsgs for Mobile --10/28
                speechs: [], //for sustitle 2023/12/13
                speechs_all: [], //for sustitle 2023/12/13
                speechs_all_debug: [], //for sustitle 2023/12/13
                speech_last_username: '',//for sustitle 2023/12/13
                show_speech_text: {},
                speech_text: '',//for sustitle 2023/12/13
                speech_text_last: '',//for sustitle 2023/12/13
                speech_text_1: '',//for sustitle 2023/12/13
                speech_text_last_1: '',//for sustitle 2023/12/13
                speech_text_2: '',//for sustitle 2023/12/13
                speech_text_last_2: '',//for sustitle 2023/12/13
                speech_timeout: {},//for sustitle 2023/12/13
                speech_merge_timeout: {},//for sustitle 2023/12/13
                current_speech_lang: 'zh',//for sustitle 2023/12/13
                current_speech_voice_lang: 'zh',//for sustitle 2023/12/13
                speech_switch_state: true,//for sustitle 2023/12/13
                speech_switch_voice_state: false,//for sustitle 2023/12/13
                speech_switch_google_trans_state: false,//for sustitle 2023/12/13
                speech_swith_ose:false,//for sustitle 2023/12/13, 母語是中文時，發英文音開關 
                speech_text_1_g: '',//for sustitle 2023/12/13
                speech_text_2_g: '',//for sustitle 2023/12/13
                voice_option: '',//for sustitle 2023/12/13
                speechs_all_merge: [], //for sustitle 2023/12/13 , 使用mergeFile的msg
                userInputMsg: '',
                chatUnreadCnt: 0,
                headerBar: {
                    // shareUser: "",
                    sharStatus: "",
                    headerMSG: "",
                    showDebugButton: true,
                    isLaserPenClicked: false,
                    showSwitchRecordButton: false
                },
                isShowChat: true,
                isChatCollapsed: true,
                isScreenShowing: false,
                //{ empId, name, email, deptId, deptName, uid, sourceType, 
                //  isMute, onlineStatus, isSpeaking, connectedStatus }
                onlineUsers: [],
                onlineUsers_b: [],     // keep onlineUsers befor sort
                isonlineUsersSort: 0,
                invitedAllUsers: [],
                invitedDisplayUsers: [],
                //歷程
                historyLogs: [], //{ showTime, iconClass, showContent }
                //文件分享歷程
                shareDocLogs: [], //{ showTime, iconClass, showContent }                
                //第幾個Tab顯示
                aTabDisplay: ["block", "none", "none", "none"],
                saTabDisplay: ["block", "none", "none", "none"],
                saTabTitleDisplay: "inline-table",
                currTransTab: "msgHistory_all",
                //
                cvsBoard: {}, //canvas
                cvsBoardpenPrevCount: -1,
                choosePenType: "",
                debugInfo:
                {
                    isShowDebug: false,
                    showDebugTab: "debug",
                    debugtext: "",
                },
                fullscreenStyle: {
                    "videoClass": "",
                    "videoStyle": ""
                },
                //歷程
                aIconClass: {
                    "in": "fas fa-user",
                    "out": "fas fa-sign-out-alt",
                    "share": "fas fa-eye",
                    "close": "fas fa-eye-slash",
                    "invite": "fas fa-user-plus",
                    "speak": "fas fa-microphone",
                    "quiet": "fas fa-microphone-slash",
                    "record": "fas fa-circle",
                    "stoprecord": "fas fa-stop",
                    "wb": "fas fa-clipboard",
                    "image": "far fa-solid fa-file-image",
                    "file": "far fa-thin fa-file",
                },
                //emojilist :['👍️','🧡','👏','🈶','🈚️','😊','💯','🆗'],
                emojilist: ["em01", "em02", "em03", "em04", "em05", "em06", "em07", "em08"],
                oNotify: new notify(),
                keyBoard: null,
                oDetectDevice: new detectDevice(),
                // mMqtt:null
                onlineSpeakers: [],
                kmsController: {},
                clicktime: 0,
                connection: connection,
                heightOffset: 180,
                isShowCondientialWording: false,
                isPteamChatTo: false,//add 2020/10/26 是否點私聊中，會觸發 beforeunload ，此isPteamChatTo 在beforeunload判斷不傳給後端api寫log                
                lanSelected: (/^zh\b/.test(navigator.language)) ? 'tw' : 'en',
                isRecordSwitchOn: CONFIG.kmsRecord.record || CONFIG.kmsRecord.forceRecordEmps.includes(window.params.roomid.split('_')[1]), //紀錄會議錄影啟用狀態
                triggerRecordSwitchOn: false, // 2021/10/15 居家人員加入會議須強制啟動會議錄影
                isAddInviteEmailShow: CONFIG.kmsRecord.inviteExternal,
                isSmartPanelOn: false,
                smPingInterval: null,
                isWhiteboardEnable: false,
                curWhiteboardUrl: "",
                invitePermit: false, //外部會議-是否允許取用鏡頭
                //isEverAskFullScreen: false, // 2021/10/26
                isShowList_Mobile: false,   // 2021/10/28 - Mobile-navigator[更多]-[線上]
                isShowChat_Mobile: false,   // 2021/10/28 - Mobile-navigator[更多]-[交談]                
                localIP: null,
                HoloUnityeB_Max: 3,  //HoloLens II 投影筆 Max
                HoloUnityeB_User: [],//HoloLens II 投影筆 users,
                resolutionList: [
                    { text: '1280x720(4/3)', value: '1280x720', constain: { width: 1280, height: 720, frameRate: { ideal: 15, max: 15 } } },
                    { text: '1366x768(16/9)', value: '1366x768', constain: { width: 1366, height: 768, frameRate: { ideal: 15, max: 15 } } },
                    { text: '1504x846(16/9)', value: '1504x846', constain: { width: 1504, height: 846, frameRate: { ideal: 15, max: 15 } } },
                    { text: '1920x1080(16/9)', value: '1920x1080', constain: { width: 1920, height: 1080, frameRate: { ideal: 15, max: 15 } } },
                    { text: 'as 1080P(OLD)', value: '1080P', constain: { width: 9999, height: 9999, frameRate: { ideal: 15, max: 15 } } },
                    { text: 'as 1080P(MAX:1920*1080)', value: '1080P1', constain: { width: 9999, height: 9999, frameRate: { ideal: 15, max: 15 } } },
                ],
                resolution: null,
                KMSshareVedioSetting_user: null,
                vd_width:240,
                vd_height:160,
                screen: { width: screen.width, height: screen.height },
                smartPanelVer: "",
                smartPanelVer_Secret: "2.2.0",
                synth_setting: false,  // translate meeting
                synth_voice: {         // translate meeting
                    name: "",
                    rate: 1,
                    pitch: 1,
                },
                newSubtitleFullScreen: false,
                newSubtitleScrollBarIsActive: false,
                newSubtitleScrollEvent: false,
                cookieFontSizeRange: 0,
                speakerActive: true,
                ccActive:true,
                iceConnected: true,
                otherIceConnected: true,
                subtitleSetting: {
                    fixPosition: 83,
                    fontSize: 16,
                    backgroundOpacity: 0.75,
                    pip: false,
                    realTimePosition: 'real-div'
                },
                glossary: 'Y',
                preloadSentence: 'N',
                subtitle_show_debug: false,
                subtitle_auto_change_lang: true,
                subtitle_diff_lang_count: 0,
                scroll_timeout: {},
                scrollCount: 0,
                same_pronunciation_edit: {
                    from: "",
                    to: "",
                    result: "",
                    show_result: ""
                },
                fromSamePronunciation: "",
                toSamePronunciation: "",
                mqtt_reconnect_time: 0,
                isMobile: false,
                isAndroid: false,
                voices: [],
                isInitPIPSubtitle: false
            }
        },
        created: function () {
            const self = this;
            self.block();
            //監聽fullscreenchange事件
            document.addEventListener('fullscreenchange', self.screenStateChange, false);
            document.addEventListener('mozfullscreenchange', self.screenStateChange, false);
            document.addEventListener('webkitfullscreenchange', self.screenStateChange, false);

            //document.addEventListener("visibilitychange", _.throttle(self.visibilitychange, 10000), false);
            document.addEventListener("visibilitychange", self.visibilitychange, false);

            window.addEventListener("focus", function () {
                self.windowBlurOrFocus(false);
            }, false);

            window.addEventListener("blur", function () {
                self.windowBlurOrFocus(true);
            }, false);
            
        },
        mounted: function () {
            const self = this;

            if (self.getCookie('SubtitleSettingfontSize')) {
                self.subtitleSetting.fontSize = parseInt(self.getCookie('SubtitleSettingfontSize'));
            }
            if (self.getCookie('SubtitleSettingBackgroundOpacity')) {
                self.subtitleSetting.backgroundOpacity = self.getCookie('SubtitleSettingBackgroundOpacity');
            }
            if (self.getCookie('SubtitleSettingPIP')) {
                self.subtitleSetting.pip = (self.getCookie('SubtitleSettingPIP').toLowerCase() === "true");
            }
            self.cvsBoard = new eBoard({
                //userId: self.currUser.userId, => 會取不到
                userId: window.params.empid,
                canvasId: "sharingVideoCanvas",
                videoId: "sharingVideoTag",
                laserFillStyle: self.getOrSetLaserFillStyle('get'),//雷射筆顏色
                canvasMobileId: "mobileCanvas", // 11/01
                HoloUnityeB_Max: self.HoloUnityeB_Max,
                onmousedown: function (penInfo) { // 會先執行eBoard.binding event(mousedown),callback再執行此event
                    // console.log("onmousedown:", penInfo);
                    if (self.cvsBoard.penType == "l") {
                        try {
                            // send(`eB#${connection.userid}#1#${JSON.stringify(penInfo)}`);
                            let _sendPen = JSON.parse(JSON.stringify(penInfo));
                            delete _sendPen.u;
                            // let videostream = document.getElementById("sharingVideoTag").srcObject;
                            // let vH = videostream.getVideoTracks()[0].getSettings().height;
                            // let vW = videostream.getVideoTracks()[0].getSettings().width
                            // if(vH/vW > _sendPen.cH/_sendPen.cW)
                            // {
                            //     let rate = vH/ _sendPen.cH;
                            //     let actW = vW*rate;
                            //     let gap = (_sendPen.cW -actW)/2;
                            //     //_sendPen.cX = Math.round((_sendPen.cX-gap)+(gap*2*(_sendPen.cX/_sendPen.cW) ));
                            //     _sendPen.cX = Math.round((_sendPen.cX-gap)+(gap*2*((_sendPen.cX-gap)/actW) ));

                            // }

                            //                     self.pen = {
                            //     u: self.userId,
                            //     n: self.displayName,
                            //     p: self.penType,
                            //     s : self.hexToRGB(self.laserFillStyle),
                            //     cW: self.cvs.offsetWidth,
                            //     cH: self.cvs.offsetHeight,
                            //     cX: x, //改用 offsetXY取得在canvas內的相對位置
                            //     cY: y,
                            //     me: 1
                            //
                            //   if(_sendPen.cX>0)  
                            if (self.isShareVideoHoloII) {
                                if (self.isHoloArrowActive) { //錨點啟用後,僅傳mousedown (send msg sendHoloArrow me=1)
                                    send(`sendHoloArrow#${self.currUser.userId}#${connection.kms.kmsUserid}#${JSON.stringify(_sendPen)}`);
                                    //self.holoArrow();     //錨點啟用後,mousedown即取消錨點啟用&video play. 4/28決定仍採錨點on後video pause, 錯點off後video replay
                                } else {
                                    if (self.cvsBoard.penData.findIndex(e => e.u == self.currUser.userId) >= 0) { //mousedown已透過eBoard.js mousedown加入penData
                                        if (self.HoloUnityeB_User.length < self.HoloUnityeB_Max) {
                                            self.userState_DashB.isUnityLaserOn = true;
                                            send(`eB#${self.currUser.userId}##${JSON.stringify(_sendPen)}`);
                                        }
                                    }
                                }
                            } else {
                                send(`eB#${self.currUser.userId}##${JSON.stringify(_sendPen)}`);
                            }

                        } catch (e) {
                            console.log("custom onmouseup:", e);
                        }
                    }
                },
                onmousemove: function (penInfo) {
                    // console.log("onmousemove:", penInfo, penInfo.moveXY[penInfo.moveXY.length-1]);

                    if (self.cvsBoard.penType == "l") {
                        try {
                            // send(`eB#${connection.userid}#1#${JSON.stringify(penInfo)}`);
                            let _sendPen = JSON.parse(JSON.stringify(penInfo));
                            delete _sendPen.u;
                            // let videostream = document.getElementById("sharingVideoTag").srcObject;
                            // let vH = videostream.getVideoTracks()[0].getSettings().height;
                            // let vW = videostream.getVideoTracks()[0].getSettings().width
                            // if(vH/vW > _sendPen.cH/_sendPen.cW)
                            // {
                            //     let rate = vH/ _sendPen.cH;
                            //     let actW = vW*rate;
                            //     let gap = (_sendPen.cW -actW)/2;
                            //     // _sendPen.cX = Math.abs(_sendPen.cX-gap);
                            //     _sendPen.cX = Math.round((_sendPen.cX-gap)+(gap*2*((_sendPen.cX-gap)/actW) ));
                            // }
                            // if(_sendPen.cX>0)   
                            if (!self.isHoloArrowActive) //錨點啟用後,僅傳mousedown,原eB不送
                                send(`eB#${self.currUser.userId}##${JSON.stringify(_sendPen)}`);

                        } catch (e) {
                            console.log("custom onmouseup:", e);
                        }
                    }
                },
                onmouseup: function (penInfo) {
                    // console.log("onmouseup:", penInfo);
                    try {
                        // send(`eB#${connection.userid}#1#${JSON.stringify(penInfo)}`);
                        let _sendPen = JSON.parse(JSON.stringify(penInfo));
                        delete _sendPen.u;
                        if (!self.isHoloArrowActive) { //錨點啟用後,僅傳mousedown,原eB不送    
                            if (self.isShareVideoHoloII) {
                                $VM.userState_DashB.isUnityLaserOn = false;
                            }
                            send(`eB#${self.currUser.userId}##${JSON.stringify(_sendPen)}`);
                        }

                    } catch (e) {
                        console.log("custom onmouseup:", e);
                    }
                }
            });
            if (self.oDetectDevice.isMobileiOS) { // 避免iOS產生直向scroll bar
                document.body.style.height = '-webkit-fill-available';
            }
            self.resizeWindow();
            //視窗縮放
            window.addEventListener('resize', function (event) {
                self.resizeWindow();
            });

            window.addEventListener('focus', function (event) {
                //console.log("addEventListener focus" );
                self.isFocus = true;

            });
            window.addEventListener('blur', function (event) {
                //console.log("addEventListener blur" );
                self.isFocus = false;

            });			
            //預設不開啟雷射筆
            self.clickLaserPen(false);
            
            $(document).on("keydown", self.keydownDetect);

            // 2021/10/21 navigator event-s.
            let tag_nav = document.getElementById("nav");
            let tag_nav_more = document.getElementById("nav_more");
            let tag_div_mobile = document.getElementById("div_mobile");
            tag_div_mobile.style.bottom = `${tag_nav.clientHeight + 4}px`;
            $('#nav_more').on('show.bs.collapse', function () {    //nav_more menu show -> CollapsePanel hide              
                try {
                    tag_nav_more.style.bottom = `${tag_nav.clientHeight + 4}px`;
                } catch {
                    console.log('tag_nav_more bottom error');
                }
            })      
            $('#nav_more a').click(function () {
                $("#nav_more").collapse('hide');
            });
            if (this.isMobileUI) {
                this.isShowList = false;
                if (this.isHolo) this.isShowList = true;
            };
            // 2021/10/21 navigator event-e.            

            window.addEventListener('beforeunload', function (event) {
                if (self.isPteamChatTo) {

                }
                else
                    self.onbeforeunload();
                self.isPteamChatTo = false;
            });
            $('#speech_options').on('hide.bs.dropdown', ({ clickEvent }) => {
                if (clickEvent?.target) {
                    console.log($(clickEvent.target).data('tuning'))
                }
            })
            if (navigator.language.includes('zh-TW')) {
                self.current_speech_lang = 'zh';
                self.current_speech_voice_lang = 'zh';
            }
            else {
                self.current_speech_lang = 'en';
                self.current_speech_voice_lang = 'en';
                self.changeTabs(2);
            }
            // 偵測翻譯區塊高度異動
            const elem = document.querySelector('#newSubtitle');
            new ResizeObserver(self.resizeWindow).observe(elem);

            //取得 speechSynthesis 中包含的所有語言資料物件的陣列
            window.mobileAndTabletCheck = function () {
                let check = false;
                (function (a) { if (/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino|android|ipad|playbook|silk/i.test(a) || /1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(a.substr(0, 4))) check = true; })(navigator.userAgent || navigator.vendor || window.opera);
                return check;
            };
            self.isMobile = window.mobileAndTabletCheck();
            let ua = navigator.userAgent.toLowerCase();
            self.isAndroid = ua.indexOf("android") > -1;
            if (self.isMobile) {
                const allVoicesObtained = new Promise(function (resolve, reject) {
                    let voices = window.speechSynthesis.getVoices();
                    if (voices.length !== 0) {
                        resolve(voices);
                    } else {
                        window.speechSynthesis.addEventListener("voiceschanged", function () {
                            voices = window.speechSynthesis.getVoices();
                            resolve(voices);
                        });
                    }
                });

                allVoicesObtained.then(voices => self.voices = voices);
            }
            else {
                speechSynthesis.addEventListener('voiceschanged', populateVoices);
                function populateVoices(event) {
                    self.voices = event.target.getVoices();
                };
            }
        },
        computed: {
            ownerName() {
                const self = this;
                let owner = ""
                if (self.currUser.titleWithConfig && self.currUser.titleWithConfig != '') {
                    owner = self.currUser.titleWithConfig;
                }
                else {
                    if (self.currUser.userType === "M") {
                        owner = self.currUser.displayName;
                    } 
                    else {
                        if (self.currUser.ename && self.currUser.ename != '')
                            owner = self.currUser.ename;
                        else
                            owner = self.currUser.email;
                    }

                    // if (self.currUser.displayName.split('/').length > 1)
                    //     owner = self.currUser.displayName.split('/')[1];
                    // else
                    //     owner = self.currUser.displayName.split('/')[0];
                }
                return owner;
            },
            showSpeechBackground() {
                const self = this;
                let speechTextStyleContent = `background-color: rgb(41,41,41,${self.subtitleSetting.backgroundOpacity});`;
                return speechTextStyleContent;
            },
            showSpeechHeight() {
                const self = this;

                let _obj = {
                    first : 0,
                    second : 0,
                    fixPosition: 84
                }
                switch (self.currTransTab) {
                    case "msgHistory_all":
                        _obj.fixPosition = 84;
                        break;
                    case "msgHistory_zh":
                        _obj.fixPosition = 87;
                        break;
                    case "msgHistory_en":
                         _obj.fixPosition = 87;
                        break;
                    case "msgHistory_debug":
                        _obj.fixPosition = 84;
                        break;
                    default:
                        console.log(`Sorry, we are out of Tab.`);
                }

                return _obj;
            },
            currTransTabLang() {
                let lan = 'zh';
                switch (this.currTransTab) {
                    case 'msgHistory_all':
                        lan = this.current_speech_lang;
                        break;
                    case 'msgHistory_zh':
                        lan = 'zh';
                        break;
                    case 'msgHistory_en':
                        lan = 'en';
                        break;
                    default:
                        lan = this.current_speech_lang;
                        break;
                }
                return lan;
            },
            currTransTabLangTrans() {
                return (this.currTransTabLang == 'zh') ? 'en' : 'zh'
            },
            showSubtitle() {
                if (this.speechs_all[this.speechs_all.length -1]) {
                    let lan = 'zh2zh';
                    if (this.currTransTab != "msgHistory_all" && this.currTransTab != "msgHistory_debug") {
                        switch (this.currTransTabLang) {
                            case 'zh':
                                lan = 'zh2zh';
                                break;
                            case 'en':
                                lan = 'zh2en';
                                break;
                            default:
                                break;
                        }
                    }

                    let speech = this.speechs_all[this.speechs_all.length -1][lan];
                    return speech;
                }
                else {
                    return ""
                }
            },
            showSubtitleTrans() {
                if (this.speechs_all[this.speechs_all.length -1]) {
                    let lan = 'zh2en';
                    return this.speechs_all[this.speechs_all.length -1][lan];
                }
                else {
                    return ""
                }
            },
            isShowPteamScheme: function () {
                return (CONFIG.PteamCDN != null);
            },
            isUsingSelf: function () {
                const self = this;
                let result = self.onlineSpeakers.filter(x => x.userId == self.currUser.empId && x.isUsing == true);
                return (result && result.length > 0 ? true : false);
            },
            speakerVideoWidth: function () {
                let width = 0;
                if ($(".kurentovideoInput").length > 0)
                    width = $(".kurentovideoInput")[0].offsetWidth;
                else
                    if ($(".kurentovideovideoViewer").length > 0)
                        width = $(".kurentovideovideoViewer")[0].offsetWidth;
                return width;
            },            
            onlineSpeakersSorted: function () {
                const self = this;
                let resullt = self.onlineSpeakers.sort(function (a, b) {  //自己->直播者->其他
                    if (a.userId == self.currUser.userId) {
                        return -1;
                    }
                    //直播者
                    if (a.userId == self.connection.kms.kmsUserid || a.userId == self.pinWebcamInfo.empId) {
                        if (b.userId == self.currUser.userId) {
                            return 1;
                        } else {
                            return -1;
                        }
                    } else {
                        return 1;
                    }
                    return 0;
                });
                return resullt;
            },
            translate_GetLastSpeech: function () {  //取逐字稿-其他人發言之最新一筆
                const self = this;
                let othersSpeech = self.speechs_all.filter(x => (x.linkid == null && !x.self));
                if (othersSpeech.length > 0) return othersSpeech.slice(-1)[0];
                else return null;
            },
            isAskMic: function () { return this.currUser.isMute && !this.cameraInfo.empid },
            onlineUserCount: function () {
                return this.onlineUsers.length + 1; //include self
            },
            invitedUserCount: function () {
                return this.invitedDisplayUsers.length;
            },
            raiseHandCount: function () {
                const self = this;
                return (self.onlineUsers.filter(x => x.raiseHandStatus == 1).length) + ((self.currUser.raiseHandStatus == 1) ? 1 : 0);
            },
            shareUserTitle() {
                const self = this;
                if (!self.isShareVideo) {
                    //add 2021/01/25 判斷如果有人在桌面直播，浮水印要增加誰正在直播，沒有人直播的時候要清空「誰正在直播字樣」
                    if (document.getElementById('divWaterMark')) {
                        let vwatermark = '';
                        vwatermark = self.isFullScreen ? "media-container-VIDEO" : "divWaterMark";
                        watermark({ watermark_user: window.params.username, watermark_parent: vwatermark, isFullScreen: self.isFullScreen });
                    }
                    // 2021/12/9: 手機加入，若無看桌面直播權限，亦需顯示「誰正在直播字樣」
                    //if(self.currUser.userType !== 'M' && self.isMobileAny && self.isShareVideo_0 && !self.currUser.authMobileViewLive){
                    if (self.isShareVideo_0 && !self.isAuthViewLive()) {
                        if (self.videoInfo_0_empid) {
                            let titleShare = "";
                            let shareUser = self.onlineUsers.filter(x => x.empId == self.videoInfo_0_empid);
                            if (shareUser.length > 0)
                                titleShare = `${shareUser[0].displayName}`;
                            else
                                titleShare = "";

                            if (self.isShareVideoDoubleCam)
                                return `(${titleShare} ${self.$t('lan-header-twolens')})`;
                            else
                                return `(${titleShare} ${self.$t('lan-header-desktop')})`;
                        }
                    }
                    return "";
                }
                if (self.isShareVideoLocalKMSWebCam) {//自己正在雙鏡頭直播
                    let titleShare = `${self.currUser.displayName}`;
                    $VM.writeLog("關鍵字", `[DISPLAYNAME] ${self.$t('lan-header-twolens')}`);
                    return `(${titleShare} ${self.$t('lan-header-twolens')})`;
                }
                else if (self.isShareVideoLocalWebRTC) {
                    let titleShare = `${self.currUser.deptId}/${self.currUser.name}`;
                    return `(${titleShare} 正在分享畫面)`;
                }

                else if (self.isShareVideoLocalKMS) {//自己正在桌面直播
                    let titleShare = `${self.currUser.displayName}`;
                    $VM.writeLog("關鍵字", `[DISPLAYNAME] ${self.$t('lan-header-desktop')}`);
                    return `(${titleShare} ${self.$t('lan-header-desktop')})`;;
                }

                else if (self.isShareVideoLocalWebCam)//自己正在視訊直播
                {
                    let titleShare = `${self.currUser.displayName}`;
                    $VM.writeLog("關鍵字", `[DISPLAYNAME] ${self.$t('lan-header-webcam')}`);
                    return `(${titleShare} ${self.$t('lan-header-webcam')})`;;
                }
                else if (self.videoInfo.isKMS)//別人正在桌面直播或正在雙鏡頭直播
                {
                    let titleShare = ""
                    let shareUser = self.onlineUsers.filter(x => x.empId == self.videoInfo.empid);
                    //add 2021/01/25 判斷如果有人在桌面直播，浮水印要增加誰正在直播
                    if (shareUser && shareUser[0] && shareUser[0].email) {
                        let wu = `${shareUser[0].email}` + self.$t('lan-header-desktop-brief');
                        watermark({ watermark_user: wu + ' ' + window.params.username, watermark_parent: "divWaterMark", isFullScreen: self.isFullScreen });
                    }
                    if (shareUser.length > 0)
                        titleShare = `${shareUser[0].displayName}`;
                    else
                        titleShare = "";

                    if (self.isShareVideoImage && self.sharingImageUser != "") {
                        let shareUser = self.onlineUsers.filter(x => x.empId == self.sharingImageUser);
                        //add 2021/01/25 判斷如果有人在桌面直播，浮水印要增加誰正在直播
                        if (shareUser && shareUser[0] && shareUser[0].email) {
                            let wu = `${shareUser[0].email}` + self.$t('lan-header-desktop-brief');
                            watermark({ watermark_user: wu + ' ' + window.params.username, watermark_parent: "divWaterMark", isFullScreen: self.isFullScreen });
                        }
                        if (shareUser.length > 0)
                            titleShare = `${shareUser[0].displayName}`;
                        else
                            titleShare = "";
                        return `(${titleShare} ${self.$t('lan-header-liveImage')})`;
                    } else
                        return `(${titleShare} ${self.videoInfo.isWebCam ? self.$t('lan-header-twolens') : self.$t('lan-header-desktop')})`;
                }
                else if (self.isShareVideoLocalImage || (self.isShareVideoImage && self.sharingImageUser != ""))//別人正在圖片直播
                {
                    let titleShare = "";
                    if (self.isShareVideoLocalImage) {
                        let titleShare = `${self.currUser.displayName}`;
                        $VM.writeLog("關鍵字", `[DISPLAYNAME] ${self.$t('lan-header-liveImage')}`);
                        return `(${titleShare} ${self.$t('lan-header-liveImage')})`;;
                    }
                    if (self.isShareVideoImage) {
                        let shareUser = self.onlineUsers.filter(x => x.empId == self.sharingImageUser);
                        //add 2021/01/25 判斷如果有人在桌面直播，浮水印要增加誰正在直播
                        if (shareUser && shareUser[0] && shareUser[0].email) {
                            let wu = `${shareUser[0].email}` + self.$t('lan-header-desktop-brief');
                            watermark({ watermark_user: wu + ' ' + window.params.username, watermark_parent: "divWaterMark", isFullScreen: self.isFullScreen });
                        }
                        if (shareUser.length > 0)
                            titleShare = `${shareUser[0].displayName}`;
                        else
                            titleShare = "";
                        return `(${titleShare} ${self.$t('lan-header-liveImage')})`;
                    }
                }
                else//別人正在視訊直播
                {
                    let titleShare = ""
                    let shareUser = self.onlineUsers.filter(x => x.empId == self.pinWebcamInfo.empId);
                    if (shareUser.length > 0)
                        titleShare = `${shareUser[0].displayName}`;
                    else
                        titleShare = "";
                    return `(${titleShare} ${self.$t('lan-header-webcam')})`;;
                }
            },
            laserColor: function () {
                const self = this;
                if (self.cvsBoard.laserFillStyle) {
                    return `background-color: ${self.cvsBoard.laserFillStyle};`;
                }
                return null;
            },
            computedTopicName: function () {
                const self = this;
                //return `${self.$t('lan-header-topic')}:${window.params.topic}${(window.params.roomid.length===24) ? `(${window.params.roomid.substring(8, 17)})` :  `(${window.params.roomid.substring(8, 14)})`}`;
                let arrayRoomid = window.params.roomid.split('_');
                let fullRoomid = arrayRoomid[0];
                let shortRoomid = fullRoomid.substring(8, fullRoomid.length);
                return `${self.$t('lan-header-topic')}:${window.params.topic}(${shortRoomid})`;
            },
            whiteboardBtnTitle: function () {
                const self = this;
                return `${self.isWhiteboardEnable ? self.$t('lan-header-whiteboard-off') : ''}${self.$t('lan-header-whiteboard')}`;
            },
            isMobileAny: function () {
                const self = this;
                return self.oDetectDevice.isMobileAny;
            },
            isHolo: function () { // HoloLens device
                const self = this;
                return self.currUser.sourceType == "holoportal";
            },          
            isMobileUI: function () {
                const self = this;
                return (self.isMobileAny || self.isHolo);
            },
            isPROD: function () {
                return window.isPROD();
            }
        },
        filters: {
            fromNow: function (value) {
                if (!value) return ''
                return moment(value).format("HH:mm");
            },
            fromNows: function (value) {
                if (!value) return ''
                return moment(value).format("HH:mm");
            },
        },
        watch: {
            fromSamePronunciation: function(val, oldVal) {
                const self = this;
                self.same_pronunciation_edit.from = val;
                if(val) {
                    self.same_pronunciation_edit.show_result = self.same_pronunciation_edit.result.replaceAll(val, `<mark>${val}</mark>`);
                    if (self.toSamePronunciation)
                        self.same_pronunciation_edit.show_result = self.same_pronunciation_edit.result.replaceAll(self.same_pronunciation_edit.from, `<mark>${self.same_pronunciation_edit.to}</mark>`);
                }
                else
                    self.same_pronunciation_edit.show_result = self.same_pronunciation_edit.result;
            },
            toSamePronunciation: function(val, oldVal) {
                const self = this;
                self.same_pronunciation_edit.to = val;
                if(val)
                    self.same_pronunciation_edit.show_result = self.same_pronunciation_edit.result.replaceAll(self.same_pronunciation_edit.from, `<mark>${val}</mark>`);
                else{
                    if (self.fromSamePronunciation)
                        self.same_pronunciation_edit.show_result = self.same_pronunciation_edit.result.replaceAll(self.same_pronunciation_edit.from, `<mark>${self.same_pronunciation_edit.from}</mark>`);
                }

            },
            isShareVideo: function (nv, ov) {
                const self = this;

                setTimeout(() => {
                    if (self.onlineSpeakers.length > 0) {
                        if ($(".kurentovideoInput").length > 0) self.heightOffset = $(".kurentovideoInput")[0].offsetWidth / 1.76;
                        else if ($(".kurentovideovideoViewer").length > 0) self.heightOffset = $(".kurentovideovideoViewer")[0].offsetWidth / 1.76;
                    }

                }, 250);
            },
            isShareVideo_0: function (nv, ov) {
                const self = this;
                if (nv && self.isSecret() && !self.isSmartPanelOn) { // secret meeting,有人直播就要執行smartpanel檢查
                    self.SecretDetect();
                } else {
                    if (SecretDetectInterval) clearInterval(SecretDetectInterval);
                    $VM.isSecretDetectDelay = false;
                }
            },
            isShowList: function (nv, ov) {
                const self = this;

                setTimeout(() => {
                    if (self.onlineSpeakers.length > 0) {
                        if ($(".kurentovideoInput").length > 0) self.heightOffset = $(".kurentovideoInput")[0].offsetWidth / 1.76;
                        else if ($(".kurentovideovideoViewer").length > 0) self.heightOffset = $(".kurentovideovideoViewer")[0].offsetWidth / 1.76;
                    }
                }, 250);
            },
            kmsWebcamInfo: function (nv, ov) {
                console.log("kmsWebcamInfo:", nv, ov);
            },
            choosePenType: function (nv, ov) {
                const self = this;
                self.cvsBoard.penType = nv;
                self.cvsBoard.cvs.style.cursor = (self.cvsBoard.penType) ? "url(img/pen.png) 14 0, auto" : "";
            },
            chatMsgs: function () {
                const self = this;
                Vue.nextTick(function () {
                    self.$refs.msgHistory.scrollTo(0, self.$refs.msgHistory.scrollHeight);
                });
            },
            currUser: {
                handler: function (nv, ov) {
                    try {
                        if (this.currUser.userId == null) return;
                        this.userState_DashB.speakInfo.isMute = this.currUser.isMute;

                        if (this.currUser.deptId && this.currUser.name) {

                        }
                    } catch (err) {
                        console.log(err);
                    }
                },
                deep: true
            },
            /* userState_DashB全部watch */
            userState_DashB: {
                handler: function (nv, ov) {
                    this.watch_userState_DashB();
                },
                deep: true
            },                      
            videoInfo: function (nv, ov) {
                const self = this;
                console.log("watch ", self.videoInfo);
            },
            onlineUsers: function (nv, ov) {
                const self = this;
            },
            "cvsBoard.laserFillStyle": function (val, oldVal) {
                const self = this;
                this.cvsBoard.changeCursorColor(self.headerBar.isLaserPenClicked);
            },
            cvsBoard: {
                handler: function (nv, ov) {
                    const self = this;
                    let isFirstIn = true;

                    try {
                        if (self.cvsBoard && self.cvsBoard.penData) {
                            //console.log("cvsBoard",(self.cvsBoard.penData) ? self.cvsBoard.penData.length : "null");

                            if (self.cvsBoardpenPrevCount == -1) {
                                self.cvsBoardpenPrevCount = self.cvsBoard.penData.length;
                            }
                            else {
                                //判斷是不是第一個雷射筆點選
                                isFirstIn = ((self.cvsBoardpenPrevCount == 0) && (self.cvsBoardpenPrevCount < self.cvsBoard.penData.length));
                                self.cvsBoardpenPrevCount = self.cvsBoard.penData.length;
                            }

                            self.videoAction(isFirstIn);
                        }
                    } catch (err) {
                        console.log(err);
                    }
                },
                deep: true
            },
            synth_setting: function (nv, ov) {  //translate:語音輸出setting
                const self = this;
                let _asis = self.current_speech_voice_lang;
                self.current_speech_voice_lang = 'en';

                if (nv == true) {
                    self.$nextTick(() => self.current_speech_voice_lang = _asis);
                }
            },
            current_speech_voice_lang: { //變更發音語系
                handler: function (nv, ov) {
                    const self = this;
                    //--translate:語音輸出setting-選項--s.//
                    let _lang = "";
                    switch (nv) {
                        case 'zh':
                            _lang = 'zh-TW';   //會議(他人外語口譯):說中文的聴中文; talk2air(口譯):說中文的聴英文                                             
                            break;
                        case 'en':
                            _lang = 'en-US';   //會議(他人外語口譯):說英文的聴英文: taslk2air(口譯):說英文的聴中文
                            break;
                        default:
                            break;
                    }
                    let _key = "talk2air.synth_voice." + _lang;
                    if (localStorage.getItem(_key) != null) {
                        let _local = JSON.parse(localStorage.getItem(_key));
                        if (_local != null) {
                            self.synth_voice = _local;
                        }
                    }
                    setVoicesOptions(_lang);
                    //--translate:語音輸出setting-選項--e.//
                }
            },
            speech_switch_voice_state: function (nv, ov) {  //--translate:語音輸出(Y/N)
                const self = this;
                if (nv == false) {
                    if (synth) synth.cancel(); // 清除 utterance queue
                }
            },
            synth_voice: { //--translate:語音輸出setting 結果儲存於localStorage
                handler: function (nv, ov) {
                    const self = this;
                    if (nv.name && nv.name != "") {
                        let _lang = "";
                        switch (self.current_speech_voice_lang) {
                            case 'en':
                                _lang = 'en-US';
                                break;
                            case 'zh':
                                _lang = 'zh-TW';
                                break;
                            case 'jp':
                                _lang = 'ja-JP';
                                break;
                            default:
                                break;
                        }
                        localStorage.setItem("talk2air.synth_voice." + _lang, JSON.stringify(nv));
                    }
                },
                deep: true
            },
        },
        methods: {
            checkIsTaTaUseVPN: function() {
                return false;
                const self = this;
                const isTaTa = self.currUser.isTaTa;
                const isFromPortalPC = (self.currUser.sourceType == "portalpc");
                const gustWifi = CONFIG.guestWifi.map((x) => x.ip);
                const isGustWifi = (gustWifi.includes(self.localIP));
                return (isTaTa && isFromPortalPC && !isGustWifi);
            },
            initRealTimeASR: function() {
                const self = this;
                self.$nextTick(() => $RealTimeASR = checkASREnable(self.roomInfo, self.currUser.deptId));
            },
            initPIPSubtitle: function() {
                const self = this;
                self.$nextTick(() => {
                    $PIPSubtitle = checkPIPEnable(self.subtitleSetting.pip ,self.roomInfo, 'subtitleCanvas', 'subtitleVideo');
                    self.isInitPIPSubtitle = ($PIPSubtitle) ? true : false;
                });
            },
            initSameSoundWeb: function() {
                const self = this;
                if (!document.getElementById("same-sound-content"))
                    self.$nextTick(() => $SameSoundWeb = checkSameSoundEnable(self.roomInfo, self.currUser.userId));
            },
            splitTextByBreakPunctuation: function(text) {
                const regex = /([。？！?.!])\s*(?=[A-Z])/g;
                const parts = text.split(regex);

                const result = [];
                for (let i = 0; i < parts.length; i += 2) {
                    const sentence = parts[i].trim();
                    const punctuation = parts[i + 1] || '';
                    result.push(sentence + punctuation);
                }

                return result;
            },
            insertNewline: function(text) {
                const self = this;
                const formattedText = self.splitTextByBreakPunctuation(text);

                let result = '';
                for (let i = 0; i < formattedText.length; i++) {
                    let _t = formattedText[i];
                    if (_t.split(" ").length > 1 && (i+1) != formattedText.length) {
                        result += `${_t}<br>`;
                    }
                    else {
                        result += `${_t}`;
                        if ((i+1) != formattedText.length)
                            result += " ";
                    }
                }

                return result;
            },
            playWav: async function(filename, download) {
                try {
                    const self = this;
                    let formData = new FormData();
                    formData.append('roomid', self.roomInfo.roomId);
                    formData.append('filename', filename);
                    formData.append('download', download);
                    const response = await fetch(CONFIG.ARGGetWav, {
                        method: 'POST',
                        body: formData,
                    })
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    const audioBlob = await response.blob();
                    const audioUrl = URL.createObjectURL(audioBlob);
                    if (download) {
                        const a = document.createElement('a');
                        a.href = audioUrl;
                        a.download = filename;
                        document.body.appendChild(a);
                        a.click();

                        window.URL.revokeObjectURL(audioUrl);
                        document.body.removeChild(a);
                    }
                    else {
                        const audio = new Audio(audioUrl);
                        audio.play();    
                    }
                    
                } catch (error) {
                    console.error('Error fetching audio file:', error);
                }
            },
            handleSpeechTextSetting: function (event) {
                const self = this;
                if (event == 'size_increase') {
                    self.subtitleSetting.fontSize += 2;
                    self.setCookie('SubtitleSettingfontSize',self.subtitleSetting.fontSize,30);
                    $RealTimeASR.setTranscriptSize(0, self.newSubtitleFullScreen);
                }
                if (event == 'size_decrease') {
                    self.subtitleSetting.fontSize = self.subtitleSetting.fontSize - 2;
                    self.setCookie('SubtitleSettingfontSize',self.subtitleSetting.fontSize,30);
                    $RealTimeASR.setTranscriptSize(0, self.newSubtitleFullScreen);
                }
                if (event == 'opacity') {
                    self.setCookie('SubtitleSettingBackgroundOpacity',self.subtitleSetting.backgroundOpacity,30);
                }
                if (event == 'pip') {
                    self.setCookie('SubtitleSettingPIP',self.subtitleSetting.pip,30);
                    self.subtitleSetting.pip = (self.getCookie('SubtitleSettingPIP').toLowerCase() === "true");
                }
            },
            changeSpeechPosition: function() {
                const self = this;
                self.subtitleSetting.fixPosition = (self.subtitleSetting.fixPosition != 50) ? 50 : self.showSpeechHeight.fixPosition;
            },
            maintainSamePronunciation: function() {
                $('#samePronunciationMaintain').modal('show');
            },
            editSamePronunciation: function(obj) {
                const self = this;
                const selection = window.getSelection(); // 獲取當前的選取內容
                if (!selection.toString()) {
                    return;
                }
                self.same_pronunciation_edit = {};
                self.fromSamePronunciation = "";
                self.toSamePronunciation = "";
                let _t = "";
                if (obj.detectLang == 'zh') {
                    _t = obj.zh2zh.replaceAll("<s>", "").replaceAll("</s>", "").replaceAll("<strong>", "").replaceAll("</strong>", "").replace(/<span class='owner-tag' title='[^']*'>/g, '').replace(/<span class='owner-tag border-bottom' title='[^']*'>/g, '').replaceAll("<span style='color: #f58080;'>", "").replaceAll("<span style='color: #ffa961;'>", "").replaceAll("</span>", "");
                }
                else {
                    _t = obj.zh2en.replaceAll("<s>", "").replaceAll("</s>", "").replaceAll("<strong>", "").replaceAll("</strong>", "").replace(/<span class='owner-tag' title='[^']*'>/g, '').replace(/<span class='owner-tag border-bottom' title='[^']*'>/g, '').replaceAll("<span style='color: #f58080;'>", "").replaceAll("<span style='color: #ffa961;'>", "").replaceAll("</span>", "");
                }
                self.same_pronunciation_edit.result = _t;
                self.fromSamePronunciation = selection.toString();
                self.same_pronunciation_edit.show_result = _t;

                $('#samePronunciation').modal('show');
            },
            saveSamePronunciation: async function() {
                const self = this;
                if (self.same_pronunciation_edit.from && self.same_pronunciation_edit.to) {
                    let formData = new FormData();
                    formData.append('word_from', self.same_pronunciation_edit.from);
                    formData.append('word_to', self.same_pronunciation_edit.to);
                    formData.append('word_type', "共同");
                    formData.append('word_deptids', self.currUser.deptId);
                    formData.append('create_empid', self.currUser.empId);
                    formData.append('word_empid', self.currUser.empId);
                    if (self.countWords(self.same_pronunciation_edit.from) > 1 && self.countWords(self.same_pronunciation_edit.to) > 1)
                        self.callARGAddToWord(formData);

                    let _w = self.same_pronunciation_edit.result.replaceAll(self.same_pronunciation_edit.from, self.same_pronunciation_edit.to);
                    self.sendInputMsg(_w, 'edit');
                }
                $('#samePronunciation').modal('hide');
            },
            handleNewSubtitleScroll: function (event) {
                const self = this;
                // detect scrollbar is active
                self.newSubtitleScrollBarIsActive = (self.$refs[self.currTransTab].scrollHeight > self.$refs[self.currTransTab].clientHeight) ? true : false;
                // detect scroll to bottom
                if (event == 'scroll' && self.newSubtitleScrollBarIsActive) {
                    const container = self.$refs[self.currTransTab];
                    const currentScrollTop = container.scrollTop;
                    if (currentScrollTop < this.lastScrollTop) {
                        clearTimeout(self.scroll_timeout);
                        self.scrollCount++;
                        if (self.scrollCount > 3) {
                            self.newSubtitleScrollEvent = true;
                        }
                        self.scroll_timeout = setTimeout(function () {self.scrollCount = 0;}, 3000);
                    }
                    else {
                        const scrollPosition = container.scrollTop + container.clientHeight;
                        const bottomPosition = container.scrollHeight - 20;
                        if (scrollPosition >= bottomPosition) {
                            self.newSubtitleScrollEvent = false;
                        }
                    }
                    this.lastScrollTop = currentScrollTop <= 0 ? 0 : currentScrollTop;
                }
                //scroll to bottom
                if (event == 'to_bottom') {
                    self.newSubtitleScrollEvent = false;
                    self.$refs[self.currTransTab].scrollTo(0, self.$refs[self.currTransTab].scrollHeight);
                }
                //scroll to bottom from add msg
                if (event == 'add_msg' && !self.newSubtitleScrollEvent) {
                    self.newSubtitleScrollEvent = false;
                    self.$refs[self.currTransTab].scrollTo(0, self.$refs[self.currTransTab].scrollHeight);
                }
            },
            isFullScreen0: function () { // for translate(avoid chrome fullscreen.js excption impact)  
                const fullScreenElement = document.fullscreenElement
                    || document.webkitFullscreenElement
                    || document.mozFullScreenElement
                    || document.msFullscreenElement
                    || null;

                if (fullScreenElement === null) return false;
                return true;
            },
            getChromeVersion: function () {
                let raw = navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./);
                return raw ? parseInt(raw[2], 10) : false;
            },
            deviceInfo: function () {
                const self = this;

                return { hasCamera: DetectRTC.hasWebcam };
            },
            SortOnlineUsers: function () {
                const self = this;
                let new_onlineUsers;
                //default = 0 ->按照displayName
                if (self.isonlineUsersSort == 0) {
                    //this.colColneArry(self.onlineUsers,self.onlineUsers_b);
                    //self.onlineUsers_b = self.onlineUsers;
                    self.onlineUsers_b = [];
                    self.onlineUsers.forEach(x => {
                        self.onlineUsers_b.push(x);
                    });

                    self.isonlineUsersSort = 1;
                    //sort
                    let new_onlineUsers = self.onlineUsers.sort(function (a, b) {
                        return a.displayName > b.displayName ? 1 : -1;
                    });
                    self.onlineUsers = new_onlineUsers;
                }
                else if (self.isonlineUsersSort == 1) //排序->反排序
                {
                    self.isonlineUsersSort = 2;
                    let new_onlineUsers = self.onlineUsers.sort(function (a, b) {
                        return a.displayName < b.displayName ? 1 : -1;
                    });
                    self.onlineUsers = new_onlineUsers;
                }
                else if (self.isonlineUsersSort == 2)//回復正常
                {
                    //self.onlineUsers = self.onlineUsers_b;
                    //ColneArry(self.onlineUsers_b,self.onlineUsers);
                    new_onlineUsers = [];
                    self.onlineUsers_b.forEach(x => {
                        new_onlineUsers.push(x);
                    });
                    self.isonlineUsersSort = 0;
                    self.onlineUsers = new_onlineUsers;
                }
                //console.log('after', self.onlineUsers);
                //console.log('old', self.onlineUsers_b);
                //self.onlineUsers = new_onlineUsers;
                // return onlineUsers;
            },
            closeKMSEndPointBeforeExit: function () {
                const self = this;

                try {
                    //check 如果有人正在直播桌面 離開前要關閉endpoint              
                    if (kmsViewClient) {

                        if (kmsViewClient.endPoint) {
                            kmsViewClient.endPoint.release();
                            kmsViewClient.endPoint = null;
                            kmsViewClient = null;
                        }
                        if (kmsViewWebRtcPeer) {
                            kmsViewWebRtcPeer.dispose();
                            kmsViewWebRtcPeer = null;
                        }
                    }
                    let sp_others = self.onlineSpeakers.filter(x => x.userId != self.currUser.userId);
                    //check 如果有人正在發言 離開前也要關閉endpoint
                    for (x = 0; x < sp_others.length; x++) {

                        let sp_other = sp_others[x];
                        try {
                            //console.log("releaseSpeakerConn ==>",sp_others.displayName);

                            if (sp_other.endPoint) {
                                sp_other.endPoint.release();
                                sp_other.endPoint = null;
                            }
                            if (sp_other.webRtcPeer) {
                                sp_other.webRtcPeer.dispose();
                                sp_other.webRtcPeer = null;
                            }

                        } catch (e) { console.log(e) }
                    }

                    let sp = self.onlineSpeakers.filter(x => x.userId == self.currUser.userId);
                    //check 自己是否發言
                    if (sp.length > 0) {
                        self.releaseSpeakerConn(sp[0]);

                        if (self.isHolo)
                            holoStop(self.isHoloUnity);
                        else
                            kmsStop();
                        if (self.pinWebcamInfo.isShow) {
                            //if(!self.isHoloUnity){ //避免HoloLens Unity.Edage X關閉. 後送stopkmsWebCam影響startview
                            send("stopkmsWebCam#" + self.currUser.empId + "#false");
                            $VM.writeLog("使用者操作", `[DISPLAYNAME] ${self.$t('lan-his-webcam-live-off')} @closeKMSEndPointBeforeExit`);
                            //}
                        }
                    }
                    self.userState_DashB_clearLive();
                    self.userState_DashB_clearSpeak();

                } catch (e) { console.log(e) }

            },
            onbeforeunload: function () {
                const self = this;
                try {
                    self.closeKMSEndPointBeforeExit();

                    if (self.isDuplicateLogin) {
                        //add 2020/10/22 4:代表重複登入，告訴後端api不要傳給smartpanel離開會議室                       
                        SetJoinStatus(self.currUser.uid, 4);
                    }
                    else {
                        SetJoinStatus(self.currUser.uid, 0);
                    }

                    sleepAWhile(1000);
                } catch (err) {
                    console.log(err);
                }
            },
            keydownDetect: function (e) {
                const self = this;
                // F5
                if ((e.which || e.keyCode) == 116) {
                    e.preventDefault();
                }
                // ctrl + M
                if(e.ctrlKey && (e.which || e.keyCode) == 77) { 
                    self.handleMic('updateMic');
                }
            },
            checkSpeakerAllvideoStateReturnBool: function (speaker) {
                const self = this;
                if (self.onlineUsers.length > 0) {
                    let onUser = self.onlineUsers.filter(x => x.userId == speaker.userId);
                    if (onUser.length == 0) {
                        return true;
                    }
                    else if (onUser.length > 0 && onUser[0].connectionState == '')//表非自已沒有發言
                    {
                        return true;
                    }
                    else if (onUser.length > 0 && onUser[0].connectionState != '') //自已有發言
                    {
                        if (onUser[0].connectionState == 'connected') {
                            if (['canplay', 'play', 'new'].includes(speaker.videoState))
                                return true;
                            else
                                return false;
                        }
                    }
                    return false;
                }
                return false;
            },
            checkcannotListenToMe: function (speaker) {
                const self = this;
                if (self.onlineUsers.length > 0) {
                    let onUser = self.onlineUsers.filter(x => x.userId == speaker.userId);
                    if (onUser.length > 0 && onUser[0].connectionState == '')//表非自已沒有發言
                    {
                        return false;
                    }
                    else if (onUser.length > 0 && onUser[0].connectionState != '') //自已有發言
                    {
                        if (onUser[0].connectionState == 'connected')
                            return false;
                        else
                            return true;
                    }
                }
                return false;
            },
            checkSpeakerAllvideoState: function (speaker) {
                const self = this;
                if (self.onlineUsers.length > 0) {
                    let onUser = self.onlineUsers.filter(x => x.userId == speaker.userId);
                    if (onUser.length > 0 && onUser[0].connectionState == '')//表非自已沒有發言
                    {
                        return speaker.videoState;
                    }
                    else if (onUser.length > 0 && onUser[0].connectionState != '') //自已有發言
                    {
                        if (onUser[0].connectionState == 'connected') {
                            if (['canplay', 'play',].includes(speaker.videoState))
                                return 'play';
                            else if (['interrupt'].includes(speaker.videoState))
                                return 'interrupt';
                            else
                                return 'loadstart';
                        }
                    }
                    return 'loadstart';
                }
                return 'loadstart';
            },
            isAuthViewLive: function () { //是否有權限看直播
                const self = this;
                let _isAuth = false;
                try {
                    if (self.currUser.userType == 'M') {
                        _isAuth = true;
                    } else { //內部人員
                        if (CONFIG.isExternal) {  //mPortal
                            if (self.isShareVideoHolo || self.isShareVideoHoloII) {  //Hololens直播中
                                _isAuth = self.currUser.authViewHololensLive;
                            } else {
                                if (self.isMobileAny) {
                                    _isAuth = self.currUser.authMobileViewLive;
                                } else {
                                    _isAuth = self.currUser.authPCViewLive;
                                }
                            }
                            if (self.isSecret()) {
                                if (self.currUser.authSecretViewLive) { //機敏會議白名單
                                    _isAuth = true;
                                }
                                else {
                                    _isAuth = false;
                                }
                            }
                        } else {
                            if (self.isSecret()) {
                                _isAuth = false;
                                //if (self.isSecretSM() && self.isSmartPanelOn){ //機敏會議:check SmartPanel ver & On/Off                                 
                                if (self.isSmartPanelOn) { //機敏會議:check SmartPanel On/Off                                                                 
                                    _isAuth = true;
                                } else {
                                    //mark by vic 2023/01/03 機敏會議沒啟動smartpanel也先給他看                                
                                    //if (self.currUser.authSecretViewLive){ //機敏會議白名單
                                    _isAuth = true;
                                    //}                
                                }
                            } else {
                                _isAuth = true;
                            }
                        }
                    }
                    return _isAuth;
                } catch (err) {
                    console.log(err);
                    return _isAuth;
                }
            },
            isSecret: function () {  //機敏會議
                const self = this;
                return self.roomInfo.isSecret;
            },
            SecretDetect: function () {  //30秒waiting
                const self = this;
                if (!self.isSmartPanelOn) {
                    setTimeout(() => {
                        if ($VM.isShareVideo_0) {
                            console.log("~~10 sec:doInvokeSmartPanel~~");
                            //$VM.doInvokeSmartPanel(true); //mark by vic 2024/01/03 
                        }
                    }, 10 * 1000);
                }
                if (SecretDetectInterval) clearInterval(SecretDetectInterval);
                SecretDetectInterval = setInterval(() => {
                    $VM.isSecretDetectDelay = true;
                }, (CONFIG.SecretDetectTime ?? 30 * 1000));
            },
            dynamicDisplayNameCss: function (speaker) {
                const self = this;
                if (self.currUser.userId != speaker.userId) {
                    if (self.isShareVideoLocalKMSWebCam || //自己正在雙鏡頭直播
                        self.isShareVideoLocalKMS || //自已正在桌面直播
                        self.isShareVideoLocalWebCam || //自己正在視訊直播                       
                        self.videoInfo.isKMS) //別人正在桌面直播或正在雙鏡頭直播
                    {
                        return 'margin-left:-24px;';
                    }
                    else
                        return '';
                }
                else
                    return '';

            },
            //頭貼
            dynamiceFrameSize: function (_isSelf) {
                const self = this;
                let width = 320;
                let height = 180;
                self.resizeWindow();
                if (self.oDetectDevice.isMobileAny) {
                    return `width:32vw;height:60px;margin:2px;border-radius:10px;contain:strict;background-color:white;overflow-y:scroll;`;
                }
                //有人桌面分享
                if ((self.isShareVideo || self.isShareVideo_0 || (self.pinWebcamInfo.empId) || (self.pinWebcamInfo.isShow) || (self.pinWebcamInfoManual.isShow) || self.isWhiteboardEnable) && !self.isShowPIP) {
                    width = width * .5;
                    height = height * .5
                    return `width:${width}px;height:${height}px;margin: 2px; border-radius:10px ;contain: strict; } ;background-color:white;`
                }
                else {
                    if (self.onlineSpeakers.length > 0) {
                        if ($(".kurentovideoInput").length > 0) {
                            self.heightOffset = $(".kurentovideoInput")[0].offsetWidth / 1.76;
                        } else if ($(".kurentovideovideoViewer").length > 0) {
                            self.heightOffset = $(".kurentovideovideoViewer")[0].offsetWidth / 1.76;
                        }
                    }

                    if (self.isShowList) {
                        return `width:32.7%;height:${self.heightOffset}px;margin: 2px; border-radius:10px ;contain: strict; } ;background-color:white;`
                    } else {
                        return `width:33.0vw;height:${self.heightOffset}px;margin: 2px; border-radius:10px ;contain: strict; } ;background-color:white;`
                    }
                }
            },
            //三個BAR
            dynamiceFrameSizeTool: function (_isSelf) {
                const self = this;
                let width = 320;
                let height = 180;
                let heightOffset = 180;
                self.resizeWindow();
                if (self.oDetectDevice.isMobileAny) {
                    return `width:32vw;height:60px;margin:2px;border-radius:10px;contain:strict;${_isSelf ? 'border: 2px solid red' : 'border: 1px solid gray'};`;
                }

                //有人桌面分享                
                if ((self.isShareVideo || self.isShareVideo_0 || (self.pinWebcamInfo.empId) || (self.pinWebcamInfo.isShow) || (self.pinWebcamInfoManual.isShow) || self.isWhiteboardEnable) && !self.isShowPIP) {
                    width = width * .5;
                    height = height * .5
                    return `width:${width}px;height:${height}px;margin: 2px; border-radius:10px ;contain: strict; ${_isSelf ? 'border: 2px solid red' : 'border: 1px solid gray'} ;`
                }
                else {
                    if (self.onlineSpeakers.length > 0) {
                        if ($(".kurentovideoInput").length > 0) {
                            self.heightOffset = $(".kurentovideoInput")[0].offsetWidth / 1.76;
                        } else if ($(".kurentovideovideoViewer").length > 0) {
                            self.heightOffset = $(".kurentovideovideoViewer")[0].offsetWidth / 1.76;
                        }
                    }

                    if (self.isShowList) {
                        return `width:32.7%;height:${self.heightOffset}px;margin: 2px; border-radius:10px ;contain: strict; ${_isSelf ? 'border: 2px solid red' : 'border: 1px solid gray'} ;`;
                    } else {
                        return `width:33.0vw;height:${self.heightOffset}px;margin: 2px; border-radius:10px ;contain: strict; ${_isSelf ? 'border: 2px solid red' : 'border: 1px solid gray'} ;`;
                    }
                }
            },
            speakerdisplayName: function (speaker) {
                const self = this;
                try {
                    if (self.onlineUsers.filter(x => x.empId == speaker.userId && x.titleWithConfig).length > 0) {
                        return self.onlineUsers.filter(x => x.empId == _empid && x.titleWithConfig)[0].titleWithConfig;
                    }
                    else if (self.currUser.userId == speaker.userId) {
                        return speaker.displayName;
                    }
                    else {
                        return speaker.displayName;
                    }

                }
                catch {
                    return speaker.displayName;
                }
            },
            isUsing: function (_empid) {
                const self = this;
                return self.onlineSpeakers.filter(x => x.userId == _empid && x.isUsing == true).length > 0;
            },
            // getSrcUrl:function(_empid){ 
            //     const self = this;
            //     return self.onlineSpeakers.filter(x=>x.userId==_empid && x.isUsing ==true)[0].srcUrl;
            // },            
            micUser: function (n) {
                const self = this;
                let mic = self.micList.filter(x => x.micId == n);
                if (mic.length == 0) return {};
                else {
                    return mic[0];
                }

            },
            hasMic: function () {
                const self = this;
                let mic = self.micList.filter(x => x.empId == self.currUser.empId);
                if (mic.length == 0) return false;
                else {
                    return true;
                }
            },
            //視窗縮放
            resizeWindow: function () {
                try {
                    const self = this;
                    //載入+resize時加浮水印
                    //add 2021/01/25 判斷如果有人在桌面直播，浮水印要增加誰正在直播
                    if (self.videoInfo.isKMS) {
                        let shareUser = self.onlineUsers.filter(x => x.empId == self.videoInfo.empid);
                        if (shareUser && shareUser[0] && shareUser[0].email) {
                            //let wu=`${shareUser[0].email}`+self.$t('lan-header-desktop');
                            let wu = `${shareUser[0].email}` + self.$t('lan-header-desktop-brief');
                            watermark({ watermark_user: wu + ' ' + window.params.username, watermark_parent: "divWaterMark", isFullScreen: self.isFullScreen });
                        }
                    }
                    else {
                        watermark({ watermark_user: window.params.username, watermark_parent: "divWaterMark", isFullScreen: self.isFullScreen });
                    }
                    //resize canvas
                    let canvas = document.getElementById("sharingVideoCanvas");
                    if (((self.videoInfo.id != null) && ((!self.isShareVideoLocalWebRTC && !self.isShareVideoLocalKMS) || self.isShareVideoLocalKMSWebCam || self.ckDispalyMyVideo))
                        || self.isShareVideoLocalImage || self.isShareVideoImage) {
                        if (!(self.isShareVideoLocalImage || self.isShareVideoImage)) {
                            let video = document.getElementById("sharingVideoTag");
                            canvas.width = video.videoWidth;
                            canvas.height = video.videoHeight;
                        } else {
                            let _image = document.getElementById("sharingImageTag");
                            // canvas.width = _image.clientWidth;
                            // canvas.height = _image.clientHeight;        
                            canvas.width = _image.naturalWidth;
                            canvas.height = _image.naturalHeight;
                        }
                        canvas.style.zIndex = 500;
                    }
                    else {
                        canvas.width = document.getElementById("videos-container").clientWidth;
                        canvas.height = 200;
                        if (self.onlineSpeakers.length <= 0 || self.isWhiteboardEnable)
                            canvas.style.zIndex = -999;
                        else
                            canvas.style.zIndex = 100;
                    }
                    setTimeout(() => {
                        if (self.onlineSpeakers.length > 0) {
                            if ($(".kurentovideoInput").length > 0) self.heightOffset = $(".kurentovideoInput")[0].offsetWidth / 1.76;
                            else if ($(".kurentovideovideoViewer").length > 0) self.heightOffset = $(".kurentovideovideoViewer")[0].offsetWidth / 1.76;
                        }

                        //調整白板大小
                        var wbiframe = document.getElementById('wbiframe');
                        wbiframe.height = wbiframe.clientWidth * 0.75;
                    }, 250);

                    //add by vic 20240223 for 逐字稿的高度動態計算
                    let scriptHeight = $('.list-transcript-height').height(); //逐字稿的高
                    let scriptY = $('.list-transcript-height')[0].getBoundingClientRect().y;//逐字稿的y座標
                    let _reelTimeDivHeight = 0;
                    if ($('#real-time-content').height()) {
                        _reelTimeDivHeight = $('#real-time-content').height();
                        //$('#real-time-content').css({'bottom': `${_toolHeight}px`});
                        $('#real-time-content').css({'bottom': `0px`});
                        switch (self.subtitleSetting.realTimePosition) {
                            case 'real-div':
                                $("#real-time-content").width($("#real-div").width());
                                $("#real-iframe-hover").width($("#real-div").width());
                                $("#real-iframe-hover").height($('#real-time-content').height());
                                break;
                            case 'real-div-subtitle-full':
                                $("#real-time-content").width($("#real-div-subtitle-full").width());
                                break;
                        }
                        self.changeRealTimeDiv();
                    }
                    //add by vic 2024/02/27 panelright
                    let panelright_height = $('body').height();
                    $('#panelright').height(panelright_height - $('#panel-tab').height() - $('#nav-bar').height() - 30);
                    //算全螢幕/非全螢幕逐字的高度
                    //let transScriptTop = $('.list-transcript-height')[0].getBoundingClientRect().top;
                    let transScriptTop = $('#emoji').height() + $('#listdivNew').height() + $('#text-tool').height() + $('#panel-tab').height() + $('#nav-bar').height() + 10;
                    let _toolHeight = $('#lan_speech_setting')[0].getBoundingClientRect().height + 5;
                    let windowInnerHeight = window.innerHeight;
                    let mHeight = windowInnerHeight - transScriptTop - _toolHeight;
                    if (self.newSubtitleFullScreen) mHeight = windowInnerHeight - $('#text-tool').height() - _toolHeight - _reelTimeDivHeight + 15;
                    $('.list-transcript-height').height(mHeight);
                    $('.list-transcript-inner-height').height(mHeight);
                    //console.log(window.innerWidth);//1024
                    self.handleNewSubtitleScroll('detect');
                } catch (e) { console.log(e) }
            },
            changeRealTimeDiv: function() {
                const self = this;
                if (self.newSubtitleFullScreen) {
                    if (self.subtitleSetting.realTimePosition != "real-div-subtitle-full") {
                        self.subtitleSetting.realTimePosition = "real-div-subtitle-full";
                        const target = document.getElementById("real-div-subtitle-full");
                        const iframeContainer = document.getElementById("real-time-content");
                        if (target && iframeContainer) {
                            iframeContainer.style.position = "absolute";
                            target.appendChild(iframeContainer);
                        }
                        self.resizeWindow();
                    }
                }
                else {
                    const target = document.getElementById("real-div");
                    const iframeContainer = document.getElementById("real-time-content");
                    const iframeHover = document.getElementById("real-iframe-hover");
                    if(self.subtitleSetting.realTimePosition != "real-div") {
                        self.subtitleSetting.realTimePosition = "real-div";
                        if (target && iframeContainer) {
                            target.appendChild(iframeContainer);
                        }
                        $RealTimeASR.setTranscriptSize(0, self.newSubtitleFullScreen);
                    }
                    if (window.innerWidth >= 1024) {
                        iframeContainer.style.position = "fixed";
                        iframeHover.style.position = "fixed";
                        iframeHover.style.bottom = "0";
                    }
                    if (window.innerWidth < 1024) {
                        iframeContainer.style.position = "unset";
                        iframeHover.style.position = "absolute";
                        iframeHover.style.bottom = "auto";
                    }
                }
            },
            //直播者 開啟視訊
            // clickDispalyMyWebCam:function(){
            //     const self = this;
            //     //self.ckDispalyMyWebCam = !self.ckDispalyMyWebCam;
            //     startcamera();
            //     // if(self.ckDispalyMyWebCam){

            //     // }
            //     // else{
            //     //     stopcamera();
            //     // }
            // },
            // clickStopMyWebCam:function(){
            //     const self = this;
            //     self.ckDispalyMyWebCam =false;
            //     stopcamera();
            // },
            clickDispalyMyVideo: function () {
                const self = this;
                //console.log("current:",self.ckDispalyMyVideo);
                self.ckDispalyMyVideo = !self.ckDispalyMyVideo;

                let canvas = document.getElementById("sharingVideoCanvas");
                if (self.ckDispalyMyVideo == true) {
                    //當 直播/分享者 打開"顯示畫面" 才在video上顯示canvas
                    if (!(self.isShareVideoLocalImage || self.isShareVideoImage)) {
                        let video = document.getElementById("sharingVideoTag");
                        canvas.width = video.videoWidth;
                        canvas.height = video.videoHeight;
                    } else {
                        let _image = document.getElementById("sharingImageTag");
                        // canvas.width = _image.clientWidth;
                        // canvas.height = _image.clientHeight;     
                        canvas.width = _image.naturalWidth;
                        canvas.height = _image.naturalHeight;
                        //image ori size .naturalWidth/.naturalHeight                   
                    }
                    canvas.style.zIndex = 500;
                    $("#sharingVideoCanvas").prependTo($("#mediaBox"));
                    self.clickLaserPen(true);
                }
                else {
                    canvas.width = document.getElementById("videos-container").clientWidth;
                    canvas.height = 200;
                    if (self.onlineSpeakers.length <= 0)
                        canvas.style.zIndex = -999;
                    else
                        canvas.style.zIndex = 100;
                    $("#sharingVideoCanvas").prependTo($("#videos-container"));
                    self.clickLaserPen(false);
                    self.isFullScreenDiscuss = false;
                }
            },
            checkCanvasDispaly: function () {
                const self = this;
                let canvas = document.getElementById("sharingVideoCanvas");

                if (self.onlineSpeakers.length <= 0)
                    canvas.style.zIndex = -999;
                else
                    canvas.style.zIndex = 100;

            },


            letUserMute: function (user) {
                const self = this;
                videoConference.webrtc.functions.askTomute(user.uid, user.deptId + "/" + user.name)
            },
            clickLaserPen: function (_state) {
                const self = this;
                self.headerBar.isLaserPenClicked = _state;
                self.cvsBoard.isDrawLaserPen = _state;
                self.cvsBoard.penType = (self.headerBar.isLaserPenClicked) ? "l" : "";
                this.cvsBoard.changeCursorColor(_state); //canvas顯示投影筆-畫筆(cursor>img)
                if (!_state) this.cvsBoard.clearPenData();
            },
            clickRecordSwitch: function () {
                const self = this;
                //to do check可以按此鈕的權限 MeetingInvtate, 在api提供之前, 先寫config或是寫這裡測
                if (!CONFIG.kmsRecord.switchRecordEmps.includes(self.currUser.empId)) {
                    alert(self.$t("lan-notify-recording-noright"));
                    return;
                }

                //self.onlineUsers.forEach((u) =>{
                //    console.log("ttt each user=" + u.userId);
                //});
                //check外部人員還在會議中, 不可停止錄影
                let _user = self.onlineUsers.filter(x => x.userType == "M");
                //console.log("length=" + _user.length + ", isRecordSwitchOn=" + self.isRecordSwitchOn);
                if (_user && _user.length > 0 && self.isRecordSwitchOn) {
                    alert(self.$t("lan-notify-recording-close"));
                    return;
                }

                //若尚未有stream可以錄, 先押成true, 待直播或是發言有stram時再錄
                self.isRecordSwitchOn = !self.isRecordSwitchOn;
                send("kmsRecordSwitch#" + self.currUser.empId + "#" + self.isRecordSwitchOn); //通知大家啟動/關閉錄影
                self.selfRecordSwitch(self.isRecordSwitchOn);
                //console.log("clickRecordSwitch self.isRecordSwitchOn=" + self.isRecordSwitchOn);
                if (self.isRecordSwitchOn) {
                    self.appendHistory("record", `[DISPLAYNAME] ${self.$t('lan-his-recording-on')}`, true);
                    $VM.writeLog("事件", `[DISPLAYNAME] 啟動會議錄影`);
                }
                else {
                    self.appendHistory("stoprecord", `[DISPLAYNAME] ${self.$t('lan-his-recording-off')}`, true);
                    $VM.writeLog("事件", `[DISPLAYNAME] 關閉會議錄影`);
                }

            },
            TriggerRecordSwitchON: function () {  // 2021/10/15 居家人員加入會議須強制啟動錄影
                const self = this;
                //self.onlineUsers.forEach((u) =>{
                //    console.log("ttt each user=" + u.userId);
                //});
                //若尚未有stream可以錄, 先押成true, 待直播或是發言有stram時再錄
                if (!self.isRecordSwitchOn) {
                    self.isRecordSwitchOn = true;
                    self.selfRecordSwitch(self.isRecordSwitchOn);
                    $VM.writeLog("事件", `[DISPLAYNAME] 啟動會議錄影`);
                }
            },
            selfRecordSwitch: function (_isRecordSwitchOn) {
                const self = this;
                self.isRecordSwitchOn = _isRecordSwitchOn;
                try {
                    if (self.isRecordSwitchOn) {
                        CONFIG.kmsRecord.record = CONFIG.kmsRecord.recordWebcam = CONFIG.kmsRecord.recordEnvcam = true; // 錄影中 overwrite Config.kmsRecord                        
                        if (typeof (kmsRecordNewStart) == typeof (Function)) kmsRecordNewStart(); //VD/VE record start
                        //AO record new start
                        if (self.onlineSpeakers) {
                            //console.log("onlineSpeaker Count=" + self.onlineSpeakers.length + ", currUser=" + self.currUser.userId);
                            let sp = self.onlineSpeakers.filter(x => x.userId == self.currUser.userId)[0];
                            if (sp) {
                                //console.log("sp userid=" + sp.userId + ",isMute=" + sp.isMute + ", isRecordingAudio=" + sp.isRecordingAudio);
                                if (!sp.isRecordingAudio && !sp.isMute) {
                                    kurentoRecordNewAudio(sp); //create a new recorder
                                }
                            }
                        }
                    }
                    else {
                        if (typeof (kmsRecordStop) == typeof (Function)) kmsRecordStop();
                        if (self.onlineSpeakers) {
                            //console.log("onlineSpeaker Count=" + self.onlineSpeakers.length);
                            let sp = self.onlineSpeakers.filter(x => x.userId == self.currUser.userId)[0];
                            if (sp) {
                                //console.log("sp userid=" + sp.userId + ",isMute=" + sp.isMute + ", isRecordingAudio=" + sp.isRecordingAudio);
                                if (sp.isRecordingAudio) {
                                    sp.recorderAudio.stop();
                                    sp.recorderAudio = null;
                                    sp.isRecordingAudio = false;
                                }
                            }

                        }
                    }
                } catch (ex) { console.log(ex) }
            },
            restartSpeak: function() {
                const self = this;
                self.handleMic('releaseMicNoConfirm');
                // self.handleMic('updateMic');
                setTimeout(() => {
                    self.handleMic('updateMic');
                }, 1000);
            },
            clickReconnect: function () {
                //重連
                const self = this;
                try {

                    //check 如果有人直播桌面 離開前也要關閉endpoint
                    self.closeKMSEndPointBeforeExit();

                    window.alert(self.$t("lan-reconnect"));
                    location.reload(true);
                }
                catch (ex) { console.log(ex) }

            },
            clickExitRoom: function () {
                const self = this;

                self.oNotify.ConfirmCustomMsg(self.$t("lan-notify-exit"), "", [
                    {
                        text: self.$t("lan-notify-yes"),
                        click: () => {
                            try {
                                //check 如果有人直播桌面 離開前也要關閉endpoint
                                self.closeKMSEndPointBeforeExit();

                                // if (connection.kms.kmsId) {
                                //     if (connection.kms.kmsUserid == connection.userid)
                                //         self.kmsStopClick();
                                // }


                            } catch (e) { console.log(e) }
                            //send("exitroom#" + connection.userid + "#true");
                            //多呼叫API一次,降低沒更新狀態成功的問題
                            //SetJoinStatus(self.currUser.uid, 0);
                            //window.close();
                            window.location.replace("logout.html");

                        },
                    },
                    {
                        text: self.$t("lan-notify-no"),
                        // click:()=>{ videoConference.webrtc.functions.shareMyScreen(isForceWebRTC)},
                        addClass: "btn-danger",
                    }
                ]);
            },
            clickWhiteboard: function (isUserRequest = false) {
                const self = this;
                try {
                    if (isUserRequest) {
                        //有人桌面分享中 且 為觀看者 => 可發request
                        let _currUserInfo = (self.currUser.deptId) ? `${self.currUser.deptId}/${self.currUser.name}` : self.currUser.name;
                        let _ev = "";
                        if (self.isShareVideo && (!self.isShareVideoLocalWebRTC && !self.isShareVideoLocalKMS)) {
                            _ev = (self.curWhiteboardUrl == '') ? "request" : "request_stop";
                            self.oNotify.ConfirmCustomMsg(
                                (_ev == "request") ? self.$t("lan-notify-whiteboard-request-on") : self.$t("lan-notify-whiteboard-request-off"), "", [{
                                    text: self.$t("lan-notify-yes"),
                                    click: () => {
                                        send(`WB#${self.currUser.userId}#${JSON.stringify({
                                            ev: _ev, name: _currUserInfo
                                        })}#${self.videoInfo.empid}`);

                                        if (_ev == "request")
                                            self.appendHistory("wb", `[DISPLAYNAME] ${$VM.$t('lan-his-wb-request-on')}`, true);
                                        else
                                            self.appendHistory("wb", `[DISPLAYNAME] ${$VM.$t('lan-his-wb-request-off')}`, true);
                                    },
                                },
                                {
                                    text: self.$t("lan-notify-no"),
                                    addClass: "btn-danger",
                                    click: () => {
                                        //do nothing
                                    }
                                }
                            ]);
                        }
                        else {
                            //發給所有人, 同步start/stop會議共用白板
                            _ev = (self.curWhiteboardUrl == '') ? "user_start" : "user_stop";

                            self.oNotify.ConfirmCustomMsg(
                                (_ev == "user_start") ? self.$t("lan-notify-whiteboard-on") : self.$t("lan-notify-whiteboard-off"), "", [
                                {
                                    text: self.$t("lan-notify-yes"),
                                    click: () => {
                                        send(`WB#${self.currUser.userId}#${JSON.stringify({
                                            ev: _ev, name: _currUserInfo
                                        })}#`);

                                        if (_ev == "user_start") {
                                            self.openMeetingWhiteboard(true);//開啟會議共用白板
                                            self.appendHistory("wb", `[DISPLAYNAME] ${$VM.$t('lan-his-wb-user-on')}`);
                                            $VM.writeLog("使用者操作", `[DISPLAYNAME] 開啟會議共用白板`);
                                        } else {
                                            self.setWhiteboardUrl(false);//關閉共用白板
                                            self.appendHistory("wb", `[DISPLAYNAME] ${$VM.$t('lan-his-wb-user-off')}`);
                                            $VM.writeLog("使用者操作", `[DISPLAYNAME] 關閉會議共用白板`);
                                        }
                                    },
                                },
                                {
                                    text: self.$t("lan-notify-no"),
                                    addClass: "btn-danger",
                                    click: () => {
                                        //do nothing
                                    }
                                }
                            ]);
                        }
                    }
                    else {
                        if (self.isWhiteboardEnable == false) {
                            self.isWhiteboardEnable = true;
                            self.isWhiteboard = true;
                        }
                        else {
                            self.isWhiteboardEnable = false;
                            self.isWhiteboard = false;
                        }
                    }
                    self.resizeWindow();
                }
                catch (ex) { console.log(ex) }
            },
            exportMember: function () {
                const self = this;
                try {
                    loadScript("js/static/xlsx.full.min.js");
                    $VM.oNotify.ConfirmCustomMsg(self.$t("lan-notify-exportmember"), "", [
                        {
                            text: self.$t("lan-notify-yes"),
                            click: () => {
                                const self = this;
                                let result = getParticipants();
                                if (result && result.length > 0) {
                                    let _data = [['部門代碼', '部門名稱', '姓名', 'Email', '工號', '廠區代碼', '分機', '加入時間', '離開時間']];

                                    result.forEach(x => {
                                        let row = [];
                                        row.push(x.deptId);
                                        row.push(x.deptName);
                                        row.push(x.name);
                                        row.push(x.email);
                                        row.push(x.userId);
                                        row.push(x.fabCode);
                                        row.push(x.ext);
                                        row.push(x.joinTime);
                                        row.push(x.leaveTime);
                                        _data.push(row);
                                    });
                                    const workbook = new Workbook();
                                    const sheet = XLS.utils.aoa_to_sheet(_data);
                                    workbook.appendSheet(sheet, '與會人員');
                                    //--to xls
                                    let fileName = `${self.roomInfo.roomId}的與會人員.xls`;
                                    saveAs(workbook.toBlob(), fileName)
                                    //--to xlsx
                                    // let fileName = `${self.roomInfo.roomId}的與會人員.xlsx`;
                                    // var wbout = XLSX.write(workbook, { bookType: 'xlsx', type: 'binary' });
                                    // saveAs(new Blob([s2ab(wbout)], { type: "application/octet-stream" }), fileName)
                                } else {
                                    alert(self.$t("lan-tab-export-nothing"));
                                }
                            },
                        },
                        {
                            text: self.$t("lan-notify-no"),
                            addClass: "btn-danger",
                            click: () => { },
                        },]);
                } catch (ex) {
                    console.log(ex)
                    alert(self.$t("lan-tab-export-failed"));
                }
            },
            doInvokeSmartPanel: function (withNotify = false) {
                const self = this;
                try {
                    if (CONFIG.isExternal || $VM.currUser.userType == 'M') return;
                    console.log("~~~doInvokeSmartPanel~~~");
                    //InvokeSmartPanel();  
                    if (withNotify) {
                        InvokeSmartPanel();
                        // self.oNotify.ConfirmMsg("", self.$t("lan-notify-invoke-smartpanel"));
                        // self.oNotify.ConfirmCustomMsg("", self.$t("lan-notify-invoke-smartpanel"), [{ text: "是",click: ()=>{$VM.doInvokeSmartPanel_uri();}}]);
                        // self.oNotify.ConfirmCustomMsg("", self.$t("lan-warning-smartpanle"), [{ text: self.$t("lan-notify-invoke-smartpanel"), click: () => { InvokeSmartPanel(); } }]);
                    }
                } catch (ex) {
                    console.log(ex)
                }
            },
            doInvokeSmartPanel_uri: function () {
                const self = this;
                console.log("~~~doInvokeSmartPanel_uri~~~");
                try {
                    if (!CONFIG.isExternal && $VM.currUser.userType != 'M') { //內部人員-呼叫 uri scheme的方式啟動smartpanel
                        //window.open("smartpanel:xxxx"); // 會出現已封鎖彈出視窗,需允許才能順利執行
                        //document.getElementById("smartPanel_link").click(); // 會導致page reload之異常
                    }
                } catch (ex) {
                    console.log(ex)
                }
            },
            setWhiteboardUrl: function (isOn, url = "") {
                const self = this;
                try {
                    var wbiframe = document.getElementById('wbiframe');
                    self.curWhiteboardUrl = (isOn && url != "") ? `${url}&username=${self.currUser.name}` : "";
                    wbiframe.src = self.curWhiteboardUrl;

                    self.isWhiteboardEnable = !isOn;
                    self.clickWhiteboard();
                }
                catch (ex) { console.log(ex) }
            },
            openMeetingWhiteboard: function (isOpener = false) {
                // 沒有桌面直播時 預設用roomid開啟共用白版
                const self = this;
                let _url = CONFIG.PWhiteboardBaseUrl + window.params.roomid;
                if (isOpener) _url += "&t=pen";
                self.setWhiteboardUrl(true, _url);
            },
            clickSendMsg: _.throttle(function (e, isemoji = false) {
                const self = this;
                self._clickSendMsg(e, isemoji);
            }, 1000),
            _clickSendMsg: async function (e, isemoji = false) {
                const self = this;
                if (self.userInputMsg === "") {
                    alert(self.$t("lan-tab-empty"));
                    return;
                }
                if (self.userInputMsg.length > 500) {
                    alert(self.$t("lan-tab-500"));
                    return;
                }
                //enter:送出; shift+enter:換行
                if (e instanceof KeyboardEvent) {
                    if (e.shiftKey && e.keyCode == 13) {
                        return;
                    }
                }

                let _t = self.userInputMsg.trim();
                if (isemoji) {
                    if (self.emojilist.indexOf(_t) == -1) {
                        isemoji = false;
                    }
                }
                let _msgObj = {
                    to: [],
                    msg: self.userInputMsg,
                    fromUserName: self.currUser.name,
                    fromUserDept: self.currUser.deptId,
                    //fromDisplayName: self.currUser.displayName,
                    fromDisplayName: self.onlineUserDisplay(self.currUser),
                    'isemoji': isemoji
                };
                self.cvsBoard.barrage.addBarrage({
                    //text: isemoji ? `    #%&${_msgObj.msg}` : `${_msgObj.fromDisplayName}：#%&${_msgObj.msg}`,                      
                    //text: `${_msgObj.fromDisplayName}：#%&${_msgObj.msg}`, //add 2021/02/05 讚、有、無、ok要加上名字
                    text: isemoji ? `${_msgObj.fromUserName}#%&${_msgObj.msg}` : `${_msgObj.fromDisplayName}：#%&${_msgObj.msg}`,
                    speed: 2,
                    fontSize: 16
                });
                _msgObj.msg = encrypt(_msgObj.msg, self.roomInfo.roomId)
                send(`userchat#${connection.userid}#${JSON.stringify(_msgObj)}`);

                if (!isemoji) {
                    self.chatMsgs.push({
                        self: true,
                        msg: self.userInputMsg.replace(/\n/g, "<br>"),
                        sendDate: moment()
                    });
                    saveMeetingMsg(self.currUser.empId, self.currUser.name, _msgObj.msg);
                    if (self.roomInfo.transType == '1' || self.roomInfo.transType == '2' || self.roomInfo.transType == '3') {
                        await self.sendInputMsg(self.userInputMsg, "chat");
                    }
                }
                self.soundEffect("typping");
                self.userInputMsg = '';
            },
            //
            checkisNewUser: function (connectUid, timeStamp) {
                try {
                    const self = this;
                    let isNew = true;
                    if (connectUid && timeStamp) {
                        let _user = self.onlineUsers.filter(x => x.userId === connectUid.substr(0, 6));
                        if (_user && _user.length > 0) {
                            if (_user[0].uid != connectUid) {
                                console.log("currnet online Time: ", _user[0].uid, moment(parseInt(_user[0].timeStamp)).format('MM-DD HH:mm:sss'),
                                    "new online Time:", connectUid, moment(parseInt(timeStamp)).format('MM-DD HH:mm:sss'));
                                isNew = (parseInt(_user[0].timeStamp) - parseInt(timeStamp) < 0) ? true : false;
                                if (isNew) {
                                    _user[0].uid = connectUid;
                                    _user[0].timeStamp = timeStamp;
                                }
                            }
                        }
                    }
                    return isNew;
                } catch (err) {
                    console.log(err);
                }
            },
            //搜尋清單中的某一個人
            filterOnlineUsers: function (emp) {
                try {
                    const self = this;
                    if (emp && emp.uid) {
                        return self.onlineUsers.find(function (element, index, arr) {
                            return (element.uid === emp.uid);
                        });
                    } else if (emp && emp.empId) {
                        return self.onlineUsers.find(function (element, index, arr) {
                            return (element.empId === emp.empId);
                        });
                    }
                } catch (err) {
                    console.log(err);
                }
            },

            insertOnlineUser: function (remoteUser) {
                try {
                    const self = this;
                    remoteUser.raiseHandStatus = -1;
                    let user = self.onlineUsers.filter(x => x.userId == remoteUser.userId)[0];
                    if (user) {
                        user.clientId = remoteUser.clientId;
                        user.connectTime = remoteUser.connectTime;

                    } else {

                        self.onlineUsers_b.push(remoteUser);
                        self.onlineUsers.push(remoteUser);
                        if ($VM.Pteam) self.$nextTick(() => $VM.Pteam.reload());
                    }

                    // self.soundEffect("in");

                    if (remoteUser && remoteUser.displayName) {
                        let _message = `${remoteUser.displayName} ${self.$t('lan-his-join')}`;
                        if (self.historyLogs.filter(x => x.showContent == _message).length == 0)
                            self.soundEffect('in');
                        self.appendHistory("in", _message, false);
                    }
                } catch (err) {
                    console.log(err);
                }
            },
            //清單移除一個人頭
            removeOnlineUser: function (userId) {
                try {
                    const self = this;
                    let remoteUser = self.filterOnlineUsers({ empId: userId });
                    if (remoteUser && remoteUser.displayName) {
                        let _message = `${remoteUser.displayName}${self.$t('lan-his-exit')}`;
                        if (self.historyLogs.filter(x => x.showContent == _message).length == 0)
                            self.soundEffect("out");
                        self.appendHistory("out", _message, false);
                    }

                    let _tmp = self.onlineUsers.filter(function (v, i, a) {
                        return (v.userId != userId)
                    });

                    self.onlineUsers = _tmp;
                    let _tmpb = self.onlineUsers_b.filter(function (v, i, a) {
                        return (v.userId != userId)
                    });
                    self.onlineUsers_b = _tmpb;
                    //========
                    if (self.pinWebcamInfo.empId == userId) {
                        self.unPinWebCam();
                    }
                    let sp = self.onlineSpeakers.filter(x => x.userId == userId);
                    if (sp.length > 0) self.releaseSpeakerConn(sp[0]);
                    let _tmpSpeaker = self.onlineSpeakers.filter(function (v, i, a) {
                        return (v.userId != userId)
                    });
                    self.onlineSpeakers = _tmpSpeaker;
                } catch (err) {
                    console.log(err);
                }
            },
            onlineUserTitleHint(u) {
                const self = this;
                if (u.userType === "M") {
                    return `${u.uid}@${moment(parseInt(u.timeStamp)).format('MM-DD HH:mm')}`;
                } else {
                    return `(ext:${u.fabCode}-${u.ext})${u.uid}@${moment(parseInt(u.timeStamp)).format('MM-DD HH:mm')}`;
                }
            },
            //切換Tab
            changeTab: function (tabIndex) {
                try {
                    const self = this;
                    self.aTabDisplay.fill("none");
                    self.aTabDisplay.splice(tabIndex, 1, "block");
                    if (tabIndex == 3) {
                        // self.saTabDisplay.fill("none");
                        // self.saTabDisplay.splice(0, 1, "block");
                        // if(self.roomInfo.transType && (self.roomInfo.transType == "2" || self.roomInfo.transType == "3"))
                        // self.saTabTitleDisplay = "inline-table";
                    }
                    else {
                        // self.saTabDisplay.fill("none");
                        // self.saTabTitleDisplay = "none";                        
                    }
                    if (tabIndex === 1) self.chatUnreadCnt = 0;
                } catch (err) {
                    console.log(err);
                }
            },
            //切換Translate Tab
            changeTabs: function (tabIndex) {
                try {
                    const self = this;
                    self.saTabDisplay.fill("none");
                    self.saTabDisplay.splice(tabIndex, 1, "block");
                    if (tabIndex === 1) self.chatUnreadCnt = 0;

                    self.$nextTick(function () {
                        switch (tabIndex) {
                            case 0:
                                self.currTransTab = "msgHistory_all";
                                break;
                            case 1:
                                self.currTransTab = "msgHistory_zh";
                                break;
                            case 2:
                                self.currTransTab = "msgHistory_en";
                                break;
                            case 3:
                                self.currTransTab = "msgHistory_debug";
                                break;
                            default:
                                console.log(`Sorry, we are out of ${tabIndex}.`);
                        }
                        if (self.subtitleSetting.fixPosition != 50) {
                            self.subtitleSetting.fixPosition = self.showSpeechHeight.fixPosition;
                        }
                        self.resizeWindow();
                        self.handleNewSubtitleScroll('to_bottom');
                    });
                } catch (err) {
                    console.log(err);
                }
            },
            //popupTips2Speech        
            popupTips2speech: function () {
                const self = this;
                try {
                    if (self.translate_GetLastSpeech != null) {
                        $(".popupTips2Speech").show();
                        setTimeout(function () {
                            $(".popupTips2Speech").hide();
                        }, 5000);
                    }
                } catch (err) {
                    console.log(err);
                }
            },
            //歷程
            appendHistory(iconClass, showContent, sendToOther) {
                try {
                    const self = this;
                    //取代範本
                    let _showContent = showContent.replace("[DEPTID]", self.currUser.deptId);
                    _showContent = _showContent.replace("[NAME]", self.currUser.name);
                    _showContent = _showContent.replace("[DISPLAYNAME]", self.currUser.displayName);
                    _showContent = _showContent.replace("[SOURCE_TYPE]", (self.sourceTypeDisplay(self.currUser.sourceType).remark) ? `(${self.sourceTypeDisplay(self.currUser.sourceType).remark})` : "");
                    //傳送給其他人
                    if (sendToOther) send(`appendHistory#${JSON.stringify({ iconClass: iconClass, showContent: _showContent })}`);
                    //新增一筆歷程
                    let _history = {
                        showTime: moment().format('H:mm:ss'),
                        iconClass: self.aIconClass[iconClass],
                        showContent: _showContent,
                    };
                    self.historyLogs.splice(0, 0, _history);
                } catch (err) {
                    console.log(err);
                }
            },
            //文件分享
            appendShareDocHistory(iconClass, showContent, linkurl, sendToOther) {
                const self = this;
                try {
                    //取代範本
                    let _showContent = showContent.replace("[DEPTID]", self.currUser.deptId);
                    _showContent = _showContent.replace("[NAME]", self.currUser.name);
                    _showContent = _showContent.replace("[DISPLAYNAME]", self.currUser.displayName);
                    //傳送給其他人
                    if (sendToOther) send(`appendShareDocHistory#${JSON.stringify({ iconClass: iconClass, showContent: _showContent, linkurl: linkurl })}`);
                    //新增一筆至最上方
                    let _history = {
                        showTime: moment().format('H:mm:ss'),
                        iconClass: self.aIconClass[iconClass],
                        showContent: _showContent,
                        linkurl: linkurl,
                        fileKind: iconClass
                    };
                    self.shareDocLogs.splice(0, 0, _history);
                    //合併顯示於[交談]
                    self.chatMsgs.push({
                        self: true,
                        msg: _showContent.replace(/\n/g, "<br>"),
                        sendDate: moment(),
                        linkid: self.shareDocLogs.length - 1
                    });
                    //合併於[交談記錄]
                    // if(sendToOther){                         
                    //     let _encryptMsg = encrypt(_showContent,self.roomInfo.roomId)
                    //     saveMeetingMsg(self.currUser.empId, self.currUser.name, _encryptMsg);                    
                    // }

                    //Open window/modal to view doc/image
                    self.openShareDoc(iconClass, linkurl, false);
                } catch (err) {
                    console.log(err);
                }
            },
            //寫LOG
            writeLog(eventType, showContent, targetUid = "") {
                try {
                    const self = this;
                    let targetUserId = "";
                    if (targetUid !== "") {
                        targetUserId = targetUid.substring(0, 6);
                    }
                    //取代範本
                    let _showContent = showContent.replace("[DEPTID]", self.currUser.deptId);
                    _showContent = _showContent.replace("[NAME]", self.currUser.name);
                    _showContent = _showContent.replace("[UID]", self.currUser.uid);
                    _showContent = _showContent.replace("[EMPID]", self.currUser.empId);
                    _showContent = _showContent.replace("[EMAIL]", self.currUser.email);
                    _showContent = _showContent.replace("[DISPLAYNAME]", self.currUser.displayName);
                    let message = `[${eventType}]${_showContent}`;
                    //新增一筆LOG
                    let formData = new FormData();
                    formData.append('platform', self.currUser.sourceType);
                    formData.append('deviceId', self.currUser.deviceId);
                    formData.append('userId', self.currUser.empId);
                    formData.append('sessionId', self.roomInfo.roomId);
                    formData.append('message', message);
                    formData.append('messageTime', moment(Date.now()).format("YYYY/MM/DD HH:mm:ss.SSS"));
                    formData.append('fromUid', self.currUser.uid);
                    formData.append('targetUserID', targetUserId);
                    formData.append('targetUid', targetUid);
                    let url = `${CONFIG.apiUrl}/api/debug/writeLog`;
                    let xhr = new XMLHttpRequest();
                    xhr.open('POST', url, true);
                    xhr.send(formData);
                } catch (err) {
                    console.log(err);
                }
            },
            sourceTypeDisplay: function (sourceType) {
                const self = this;
                switch (sourceType) {
                    case "portalmobile":
                        return { title: `Portal-${self.$t('lan-tab-mobile')}`, css: "fas fa-tablet-alt iconBlue fa-fw", remark: "外網" };
                        break;
                    case "mobile":
                        return { title: `Pteam-${self.$t('lan-tab-mobile')}`, css: "fas fa-tablet-alt iconBlue fa-fw", remark: "手機" };
                        break;
                    case "portalpc":
                        return { title: `Portal-${self.$t('lan-tab-desktop')}`, css: "fas fa-laptop-code iconBlue fa-fw", remark: "外網" };
                        break;
                    case "pc":
                        return { title: `Pteam-${self.$t('lan-tab-desktop')}`, css: "fas fa-laptop-code iconBlack fa-fw", remark: "" };
                        break;
                    case "portalthinclient":
                        return { title: `Portal-ThinClient`, css: "fas fa-laptop-house iconBlue fa-fw", remark: "外網" };
                        break;
                    case "thinclient":
                        return { title: `Pteam-ThinClient`, css: "fas fa-laptop-house iconBlue fa-fw", remark: "外網" };
                        break;
                    case "externalpc":
                        return { title: `External`, css: "far fa-envelope iconBlue fa-fw", remark: "外網" };
                        break;
                    case "holoportal":
                        return { title: `Pteam-${self.$t('lan-tab-holo')}`, css: "fas fa-vr-cardboard iconBlack fa-fw", remark: "" };
                        break;
                    default:
                        return {};
                        break;
                }
            },
            onlineStatusDisplay: function (onlineStatus) {
                const self = this;
                switch (onlineStatus) {
                    case 1:
                        return { title: self.$t('lan-tab-offline'), css: "fas fa-door-open" };
                        break;
                    case 0:
                    default:
                        return { title: self.$t('lan-tab-online'), css: "fas fa-headphones-alt" };
                        break;
                }
            },
            raiseHandStatusDisplay: function (raiseHandStatus) {
                const self = this;
                switch (raiseHandStatus) {
                    case 1:
                        return { title: "同意", css: "fas fa-thumbs-up" };
                        break;
                    // case 0:
                    //     return { title: "舉手", css: "fas fa-thumbs-down" };
                    //     break;
                    case 0:
                    default:
                        return { title: self.$t('lan-tab-agree'), css: "far fa-hand-paper" };
                        break;
                }
            },
            onlineStatusChange: function () {
                this.currUser.onlineStatus = (this.currUser.onlineStatus == 1) ? 0 : 1;
                send("onlineStatus#" + this.currUser.empId + "#" + (this.currUser.onlineStatus));
            },
            raiseHandStatusChangedown: function () {
                const self = this;
                self.raiseHandStatusChange(1);
            },
            raiseHandStatusChangeup: function () {
                const self = this;
                self.raiseHandStatusChange(0);
            },
            raiseHandStatusChange: function (raiseHandStatus) {
                this.currUser.raiseHandStatus = raiseHandStatus;
                send("raiseHandStatus#" + this.currUser.empId + "#" + (this.currUser.raiseHandStatus));
            },
            openSelectEmp: function (event) {
                const self = this;
                self.isSelectEmpShow = true;
                setTimeout(() => {
                    openSelectEmpDialog();
                    self.ajaxEmployeeLoading = false;
                }, 500);
            },
            sendInvite: function (event) {
                const self = this;
                sendInviteClick();
                self.isSelectEmpShow = false;
                self.ajaxEmployeeLoading = true;
            },
            addInviteEmail: function (event) {
                addInviteEmailClick();
            },
            sendClear: function (event) {
                const self = this;
                sendClearClick();

            },
            letUserSignOut: function (user) {
                const self = this;
                let title = user.displayName;

                self.oNotify.ConfirmCustomMsg(self.$t("lan-notify-push", { name: `${title}` }), "", [
                    {
                        text: self.$t("lan-notify-yes"),
                        click: () => {
                            try {
                                $VM.writeLog("使用者操作", `[EMAIL]/[UID] 請${title}退出會議室`);
                                $VM.appendHistory("out", `[DEPTID]/[NAME]${self.$t('lan-his-push', { name: `${title}` })}`, true);
                                send("deletepeer#" + user.userId + "#true");
                                // connection.deletePeer(event.userid);
                            } catch (e) { console.log(e) }
                        },
                    },
                    {
                        text: self.$t("lan-notify-no"),
                        // click:()=>{ videoConference.webrtc.functions.shareMyScreen(isForceWebRTC)},
                        addClass: "btn-danger",
                    }
                ]);

            },
            isFirtstMsg: function (chat, index) {
                const self = this;
                let previousMessage = self.chatMsgs[index - 1];
                if (!previousMessage || previousMessage.userName !== chat.userName)
                    return true;
                else
                    return false;
            },

            videoreadyCallBack: function (event) {
                const self = this;
                let canvas = document.getElementById("sharingVideoCanvas");
                //video event 
                //loadstart ->progress ->loadeddata ->canplay ->play ->playing ->progress
                console.log(event.type);
                switch (event.type) {
                    case "loadstart":
                        //document.getElementById("sharStatus").innerText ="載入中..";
                        self.headerBar.sharStatus = "載入中..";
                        break;
                    case "canplay":
                        // document.getElementById("sharStatus").innerText ="";
                        self.headerBar.sharStatus = "";

                        // 是觀看者才將canvas移動到影片，直播/分享者預設不顯示影片，在外顯示canvas
                        if (!self.isShareVideoLocalWebRTC && !self.isShareVideoLocalKMS || self.isShareVideoLocalKMSWebCam) {
                            canvas.style.zIndex = 500;
                            // control canvas - to inside
                            $("#sharingVideoCanvas").prependTo($("#mediaBox"));
                        }
                        else {
                            $("#sharingVideoCanvas").attr('width', document.getElementById("videos-container").clientWidth);
                            $("#sharingVideoCanvas").attr('height', 200);
                            if (self.onlineSpeakers.length <= 0)
                                canvas.style.zIndex = -999;
                            else
                                canvas.style.zIndex = 100;
                        }
                        break;
                    case "emptied":
                        self.headerBar.sharStatus = "";
                        //  if (!(self.isShareVideo && self.isShareVideoLocalKMS && self.isShareVideoLocalWebRTC)) self.videoInfoclear();
                        break;
                    case "pause":
                        //document.getElementById("sharStatus").innerText ="載入中..";
                        //self.headerBar.sharStatus = "暫停中..";
                        if (self.isFocus) {     // 2021/10/26 iPhone:webkitendfullscreen後會有pause,需trigger play                            
                            if (!self.isHoloArrowActive) // 錨點啟用後暫停video
                                self.videoplay();
                        }
                        break;
                    case "play":
                        //document.getElementById("sharStatus").innerText ="載入中..";
                        self.headerBar.sharStatus = "";
                        $("#sharingVideoCanvas").css('display', '');

                        // 是觀看者才啟用雷射筆，直播/分享者預設不顯示影片，在外顯示canvas&不需雷射筆
                        if ((!self.isShareVideoLocalWebRTC && !self.isShareVideoLocalKMS) || self.isShareVideoLocalKMSWebCam || self.ckDispalyMyVideo) {
                            canvas.style.zIndex = 500;
                            self.clickLaserPen(true);
                        }
                        else {
                            $("#sharingVideoCanvas").attr('width', document.getElementById("videos-container").clientWidth);
                            $("#sharingVideoCanvas").attr('height', 200);
                            if (self.onlineSpeakers.length <= 0)
                                canvas.style.zIndex = -999;
                            else
                                canvas.style.zIndex = 100;
                        }
                        break;
                    case "abort":
                        // control canvas - to outside
                        self.headerBar.sharStatus = "";
                        $("#sharingVideoCanvas").attr('width', document.getElementById("videos-container").clientWidth);
                        $("#sharingVideoCanvas").attr('height', 200);
                        if (self.onlineSpeakers.length <= 0)
                            canvas.style.zIndex = -999;
                        else
                            canvas.style.zIndex = 100;
                        $("#sharingVideoCanvas").prependTo($("#videos-container"));
                        $("#sharingVideoCanvas").css('display', '');
                        self.clickLaserPen(false);
                        self.ckDispalyMyVideo = false;
                        //if(CONFIG.isConfidentialDetectEnable && window.globalVar.isDisableInfoSecurity==false)                        
                        //if(CONFIG.isConfidentialDetectEnable )
                        if (CONFIG.isConfidentialDetectEnable && window.globalVar.isDisableInfoSecurity == false && $VM.currUser.sourceType != 'externalpc')
                            confidential.detectConfidentialStop();
                        if($PIPSubtitle)
                            $PIPSubtitle.closePIP();
                        break;
                    case "webkitbeginfullscreen": // 2021/10/26  iPhone-開始全螢幕
                        break;
                    case "webkitendfullscreen":   // 2021/10/26  iPhone-結束全螢幕
                        break;
                    default:
                        break;
                }
            },
            watch_userState_DashB() {
                const self = this;
                try {
                    if (!$VM.mqttClient) return;
                    $VM.mqttClient.sendUserState_DashB();
                } catch (err) {
                    console.log(err);
                }
            },
            userState_DashB_clearLive() {
                const self = this;
                try {
                    self.userState_DashB.speakInfo.isLive = false;
                    self.userState_DashB.speakInfo.liveSource = null;
                    self.userState_DashB.speakInfo.kmsid_Live = null;
                    if (self.isShareVideoLocalImage) {
                        self.sharingImageSrc = "";
                        self.sharingImageUser = "";
                        self.isShareVideoLocalImage = false;
                    }
                } catch (err) {
                    console.log(err);
                }
            },
            userState_DashB_clearSpeak() {
                const self = this;
                try {
                    this.userState_DashB.speakInfo.isSpeaking = false;
                    this.userState_DashB.speakInfo.isMute = true;
                    this.userState_DashB.speakInfo.isDisableCamera = false;
                    this.userState_DashB.speakInfo.kmsid_Speak = null;
                } catch (err) {
                    console.log(err);
                }
            },
            setCameraInfo(cameraData) {

            },
            setVideoInfo(videoData, isEnd = false, isKMS = false) {
                const self = this;

                if (!isEnd) {
                    // let islocal =  (self.currUser.empId == videoData.userid.substr(0,6));
                    // let userData = (self.currUser.empId == videoData.userid.substr(0,6)) ? self.currUser : self.onlineUsers.filter(x => x.empId == videoData.userid.substr(0,6))[0];
                    //modify 2020/12/01 userid 或工號 取消 6碼的限制，因應外部廠商的email
                    let islocal = (self.currUser.empId == videoData.userid);
                    let userData = (self.currUser.empId == videoData.userid) ? self.currUser : self.onlineUsers.filter(x => x.empId == videoData.userid)[0];
                    let title = (userData) ? `${userData.deptId}/${userData.name}` : "N\/A";
                    // self.headerBar.shareUser = `(${title}正在分享畫面)`;
                    if (islocal) {
                        self.isShareVideo = true;
                        if (!isKMS) {
                            self.isShareVideoLocalKMS = false;
                            self.isShareVideoLocalWebRTC = true;
                            self.isShareVideoLocalKMSWebCam = false;
                            self.isShareVideoLocalWebCam = false;
                        }
                        else {
                            self.isShareVideoLocalKMS = true;
                            self.isShareVideoLocalWebRTC = false;
                            self.isShareVideoLocalKMSWebCam = videoData.isWebCam;
                            self.isShareVideoLocalWebCam = false;
                        }
                        //$("#sharingVideo").css('display','none');

                    } else {
                        self.isShareVideo = true;
                        self.isShareVideoLocalKMS = false;
                        self.isShareVideoLocalWebRTC = false;
                        self.isShareVideoLocalKMSWebCam = false;
                        self.isShareVideoLocalWebCam = false;
                        // $("#sharingVideo").css('display','');
                    }

                    self.videoInfo.srcObject = videoData.stream;
                    self.videoInfo.id = videoData.stream.id;
                    self.videoInfo.userid = videoData.userid;
                    self.videoInfo.empid = videoData.userid;
                    self.videoInfo.type = videoData.type;
                    self.videoInfo.isWebCam = videoData.isWebCam;
                    self.videoInfo.isKMS = isKMS;
                }
                else {
                    self.isShareVideo_0 = false;
                    self.videoInfo_0_empid = null;
                    self.videoDataEvent_0 = null;
                    //關閉分享
                    if ((self.videoInfo.id == videoData.stream.id || self.videoInfo.id == connection.kms.kmsId) && (self.videoInfo.id)) {
                        // self.headerBar.shareUser = ``;
                        self.isShareVideo = false;
                        self.isShareVideoLocalKMS = false;
                        self.isShareVideoLocalWebRTC = false;
                        self.isShareVideoLocalKMSWebCam = false;
                        self.isShareVideoDoubleCam = false;
                        self.isShareLocalDoubleCam = false;

                        self.isShareVideoHolo = false;
                        self.isShareVideoHoloII = false;
                        self.isHoloArrowActive = false;

                        self.currUser.isUseBuildInCamForFace = true;
                        self.videoInfo.srcObject = null;
                        self.videoInfo.id = null;
                        self.videoInfo.userid = null;
                        self.videoInfo.empid = null;
                        self.videoInfo.type = null;
                        self.videoInfo.isKMS = null;
                        // $("#sharingVideo").css('display','none');
                        connection.kms = { kmsId: null, kmsUserid: null };

                    } else {

                    }
                }

            },

            videoInfoclear() {
                const self = this;
                self.videoInfo.id = null;
                self.videoInfo.userid = null;
                self.videoInfo.empid = null;

                self.videoInfo.srcObject = null;
                self.videoInfo.type = "";
                self.videoInfo.muted = true;
                self.videoInfo.isActive = false;

                self.isShareVideoLocalWebRTC = false;
                self.isShareVideoLocalKMS = false;
                self.isShareVideo = false;
                self.videoInfo.isKMS = null;
                // $("#sharingVideo").css('display','none');
            },
            kmsVideoStartView(KmsData) {
                const self = this;

                if (self.videoInfo.srcObject && self.videoInfo.srcObject.getVideoTracks) {
                    if (self.videoInfo.srcObject.getVideoTracks().length > 0) self.videoInfo.srcObject.getVideoTracks()[0].stop();
                };
                self.setVideoInfo(KmsData, false, true);
            },
            kmsVideoStartViewCamera(KmsData) {
                self.setCameraInfo(KmsData, false, true);
            },
            kmsVideoStart(KmsData) {
                const self = this;
                if (self.videoInfo.srcObject && self.videoInfo.srcObject.getVideoTracks) {
                    self.videoInfo.srcObject.getVideoTracks()[0].stop();
                };
                self.setVideoInfo(KmsData, false, true);

            },
            kmsVideoStop(KmsData) {
                const self = this;
                self.setVideoInfo(KmsData, true, true);
                self.clickLaserPen(false);//add 2021/09/23 canvas還原全螢幕, 恢復 mouse 原始游標
            },
            //開啟視訊直播
            kmsWebCamClick: function (event) {
                const self = this;
                try {

                    if (!DetectRTC.hasWebcam) {
                        self.oNotify.ConfirmCustomMsg("沒有偵測到攝影機?", "", [{ text: "是", click: () => { return; } }]);
                    }
                    else {
                        let speaker = self.onlineSpeakers.filter(x => x.userId == self.currUser.empId);
                        if (speaker.length <= 0) {
                            self.handleMic('updateMic');
                        }
                        self.kmsWebcamInfo.userId = self.currUser.empId;
                        self.kmsWebcamInfo.isShow = true;
                        self.kmsWebcamInfo.displayName = self.currUser.name;
                    }
                } catch (ex) { console.log(ex) }
            },

            //開啟直播
            beforeKmsShareClick: function (event, isWebCam = false, isUnity = false, isStartHoloUnityFromUnity = false) {
                const self = this;
                //HoloLensUnity
                if (isUnity) {
                    $VM.isHoloUnity = true;
                }
                self.ckDispalyMyVideo = false; //add by vic 2022/09/12 圖片直播，搶直播UI要恢復正常
                $VM.isStartHoloUnityFromUnity = isStartHoloUnityFromUnity;
                //如果是外部會議, 內部人員點桌面直播時, 檢查邀請名單中的外部人員, 若有任一人非白名單, 系統顯示提示, 不允許直播
                if (_CONFIG3_External && self.currUser.userType !== "M") {
                    HasPermissionToShareToExternal().then(function (resolve) {
                        if (!resolve.hasPermission) {
                            self.oNotify.ConfirmMsg("", self.$t("lan-notify-noshare1", { name: `${resolve.externalNotInList}` }));
                            return;
                        } else {
                            self.kmsShareClick(event, isWebCam);
                            if($PIPSubtitle && self.subtitleSetting.pip) {
                                $PIPSubtitle.updateText('','');
                                $PIPSubtitle.showPIP();
                            }
                        }
                    }).catch(err => {
                        self.oNotify.ConfirmMsg("", self.$t("lan-notify-noshare2"));
                        return;
                    });
                } else {
                    self.kmsShareClick(event, isWebCam);
                    if($PIPSubtitle && self.subtitleSetting.pip) {
                        $PIPSubtitle.updateText('','');
                        $PIPSubtitle.showPIP();
                    }
                }
            },
            kmsShareClick: function (event, isWebCam = false) {
                const self = this;
                if (!$VM.isHolo) {   // HoloLens I-RDP Service直播時使用kurento-utils.min.js, 會影響一般會議人員桌面直播使用的kurento-utils.js, 提示user進行重連reload kurento-utils.js
                    if (Array.from(document.getElementsByTagName("script")).filter(x => x.src.indexOf("kurento-utils.min.js") != -1).length > 0) {
                        $VM.oNotify.ConfirmCustomMsg("", $VM.$t("lan-notify-after-hololens"), [
                            {
                                text: $VM.$t("lan-hint-tips4"),
                                click: () => {
                                    $VM.clickReconnect();
                                },
                                addClass: 'IdleNotifyY',
                            },
                            {
                                text: $VM.$t("lan-notify-no"),
                                addClass: "btn-danger",
                            }
                        ]);
                    }
                }
                if (self.isShareVideo && (self.isShareVideoLocalKMS || self.isShareVideoLocalWebCam || self.isShareVideoLocalWebRTC)) {
                    return;
                }
                if (self.oDetectDevice.isMobileAny) {
                    self.oNotify.ConfirmMsg("", self.$t("lan-notify-mobile"));
                    return;
                }
                else if (isWebCam && !DetectRTC.hasWebcam) {
                    self.oNotify.ConfirmCustomMsg("沒有偵測到攝影機?", "", [{ text: "是", click: () => { return; } }]);
                }
                else {
                    self.videoInfo.isOpenCamera = false;
                    if (isWebCam) {//視訊直播
                        try {
                            self.updateSpeakerCam({
                                userId: self.currUser.userId,
                                displayName: null,
                                isUsing: false,
                                kmsid: "",
                                srcUrl: "",
                                srcObject: null,
                                isMute: false,
                                // isCameraOff:false,
                                isSpeaking: false,
                                hascamera: false,
                                isDiableCamera: true,
                                audioFFTData: [],
                                videoState: 'end',
                                isHD: true,
                                isAllowWebCam: self.currUser.isAllowWebCam,
                                logTime: { action: 'end', time: getTimeStamp() },
                                cannotHearYou: false,
                                trackEnabled:true,
                            });
                            //取消發言，要把peer release
                            let sp = self.onlineSpeakers.filter(x => x.userId == self.currUser.userId);
                            if (sp.length > 0) {
                                self.releaseSpeakerConn(sp[0]);
                            }
                            setTimeout(() => send("mute#" + self.currUser.empId + "#false"), 200);
                        } catch (e) { console.log(e) }
                    }
                    self.kmsShare(isWebCam);
                }
            },
            kmsShare: function (isWebCam = false) {
                const self = this;
                self.videoInfo.isShowKMSSetting = false;
                let KMSopt = {};

                KMSopt.isOpenCamera = false;
                self.checkandCloseImageLive();//關閉圖片直播
                //startFunction(false);
                beforeStartFunction();//by 2021/06/06, beforeStartFunction判斷是否搶直播用
                self.checkandClosePIP();
                self.setWhiteboardUrl(false);//關閉共用白板
                ///開啟直播時也要開啟發言()
                if (self.onlineSpeakers.filter(x => x.userId == self.currUser.userId).length <= 0) {
                    self.handleMic('updateMic');
                }
            },
            kmsStopClick: function (event, isStopHoloUnityFromUnity = false) { //停止直播
                const self = this;
                self.isStopHoloUnityFromUnity = isStopHoloUnityFromUnity;
                if (self.isShareVideoLocalKMS)  //桌面直播-停止直播
                {
                    if (self.isHolo) {
                        if (!self.isHoloUnity)
                            send(`stopHolo#${connection.kms.kmsId}#${connection.kms.kmsUserid}`);
                    }
                    self.checkandClosePIP();
                    if (self.isShareVideoLocalKMSWebCam) { //fix 雙鏡頭直播-停止直播 後,未送出stopview,導致viewer video仍在
                        send(`stopview#${connection.kms.kmsId}#${connection.kms.kmsUserid}`);
                    }
                    if (self.isHolo) {
                        holoStop(self.isHoloUnity);
                    } else {
                        kmsStop();
                    }
                }
                else if (self.isShareVideoLocalKMSWebCam) //雙鏡頭直播-停止直播
                {
                    send(`stopview#${connection.kms.kmsId}#${connection.kms.kmsUserid}`);
                    self.checkandClosePIP();
                    kmsStop();
                }
                else if (self.isShareVideoLocalWebCam) //視訊直播-停止直播
                {
                    self.isShareVideo = false;
                    self.isShareVideoLocalWebCam = false;
                    self.pinWebcamInfo.isShow = false;
                    self.pinWebcamInfo.empId = null;
                    self.pinWebcamInfo.srcObject = null;
                    send("stopkmsWebCam#" + self.currUser.empId + "#false");
                    $VM.writeLog("使用者操作", `[DISPLAYNAME] 關閉視訊直播 @kmsStopClick`);
                    $VM.appendHistory("close", `[DISPLAYNAME] ${self.$t('lan-his-webcam-live-off')}`);
                }
                // self.clickStopMyWebCam();//停止視訊
                self.userState_DashB_clearLive();
            },
            checkandCloseImageLive: function () {
                const self = this;
                //若自己仍圖片直播中,需停止圖片直播;若他人仍圖片直播中,需通知他們停止圖片直播
                if (self.isShareVideoLocalImage) {
                    self.LiveImage();
                }
                if (self.isShareVideoImage) {
                    send(`askbreakliveImg##${self.sharingImageUser}#${self.sharingImageUser}`);
                }
            },
            clickSetMuteNewComing: function (event) {
                const self = this;
                self.roomInfo.isMuteNewComing = !self.roomInfo.isMuteNewComing;
                videoConference.webrtc.functions.SetMuteNewComing();
            },
            mute: function (isMute) {
                const self = this;
                try {
                    self.currUser.isMute = isMute;
                    if ($RealTimeASR)
                        $RealTimeASR.setMute(isMute);
                    
                    // console.log(self.onlineSpeakers.filter(x=>x.userId == self.currUser.userId));
                    self.onlineSpeakers.filter(x => x.userId == self.currUser.userId)
                    let kmsSpeaker = self.onlineSpeakers.filter(x => x.userId == self.currUser.userId)[0];
                    let kmsWebRtcPeer = kmsSpeaker.webRtcPeer;
                    let kmsRecorderAudio = kmsSpeaker.recorderAudio;
                    if (self.currUser.isMute) {
                        kmsWebRtcPeer.peerConnection.getSenders().forEach(function (rtpSender) {
                            if (rtpSender.track && rtpSender.track.kind == 'audio') {
                                if (rtpSender.track != null) {
                                    rtpSender.lastTrack = rtpSender.track;
                                    //rtpSender.replaceTrack(null);
                                    rtpSender.track.enabled = false; //modify 2021/11/05 改用enabled,避免iphone null track 恢後仍沒有聲音
                                    if (kmsSpeaker.isRecordingAudio) {
                                        //關掉camera,開啟mic會繼續錄黑屏, 不影響錄製
                                        //關mic(audio null), 開啟鏡頭還是會被剪掉, 需要開新檔錄製
                                        //recordState: vidoeOnly, videoAudio, audioOnly, stop
                                        kmsRecorderAudio.stop();
                                        kmsRecorderAudio = null;
                                        kmsSpeaker.isRecordingAudio = false;
                                        // if(self.deviceInfo().hasCamera && !kmsSpeaker.isDiableCamera ) {
                                        //     //靜音&開鏡頭
                                        //     kurentoNewRecord(kmsSpeaker, "videoOnly"); 
                                        // }
                                    }
                                }
                            }
                        });
                    }
                    else {
                        var recordNewAudioOn = false;
                        kmsWebRtcPeer.peerConnection.getSenders().forEach(function (rtpSender) {
                            rtpSender.track.enabled = true; //modify 2021/11/05 改用enabled,避免iphone null track 恢後仍沒有聲音
                            if (!rtpSender.track || rtpSender.track.enabled) {
                                //rtpSender.replaceTrack(rtpSender.lastTrack);                                
                                if (self.isRecordSwitchOn && !recordNewAudioOn) {
                                    recordNewAudioOn = true;
                                    kurentoRecordNewAudio(kmsSpeaker); //create a new recorder
                                }
                            }
                        });
                    }
                    setTimeout(() => {
                        self.checkMuteStatus(true);
                    }, 200);
                }
                catch (ex) {
                    console.log(ex);
                    $VM.writeLog("異常", `[EMAIL]/[UID] 收音/靜音狀態異常isMute=${isMute}(ex=>${ex})`);
                    self.checkMuteStatus(false);
                }
            },
            checkMuteStatus: function (doSendMsg) {
                const self = this;
                try {
                    if (self.onlineSpeakers.length > 0) {
                        let _isMute = self.isMuteFromPeer();
                        if (_isMute != null) {
                            if (_isMute == self.currUser.isMute) {   // 狀態一致
                                if (doSendMsg)
                                    send("mute#" + self.currUser.empId + `#${self.currUser.isMute ? 'true' : 'false'}`);
                            } else {                                              // 狀態不一致                                                        
                                $VM.writeLog("異常", `[EMAIL]/[UID] 收音/靜音狀態異常isMuteFromPeer=${_isMute},isMute=${self.currUser.isMute})`);
                                self.currUser.isMute = _isMute;                 // UI設定為track.enabled                                              
                                send("mute#" + self.currUser.empId + `#${self.currUser.isMute ? 'true' : 'false'}`);
                                self.oNotify.ConfirmCustomMsg((self.currUser.isMute ? self.$t("lan-hint-tips10-1") : self.$t("lan-hint-tips10")), "", [{ text: self.$t("lan-notify-yes"), click: () => { return; } }]);
                            }
                        }
                    }
                }
                catch (ex) {
                    console.log(ex);
                }
            },
            cameraoff: function (_speaker) {
                try {
                    const self = this;
                    _speaker.isDiableCamera = !_speaker.isDiableCamera;
                    _speaker.webRtcPeer.peerConnection.getSenders().forEach(function (rtpSender) {

                        if (rtpSender.track)
                            if (rtpSender.track.kind == 'video') {
                                rtpSender.track.enabled = !_speaker.isDiableCamera;
                                if (rtpSender.track.enabled) {
                                    if (self.isRecordSwitchOn && CONFIG.kmsRecord.recordWebcam && self.deviceInfo().hasCamera) {
                                        let kmsSpeaker = self.onlineSpeakers.filter(x => x.userId == self.currUser.userId)[0];
                                        kurentoRecordNewVideo(kmsSpeaker); //create a new recorder
                                    }
                                }
                                else {
                                    let kmsSpeaker = self.onlineSpeakers.filter(x => x.userId == self.currUser.userId)[0];
                                    let kmsRecorderVideo = kmsSpeaker.recorderVideo;
                                    if (kmsSpeaker.isRecordingVideo) {
                                        kmsRecorderVideo.stop();
                                        kmsRecorderVideo = null;
                                        kmsSpeaker.isRecordingVideo = false;
                                    }
                                }
                            }

                    });

                    $VM.userState_DashB.speakInfo.isDisableCamera = _speaker.isDiableCamera;
                    send(`cameraStatus#${connection.userid}#${_speaker.isDiableCamera}`);
                    if (_speaker.isDiableCamera) {
                        $VM.writeLog("使用者操作", `[DISPLAYNAME] 關閉攝影機Camera`);
                        $VM.appendHistory("close", `[DISPLAYNAME] ${self.$t('lan-his-webcam-off')}`);
                    } else {
                        $VM.writeLog("使用者操作", `[DISPLAYNAME] 開啟攝影機Camera`);
                        $VM.appendHistory("share", `[DISPLAYNAME] ${self.$t('lan-his-webcam-on')}`);
                    }
                }
                catch (ex) {
                    console.log(ex);
                }
            },
            trackoff:function(_speaker)
            {
                try{
                    const self = this;
                    _speaker.trackEnabled = !_speaker.trackEnabled;
                    _speaker.srcObject.getAudioTracks()[0].enabled = _speaker.trackEnabled;

                }
                catch(ex)
                {
                    console.log(ex);
                }

            },
            showDebug: function () {
                const self = this;
                if (self.debugInfo.showDebugTab == 'debug') {
                    self.debugInfo.debugtext = videoConference.webrtc.utils.debugInfo();
                }
                else if (self.debugInfo.showDebugTab == 'detail') {
                    self.debugInfo.debugtext = videoConference.webrtc.utils.debugdetail();
                }
                else if (self.debugInfo.showDebugTab == 'device') {
                    self.debugInfo.debugtext = videoConference.webrtc.utils.debugDeviceInfo();
                }
                else if (self.debugInfo.showDebugTab == 'detect') {
                    self.onlineUsers.forEach((u) => {
                        u.isAckSending = false;
                        u.isAckReply = false;
                    });
                }
                else if (self.debugInfo.showDebugTab == 'config') {
                }
                self.debugInfo.isShowDebug = true;
            },
            showList_Mobile: function () {
                const self = this;
                self.isShowList_Mobile = true;
            },
            showChat_Mobile: function () {
                const self = this;
                self.isShowChat_Mobile = true;
            },
            checkWindowsFocus() {
                const self = this;
                try {
                    let isHidden = document.hidden; //是否再前景
                    //

                } catch (e) {
                    console.log("videoplay error:", e);
                }
            },
            videoAction: function (isFirstIn) {
                //收到雷射筆事件 || 收到視窗縮小事件
                //直播者才會暫停
                //判斷需要撥放條件: 
                //1.雷射筆數量 =0 直播者 
                //2.且直播Video 在背景 

                //判斷需要暫停條件: 
                //1.雷射筆數量 >0 暫停 
                //2.且直播Video 在背景 
                const self = this;
                try {
                    if (!self.isShareVideoLocalWebRTC && !self.isShareVideoLocalKMS && !self.isShareVideoLocalKMSWebCam) return;
                    //console.log("videoAction ",(self.cvsBoard && self.cvsBoard.penData && self.cvsBoard.penData.length>0),self.cvsBoard,self.cvsBoard.penData,self.cvsBoard.penData.length);

                    //雷射筆
                    if (self.cvsBoard && self.cvsBoard.penData && self.cvsBoard.penData.length > 0) {
                        if (self.isFocus) {
                            //不做事情
                        }
                        else {
                            self.videopause(isFirstIn);
                        }
                    }
                    else {
                        if (self.isFocus) {
                            //不做事情
                        }
                        else {
                            self.videoplay();
                        }
                        //沒有雷射筆 
                    }

                }
                catch (e) { console.log(e) }
            },
            videoplay: function () {
                const self = this;

                try {
                    //if(self.isfocus ) return ;
                    let vd = document.getElementById("sharingVideoTag");
                    if (vd.paused) {
                        vd.play();
                        self.videoInfo.isPasue = false;
                    }
                } catch (e) {
                    console.log("videoplay error:", e);
                }
            },
            videopause: function (isFirstIn) {
                const self = this;
                try {

                    let vd = document.getElementById("sharingVideoTag");
                    if (!vd.paused) {
                        if (self.isHoloArrowActive) { // 錨點啟用後暫停video
                            vd.pause();
                            self.videoInfo.isPasue = true;
                        }
                        if ((self.isShareVideoLocalKMS || self.isShareVideoLocalWebRTC) && !self.isShareVideoLocalKMSWebCam) {
                            vd.pause();
                            self.videoInfo.isPasue = true;
                        }
                    }
                    else {
                        //影片已經暫停了。需要判斷是不是有人要開啟雷射筆
                        //console.log("影片已經暫停了。需要判斷是不是有人要開啟雷射筆",isFirstIn);
                        if (isFirstIn) {
                            vd.play();
                            setTimeout(() => {
                                vd.pause();
                            }, 1000);
                        }
                    }

                } catch (e) {
                    console.log("videoplay error:", e);
                }

            },
            windowBlurOrFocus: function (isShowPanelMsg) {
                const self = this;
                //若是直播者：若偵測到會議畫面chrome切換到前景，通知smartPanel隱藏功能，否則顯示功能
                if ((self.isShareVideoLocalKMS == true || self.isShareVideoLocalWebRTC == true)) {
                    //let isVisible = (document.visibilityState=='visible') ? false : true;
                    send(`meetingVisibility#${self.currUser.empId}#${isShowPanelMsg}`);
                }
            },
            visibilitychange: function () {
                const self = this;
                self.videoAction(false);//如果是放大，不做動作所以不會有影像，如果是縮小。是否有撥放也沒有影響。

                //若是直播者：若偵測到會議畫面chrome切換到前景，通知smartPanel隱藏功能，否則顯示功能
                if ((self.isShareVideoLocalKMS == true || self.isShareVideoLocalWebRTC == true)) {
                    let isVisible = (document.visibilityState == 'visible') ? false : true;
                    send(`meetingVisibility#${self.currUser.empId}#${isVisible}`);
                }

            },
            fullscreen: function (_id) {
                const self = this;
                let element = document.getElementById(_id); //div tag
                //launchFullscreen
                if (element.requestFullscreen) {
                    element.requestFullscreen();
                    return;
                }
                /* Firefox */
                if (element.mozRequestFullScreen) {
                    element.mozRequestFullScreen();
                    return;
                }
                /* Chrome, Safari & Opera */
                if (self.oDetectDevice.isMobileiOS) {  // -add. 2021/10/22
                    element = document.getElementById('sharingVideoTag'); //video tag
                    if (element.webkitEnterFullscreen) {
                        element.webkitEnterFullscreen();
                        return;
                    }
                }
                if (element.webkitRequestFullscreen) {
                    element.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT);
                    return;
                }
                /* IE/Edge */
                if (element.msRequestFullscreen) {
                    element.msRequestFullscreen();
                    return;
                }
            },
            cancelFullScreen: function () {
                const self = this;
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.msExitFullscreen) {
                    document.msExitFullscreen();  /* IE11 */
                } else if (document.mozCancelFullScreen) {
                    document.mozCancelFullScreen();
                } else if (document.webkitExitFullscreen) {  /* Safari */
                    document.webkitExitFullscreen();
                }

                self.isFullScreenCanceling = true;
                // console.log("isFullScreenCanceling", self.isFullScreenCanceling);
                setTimeout(() => {
                    self.isFullScreenCanceling = false;
                    // console.log("isFullScreenCanceling", self.isFullScreenCanceling);
                }, 3000);

                self.isFullScreenDiscuss = false;
            },
            screenStateChange: function (e) {
                const self = this;
                if (e.target.id == 'newSubtitle') {
                    self.newSubtitleFullScreen = !self.newSubtitleFullScreen;
                    self.handleSize('resize');
                }
                // self.isFullScreen = document.webkitIsFullScreen || document.mozFullScreen || document.fullscreen;
                if (self.isFullScreen) {
                    self.isFullScreenCanceling = true;
                    // console.log("isFullScreenCanceling", self.isFullScreenCanceling);
                    setTimeout(() => {
                        self.isFullScreenCanceling = false;
                        // console.log("isFullScreenCanceling", self.isFullScreenCanceling);
                    }, 3000);
                }
                if (e.target.id != "sharingVideo") return;
                self.isFullScreen = !self.isFullScreen;

                if (self.isFullScreen) {
                    let video = document.getElementById("sharingVideoTag");
                    let srcVideoW = video.videoWidth;
                    let srcVideoH = video.videoHeight;

                    if (srcVideoW != 0 && srcVideoH != 0) {

                        let srcSlope = srcVideoH / srcVideoW;
                        let slope = window.screen.height / window.screen.width;

                        let mediaElementContainer = document.getElementById("sharingVideo");

                        //console.log("srcSlope>=slope",srcSlope>=slope);
                        if (srcSlope >= slope) {
                            //高100寬auto
                            self.fullscreenStyle.videoClass = "video-fullscreen";
                            self.fullscreenStyle.videoStyle = 'height: 100%;width: auto;';

                        } else {
                            //寬100高auto
                            self.fullscreenStyle.videoClass = "video-fullscreenH";
                            self.fullscreenStyle.videoStyle = `width: 100%;height: ${window.screen.width * srcSlope}px;`;
                        }
                    }

                    //add 2021/01/25 判斷如果有人在桌面直播，浮水印要增加誰正在直播
                    if (self.videoInfo.isKMS) {
                        let shareUser = self.onlineUsers.filter(x => x.empId == self.videoInfo.empid);
                        if (shareUser && shareUser[0] && shareUser[0].email) {
                            let wu = `${shareUser[0].email}` + self.$t('lan-header-desktop-brief');
                            watermark({ watermark_user: wu + ' ' + window.params.username, watermark_parent: "divWaterMark", isFullScreen: self.isFullScreen });
                        }
                    }
                    else {
                        watermark({ watermark_user: window.params.username, watermark_parent: "media-container-VIDEO", isFullScreen: self.isFullScreen });
                    }

                }
                else {
                    // 從全螢幕回來要關閉 視窗
                    if ((self.isShareVideoLocalKMS == true || self.isShareVideoLocalWebRTC == true) && self.isShareVideoLocalKMSWebCam == false) {
                        self.clickDispalyMyVideo();
                    }
                }

            },
            getOrSetLaserFillStyle(type) {
                const self = this;
                if (type == 'get') {
                    let data = localStorage.getItem('laserFillStyle');
                    if (data) {
                        window.globalVar.isShowInfoStep = false;
                        return data;
                    } else {
                        // let color=`#${(((1 << 24) * Math.random()) | 0).toString(16)}`
                        window.globalVar.isShowInfoStep = true;
                        let color = randomColor({ luminosity: 'dark' });
                        localStorage.setItem('laserFillStyle', color)
                        return color;
                    }
                } else {
                    if (self.cvsBoard.laserFillStyle) {
                        localStorage.setItem('laserFillStyle', self.cvsBoard.laserFillStyle);
                        $("#settingModal").modal("toggle");
                    }
                }
            },
            soundEffect(status) {
                const self = this;
                try {
                    let _soundfile = "";
                    let _soundvolume = "";
                    switch (status) {
                        case "in":
                            _soundfile = "./wav/din.mp3"
                            _soundvolume = 0.2;
                            break;
                        case "out":
                            _soundfile = "./wav/left.mp3";
                            _soundvolume = 0.2;
                            break;
                        case "typping":
                            _soundfile = "./wav/msg.mp3";
                            _soundvolume = 0.2;
                            break;
                        default:

                    }
                    let snd = new Audio(_soundfile);
                    snd.volume = _soundvolume;
                    snd.play();
                } catch (e) { console.log(e) };

            },
            //手機版面:主題太長,點一下展開,再點一下縮合
            expandTopic: function () {
                if ($(".topic-name-height").css("max-height") === "40px") {
                    $(".topic-name-height").css("max-height", "none");
                } else {
                    $(".topic-name-height").css("max-height", "40px");
                }
            },
            testDataChannel(e, u) {
                const self = this;
                console.log(e.target.getAttribute("userid"));
                send(`ACK#${connection.userid}##${u.userId}`)
                u.isAckSending = true;
                u.isAckReply = false;
            },
            block: function () {
                const self = this;
                $.blockUI({
                    // message: "<i  style='color:orange' class='fa fa-spinner fa-pulse fa-7x'></i>", 
                    message: "<div class='loader-wrapper'><div class='loader'><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div>",
                    css: { borderWidth: '0px', backgroundColor: 'transparent' },
                });

                setTimeout($.unblockUI(), 15000);

            },
            blockForSpeak: function () {
                const self = this;
                $.blockUI({
                    message: `<div style='color: ghostwhite;'><i class='fa fa-spinner fa-pulse' style='font-size:600%'></i><div><br>${self.$t('lan-notify-limit-gain')}</div></div>`,
                    css: { borderWidth: '0px', backgroundColor: 'transparent' },
                });
                setTimeout(self.unBlock(), 15000);
            },
            unBlock: function () {
                $.unblockUI();
            },

            afterMqttConnected: function () {
                console.log("afterMqttConnectedafterMqttConnectedafterMqttConnectedafterMqttConnectedafterMqttConnected");
            },
            handleKMSWebCam: function (eventType, data = null) {
                const self = this;
                // console.log('handleMic eventType data',eventType,data);
                try {
                    switch (eventType) {
                        case "recvUpdate": // from onmessage data已組好過來
                            self.kmsWebcamInfo = data;

                            if (!data.isShow) {
                                try {
                                    self.releaseSpeakerConn(self.kmsWebcamInfo);
                                } catch (err) {
                                    console.log(err);
                                }
                            } else {

                            }
                            break;
                    }
                } catch (ex) { console.log(e) }
                //console.log(JSON.stringify(self.kmsWebcamInfo));
            },
            updateMicHD2: function (eventType, data = null) {
                const self = this;
                if (!DetectRTC.hasWebcam) {
                    self.oNotify.ConfirmCustomMsg(self.$t("lan-live-nowebcam"), "", [{ text: "是", click: () => { return; } }]);
                } else {
                    self.handleMic(eventType, null);
                }
            },
            handleMicHD: function (eventType, data = null) {
                const self = this;
                if (!DetectRTC.hasWebcam) {
                    self.oNotify.ConfirmCustomMsg("沒有偵測到攝影機?", "", [{ text: "是", click: () => { return; } }]);
                } else {
                    self.handleMic(eventType, null);
                }
            },
            handleMic: function (eventType, data = null) {
                const self = this;
                // console.log('handleMic eventType data',eventType,data);
                // 2022.03.03 減少user一進入會議就發言造成攝影機status未同步問題                
                if (eventType == "updateMic") {
                    if (self.currUser.userId == null) {
                        self.oNotify.ConfirmCustomMsg(self.$t("lan-notify-wait-initial"), "", [{ text: self.$t("lan-notify-yes"), click: () => { return; } }]);
                        return;
                    }
                    if (self.currUser.isAllowMicphone == null || self.currUser.isAllowWebCam == null) {
                        self.oNotify.ConfirmCustomMsg(self.$t("lan-notify-wait-detect"), "", [{ text: self.$t("lan-notify-yes"), click: () => { return; } }]);
                        return;
                    }
                }
                if (voices.length > 0 && $("#synth_setting")[0]) {  //translate:synth_setting          
                    self.synth_setting = true;
                }

                try {
                    switch (eventType) {
                        case "updateMicHD2": // from click //雙鏡頭直播 
                        case "updateMicHD": // from click //視訊直播 
                        case "updateMic": // from click   //發言
                            //自己發言
                            self.onlineSpeakers.forEach((s) => {
                                if (s.userId != self.currUser.userId && s.setcannotHearYouTimout) {
                                    clearTimeout(s.setcannotHearYouTimout);
                                    s.setcannotHearYouTimout = null;
                                }
                                s.cannotHearYou = false;
                                s.setcannotHearYouTimout = setTimeout((_sp) => {
                                    _sp.cannotHearYou = self.checkcannotListenToMe(_sp);
                                }, 20000, s);
                            });
                            let sp = self.onlineSpeakers.filter(x => x.userId == self.currUser.empId);
                            //if (self.currUser.isMute && !self.cameraInfo.empid) {
                            if (self.isAskMic && sp.length <= 0) { // 自己未發言 

                                if (!self.currUser.isAllowMicphone) {
                                    self.oNotify.ConfirmMsg(self.$t("lan-notify-nomic-title"), self.$t("lan-notify-nomic-content"));
                                    return;
                                }
                                if (eventType == "updateMicHD" && !self.currUser.isAllowWebCam) {
                                    self.oNotify.ConfirmMsg(self.$t("lan-notify-nowebcam-title"), self.$t("lan-notify-nowebcam-content"));
                                    return;
                                }


                                let isFullAmount = false;
                                let fullAmount = 20;

                                let r = self.onlineSpeakers.map((sp, index) => {
                                    let spUser = self.onlineUsers.find(o => o.userId === sp.userId);
                                    return Object.assign({}, sp, spUser);
                                });
                                r = r.filter(x => (!x.titleWithConfig));
                                //CHECK 發言人數
                                if (_CONFIG_RTCSDDeptId.includes(_CreateUserDeptId)) {
                                    //MIS 部門 人數限制 
                                    if (r.length >= _CONFIG3_SpeakersMIS) {
                                        isFullAmount = true;
                                        fullAmount = _CONFIG3_SpeakersMIS;
                                    }
                                }
                                else if (logTopic.indexOf("(1080P)") >= 0) {
                                    if (r.length >= _CONFIG3_Speakers1080P) {
                                        isFullAmount = true;
                                        fullAmount = _CONFIG3_Speakers1080P;
                                    }
                                }
                                else {
                                    //一般人數卡控
                                    if (r.length >= _CONFIG3_Speakers) {
                                        isFullAmount = true;
                                        fullAmount = _CONFIG3_Speakers;
                                    }
                                }

                                if (self.currUser.titleWithConfig)
                                    isFullAmount = false;//高階長官不卡控

                                if (isFullAmount) {
                                    self.oNotify.ConfirmCustomMsg(self.$t("lan-notify-limit-notify", { limit: `${fullAmount}` }), "", [
                                        {
                                            text: "是",
                                            click: () => {
                                                try {

                                                    let isPassTitleUser = true;
                                                    asklist = r.filter(x => (x.isMute == true && (!x.titleWithConfig)));
                                                    if (asklist.length >= 5) {
                                                        //非主管已靜音
                                                        asklist = r.filter(x => (x.isMute == true && (!x.titleWithConfig)));
                                                        isPassTitleUser = true;
                                                    }
                                                    if (asklist.length <= 0) {
                                                        //所有靜音
                                                        asklist = r.filter(x => (x.isMute == true));
                                                        isPassTitleUser = false;
                                                    }
                                                    if (asklist.length <= 0) {
                                                        //所有發言者
                                                        asklist = r;
                                                        isPassTitleUser = false;
                                                    }
                                                    asklist = asklist.filter(x => x.empId != self.videoInfo.empid && x.empId != self.pinWebcamInfo.empId);
                                                    asklist.forEach((sp) => {
                                                        self.askUserReleaseMic(sp, false, isPassTitleUser);
                                                    });
                                                } catch (e) { console.log(e) }
                                            },
                                        },
                                        {
                                            text: "否",
                                            addClass: "btn-danger",
                                        }
                                    ]);
                                    return;
                                }
                                self.blockForSpeak(); //roller
                                self.currUser.isMute = !self.currUser.isMute;

                                //發言者 srcUrl 用  cameraframe.html
                                let _data = {
                                    userId: self.currUser.userId,
                                    // displayName: `${self.currUser.deptId}/${self.currUser.name}`,
                                    displayName: `${self.currUser.name}`,
                                    isUsing: !self.currUser.isMute,
                                    kmsid: "",
                                    //srcUrl 後來不使用                                    
                                    //srcUrl: `cameraframe.html?autoplay=1&background=1&&hascamera=${self.deviceInfo().hasCamera?1:0}&roomid=${window.params.roomid}&displayName=${self.currUser.name}`,
                                    srcObject: null,
                                    isMute: false,
                                    // isCameraOff:false,
                                    isSpeaking: false,
                                    hascamera: self.deviceInfo().hasCamera,
                                    isDiableCamera: !self.deviceInfo().hasCamera,
                                    audioFFTData: [],
                                    videoState: 'new',
                                    isHD: (eventType == "updateMicHD"),
                                    isHD2: (eventType == "updateMicHD2"), // 開桌面直播(改用後鏡頭)
                                    isAllowWebCam: self.currUser.isAllowWebCam,
                                    logTime: { action: self.currUser.isMute ? 'end' : 'start', time: getTimeStamp() },
                                    cannotHearYou: false,
                                    trackEnabled:true,
                                };

                                // console.log('handleMic eventType data [updateMic]', _data);
                                if (eventType == "updateMicHD" || eventType == "updateMicHD2") { //自己視訊直播
                                    if (self.pinWebcamInfo.isShow && eventType == "updateMicHD") {
                                        self.unPinWebCam();
                                    }
                                    let sp = self.onlineSpeakers.filter(x => x.userId == self.currUser.empId);

                                    if (sp.length > 0) {
                                        if (!sp[0].isHD) {
                                            self.handleMic("releaseMicNoConfirm");
                                            return;
                                        }
                                        else {
                                            startFunction(true);  //KMS 前鏡頭   
                                        }

                                    }
                                    self.isShareVideo = true;
                                    self.isShareVideoLocalWebCam = (eventType == "updateMicHD"); //視訊直播中
                                    self.isShareVideoLocalKMSWebCam = (eventType == "updateMicHD2"); //雙鏡頭直播
                                }

                                self.updateSpeakerCam(_data);
                                self.onlineUsers.forEach((u) => {
                                    u.connectionState = "checking";
                                });
                                //--for translate
                                if (self.roomInfo.transType != "") {
                                    //self.speakText("en","Hello,How are you?");                                    
                                    self.speakText("en", "");
                                    self.startRecording();
                                }
                            }
                            else { // 自己已發言. 點選視訊直播/雙鏡頭直播
                                if (eventType != 'updateMicHD' && eventType != 'updateMicHD2') {
                                    if (self.currUser.isMute) {
                                        if (mediaRecorder && mediaRecorder.state == "recording") {
                                            mediaRecorder.stop();
                                            // mediaRecorder.start(1000);
                                            mediaRecorder.start(50);
                                        }
                                    }
                                    // else {
                                    //     if (mediaRecorder && mediaRecorder.state != "recording") {
                                    //         mediaRecorder.start(50);
                                    //     }
                                    // }
                                    self.mute(!this.currUser.isMute);
                                }
                                else {
                                    //已發言 & 自己視訊直播updateMicHD   或 雙鏡頭直播 updateMicHD2  
                                    if (!self.currUser.isAllowMicphone) {
                                        self.oNotify.ConfirmMsg(self.$t("lan-notify-nomic-title"), self.$t("lan-notify-nomic-content"));
                                        return;
                                    }
                                    if (!self.currUser.isAllowWebCam) {
                                        self.oNotify.ConfirmMsg(self.$t("lan-notify-nowebcam-title"), self.$t("lan-notify-nowebcam-content"));
                                        return;
                                    }

                                    //自己視訊直播
                                    if (self.pinWebcamInfo.isShow) {
                                        self.unPinWebCam();
                                    }
                                    let sp = self.onlineSpeakers.filter(x => x.userId == self.currUser.empId);

                                    if (sp.length > 0) {
                                        if (!sp[0].isHD) {
                                            self.handleMic("releaseMicNoConfirm");
                                            setTimeout(() => {
                                                self.handleMic(eventType);
                                            }, 200);

                                            return;
                                        }
                                        else {
                                            if (eventType == 'updateMicHD2') {
                                                sp[0].isHD = false;
                                                sp[0].isHD2 = true;
                                                self.isShareLocalDoubleCam = true;
                                                startFunction(true);  //KMS 前鏡頭  
                                            }

                                        }
                                    }
                                    self.isShareVideo = true;

                                    if (eventType == 'updateMicHD2') {
                                        self.isShareVideoLocalWebCam = false;
                                        self.isShareVideoLocalKMSWebCam = true;
                                    }
                                    else {
                                        self.isShareVideoLocalKMSWebCam = false;
                                        self.isShareVideoLocalWebCam = true;
                                    }
                                    console.log(eventType, self.isShareVideoLocalKMSWebCam);
                                    console.log(eventType, self.isShareVideoLocalWebCam);

                                    send(`startSpeakHD#${connection.userid}#${sp.kmsid}&hasCamera=${sp.hasCamera}`);
                                    $VM.userState_DashB.speakInfo.isLive = true;
                                    $VM.userState_DashB.speakInfo.liveSource = "webcam";
                                    $VM.userState_DashB.speakInfo.kmsid_Live = sp.kmsid;
                                    $VM.writeLog("使用者操作", `[DISPLAYNAME] 開啟視訊直播`);
                                    $VM.appendHistory("share", `[DISPLAYNAME] ${self.$t('lan-his-webcam-live-on')}`);

                                }
                            }
                            break;

                        case "recvUpdateMic": // from onmessage data已組好過來
                            self.updateSpeakerCam(data);
                            break;
                        case "releaseMic": //取消發言
                            self.oNotify.ConfirmCustomMsg(self.$t("lan-notify-quiet"), "", [
                                {
                                    text: self.$t("lan-notify-yes"),
                                    click: () => {
                                        if (self.isShareVideoLocalWebCam) {
                                            self.isShareVideoLocalWebCam = false;
                                            self.isShareVideo = false;
                                            self.unPinWebCam();
                                        }

                                        try {
                                            self.updateSpeakerCam({
                                                userId: self.currUser.userId,
                                                displayName: null,
                                                isUsing: false,
                                                kmsid: "",
                                                srcUrl: "",
                                                srcObject: null,
                                                isMute: false,
                                                // isCameraOff:false,
                                                isSpeaking: false,
                                                hascamera: false,
                                                isDiableCamera: true,
                                                audioFFTData: [],
                                                videoState: 'end',
                                                isHD: false,
                                                isAllowWebCam: null,
                                                logTime: { action: 'end', time: getTimeStamp() },
                                                cannotHearYou: false,
                                                trackEnabled:true,
                                            });
                                            //取消發言，要把peer release
                                            let sp = self.onlineSpeakers.filter(x => x.userId == self.currUser.userId);
                                            if (sp.length > 0) {
                                                self.releaseSpeakerConn(sp[0]);
                                            }
                                            //取消發言，也要清除check cannotHearYou 的 setTimeout by 2021/07/19
                                            let spAry = self.onlineSpeakers.filter(x => x.userId != self.currUser.userId);
                                            self.onlineSpeakers.forEach((s) => {
                                                s.cannotHearYou = false;
                                                if (s.userId != self.currUser.userId && s.setcannotHearYouTimout) {
                                                    clearTimeout(s.setcannotHearYouTimout);
                                                    s.setcannotHearYouTimout = null;
                                                }
                                            });
                                            setTimeout(() => send("mute#" + self.currUser.empId + "#false"), 200);
                                            //--for translate
                                            if (self.roomInfo.transType != "") {
                                                self.stopRecording();
                                            }
                                        } catch (e) { console.log(e) }
                                    },
                                },
                                {
                                    text: self.$t("lan-notify-no"),
                                    // click:()=>{ videoConference.webrtc.functions.shareMyScreen(isForceWebRTC)},
                                    addClass: "btn-danger",
                                }
                            ]);
                            //$VM.speakText("zh","取消發言");
                            break;
                        case "releaseMicNoConfirm": //收到取消發言訊息 點確認 不再confirm
                            // self.updateSpeakerCam({
                            //     userId: self.currUser.userId,
                            //     displayName: null,
                            //     isUsing: false,
                            //     kmsid: "",
                            //     srcUrl: "",
                            //     srcObject: null,
                            //     isMute: false,
                            //     // isCameraOff:false,
                            //     isSpeaking: false,
                            //     hascamera: false,
                            //     isDiableCamera: true,
                            //     cannotHearYou: false,
                            //     trackEnabled:true,
                            // });
                            if (self.isShareVideoLocalWebCam) {
                                self.isShareVideoLocalWebCam = false;
                                self.isShareVideo = false;
                                self.unPinWebCam();
                            }

                            try {
                                self.updateSpeakerCam({
                                    userId: self.currUser.userId,
                                    displayName: null,
                                    isUsing: false,
                                    kmsid: "",
                                    srcUrl: "",
                                    srcObject: null,
                                    isMute: false,
                                    // isCameraOff:false,
                                    isSpeaking: false,
                                    hascamera: false,
                                    isDiableCamera: true,
                                    audioFFTData: [],
                                    videoState: 'end',
                                    isHD: false,
                                    isAllowWebCam: null,
                                    logTime: { action: 'end', time: getTimeStamp() },
                                    cannotHearYou: false,
                                    trackEnabled:true,
                                });
                                //取消發言，要把peer release
                                let sp = self.onlineSpeakers.filter(x => x.userId == self.currUser.userId);
                                if (sp.length > 0) {
                                    self.releaseSpeakerConn(sp[0]);
                                }
                                //取消發言，也要清除check cannotHearYou 的 setTimeout by 2021/07/19
                                let spAry = self.onlineSpeakers.filter(x => x.userId != self.currUser.userId);
                                self.onlineSpeakers.forEach((s) => {
                                    s.cannotHearYou = false;
                                    if (s.userId != self.currUser.userId && s.setcannotHearYouTimout) {
                                        clearTimeout(s.setcannotHearYouTimout);
                                        s.setcannotHearYouTimout = null;
                                    }
                                });
                                setTimeout(() => send("mute#" + self.currUser.empId + "#false"), 200);
                                //--for translate
                                if (self.roomInfo.transType != "") {
                                    self.stopRecording();
                                }
                            } catch (e) { console.log(e) }
                            break;
                        default:
                            break;
                    }
                } catch (e) { console.error(e); }
            },
            releaseSpeakerConn: function (sp) {
                const self = this;
                try {
                    console.log("releaseSpeakerConn", sp.displayName);
                    if (sp.recorder) {
                        sp.recorder.stop();
                        sp.recorder = null;
                    }
                    if (sp.webRtcPeer) {
                        sp.webRtcPeer.dispose();
                        sp.webRtcPeer = null;
                    }
                    if (sp.pipeline) {
                        sp.pipeline.release();
                        sp.pipeline = null;
                    }
                    if (sp.client) {
                        sp.client.close(); //ws colose 
                        sp.client = null; //ws colose                    
                    }
                } catch (e) { console.log(e) }

            },
            updateSpeakerCam: function (data) {
                const self = this;
                // console.log('updateSpeakerCam .. data. ',data.isUsing, data.logTime);

                let userIndex = self.onlineSpeakers.findIndex(x => x.userId == data.userId);
                //console.log("updateSpeakerCam",data)
                if (data.isUsing) {
                    if (userIndex < 0) {
                        if (data.isHD2)
                            self.isShareLocalDoubleCam = true;
                        self.onlineSpeakers.push(data);
                        if (data.isHD) {
                            self.isShareVideo = true;
                            self.pinWebCam(data);
                        }
                    }
                } else {

                    if (userIndex >= 0) {
                        let speaker = self.onlineSpeakers.filter(x => x.userId == data.userId)[0];


                        try {
                            let _tmp = self.onlineSpeakers.filter(function (v, i, a) {
                                return (v.userId != data.userId)
                            });
                            self.onlineSpeakers = _tmp;

                        } catch (err) {
                            console.log(err);
                        }
                        if (data.userId == self.currUser.userId) {
                            self.releaseSpeakerConn(speaker);
                            self.currUser.isMute = true;

                            self.ckDispalyMyWebCam = false;
                            self.cameraInfo.id = null;
                            self.cameraInfo.userid = null;
                            self.cameraInfo.empid = null;
                            send(`stopSpeak#${connection.userid}`);
                            self.userState_DashB_clearSpeak();
                            try {
                                $VM.writeLog("使用者操作", `[DISPLAYNAME] 取消發言(KSMID:${speaker.kmsid}，發言時間${getTimeDiff(data.logTime.time, speaker.logTime.time)} )`);
                                $VM.appendHistory("quiet", `[DISPLAYNAME] ${$VM.$t('lan-his-unspeak-time', { time: `${getTimeDiff(data.logTime.time, speaker.logTime.time)}` })}`);
                            } catch (ex) {
                                $VM.writeLog("使用者操作", `[DISPLAYNAME] 取消發言`);
                                $VM.appendHistory("quiet", `[DISPLAYNAME] ${self.$t('lan-his-unspeak')}`);
                            }

                        }
                    }

                    if (data.userId == self.currUser.userId)
                        self.onlineUsers.forEach((u) => {
                            u.connectionState = "";
                        });
                    //取消發言後，重新check cannotHearYou by 2021/06/30
                    self.onlineSpeakers.forEach(s => {
                        s.cannotHearYou = false;
                        if (s.userId != self.currUser.userId && s.setcannotHearYouTimout) {
                            clearTimeout(s.setcannotHearYouTimout);
                            s.setcannotHearYouTimout = null;
                        }
                    });

                    self.checkCanvasDispaly(); //確認Canvas z-index
                }
            },
            updateSpeakerSpeakInfo: function (msg, _retry = false) {
                const self = this;
                try {
                    let findIndex = self.onlineUsers.findIndex(x => x.userId == msg.sendUserId);
                    if (findIndex == -1) return;
                    let spIdx = self.onlineSpeakers.findIndex(x => x.userId == msg.sendUserId)
                    if (spIdx == -1) { // onlineSpeakers not found
                        if (msg.data.speakInfo.isSpeaking == true) {
                            //console.log("speaker not found!",msg.sendUserId,msg.data.speakInfo);
                            if (_retry) {
                                setTimeout(function () {
                                    //console.log("speaker interval!",msg.sendUserId);
                                    self.updateSpeakerSpeakInfo(msg, false);
                                }, 2000);
                            }
                        }
                    }
                    else {
                        //--remark 原已有mqtt msg接收後的處理,避免影響-s.
                        //self.onlineSpeakers[spIdx].isMute = msg.data.speakInfo.isMute;
                        //self.onlineSpeakers[spIdx].isSpeaking = msg.data.speakInfo.isSpeaking;
                        //self.onlineSpeakers[spIdx].isDiableCamera = msg.data.speakInfo.isDisableCamera;
                        //self.onlineSpeakers[spIdx].kmsid = msg.data.speakInfo.kmsid_Speak;
                        //--remark 原已有mqtt msg接收後的處理,避免影響-e.

                        //mark by vic 2022/09/02 
                        // if(msg.data.speakInfo.isLive==false && self.isShareVideoImage == true){ //停止圖片直播
                        //     self.sharingImageSrc = '';
                        //     self.sharingImageUser = '';                            
                        //     self.isShareVideo = false;         
                        //     self.clickDispalyMyVideo();                        
                        // }
                        // // binding spakInfo from userState_DashB       
                        // self.$set(self.onlineSpeakers[spIdx],'speakInfo',msg.data.speakInfo); 
                        // if(msg.data.speakInfo.isLive==true && msg.data.speakInfo.liveSource=="image"){
                        //     self.sharingImageSrc = msg.data.speakInfo.kmsid_Live;
                        //     self.sharingImageUser = msg.userid;
                        //     self.isShareVideo = true;
                        // }
                    }
                } catch (err) {
                    console.log(err);
                }
            },
            shareFile: function (event) {
                const self = this;
                //$("#shareFile")[0].click();  // could have message:File chooser dialog can only be shown with a user activation.
                this.$refs.shareFile.dispatchEvent(new MouseEvent('click'));
            },
            shareImage: function (event) {
                const self = this;
                //$("#shareImage")[0].click();
                this.$refs.shareImage.dispatchEvent(new MouseEvent('click'));
            },
            viewShareImage: function (event) {
                const self = this;
                $("#ModalViewImage").modal("toggle");
            },
            openShareDoc: function (fileKind, linkurl, newWindow = false) {
                const self = this;
                try {
                    if (!newWindow && fileKind == "image") {
                        self.viewShareImage();
                    } else {
                        if (fileKind == "file") {
                            window.open(linkurl);
                        } else {
                            window.open(linkurl);
                        }
                    }
                } catch (err) {
                    console.log(err);
                }
            },
            click_divLiveImg: function () {
                const self = this;
                //this.oNotify.ConfirmMsg( self.$t("lan-notify-liveimage-howto"), ""); //不顯示訊息,改顯示檔案選擇
                self.userState_DashB.speakInfo.liveSource = "image";
                self.shareImage();
            },
            beforeLiveImage: function (_file) {
                const self = this;
                //-popup to confirm
                let _notify = "";
                if (self.isShareVideo_0 || self.isShareVideoImage) { //有人正在直播
                    $VM.oNotify.ConfirmMsg($VM.$t("lan-notify-livestreaming"), "");
                    return;
                    //_notify = self.$t("lan-notify-livestreaming")+",";
                }
                self.oNotify.ConfirmCustomMsg(self.$t("lan-notify-liveimage", { notify: `${_notify}` }), "", [
                    {
                        text: self.$t("lan-notify-yes"),
                        click: () => {
                            //--開啟直播前若未發言,要開啟發言                   
                            if (self.onlineSpeakers.filter(x => x.userId == self.currUser.userId).length <= 0) {
                                self.handleMic('updateMic');
                            }
                            //--check 直播權限
                            //----as beforeKmsShareClick,如果是外部會議, 內部人員點桌面直播時, 檢查邀請名單中的外部人員, 若有任一人非白名單, 系統顯示提示, 不允許直播
                            if (_CONFIG3_External && self.currUser.userType !== "M") {
                                HasPermissionToShareToExternal().then(function (resolve) {
                                    if (!resolve.hasPermission) {
                                        self.oNotify.ConfirmMsg("", self.$t("lan-notify-noshare1", { name: `${resolve.externalNotInList}` }));
                                        return;
                                    }
                                }).catch(err => {
                                    self.oNotify.ConfirmMsg("", self.$t("lan-notify-noshare2"));
                                    return;
                                });
                            }
                            self.checkandClosePIP();     //關閉PIP
                            self.setWhiteboardUrl(false);//關閉共用白板                                       

                            //-do upload file to live image
                            self.userState_DashB.speakInfo.liveSource = "image";
                            doUploadFile(_file, "image");
                        },
                    },
                    {
                        text: self.$t("lan-notify-no"),
                        addClass: "btn-danger",
                        click: () => {
                            //do nothing
                        }
                    }
                ]);
            },
            LiveImage: function (event) {
                const self = this;
                //--action:圖片直播/停止圖片直播
                if (self.isShareVideoLocalImage) {   //click:停止圖片直播
                    self.userState_DashB_clearLive();
                    self.isShareVideo = false;
                    self.isShareVideoLocalImage = false;
                    self.sharingImageSrc = "";
                    self.sharingImageUser = "";
                    self.isShareVideo = false;
                    self.isShareVideoImage = false;
                    self.clickDispalyMyVideo();
                    send(`stopimage#${$VM.currUser.empId}#img=&file=`);
                } else {                              //click:圖片直播
                    //--check 直播權限
                    //----as beforeKmsShareClick,如果是外部會議, 內部人員點桌面直播時, 檢查邀請名單中的外部人員, 若有任一人非白名單, 系統顯示提示, 不允許直播
                    if (_CONFIG3_External && self.currUser.userType !== "M") {
                        HasPermissionToShareToExternal().then(function (resolve) {
                            if (!resolve.hasPermission) {
                                self.oNotify.ConfirmMsg("", self.$t("lan-notify-noshare1", { name: `${resolve.externalNotInList}` }));
                                return;
                            }
                        }).catch(err => {
                            self.oNotify.ConfirmMsg("", self.$t("lan-notify-noshare2"));
                            return;
                        });
                    }
                    self.checkandClosePIP();     //關閉PIP
                    self.setWhiteboardUrl(false);//關閉共用白板                    
                    //--開啟直播前若未發言,要開啟發言                   
                    if (self.onlineSpeakers.filter(x => x.userId == self.currUser.userId).length <= 0) {
                        self.handleMic('updateMic');
                    }
                    //--upload image, userState_DashB.speakInfo.isLive=true after upload OK
                    self.userState_DashB.speakInfo.liveSource = "image";
                    this.$refs.shareImage.dispatchEvent(new MouseEvent('click'));
                }
            },
            sharingImageLoad: function (event) {
                const self = this;
                //console.log("img~load",event.type);
                //start canvas
                self.ckDispalyMyVideo = false;
                self.clickDispalyMyVideo();
            },
            openPIP: function (event) {
                const self = this;
                self.isShowPIP = !(document.pictureInPictureElement !== null);
                if (self.isShowPIP) {
                    // 進入 Picture In Picture
                    if (self.pinWebcamInfo.isShow && self.pinWebcamInfo.srcObject) {
                        $("#pinWebcamVideoTag")[0].requestPictureInPicture().catch((error) => {
                            // Error Handling
                        });
                    } else
                        $("#sharingVideoTag")[0].requestPictureInPicture().catch((error) => {
                            // Error Handling
                        });
                } else {
                    // 離開 Picture In Picture
                    if (document.exitPictureInPicture) {
                        document.exitPictureInPicture().catch((error) => {
                            // Error Handling
                        });
                    }
                }
            },
            remoteCtrl: function (event) {
                const self = this;
                let _currUserInfo = self.currUser.name; //(self.currUser.deptId) ? `${self.currUser.deptId}/${self.currUser.name}` : self.currUser.name;
                let shareUser = self.onlineUsers.filter(x => x.empId == self.videoInfo.empid);
                titleShare = (shareUser.length > 0) ? `${shareUser[0].deptId}/${shareUser[0].name}` : "";

                if (self.isFullScreen) self.cancelFullScreen(); //全螢幕下彈跳視窗會被蓋掉，要先取消螢幕
                if (!self.isRemoteCtrlActive) {
                    self.oNotify.ConfirmCustomMsg(`是否發送 [${titleShare}] 遠端操作請求`, "", [
                        {
                            text: "是",
                            click: () => self.cvsBoard.rmCtrl.sendEventControlFlowData("request", shareUser[0].userId, _currUserInfo),
                        },
                        {
                            text: "否",
                            addClass: "btn-danger",
                        }
                    ]);
                } else {
                    self.oNotify.ConfirmCustomMsg(`是否取消 [${titleShare}] 遠端操作請求`, "", [
                        {
                            text: "是",
                            click: () => {
                                self.cvsBoard.rmCtrl.sendEventControlFlowData("remote_cancel", shareUser[0].userId, _currUserInfo);
                            },
                        },
                        {
                            text: "否",
                            addClass: "btn-danger",
                        }
                    ]);
                }
            },
            holoArrow: function () {
                const self = this;
                let _currUserInfo = self.currUser.name; //(self.currUser.deptId) ? `${self.currUser.deptId}/${self.currUser.name}` : self.currUser.name;
                let shareUser = self.onlineUsers.filter(x => x.empId == self.videoInfo.empid);
                titleShare = (shareUser.length > 0) ? `${shareUser[0].deptId}/${shareUser[0].name}` : "";

                if (self.isFullScreen) self.cancelFullScreen(); //全螢幕下彈跳視窗會被蓋掉，要先取消螢幕
                if (!self.isHoloArrowActive) {
                    self.oNotify.ConfirmCustomMsg(self.$t("lan-notify-holo-arrow"), "", [
                        {
                            text: "是",
                            click: () => {
                                sendHoloArrowReq(false, shareUser[0].userId, _currUserInfo),
                                    self.isHoloArrowActive = !self.isHoloArrowActive;
                                self.videopause();  // 錨點啟用後暫停video
                            }
                        },
                        {
                            text: "否",
                            addClass: "btn-danger",
                        }
                    ]);
                } else {
                    sendHoloArrowReq(true, shareUser[0].userId, _currUserInfo);
                    self.isHoloArrowActive = !self.isHoloArrowActive;
                    self.cvsBoard.penData = [];
                    self.videoplay();    // 錨點關閉後play video
                }
            },
            holoCapture: function () {
                const self = this;
                self.oNotify.ConfirmCustomMsg(self.$t("lan-notify-holo-capture"), "", [
                    {
                        text: "是",
                        click: () => {
                            sendHoloCaptureReq();
                        }
                    },
                    {
                        text: "否",
                        addClass: "btn-danger",
                    }
                ]);
            },
            holoStopCapture: function () {
                const self = this;
                self.oNotify.ConfirmCustomMsg(self.$t("lan-notify-holo-stop-capture"), "", [
                    {
                        text: "是",
                        click: () => {
                            sendHoloStopCaptureReq();
                        }
                    },
                    {
                        text: "否",
                        addClass: "btn-danger",
                    }
                ]);
            },
            checkandClosePIP: function () {
                const self = this;
                console.log("checkandClosePIP", (document.pictureInPictureElement !== null));
                self.isShowPIP = (document.pictureInPictureElement !== null);
                if (self.isShowPIP) {
                    // 字幕子母畫面另外處理
                    if (document.pictureInPictureElement.id == "subtitleVideo")
                        return;
                    // 離開 Picture In Picture
                    if (document.exitPictureInPicture) {
                        document.exitPictureInPicture().catch((error) => {
                            // Error Handling
                        });
                        self.isShowPIP = false;
                    }
                }
                // cancel element fullscreen: 避免viewer[]element fullscreen,直播主停止直播後,viewer仍全螢幕
                if (self.isFullScreen) {
                    self.cancelFullScreen();
                }
            },
            startViewing: function (event, speaker) {
                //取得視訊VIDEO STATE
                const self = this;

                console.log("startViewing", speaker.userId, event.type);
                if (event.type == 'loadstart') {
                    setTimeout(() => { if (speaker.videoState != 'play' && speaker.videoState != 'canplay') { speaker.videoState = 'loadstart'; console.log('update loadstart'); } }, 8000);
                }
                else {
                    speaker.videoState = event.type;
                }
                try {
                    if (speaker && ['canplay', 'play'].includes(event.type)) {
                        send(`reciverspeakeply#${connection.userid}##${speaker.userId}`);                    
                    }
                } catch (e) { console.log(e) };

            },
            pinWebCamManual: function (_speaker) { //
                const self = this;

                try {

                    if ((self.pinWebcamInfoManual.empId != _speaker.userId) && _speaker.isDiableCamera) {
                        return;
                    }
                    if (self.pinWebcamInfoManual.isShow) {
                        self.unPinWebCamManual();
                    }
                    else {
                        self.pinWebcamInfoManual.isShow = true;
                        self.pinWebcamInfoManual.empId = _speaker.userId;
                        self.pinWebcamInfoManual.srcObject = _speaker.srcObject;
                    }


                } catch (e) { console.log(e) };
            },
            unPinWebCamManual: function () {
                const self = this;
                try {
                    self.pinWebcamInfoManual.isShow = false;
                    self.pinWebcamInfoManual.empId = null;
                    self.pinWebcamInfoManual.scrObject = null;

                } catch (e) { console.log(e) };
            },
            pinWebCam: function (_speaker) { //
                const self = this;

                try {
                    if (!self.pinWebcamInfo.isShow) {
                        self.pinWebcamInfo.isShow = true;
                        self.pinWebcamInfo.empId = _speaker.userId;
                        self.pinWebcamInfo.srcObject = _speaker.srcObject;
                    } else {
                        self.unPinWebCam();
                    }
                    //  $("#pinWebcamVideoTag")[0].srcObject = pingWebCamMedia;
                    //  console.log(pingWebCamMedia);


                } catch (e) { console.log(e) };
            },
            unPinWebCam: function () {
                const self = this;
                try {
                    self.pinWebcamInfo.isShow = false;
                    self.pinWebcamInfo.empId = '';
                    self.pinWebcamInfo.scrObject = null;

                } catch (e) { console.log(e) };
            },
            askUserReleaseMic: function (speaker, isConfirm = true, isPassUserWithTitle = true) {
                const self = this;
                try {
                    let user = self.onlineUsers.filter(x => x.empId == speaker.userId)[0];

                    if (!user.titleWithConfig || !isPassUserWithTitle) {
                        let title = user.displayName;
                        if (isConfirm) {
                            if (!speaker.isMute) {
                                self.oNotify.ConfirmCustomMsg(self.$t("lan-notify-mute", { name: `${title}` }), "", [
                                    {
                                        text: self.$t("lan-notify-yes"),
                                        click: () => {
                                            try {
                                                send(`remind#${self.currUser.userId}#mute#${user.userId}#${$VM.currUser.deptId}/${$VM.currUser.name}`);
                                            } catch (e) { console.log(e) }
                                        },
                                    },
                                    {
                                        text: self.$t("lan-notify-no"),
                                        // click:()=>{ videoConference.webrtc.functions.shareMyScreen(isForceWebRTC)},
                                        addClass: "btn-danger",
                                    }
                                ]);
                            }
                            else {
                                self.oNotify.ConfirmCustomMsg(self.$t("lan-notify-mute3", { name: `${title}` }), "", [
                                    {
                                        text: self.$t("lan-notify-yes"),
                                        click: () => {
                                            try {
                                                send(`remind#${self.currUser.userId}#releaseMic#${user.userId}`);
                                            } catch (e) { console.log(e) }
                                        },
                                    },
                                    {
                                        text: self.$t("lan-notify-no"),
                                        // click:()=>{ videoConference.webrtc.functions.shareMyScreen(isForceWebRTC)},
                                        addClass: "btn-danger",
                                    }
                                ]);
                            }

                        } else {
                            try {
                                send(`remind#${self.currUser.userId}#askMic#${user.userId}`);
                            } catch (e) { console.log(e) }
                        }


                    }
                } catch (e) { console.log(e) };
            },
            reConnectKms: function (speaker) {
                const self = this;
                setTimeout(() => {
                    speaker.cannotHearYou = false;
                    kurentoView(0, speaker, $VM.pinWebcamInfo);
                }, 1000);
            },
            startPlayCameraVideo: function (speakerUserId) {
                const self = this;
                try {
                    let _sp = self.onlineSpeakers.filter(x => x.userId == speakerUserId)[0];
                    if (_sp.videoState == 'canplay') {
                        console.log("canplay~>try play", _sp.userId);
                        if ($(`#kurento_${speakerUserId}`).length > 0) $(`#kurento_${speakerUserId}`)[0].play();
                    }
                } catch (e) { console.log(e) }
            },
            startPlayCamera: function (speaker) {
                const self = this;
                try {
                    self.$nextTick(() => {
                        let sp = self.onlineSpeakers.filter(x => x.userId == speaker.userId)[0];
                        speaker.cvsSound = self.$refs.cvsSound.filter((x) => x.dataset.userid == sp.userId)[0];
                        sp.webrtcOption = self.webrtcOption;
                        if (speaker.userId == self.currUser.userId) //自己的直播發言不用等待秒數
                            kurentoStart(0, sp);
                        else {
                            if (self.onlineUsers.length + 1 >= 200) {
                                let waitSec = getRandom(1, 3);
                                //console.log(`random wait ${waitSec} sec`)
                                setTimeout(() => { kurentoView(0, sp, self.pinWebcamInfo); }, waitSec * 1000);
                            }
                            else {
                                kurentoView(0, sp, self.pinWebcamInfo);
                            }
                            //timed out 時狀態改為loadstart, 重建連線出現 2021/06/25
                            setTimeout(() => {
                                if (sp.videoState == 'new')
                                    sp.videoState = 'loadstart';
                            }, 20000);
                            let selfspAry = self.onlineSpeakers.filter(x => x.userId == self.currUser.userId);
                            if (selfspAry.length > 0) //表示我在發言
                            {
                                let uAry = self.onlineUsers.filter(u => u.userId == sp.userId);
                                if (uAry.lenght > 0) {
                                    if (['connected'].includes(uAry[0].connectionState) > 0)
                                        sp.cannotHearYou = false;
                                    else {
                                        if (sp.setcannotHearYouTimout) {
                                            clearTimeout(sp.setcannotHearYouTimout);
                                            sp.setcannotHearYouTimout = null;
                                        }
                                        sp.setcannotHearYouTimout = setTimeout((_sp) => {
                                            _sp.cannotHearYou = self.checkcannotListenToMe(_sp);
                                        }, 2000, sp);
                                    }
                                }
                            }
                        }
                        if (speaker.isHD2) {
                            self.isShareLocalDoubleCam = true;
                            startFunction(true);
                        }
                    });

                } catch (e) { console.log(e) }
                finally { }
            },
            avatarDisplay(userId, isShortName = true) {
                try {
                    const self = this;
                    let user = null;
                    let show_name = "";

                    if (self.currUser.userId == userId) {
                        user = self.currUser;
                    } 
                    else {
                        user = self.onlineUsers.filter(x => x.userId == userId)[0];
                    }

                    if (user.userType === "M") {
                        show_name = user.displayName.slice(0, 10);
                    } 
                    else {
                        if (isShortName) {
                            let photoUid = user.avatar ? user.avatar : null;
                            //if(photoUid) return "";
                            if (photoUid && user.avatarIsExist) return "";
                        }

                        let name = user.name;

                        try {
                            if (i18n.locale == 'en') {
                                if (user.ename && user.ename != '')
                                    name = user.ename;
                                else
                                    name = user.email;
                            }
                        }
                        catch (e) { }

                        let titleWithConfig = user.titleWithConfig ? user.titleWithConfig : null;

                        show_name = titleWithConfig ? titleWithConfig : (isShortName ? name.substr(name.length - 2, 2) : name);
                    }

                    return (show_name.length > 10) ? `${show_name.slice(0, 10)}` : show_name;
                } catch (error) {
                    console.log(error);
                    return "";
                }

            },
            onlineUserDisplay(user) {
                const self = this;
                
                // 內部會議
                if(self.roomInfo.version != '3.2') {
                    return user.displayName;
                }

                let show_name = "";
                if (user.userType === "M") {
                    show_name = user.displayName;
                }
                else {
                    let e_name = user.titleWithConfig ? user.titleWithConfig : user.ename ? user.ename : user.email;
                    show_name = `${user.deptId}/${user.name}(${e_name})`;
                }

                return show_name;
            },
            checkPhotoUidIsEffective(userId, photoUid) {
                try {
                    const self = this;
                    let img = new Image();
                    img.onload = function () {
                        //console.log("userId:"+userId+"avatar check:OK!");
                        if (self.currUser.userId == userId) {
                            self.currUser.avatarIsExist = true;
                        }
                        else {
                            let findIndex = self.onlineUsers.findIndex(x => x.userId == userId);
                            if (findIndex != -1) {
                                self.onlineUsers[findIndex].avatarIsExist = true;
                            }
                        }
                    };
                    img.onerror = function () {
                        //console.log("userId:"+userId+"avatar check:NG!");
                        //表示找不到大頭貼圖檔
                        //但要判斷自已還是別人
                        if (self.currUser.userId == userId) {
                            self.currUser.avatarIsExist = false;
                        }
                        else {
                            let findIndex = self.onlineUsers.findIndex(x => x.userId == userId);
                            if (findIndex != -1) {
                                self.onlineUsers[findIndex].avatarIsExist = false;
                            }
                        }
                    };
                    img.src = `${CONFIG.apiUrl}/api/UploadFile/GetImageByUid?uid=${photoUid}&original=N`;
                }
                catch
                {
                    console.log(error);
                }
            },
            avatarStyle(userId, vidoState = null) {
                try {
                    const self = this;
                    let user = null;
                    let photoUid = null;
                    let photoUrl = null;

                    if (self.currUser.userId == userId) {
                        user = self.currUser;

                    } else {
                        user = self.onlineUsers.filter(x => x.userId == userId)[0];
                    }
                    photoUid = user.avatar ? user.avatar : null;
                    photoUrl = photoUid ?
                        `${CONFIG.apiUrl}/api/UploadFile/GetImageByUid?uid=${photoUid}&original=N` : null;
                    photoUrl = user.avatarIsExist ? photoUrl : null;
                    let style = {

                    };


                    if (userId == self.currUser.empId) vidoState = 'play';
                    if (photoUrl) {
                        style = {
                            "height": "100%",
                            "border-radius": "50%",
                            "margin-left": "21%",
                            "margin-right": "21%",
                            "font-size": "50px",
                            "background-color": user.name ? self.toColor(user.name) : "black",
                            "background": `url(${photoUrl})  no-repeat center ${user.name ? self.toColor(user.name) : "black"} `,
                            "background-size": "cover",
                            "opacity": ((vidoState) && ['canplay', 'loadstart'].includes(vidoState)) ? 0.5 : 1
                        };
                    }
                    else {
                        style = {
                            "height": "100%",
                            "border-radius": "50%",
                            "margin-left": "21%",
                            "margin-right": "21%",
                            "font-size": "50px",
                            "background-color": user.name ? self.toColor(user.name) : "black",
                            "background-image": 'none',
                            "background-size": "cover",
                            "opacity": ((vidoState) && ['canplay', 'loadstart'].includes(vidoState)) ? 0.5 : 1
                        };
                    }

                    return style;
                } catch (error) {
                    console.log(error);
                }

            },
            toColor(name) {
                let str = name;
                str = (name.split(" ").length > 1 ? name.split(" ")[1] : name);
                let hash = 0;
                let len = str.length;
                if (len === 0) return "black";
                for (let i = 0; i < len; i++) {
                    hash = (hash << 8) - hash + str.charCodeAt(i);
                    hash |= 0;
                }
                hash = Math.abs(hash);
                let result = "#" + hash.toString(16).substr(0, 6);
                if (result == "#ffffff") {
                    result = "#74b0e8"
                }
                return result;
            },
            dbclick(id, callback) {
                const self = this;
                if (self.clickid && id != self.clickid) return;
                if (self.clicktime == 0) {
                    setTimeout(() => {
                        self.clicktime = 0;
                        self.clickid = null;
                    }, 300);   //大概時間300ms
                }
                self.clicktime++;
                self.clickid = id;
                if (self.clicktime == 2) {
                    callback();
                }

            },
            exportChatMsg: function () {
                const self = this;
                try {
                    loadScript("js/static/xlsx.full.min.js");
                    $VM.oNotify.ConfirmCustomMsg(self.$t("lan-tab-export-title"), self.$t("lan-tab-export-content"), [
                        {
                            text: self.$t("lan-tab-export-download"),
                            click: () => {
                                const self = this;
                                let result = getMeetingMsg();
                                if (result && result.length > 0) {

                                    result.map(x => {
                                        x.msgBody = decrypt(x.msgBody, self.roomInfo.roomId);
                                    });

                                    data = [['時間', '工號', '姓名', '訊息內容']];

                                    result.forEach(x => {
                                        let row = [];
                                        row.push(x.sendTime);
                                        row.push(x.sendUserId);
                                        row.push(x.sendUserName);
                                        row.push(x.msgBody);
                                        data.push(row);
                                    });
                                    const workbook = new Workbook();
                                    const sheet = XLS.utils.aoa_to_sheet(data);
                                    workbook.appendSheet(sheet, 'sheet_1');
                                    let fileName = `${self.roomInfo.roomId}的交談內容.xls`;
                                    saveAs(workbook.toBlob(), fileName)
                                } else {
                                    alert(self.$t("lan-tab-export-zero"));
                                }
                            },
                        },
                        {
                            text: self.$t("lan-tab-export-cancel"),
                            click: () => { },
                        },]);

                } catch (error) {
                    console.log(error);
                    alert(self.$t("lan-tab-export-error"));
                }
            },
            formatDate: function(dateStr) {
                const date = new Date(dateStr);
                const hours = date.getHours().toString().padStart(2, '0');
                const minutes = date.getMinutes().toString().padStart(2, '0');
                return `${hours}:${minutes}`;
            },
            isChinese: function(text) {
                return /[\u4e00-\u9fa5]/.test(text);
            },
            generateTextContent: function(data, mode) {
                const self = this;
                return data.map(item => {
                    const time = self.formatDate(item.modify_dt);

                    if (mode == "subtitle") {
                        let chineseText = item.sentence;
                        let englishText = item.trans_sentence;

                        // Determine which text is Chinese and which is not
                        if (self.isChinese(item.trans_sentence) && !self.isChinese(item.sentence)) {
                            chineseText = item.trans_sentence;
                            englishText = item.sentence;
                        }

                        return `${time} ${item.owners}\n${chineseText.trim()}\n${englishText.trim()}`;
                    }

                    if (mode == "script") {
                        return `${time} ${item.username}\n${item.content.trim()}`;
                    }
                    
                }).join('\n\n');
            },
            exportToFile: function(filename, content) {
                const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            },
            exportScriptMsg: function (lang, type) {
                const self = this;
                try {
                    loadScript("js/static/xlsx.full.min.js");
                    let export_content = (type == "subtitle") ? self.$t("lan-tab-export-subtitle-content") : self.$t("lan-tab-export-script-content");
                    let file_last_name = (type == "subtitle") ? self.$t("lan-tab-speech-all") : self.$t("lan-tab-verbatim");
                    $VM.oNotify.ConfirmCustomMsg(self.$t("lan-tab-export-title"), export_content, [
                        {
                            text: self.$t("lan-tab-export-download"),
                            click: () => {
                                const self = this;                             
                                let result = [];                             
                                if ($VM.roomInfo.transType == '1') {
                                    result = getVoiceTransLog(); // from API
                                }
                                if ($VM.roomInfo.transType == '2' || $VM.roomInfo.transType == '3') {
                                    if (self.currTransTab == 'msgHistory_debug')
                                        result = getVoiceTransLog(); // from API
                                    else
                                        result = getSubtitleTransLog(); // from API
                                    
                                }
                                if (result && result.length > 0) {
                                    const textContent = self.generateTextContent(result,type);
                                    const filename = `${self.roomInfo.roomId}_${file_last_name}.txt`;
                                    const topic = `Topic: ${self.roomInfo.topic}`;
                                    const datetime = `Date: ${self.roomInfo.roomId.substring(0,4)}/${self.roomInfo.roomId.substring(4,6)}/${self.roomInfo.roomId.substring(6,8)}`
                                    self.exportToFile(filename, `${topic}\n\n${datetime}\n\n${textContent}`);
                                }
                                else {
                                    alert(self.$t("lan-tab-export-zero"));
                                }
                            },
                        },
                        {
                            text: self.$t("lan-tab-export-cancel"),
                            click: () => { },
                        },]);

                } catch (error) {
                    console.log(error);
                    alert(self.$t("lan-tab-export-error"));
                }
            },
            exportScriptMsg_backup: function (lang, type) {
                const self = this;
                try {
                    loadScript("js/static/xlsx.full.min.js");
                    let export_content = (type == "subtitle") ? self.$t("lan-tab-export-subtitle-content") : self.$t("lan-tab-export-script-content");
                    let file_last_name = (type == "subtitle") ? self.$t("lan-tab-speech-all") : self.$t("lan-tab-verbatim");
                    $VM.oNotify.ConfirmCustomMsg(self.$t("lan-tab-export-title"), export_content, [
                        {
                            text: self.$t("lan-tab-export-download"),
                            click: () => {
                                const self = this;                             
                                let result = [];
                                let data = [[]];  // download xls data                              
                                if ($VM.roomInfo.transType == '1') {
                                    result = getVoiceTransLog(); // from API
                                }
                                if ($VM.roomInfo.transType == '2' || $VM.roomInfo.transType == '3') {
                                    if (self.currTransTab == 'msgHistory_debug')
                                        result = getVoiceTransLog(); // from API
                                    else
                                        result = getSubtitleTransLog(); // from API
                                    
                                }

                                if (result && result.length > 0) {
                                    if ($VM.roomInfo.transType == '1') {
                                        data = [['Time', 'Name', 'Verbatim']];
                                    }
                                    if ($VM.roomInfo.transType == '2' || $VM.roomInfo.transType == '3') {
                                        if (self.currTransTab == 'msgHistory_debug')
                                            data = [['Time', 'Name', 'Verbatim']];
                                        else
                                            data = [['Time', 'Names', 'Subtitle', 'Translate']];
                                    }

                                    result.forEach(x => {
                                        let row = [];
                                        row.push(x.modify_dt);
                                        if ($VM.roomInfo.transType == '1') {
                                            row.push(x.username);
                                            row.push(x.content);
                                        }
                                        if ($VM.roomInfo.transType == '2' || $VM.roomInfo.transType == '3') {
                                            if (self.currTransTab == 'msgHistory_debug') {
                                                row.push(x.username);
                                                row.push(x.content);
                                            }
                                            else {
                                                row.push(x.userNameList);
                                                row.push(x.sentence);
                                                row.push(x.trans_sentence);
                                            }
                                        }
                                        data.push(row);
                                    });
                                }

                                if (data[0].length == 0) {
                                    alert(self.$t("lan-tab-export-zero"));
                                } else {
                                    const workbook = new Workbook();
                                    const sheet = XLS.utils.aoa_to_sheet(data);
                                    workbook.appendSheet(sheet, 'sheet_1');
                                    let fileName = `${self.roomInfo.roomId}_${file_last_name}.xls`;
                                    saveAs(workbook.toBlob(), fileName);
                                }

                            },
                        },
                        {
                            text: self.$t("lan-tab-export-cancel"),
                            click: () => { },
                        },]);

                } catch (error) {
                    console.log(error);
                    alert(self.$t("lan-tab-export-error"));
                }
            },
            exportPreloadLog: function (lang, type) {
                const self = this;
                try {                        
                    let result = [];
                    let data = [[]];  // download xls data                              
                    result = self.speechs_all.filter(x => x.is_merge);

                    if (result && result.length > 0) {
                        data = [['Date','Name','Whisper','srcSentence','resType','spendTimeApi']];

                        result.forEach(x => {
                            let row = [];
                            row.push(x.sendDate);
                            row.push(x.userName);
                            row.push(self.removeHtmlTags(x.txt_Whisper));
                            row.push(x.preload_api_info.srcSentence);
                            row.push(x.preload_api_info.resType);
                            row.push(x.preload_api_info.spendTimeApi);
                            data.push(row);
                        });
                    }

                    if (data[0].length == 0) {
                        alert(self.$t("lan-tab-export-zero"));
                    } else {
                        const workbook = new Workbook();
                        const sheet = XLS.utils.aoa_to_sheet(data);
                        workbook.appendSheet(sheet, 'sheet_1');
                        let fileName = `${self.roomInfo.roomId}_PreloadLog.xls`;
                        saveAs(workbook.toBlob(), fileName);
                    }
                } catch (error) {
                    console.log(error);
                    alert(self.$t("lan-tab-export-error"));
                }
            },
            clickPteamScheme: function (u) {
                const self = this;
                self.oNotify.ConfirmCustomMsg(self.$t('lan-notify-pteam', { name: `${u.name}` }), "", [
                    {
                        text: self.$t("lan-notify-yes"),
                        click: () => {
                            try {
                                self.isPteamChatTo = true;
                                self.Pteam.chatTo(u.userId)
                                    .then((resp) => {
                                        if (resp && resp.isSuccess && resp.isSuccess == false) {
                                            self.oNotify.ConfirmCustomMsg("", resp.message, [{ text: "好" }]);
                                        }
                                    });
                            } catch (e) { console.log(e) }
                        },
                    },
                    {
                        text: self.$t("lan-notify-no"),
                        // click:()=>{ videoConference.webrtc.functions.shareMyScreen(isForceWebRTC)},
                        addClass: "btn-danger",
                    }
                ]);
            },
            kmsVideoStreamChange: function (event) {
                const self = this;
                if ($(".kurentovideoInput").length == 0) return;
                let oldStatus = self.currUser.isUseBuildInCamForFace; //keep old status, 因kmsStop,會 reset currUser.isUseBuildInCamForFace
                kmsStop();//add 2020/12/08 雙鏡頭切換也要kmsStop()避免先前的殘留
                self.currUser.isUseBuildInCamForFace = !oldStatus;
                self.handleMicHD('updateMicHD2');
                // let mediaStream = $("#sharingVideoTag")[0].srcObject;
                // $("#sharingVideoTag")[0].srcObject = $(".kurentovideoInput")[0].srcObject ;
                // $(".kurentovideoInput")[0].srcObject = mediaStream;
            },
            zoomin: function (event) {
                const self = this;
                try {
                    let cap = $("#sharingVideoTag")[0].srcObject.getVideoTracks()[0].getCapabilities();
                    if (cap.zoom) {

                    }
                    // $VM.videoInfo.srcObject.getVideoTracks()[0].applyConstraints({
                    //     advanced: [{zoom: 2}]
                    // })
                    // .catch(e => console.log(e));
                } catch (ex) { console.log(ex) }
            },
            zoomout: function (event) {
                const self = this;
                try {
                    let cap = $("#sharingVideoTag")[0].srcObject.getVideoTracks()[0].getCapabilities();
                    if (cap.zoom) {
                        console.log()
                    }
                    // $VM.videoInfo.srcObject.getVideoTracks()[0].applyConstraints({
                    //     advanced: [{zoom: 2}]
                    // })
                    // .catch(e => console.log(e));
                } catch (ex) { console.log(ex) }
            },
            openDetectHtml: function () {
                window.open('checkenv/detect.html');
            },
            allmute: function (bolFlag) {
                const self = this;
                try {
                    self.currUser.isAllmute = !bolFlag;
                    // let vidary=$('video');

                    // if(vidary.length>0)
                    // {
                    //     Array.from(vidary).forEach(ele=>{
                    //         if(ele.srcObject && ele.srcObject.getAudioTracks())
                    //             ele.srcObject.getAudioTracks()[0].enabled=bolFlag;
                    //     });
                    // }
                } catch (ex) { console.log(ex) }
            },
            idleNotify: function () {
                const self = this;
                isIdleNotify = true;
                let i = 60;
                let delayOneMinute;
                self.oNotify.ConfirmCustomMsg("您已閒置超過30分鐘，是否要離開會議室?", "", [
                    {
                        text: '是 (' + i + 's)',
                        click: () => {
                            try {
                                if (connection.kms.kmsId) {
                                    if (connection.kms.kmsUserid == connection.userid)
                                        self.kmsStopClick();
                                }
                            } catch (e) { console.log(e) }
                            isIdleNotify = false;
                            //send("exitroom#" + connection.userid + "#true");
                            //多呼叫API一次,降低沒更新狀態成功的問題
                            //SetJoinStatus(self.currUser.uid, 0);
                            //window.close();
                            window.location.replace("logout.html?r=12");

                        },
                        addClass: 'IdleNotifyY',
                    },
                    {
                        text: "否",
                        // click:()=>{ videoConference.webrtc.functions.shareMyScreen(isForceWebRTC)},
                        addClass: "btn-danger",
                        click: () => {
                            isIdleNotify = false;
                            clearInterval(delayOneMinute);
                        },

                    }
                ]);
                clearInterval(idleInterval);
                delayOneMinute = setInterval(function () {
                    i -= 1;
                    $('.IdleNotifyY').text('是 (' + i + 's)');
                    if (i == 1) {
                        try {
                            if (connection.kms.kmsId) {
                                if (connection.kms.kmsUserid == connection.userid)
                                    self.kmsStopClick();
                            }
                        } catch (e) { console.log(e) }

                        //send("exitroom#" + connection.userid + "#true");
                        //多呼叫API一次,降低沒更新狀態成功的問題
                        //SetJoinStatus(self.currUser.uid, 0);
                        //window.close();
                        window.location.replace("logout.html?r=12");
                    }
                }, 1000);
            },
            select_lang_change: function (event) {
                const self = this;
                i18n.locale = self.lanSelected;
                // i18n.locale = event.target.value;
                //console.log(event.target.value)
            },
            detectSmartPanel: function () {
                const self = this;
                console.log('%c %s', 'background: lightgray; color: blue;', "Waiting for SmartPanel to start", moment(Date.now()).format("YYYY/MM/DD HH:mm:ss"));

                //每十秒執行檢查智慧看板狀態=false,發送ping事件詢問
                self.smPingInterval = setInterval(() => {
                    if (!self.isSmartPanelOn) {
                        send(`SM_ping#${self.currUser.empId}#null`);
                    }
                }, (10000)); //10 sec

                setTimeout(() => {
                    if (!self.isSmartPanelOn) {
                        console.log('%c %s', 'background: #FFBB73; color: blue;', "SmartPanel :未啟動");
                        $VM.writeLog("異常", `[EMAIL]/[UID] 智慧看板未啟動`);
                        self.oNotify.ConfirmCustomMsg("偵測到智慧看板未啟動，請聯絡MIS協助。", "", [{ text: "是", click: () => { return; } }]);
                    }
                    clearInterval(self.smPingInterval);
                }, 180000); //3 min
            },
            askUserWhiteboardOpened: function () {
                const self = this;
                setTimeout(() => {
                    // 發訊息發onlineUsers第一位詢問對方白板是否開啟中
                    if (self.onlineUsers.length > 0) {
                        send(`WB#${self.currUser.userId}#${JSON.stringify({ ev: "user_check_newin" })}#${self.onlineUsers[0].empId}`);
                    }
                }, 1500);
            },
            showHideDivKMSWebCam: function () {
                const self = this;
                if (_CONFIG3_External && self.currUser.userType === 'E' && !self.invitePermit) {
                    return false;
                } else {
                    return true;
                }
            },
            isMuteFromPeer: function () {
                const self = this;
                try {
                    let _isMute = null;
                    if ($VM.onlineSpeakers.length > 0 && $VM.onlineSpeakers.filter(x => x.userId == $VM.currUser.userId).length > 0) {
                        let _WebRtcPeer = $VM.onlineSpeakers.filter(x => x.userId == $VM.currUser.userId)[0].webRtcPeer;
                        if (_WebRtcPeer) {
                            if (_WebRtcPeer.peerConnection.getSenders().forEach(function (rtpSender) {
                                if (rtpSender.track && rtpSender.track.kind == 'audio') {
                                    _isMute = !rtpSender.track.enabled; // enabled:true-收音中／false-靜音
                                }
                            }));
                        }
                    }
                    return _isMute;
                } catch (err) {
                    console.log(err);
                }
            },
            changeResolution: function () {
                const self = this;
                try {
                    /*
                    let _frameRate = parseInt($('#frameRate').val());
                    if (_frameRate < 15 || _frameRate > 30){
                        self.oNotify.ConfirmMsg("", "frameRate in 15~30 is valid!");
                        $('#frameRate').val(15);
                        return;
                    }                    
                    let _sel = self.resolutionList.filter(x=>x.value ==$('#resolution').val())[0];
                    if (_sel){
                        self.KMSshareVedioSetting_user = {width: 1280, high: 720,frameRate: { ideal: 6, max: 10 }}; // from kurento-util.js monitor
                        self.KMSshareVedioSetting_user.constain = _sel.constain;
                        self.KMSshareVedioSetting_user.constain.frameRate.ideal = _frameRate;
                        self.KMSshareVedioSetting_user.constain.frameRate.max = _frameRate;
                    }   
                    */
                    let resolution_width = parseInt($('#resolution_width').val());
                    if (resolution_width > self.screen.width) {
                        self.oNotify.ConfirmMsg("", "resolution_width is valid!");
                        $('#resolution_width').val(self.screen.width);
                        return;
                    }
                    let resolution_height = parseInt($('#resolution_height').val());
                    if (resolution_height > self.screen.height) {
                        self.oNotify.ConfirmMsg("", "resolution_height is valid!");
                        $('#resolution_height').val(self.screen.height);
                        return;
                    }
                    self.resolution = "Y";
                    self.KMSshareVedioSetting_user = {
                        constain: {
                            width: parseInt($('#resolution_width').val()),
                            height: parseInt($('#resolution_height').val()),
                            frameRate: {
                                ideal: parseInt($('#frameRate_ideal').val()),
                                max: parseInt($('#frameRate_max').val()),
                            },
                        },
                        Bandwidth: {
                            min: parseInt($('#Bandwidth_min').val()),
                            max: parseInt($('#Bandwidth_max').val()),
                        },
                    };
                    self.debugInfo.isShowDebug = false;
                } catch (err) {
                    console.log(err)
                }
            },
            setCurrent_speech_lang: function (lang) { //add by vic 2023/12/13 設定語音字幕的語系
                const self = this;
                if (lang == 'sw')
                    self.speech_switch_state = !self.speech_switch_state
                else if (lang == 'sv')
                    self.speech_switch_voice_state = !self.speech_switch_voice_state;
                else if (lang == 'sg')
                    self.speech_switch_google_trans_state = !self.speech_switch_google_trans_state;
                else if (lang == 'ose')
                    self.speech_swith_ose = !self.speech_swith_ose;
                else {
                    self.current_speech_lang = lang;
                    self.current_speech_voice_lang = lang;
                }

            },
            setCurrent_speech_voice_lang: function (lang) {
                const self = this;
                self.current_speech_voice_lang = lang;
            },
            async findSpeechSynthesisVoice(_lang) {
                //--依語系找語音 (Chrome/Edge: window.speechSynthesis.getVoices()差異)
                let sel_voice = null;
                try {
                    if (voices.length == 0) await populateVoiceList('findSpeechSynthesisVoice');
                    //$VM.writeLog("speechSynthesis","findSpeechSynthesisVoice voices.length="+voices.length+"_lang="+_lang);                    
                    if (_lang == null || _lang == "") return sel_voice;
                    //--找會議指定語音設定voices_default
                    let default_voice = voices_default.filter(x => x.lang == _lang);
                    if (default_voice && default_voice.length > 0) default_voice = default_voice[0];
                    //--找user指定的voice from localStorage by lang
                    let _key = "talk2air.synth_voice." + _lang;
                    if (localStorage.getItem(_key) != null) {
                        let _local = JSON.parse(localStorage.getItem(_key));
                        if (_local != null) {
                            $VM.synth_voice = _local;
                        }
                    }
                    if ($VM.synth_voice.name != "") {
                        default_voice.voice_name = $VM.synth_voice.name;
                        default_voice.voice_name_Edge = $VM.synth_voice.name;
                    }
                    //--  
                    if (default_voice != null) {
                        if (/Edg/i.test(window.navigator.userAgent) && default_voice.voice_lang_Edge) { //Edge
                            let find_voice = voices.filter(x => x.lang == default_voice.voice_lang_Edge);
                            if (find_voice != null && find_voice.length > 0 && default_voice.voice_name_Edge != "") {
                                find_voice = voices.filter(x => x.name.indexOf(default_voice.voice_name_Edge) != -1);
                            }
                            if (find_voice.length > 0) sel_voice = find_voice[0];
                        } else {
                            let find_voice = voices.filter(x => x.lang == default_voice.voice_lang);
                            if (find_voice != null && find_voice.length > 0 && default_voice.voice_name != "") {
                                find_voice = voices.filter(x => x.name.indexOf(default_voice.voice_name) != -1);
                            }
                            if (find_voice.length > 0) sel_voice = find_voice[0];
                        }
                    }
                    let voiceOptions = voices.filter(x => x.lang == _lang)
                        .map(voice => `${voice.name}`)
                        .join(',');
                    //$VM.writeLog("speechSynthesis","findSpeechSynthesisVoice ["+_lang+"]:"+voiceOptions);

                    if (sel_voice == null) { // 未找到mapping voice: 1.以語系找1st,2.以browser預設
                        sel_voice = voices.filter(x => x.lang == _lang)[0];
                        //if (sel_voice==null)
                        //    sel_voice=voices.filter(x=>x.default==true)[0];
                        console.log("default_voice:" + sel_voice.lang + "," + sel_voice.name);
                        //$VM.writeLog("speechSynthesis","default_voice:"+sel_voice.lang+","+sel_voice.name);
                    } else {
                        console.log("sel_voice:" + sel_voice.lang + "," + sel_voice.name);
                        //$VM.writeLog("speechSynthesis","sel_voice:"+sel_voice.lang+","+sel_voice.name);                        
                    }
                    //return sel_voice;
                    return Promise.resolve(sel_voice);
                } catch (e) {
                    console.log(e);
                }
            },
            speakText(startLanWord, target_msg) {
                const self = this;
                let utterContent = new SpeechSynthesisUtterance(target_msg);
                if (self.isAndroid) {
                    let lang = 'zh-TW';
                    switch (startLanWord) {
                        case 'en':
                            lang = 'en-US';
                            break;
                        case 'jp':
                            lang = 'ja-JP';
                            break;
                        default:
                            lang = 'zh-TW';
                    }
                    utterContent.lang = lang;
                }

                utterContent.rate = self.synth_voice.rate;
                utterContent.pitch = self.synth_voice.pitch;
                let voiceChoices = self.voices.filter(v => v.name == self.synth_voice.name);
                if (voiceChoices.length > 0) { 
                    utterContent.voice = voiceChoices[0];
                }
                else {
                    let matcher = new RegExp("^" + startLanWord, "gm");
                    voiceChoices = self.voices.filter(v => matcher.test(v.lang));
                    if (voiceChoices.length > 0) {
                        utterContent.voice = voiceChoices[0];
                    }
                    if (self.isMobile && startLanWord == "zh") {
                        let zh_voice = self.voices.filter(v => v.name == "婷婷");
                        if (zh_voice.length > 0) {
                            utterContent.voice = zh_voice[0];
                        }
                    }
                }
                // try { speechSynthesis.cancel(); } catch (e) { };
                utterContent.onend = function (event) { };
                speechSynthesis.speak(utterContent);
            },
            speakText_backup: function (_lang, text) {  // 文字轉語音輸出
                const self = this;
                if ((self.roomInfo.transType == '2' || self.roomInfo.transType == '3') && $VM.speech_switch_voice_state) {
                    if (!$VM.oDetectDevice.isMobileAny) {
                        if (self.current_speech_lang == 'jp') {
                            _lang = 'ja-JP';
                        }
                        else if (self.current_speech_lang == 'en') {
                            _lang = 'en-US';
                        }
                        else {
                            _lang = 'zh-TW';
                        }
                        if ($VM.current_speech_voice_lang == 'en') {
                            _lang = 'en-US';
                        }
                    } else {
                        switch (_lang) {
                            case 'en': _lang = 'en-US'; break;
                            case 'zh': _lang = 'zh-TW'; break;
                            case 'jp': _lang = 'ja-JP'; break;
                            default: break;
                        }
                    }
                    if (synth.speaking) {
                        //synth.cancel(); // 清除 utterance queue
                        //console.error("speechSynthesis.speaking");
                        //synth = window.speechSynthesis;
                        //return;
                    }


                    if (text !== "") {
                        const utterThis = new SpeechSynthesisUtterance(text);

                        utterThis.onend = function (event) {
                            console.log("SpeechSynthesisUtterance.onend");
                            self.clearSubtitle();
                        };

                        utterThis.onerror = function (event) {
                            console.error("SpeechSynthesisUtterance.onerror");
                            //synth = window.speechSynthesis;
                            return;
                        };

                        let _done = false;
                        self.findSpeechSynthesisVoice(_lang)
                            .then(function (sel_voice) {
                                //$VM.writeLog("speechSynthesis","findSpeechSynthesisVoice back sel_voice="+sel_voice.name);
                                if (sel_voice == null) {
                                    console.log("[**] can find suitable SpeechSynthesisVoice!");
                                } else {
                                    //$VM.oNotify.ConfirmMsg("",_lang+",sel_voice:"+sel_voice.name);
                                    switch (_lang) {
                                        case "zh-TW":
                                            utterThis.pitch = 0.6;
                                            utterThis.rate = 1.9;
                                            if (!sel_voice.name.includes("Yating")) {
                                                utterThis.rate = 1;
                                            }
                                            break;
                                        case "en-US":
                                            utterThis.pitch = 1;
                                            utterThis.rate = 1;
                                            break;

                                        case "ja-JP":
                                            utterThis.pitch = 1;
                                            utterThis.rate = 1.2;
                                            break;
                                        default:
                                            break;
                                    }
                                    utterThis.voice = sel_voice;
                                    //--用user指定的
                                    if ($VM.synth_voice.name != "") {
                                        utterThis.pitch = $VM.synth_voice.pitch;
                                        utterThis.rate = $VM.synth_voice.rate;
                                    }
                                    //--   
                                    utterThis.volume = 1;
                                    //$VM.writeLog("speechSynthesis",_lang+",utterThis.voice:"+utterThis.voice.name+
                                    //             ",utterThis.pitch:"+utterThis.pitch+",utterThis.rate:"+utterThis.rate);                                
                                    synth.speak(utterThis);
                                    _done = true;
                                }
                            })
                            .catch(function () {
                                console.log("findSpeechSynthesisVoice >> catch");
                            })
                            .finally(function () {
                                console.log("findSpeechSynthesisVoice >> finally");
                                if (!_done) {
                                    utterThis.volume = 1;
                                    synth.speak(utterThis);
                                }
                            });
                    }
                }
            },
            speakTextForOSE: function (_lang, text) {  // 文字轉語音輸出
                const self = this;
                if ((self.roomInfo.transType == '2' || self.roomInfo.transType == '3') && $VM.speech_swith_ose) {
                    if (!$VM.oDetectDevice.isMobileAny) {
                        if (self.current_speech_lang == 'jp') {
                            _lang = 'ja-JP';
                        }
                        else if (self.current_speech_lang == 'en') {
                            _lang = 'en-US';
                        }
                        else {
                            _lang = 'zh-TW';
                        }
                        if ($VM.current_speech_voice_lang == 'en') {
                            _lang = 'en-US';
                        }
                    } else {
                        switch (_lang) {
                            case 'en': _lang = 'en-US'; break;
                            case 'zh': _lang = 'zh-TW'; break;
                            case 'jp': _lang = 'ja-JP'; break;
                            default: break;
                        }
                    }
                    if (synth.speaking) {
                        //synth.cancel(); // 清除 utterance queue
                        //console.error("speechSynthesis.speaking");
                        //synth = window.speechSynthesis;
                        //return;
                    }


                    if (text !== "") {
                        const utterThis = new SpeechSynthesisUtterance(text);

                        utterThis.onend = function (event) {
                            console.log("SpeechSynthesisUtterance.onend");
                            self.clearSubtitle();
                        };

                        utterThis.onerror = function (event) {
                            console.error("SpeechSynthesisUtterance.onerror");
                            //synth = window.speechSynthesis;
                            return;
                        };

                        let _done = false;
                        self.findSpeechSynthesisVoice(_lang)
                            .then(function (sel_voice) {
                                //$VM.writeLog("speechSynthesis","findSpeechSynthesisVoice back sel_voice="+sel_voice.name);
                                if (sel_voice == null) {
                                    console.log("[**] can find suitable SpeechSynthesisVoice!");
                                } else {
                                    //$VM.oNotify.ConfirmMsg("",_lang+",sel_voice:"+sel_voice.name);
                                    switch (_lang) {
                                        case "zh-TW":
                                            utterThis.pitch = 0.6;
                                            utterThis.rate = 1.9;
                                            if (!sel_voice.name.includes("Yating")) {
                                                utterThis.rate = 1;
                                            }
                                            break;
                                        case "en-US":
                                            utterThis.pitch = 1;
                                            utterThis.rate = 1;
                                            break;

                                        case "ja-JP":
                                            utterThis.pitch = 1;
                                            utterThis.rate = 1.2;
                                            break;
                                        default:
                                            break;
                                    }
                                    utterThis.voice = sel_voice;
                                    //--用user指定的
                                    if ($VM.synth_voice.name != "") {
                                        utterThis.pitch = $VM.synth_voice.pitch;
                                        utterThis.rate = $VM.synth_voice.rate;
                                    }
                                    //--   
                                    utterThis.volume = 1;
                                    //$VM.writeLog("speechSynthesis",_lang+",utterThis.voice:"+utterThis.voice.name+
                                    //             ",utterThis.pitch:"+utterThis.pitch+",utterThis.rate:"+utterThis.rate);                                
                                    synth.speak(utterThis);
                                    _done = true;
                                }
                            })
                            .catch(function () {
                                console.log("findSpeechSynthesisVoice >> catch");
                            })
                            .finally(function () {
                                console.log("findSpeechSynthesisVoice >> finally");
                                if (!_done) {
                                    utterThis.volume = 1;
                                    synth.speak(utterThis);
                                }
                            });

                        
                    }
                }
            },
            vh: function(percent) {
                var h = Math.max(document.documentElement.clientHeight, window.innerHeight || 0);
                return (percent * h) / 100;
            },
            showSpeechStyle: function() {
                const self = this;
                let _style = '';
                if (!self.isShowList)
                    _style = "width: 100vw;"              
                if (self.isFullScreen) {
                    _style += 'width: 100%; left: 10%;';
                } 
                _style += `overflow:hidden; z-index: 500 !important;top:${self.subtitleSetting.fixPosition}%;position:fixed;`; 
                return _style;
            },
            speechTextStyle: function (speechObj, isShowSubtitle, isFirst) {
                const self = this;
                let srcLang = speechObj.srcLang;
                let detectLang = speechObj.detectLang;
                let default_size = 16;
                if (isShowSubtitle) {
                    default_size = self.subtitleSetting.fontSize * ((self.isFullScreen) ? 1.2 : 1);
                }
                if(self.newSubtitleFullScreen) {
                    self.cookieFontSizeRange = (self.getCookie('SpeechTextSize')) ? parseInt(self.getCookie('SpeechTextSize')) : 0;
                    default_size = default_size + self.cookieFontSizeRange;
                }
                
                let speechTextStyleContent = `font-size:${default_size}px; line-height: normal;`;

                if(!isFirst) {
                    speechTextStyleContent += `font-family:Arial;`;
                }
                // 標註不同語系譯文
                if (self.current_speech_lang != srcLang) {
                    if (isShowSubtitle) {
                        if (this.currTransTab == "msgHistory_zh") {
                            if ((self.current_speech_lang == "zh" && isFirst))
                                speechTextStyleContent += 'color:rgb(252, 252, 177);';
                        }
                        else if (self.currTransTab == "msgHistory_en") {
                            if ((self.current_speech_lang == "en" && isFirst))
                                speechTextStyleContent += 'color:rgb(252, 252, 177);';
                        }
                        else {
                            if ((self.current_speech_lang == "zh" && isFirst) || (self.current_speech_lang == "en" && !isFirst))
                                speechTextStyleContent += 'color:rgb(252, 252, 177);';
                        }
                    }
                    else {
                        if (self.currTransTab != "msgHistory_debug") {
                            if ((self.current_speech_lang == "zh" && isFirst) || (self.current_speech_lang == "en" && !isFirst))
                                speechTextStyleContent += 'color:rgb(252, 252, 177);';
                        }
                    }  
                }

                return speechTextStyleContent;
            },
            handleSize: function (event) {
                const self = this;
                if (event == 'add') {
                    self.cookieFontSizeRange = self.cookieFontSizeRange + 2;
                }
                if (event == 'reduce') {
                    self.cookieFontSizeRange = self.cookieFontSizeRange - 2;
                }
                self.setCookie('SpeechTextSize',self.cookieFontSizeRange,30);
                if ($RealTimeASR)
                    $RealTimeASR.setTranscriptSize(self.cookieFontSizeRange, self.newSubtitleFullScreen);
            },
            setCookie: function (cname,cvalue,exdays) {
                var d = new Date();
                d.setTime(d.getTime()+(exdays*24*60*60*1000));
                var expires = "expires="+d.toGMTString();
                document.cookie = cname + "=" + cvalue + "; " + expires;
            },
            getCookie: function (cname) {
                var name = cname + "=";
                var ca = document.cookie.split(';');
                for(var i=0; i<ca.length; i++) 
                {
                    var c = ca[i].trim();
                    if (c.indexOf(name)==0) return c.substring(name.length,c.length);
                }
                return "";
            },
            getMeetingMembers: function () {
                const self = this;
                let m = (self.currUser.nickName) ? self.currUser.nickName : self.currUser.name;
                let menbers = [m];
                self.onlineUsers.forEach((element) => menbers.push((element.nickName) ? element.nickName : element.name));
                return menbers;
            },
            isSlient: function(data, threshold = 0.01) {
                const self = this;
                return data.every(sample => Math.abs(sample) < threshold);
            },
            startRecording: async function () {
                const self = this;
                if (!hasInit) {
                    hasInit = true;
                    //populateVoiceList();
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    var options = {
                        audioBitsPerSecound: 256000
                    }
                    mediaRecorder = new MediaRecorder(stream, options);
                    mediaRecorder.ondataavailable = event => {
                        //console.log('ondataavailable:'+event.data.size );
                        if (self.currUser.isMute)
                            return;
                        if (event.data.size > 0) {
                            if (isSpeaking)
                                vcount++;
                            else
                                lcount++;

                            // 計算當前總大小
                            let currentSize = audioChunks.reduce((accumulator, chunk) => {
                                return accumulator + chunk.size;
                            }, 0);
                            // 如果加上新的音訊塊還小於 1MB，則推入陣列
                            sumsize=currentSize + event.data.size;
                            // console.log("sumsize",sumsize);
                            if (currentSize + event.data.size <= 1000000) {
                                audioChunks.push(event.data);
                            }
                            else{
                                if(mediaRecorder){
                                    mediaRecorder.stop();
                                    mediaRecorder.start(50);
                                }
                            }
                        }
                    };
                    mediaRecorder.onstop = async () => {
                        if (!self.iceConnected || self.currUser.isMute) {
                            audioChunks = [];
                            return;
                        }
                            
                        if (vcount > 0) {
                            vcount = 0;
                            lcount = 0;
                            const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                            let formData = new FormData();
                            formData.append('audio_data', audioBlob, 'recording.wav');
                            formData.append('srcLang', self.current_speech_lang);
                            formData.append('userName', self.ownerName);
                            formData.append('actualName', (self.currUser.userType == "E") ? self.currUser.name : "");
                            formData.append('empId', (self.currUser.userType == "E") ? self.currUser.empId : "");
                            formData.append('sendDate', new Date());
                            formData.append('sdts', new Date().getTime());
                            formData.append('roomid', window.params.roomid);
                            formData.append('rtcbroker', CONFIG.mqttConfig.SERVER_URL);
                            formData.append('transType', self.roomInfo.transType);
                            formData.append('glossary', self.glossary);
                            formData.append('changeByPreLoad', self.preloadSentence);
                            formData.append('word_emp',self.roomInfo.userName);
                            formData.append('last_is_merge', (self.show_speech_text.is_merge) ? "Y":"N");
                            audioChunks = [];
                            if (!self.currUser.isMute) {
                                $VM.callARGService(formData)
                                    .then(function (data) {
                                        speechEvents.setInterval(50);
                                    })
                                    .catch(function (reject) {
                                        console.log('%c %s', 'background: #FFBB73; color: lightyellow;', "callARGService,reject:", reject);
                                    });
                            }
                        }
                        else
                            audioChunks = [];
                    };
                }
                mediaRecorder.start(50);
                isMute = false;
                if ($RealTimeASR)
                    $RealTimeASR.setMute(false);

            },
            stopRecording: function () {
                const self = this;
                mediaRecorder.stop();
                isMute = true;
                if ($RealTimeASR)
                    $RealTimeASR.setMute(true);
            },
            clearSubtitle: function () {
                const self = this;
                self.speech_timeout = setTimeout(function () {
                    self.speech_last_username = '';
                    self.speech_text_last = ''
                    self.speech_text = '';
                    self.speech_text_last_1 = ''
                    self.speech_text_1 = '';
                    self.speech_text_last_2 = ''
                    self.speech_text_2 = '';
                    self.speech_text_1_g = '';
                    self.speech_text_2_g = '';
                }, 2000);
            },
            callARGService: async function (formData) {
                const self = this;
                try {
                    callARGServiceTime = new Date();
                    const response = await fetch(CONFIG.ARGUploadUrl, {
                        method: 'POST',
                        body: formData,
                    })
                    .catch((error) => {
                        console.log(`fetch ARGUpload Error: ${error}`);
                        // self.oNotify.ErrorMsg("", "Voice recognition error occurred!");
                    });

                    // check for error response
                    if (response && response.ok) {
                        const isJson = response.headers.get('content-type')?.includes('application/json');
                        const data = isJson ? await response.json() : null;
                        if (data) {
                            return Promise.resolve(data);
                        } else {
                            const error = response.status + ",isJson:" + isJson;
                            return Promise.reject(error);
                        }
                    } else {
                        const error = response == null ? "no status" : response.status;
                        return Promise.reject(error);
                    }

                } catch (e) {
                    console.error('An error occurred:', e);
                }
            },
            callARGAddToWord: async function (formData) {
                const self = this;
                try {
                    callARGServiceTime = new Date();
                    const response = await fetch(CONFIG.ARGAddToWordUrl, {
                        method: 'POST',
                        body: formData,
                    })
                    .catch((error) => {
                        console.log(`fetch ARGUpload Error: ${error}`);
                        // self.oNotify.ErrorMsg("", "Voice recognition error occurred!");
                    });
                } catch (e) {
                    console.error('An error occurred:', e);
                }
            },
            sendWaitAminute:function(){
                const self = this;
                self.oNotify.ConfirmCustomMsg(self.$t('lan-notify-input-words-comfirm'), "", [
                    {
                        text: self.$t('lan-notify-yes'),
                        click: () => {
                            let _now = new Date();
                            let itm = {};
                            itm.zh = '請稍後';
                            itm.en = 'Wait a minute.';
                            itm.userName = self.ownerName;
                            itm.sendDate = _now;
                            itm.srcLang = self.current_speech_lang;
                            itm.detectLang = self.current_speech_lang;
                            itm.txt_Whisper = (self.current_speech_lang == 'zh') ? '請稍後' : 'Wait a minute.';
                            itm.filename = _now.getTime().toString();
                            itm.sentenceId = _now.getTime().toString();
                            itm.roomid = self.roomInfo.roomId;
                            itm.userNameList = [self.ownerName];
                            itm.source = "wait";
                            itm.filename = "M_wait";
                            
                            send(`translate#${self.currUser.userId}#${JSON.stringify(itm)}`);

                            var st_all = {
                                "userName": self.ownerName,
                                "sendDate": _now,
                                "zh2zh": '<strong>請稍後</strong>',
                                "zh2en": '<strong>Wait a minute.</strong>',
                                "srcLang": self.current_speech_lang,
                                "detectLang": self.current_speech_lang,
                                "txt_Whisper": (self.current_speech_lang == 'zh') ? '請稍後' : 'Wait a minute.',
                                "filename": _now.getTime().toString(),
                                "sentenceId": _now.getTime().toString(),
                                "isShow": true,
                                "owners": [self.ownerName],
                                "source": "wait",
                                "is_merge": true
                            };
                            self.speechs_all.push(st_all);
                            self.speechs_all_debug.push(st_all);
                            self.handleSpeechText();
                            self.$nextTick(() => self.handleNewSubtitleScroll('add_msg'));

                            self.oNotify.InputNeedMsg(self.$t('lan-notify-input-words'), '', [{ text: self.$t('lan-invite-submit'), click: (m) => { self.sendInputMsg(m, 'wait'); } }]);
                        },
                        addClass: 'IdleNotifyY',
                    },
                    {
                        text: self.$t('lan-notify-no'),
                        addClass: "btn-danger",
                        click: () => {
                            return;
                        },

                    }
                ]);
                
            },
            sendInputMsg: async function(m, source) {
                const self = this;
                // console.log(m);
                m = m.trim();
                if(!m) {
                    return;
                }
                var translatedResult = await TranslateMsg(m);
                // 標註相似音
                if(source == 'edit')
                    m = m.replaceAll(self.same_pronunciation_edit.to, `\$\$\$\$${self.same_pronunciation_edit.to}\$\$\$\$`);

                let _now = new Date();
                let itm = {};
                itm.zh = (self.current_speech_lang == 'zh') ? m : translatedResult.text[0];
                itm.en = (self.current_speech_lang == 'en') ? m : translatedResult.text[0];
                itm.userName = self.ownerName;
                itm.sendDate = _now;
                itm.srcLang = self.current_speech_lang;
                itm.detectLang = self.current_speech_lang;
                itm.txt_Whisper = (self.current_speech_lang == 'zh') ? m : translatedResult.text[0];
                itm.before_similar_compare = (source == 'edit') ? self.same_pronunciation_edit.result : "";
                itm.filename = "M_edit";
                itm.sentenceId = _now.getTime().toString();
                itm.roomid = self.roomInfo.roomId;
                itm.userNameList = [self.ownerName];
                itm.source = source;
                
                send(`translate#${self.currUser.userId}#${JSON.stringify(itm)}`);

                // 使用正則表達式替換 - 相似音
                if(source == 'edit')
                    m = m.replace(/\$\$(.*?)\$\$/g, "<span style='color: #ffa961;'>$1</span>");
                var st_all = {
                    "userName": self.ownerName,
                    "sendDate": _now,
                    "zh2zh": (self.current_speech_lang == 'zh') ? `<strong>${m}</strong>` : `<strong>${translatedResult.text[0]}</strong>`,
                    "zh2en": (self.current_speech_lang == 'en') ? `<strong>${m}</strong>` : `<strong>${translatedResult.text[0]}</strong>`,
                    "srcLang": self.current_speech_lang,
                    "detectLang": self.current_speech_lang,
                    "txt_Whisper": m,
                    "before_similar_compare": (source == 'edit') ? self.same_pronunciation_edit.result : "",
                    "filename": _now.getTime().toString(),
                    "sentenceId": _now.getTime().toString(),
                    "isShow":true,
                    "owners": [self.ownerName],
                    "source": source,
                    "is_merge": true
                };
                self.speechs_all.push(st_all);
                self.speechs_all_debug.push(st_all);
                self.handleSpeechText();
                self.$nextTick(() => self.handleNewSubtitleScroll('add_msg'));
            },
            formatNumber: function(num) {
                let number = parseFloat(num);
                if (isNaN(number)) {
                    return;
                }
                if (number % 1 === 0) {
                    return number;
                } else {
                    return parseFloat(number.toFixed(2));
                }
            },
            handleSpeechText: function() {
                const self = this;
                clearTimeout(self.speech_timeout);

                self.show_speech_text = self.speechs_all[self.speechs_all.length - 1];

                if (self.speechs_all.length > 4) {
                    Object.freeze(self.speechs_all[self.speechs_all.length - 5]);
                }
                if (self.speechs_all_debug.length > 4) {
                    Object.freeze(self.speechs_all_debug[self.speechs_all_debug.length - 5]);
                }

                if ($PIPSubtitle)
                    $PIPSubtitle.updateText(self.show_speech_text.zh2zh,self.show_speech_text.zh2en);

                self.speech_timeout = setTimeout(function () {
                    self.show_speech_text.isShow = false;
                    if($PIPSubtitle)
                        $PIPSubtitle.updateText('','');
                }, 10000);
                
                self.doMergeFinalResult(self.show_speech_text.userName ,self.show_speech_text.sentenceId, self.show_speech_text.is_merge, 3000);
            },
            doMergeFinalResult(sentenceOwner, sentenceId, is_merge, ms) {
                const self = this;
                clearTimeout(self.speech_merge_timeout);

                self.speech_merge_timeout = setTimeout(function () {
                    if (sentenceOwner == self.ownerName && !is_merge && vcount == 0) {
                        let formData = new FormData();
                        formData.append('roomid', self.roomInfo.roomId);
                        formData.append('sentenceId', sentenceId);
                        formData.append('transType', self.roomInfo.transType);
                        formData.append('changeByPreLoad', self.preloadSentence);
                        const response = fetch(CONFIG.ARGDoMergeFinalResult, {
                            method: 'POST',
                            body: formData,
                        })
                    }
                }, ms);
            },
            handleGlossary: function() {
                const self = this;
                let itm={};
                itm.glossary= self.glossary;
                itm.userName= self.currUser.name;
                
                send(`glossary#${self.currUser.userId}#${JSON.stringify(itm)}`);
            },
            handlePreloadSentence: function() {
                const self = this;
                let itm={};
                itm.preloadSentence= self.preloadSentence;
                itm.userName= self.currUser.name;
                
                send(`preloadSentence#${self.currUser.userId}#${JSON.stringify(itm)}`);
            },
            noticeSpeakerRestartSpeak: function(notice_user) {
                const self = this;
                send(`restartSpeak#${self.currUser.userId}#${self.currUser.userId}#${notice_user}`, true);
            },
            countWords: function(text){
                const self = this;
                try{
                    chinese_count=0
                    //使用正規表示法匹配所有中文
                    const chineseText = text.match(/[\u4e00-\u9fff]/g);
                    //如果有匹配結果，返回匹配到的字母數，否則返回0
                    chinexe_count = chineseText ? chineseText.length : 0;
                    
                    english_count=0
                    //使用正規表示法匹配所有英文字母
                    const englishLetters = text.match(/\b[A-Za-z]+\b/g);
                    //如果有匹配結果，返回匹配到的字母數，否則返回0
                    english_count = englishLetters ? englishLetters.length: 0;
                    
                    return chinexe_count + english_count
                }catch(ex){return 0}
            }
        }
    });

    //populateVoiceList();

    function loadScript(url, callback, callbackError) {
        // <script src="js/wookBook.js">             
        if (Array.from(document.getElementsByTagName("script")).filter(x => x.src == url).length > 0) return;
        if (document.getElementById(url)) return;
        console.log("loadScript", url);
        callback = callback || function () { };
        callbackError = callbackError || function () { };
        var scrpt = document.createElement("script");
        scrpt.type = "text/javascript";

        try {
            if (scrpt.readyState) {  //IE
                scrpt.onreadystatechange = function () {
                    if (scrpt.readyState === "loaded" || scrpt.readyState === "complete") {
                        scrpt.onreadystatechange = null;
                        callback();
                    }
                };
            } else {
                //其餘瀏覽器支援onload
                scrpt.onload = function () {
                    callback();
                };
            }

            scrpt.src = url;
            scrpt.setAttribute('id', url);
            document.getElementsByTagName("head")[0].appendChild(scrpt);
        } catch (e) {
            if (null !== callbackError) callbackError(e);
        }
    };
    function connectMqtt() {
        Vue.prototype.mqttClient = new mMqtt({
            afterConnectedFunc: function () {

                Vue.prototype.mqttClient.sendUserConnected();
                console.log('%c %s', 'background: #222; color: white;', "sendUserConnected ");

                //send("onlineStatus#" +  $VM.currUser.userId + "#" + ($VM.currUser.onlineStatus));                
                $VM.appendHistory("in", `[DISPLAYNAME] ${$VM.$t('lan-his-join')}`);
                $VM.writeLog("事件", `[DISPLAYNAME] 加入會議室`);
                setTimeout(() => {
                    if (!$VM.isSmartPanelOn) {
                        $VM.writeLog("SmartPanel", `[DISPLAYNAME] invoke smartpanel using uri(after connectMqtt)`);
                        //$VM.doInvokeSmartPanel_uri();  //呼叫 uri scheme的方式啟動smartpanel
                        InvokeSmartPanel(); // add by vic 2024/01/03 改回使用broker的方式呼叫smartpanel起來
                        console.log('%c %s', 'background: blue; color: white;', "第一次InvokeSmartPanel ");
                    }
                }, 60 * 1000);
                setTimeout(() => {
                    if (!$VM.isSmartPanelOn) {
                        $VM.writeLog("SmartPanel", `[DISPLAYNAME] invoke smartpanel using uri(after connectMqtt)`);
                        //$VM.doInvokeSmartPanel_uri();  //呼叫 uri scheme的方式啟動smartpanel
                        InvokeSmartPanel(); // add by vic 2024/01/03 改回使用broker的方式呼叫smartpanel起來
                        console.log('%c %s', 'background: blue; color: white;', "第二次InvokeSmartPanel ");
                    }
                }, 120 * 1000);
                setTimeout(() => {
                    if (!$VM.isSmartPanelOn) {
                        $VM.writeLog("SmartPanel", `[DISPLAYNAME] invoke smartpanel using uri(after connectMqtt)`);
                        //$VM.doInvokeSmartPanel_uri();  //呼叫 uri scheme的方式啟動smartpanel
                        InvokeSmartPanel(); // add by vic 2024/01/03 改回使用broker的方式呼叫smartpanel起來
                        console.log('%c %s', 'background: blue; color: white;', "第三次InvokeSmartPanel ");
                    }
                }, 180 * 1000);
                setTimeout(() => {
                    if (!$VM.isSmartPanelOn) {
                        $VM.writeLog("SmartPanel", `[DISPLAYNAME] invoke smartpanel using uri(after connectMqtt)`);
                        //機敏會議
                        if ($VM.isSecret()) {
                            NoticeMISForNoSmartPanel("N");
                            $VM.doInvokeSmartPanel(true);
                            console.log('%c %s', 'background: blue; color: white;', "已check 3次，沒啟動smartpanel，通知MIS");
                        }
                    }
                }, 240 * 1000);
                setTimeout(() => {
                    if (!$VM.isSmartPanelOn) {
                        $VM.writeLog("SmartPanel", `[DISPLAYNAME] invoke smartpanel using uri(after connectMqtt)`);
                        //機敏會議
                        if ($VM.isSecret()) {
                            NoticeMISForNoSmartPanel("Y");
                            console.log('%c %s', 'background: blue; color: white;', "第4次，沒啟動smartpanel，通知MIS");
                        }
                    }
                }, 300 * 1000);
            },
            afterLoadedFunc: function () {
                // if ($VM.isRoomIssuer) { //owner create pipelineId
                //     if ($VM.kmsController.viewers.length == 0) { //create pip
                //         let _f = new KmsFactory()

                //         for (let i=0; i<$VM.micCount; i++) {
                //             let _remoteVideoObj = $VM.$refs.speakerVideoObj[i];
                //             _f.createPipelineWithWebrtc({
                //                 remoteVideoObj: _remoteVideoObj,
                //             }, function(kmsInfo) {
                //                 let kmsId = kmsInfo.dispatcher.id;
                //                 $VM.mqttClient.sendMessage({ kmsId }, "mic", i);
                //             });
                //         }
                //     };
                // }
            },
            afterOfflineFunc: function () {  // 2021/10/15
                try {
                    $VM.writeLog("異常", `${self.currUser.email} mqtt connect failed,(${CONFIG.mqttConfig.SERVER_URL})`);
                }
                catch (e) {}
                if ($VM.mqtt_reconnect_time > 9) {
                    $VM.oNotify.ConfirmCustomMsg("", `${$VM.$t('lan-mqtt-desc1')}`, [
                        {
                            text: $VM.$t("lan-hint-tips4"),
                            click: () => { $VM.clickReconnect(); },
                            addClass: 'IdleNotifyY',
                        },
                        {
                            text: $VM.$t("lan-notify-no"),
                            addClass: "btn-danger",
                        }
                    ]);
                }  
            }
        });

    };

    validateTokenPromise()
        .then(function (resp) {
            window.mytoken = resp.data.token;
            console.log("validateTokenPromise");
            console.log(resp);
            CheckDisableInfoSecurityIP();
            checkEmp().then(function (resp) {
                console.log("checkEmp");
                console.log(resp);
                // $VM.Pteam = new Pteam(resp.userId);
                if (CONFIG.PteamCDN) {
                    let pteamJS = document.createElement('script');
                    pteamJS.src = CONFIG.PteamCDN;
                    pteamJS.onload = () => $VM.Pteam = new Pteam(resp.userId);
                    document.head.appendChild(pteamJS);
                }
                $VM.currUser.userId = resp.userId; //工號
                $VM.currUser.avatar = resp.avatar.imageUid;
                $VM.currUser.name = window.params.nickname || resp.name;
                $VM.currUser.email = resp.email;
                $VM.currUser.deptId = resp.deptId;
                $VM.currUser.displayName = window.params.usertype === "M" ? window.params.nickname : $VM.roomInfo.version == '3.2' ? resp.titleWithConfig != '' ? `${resp.deptId}/${resp.name}(${resp.titleWithConfig})` : resp.eName != '' ? `${resp.deptId}/${resp.name}(${resp.eName})` : `${resp.deptId}/${resp.name}` : `${resp.deptId}/${resp.name}`;
                $VM.currUser.fabCode = resp.fabCode;
                $VM.currUser.ext = resp.ext;
                $VM.currUser.sourceType = window.params.sourcetype;
                $VM.currUser.isMute = true;
                $VM.currUser.onlineStatus = 0;
                $VM.currUser.connectionState = "";
                $VM.currUser.iceState = "";
                $VM.currUser.channelState = "";
                $VM.currUser.timeStamp = moment().format('x');
                $VM.currUser.titleWithConfig = resp.titleWithConfig;
                $VM.cvsBoard.displayName = $VM.currUser.name;
                $VM.currUser.avatarIsExist = false;
                $VM.currUser.ename = resp.eName;
                $VM.currUser.type = resp.type;
                $VM.currUser.isTaTa = resp.isTaTa;
                //add by vic 2022/04/25
                if (resp.avatar && resp.avatar != null && resp.avatar != undefined && resp.avatar.imageUid)
                    $VM.currUser.avatarIsExist = $VM.checkPhotoUidIsEffective(resp.userId, resp.avatar.imageUid);

                setUserid().then(function () {
                    if ($VM.roomInfo.transType) {
                        Split(['#listdivNew', '#newSubtitle'], {
                            direction: 'vertical',
                            sizes: [15, 85],
                            minSize: 120,
                            maxSize: 125,
                            gutterSize: 10, // 分隔條的寬度為 10px
                        });
                    }
                    $VM.initRealTimeASR();
                    $VM.initPIPSubtitle();
                    //$VM.currUser.displayName = window.params.usertype === "M" ? window.params.nickname : $VM.roomInfo.version == '3.2' ? (resp.eName && resp.eName != '') ? `${resp.deptId}/${resp.name}(${resp.eName})` : `${resp.deptId}/${resp.name}` : ``;
                    $VM.currUser.displayName = window.params.usertype === "M" ? window.params.nickname : $VM.roomInfo.version == '3.2' ? resp.titleWithConfig != '' ? `${resp.deptId}/${resp.name}(${resp.titleWithConfig})` : resp.eName != '' ? `${resp.deptId}/${resp.name}(${resp.eName})` : `${resp.deptId}/${resp.name}` : `${resp.deptId}/${resp.name}`;
                    DetectRTC.load(function () {
                        checkMicAuthorized().then(function (resolve) {
                            if (resolve == 0) {
                                $VM.currUser.isAllowMicphone = true;
                                console.log('%c %s', 'background: #FFBB73; color: blue;', "Microphone :OK");
                                //connectMqtt();   
                            } else {
                                $VM.currUser.isAllowMicphone = false;
                                $VM.oNotify.ConfirmMsg($VM.$t("lan-notify-nomic-title"), $VM.$t("lan-notify-nomic-content"));
                                console.log('%c %s', 'background: #FFBB73; color: blue;', "未授權Microphone,resolve:", resolve);
                            }
                        }).catch(function (reject) {
                            $VM.currUser.isAllowMicphone = false;
                            $VM.oNotify.ConfirmMsg($VM.$t("lan-notify-nomic-title"), $VM.$t("lan-notify-nomic-content"));
                            console.log('%c %s', 'background: #FFBB73; color: blue;', "未授權Microphone,reject:", reject);
                            // if (!isPROD()){ // for development-RDP pc
                            //     if (!Vue.prototype.mqttClient){
                            //         connectMqtt();
                            //     }
                            // }                            
                        });

                        if ($VM.isMobileAny || $VM.isHolo) { //2021/10/14 如果是Mobile預設不取用鏡頭; HoloLens預設不取用鏡頭
                            $VM.currUser.isAllowWebCam = false;
                        } else {
                            checkWebcamAuthorized(true).then(function (resolve) {
                                if (resolve == 0) {
                                    $VM.currUser.isAllowWebCam = true;
                                    console.log('%c %s', 'background: #FFBB73; color: blue;', `webcam :OK ,check Start Airs:${(CONFIG.isAirsEnable && getUserAgentWorkFromHome())}`);
                                    //modify 2020/09/23 要secret_right=Y，才要啟動反偷拍
                                    //if(CONFIG.isAirsEnable && window.params.secret_right && window.params.secret_right=='Y') airsStart();
                                    //mark 2021/06/05 暫不啟動機敏小圖偵測 start
                                    // if(CONFIG.isAirsEnable && getUserAgentWorkFromHome()) 
                                    //     airsStart();      
                                    // else if(CONFIG.isAirsEnable && window.globalVar.isDisableInfoSecurity==false) 
                                    //     airsStart();
                                    //mark 2021/06/05 暫不啟動機敏小圖偵測 end
                                } else {
                                    $VM.currUser.isAllowWebCam = false;
                                    console.log('%c %s', 'background: #FFBB73; color: blue;', "未授權webcam,resolve:", resolve);
                                }
                            }).catch(function (reject) {
                                $VM.currUser.isAllowWebCam = false;
                                console.log('%c %s', 'background: #FFBB73; color: blue;', "未授權webcam,reject:", reject);
                                if (getUserAgentWorkFromHome()) {
                                    //居家人員必須要授權攝影機，不然不可進入會議
                                    window.location.replace("./logout.html?r=11")
                                }
                            });
                        }


                        navigator.mediaDevices.enumerateDevices().then((devices) => {
                            const cameras = devices.filter((device) => device.kind === 'videoinput');
                            $VM.currUser.isDoubleCam = cameras.length > 1 ? true : false;
                            console.log('%c %s', 'background: #FFBB73; color: blue;', `webcam Device count :${cameras.length}`);
                            if (cameras.length == 0 && getUserAgentWorkFromHome()) {
                                //居家人員必須要授權攝影機，不然不可進入會議
                                window.location.replace("./logout.html?r=11")
                            }
                        }).catch(err => {
                            console.error(err)
                        })


                        // let _k = new KmsSpeakerControler({
                        // localVideoObj: self.$children[1].$refs.localVideo,
                        // remoteVideoObj: self.$children[1].$refs.remoteVideo

                        // });
                        // $VM.kmsController = _k;
                        console.log('%c %s', 'background: yellow; color: blue;', "validateTokenPromise DetectRTC load");

                        ConfirmIfIsSecret().then(function (resolve) {
                            try {
                                document.getElementById('ppnotify').remove(); // from vicw
                                let browser_lang = navigator.language;
                                if (browser_lang.includes("zh"))
                                    $VM.current_speech_lang = 'zh';
                                else {
                                    $VM.current_speech_lang = 'en';
                                    self.changeTabs(2);
                                }
                                
                                if ($RealTimeASR)
                                    $RealTimeASR.setLang($VM.current_speech_lang);
                            }
                            catch {

                            }

                            GetInvited().then(function () {
                                connectMqtt();
                            });
                            // console.log('validateTokenPromise DetectRTC load kmsController');                        

                            // setUserid();
                            AddActionLog();
                            getSystemConfig();
                            //getRoomMasterUser();
                            checkIsWifi();
                            if (CONFIG.isAirsEnable && getUserAgentWorkFromHome()) {
                                loadScript("js/airs.js");
                            }
                            else if (CONFIG.isAirsEnable && window.globalVar.isDisableInfoSecurity == false) {
                                loadScript("js/airs.js");
                            }
                            if (CONFIG.isConfidentialDetectEnable && window.globalVar.isDisableInfoSecurity == false && $VM.currUser.sourceType != 'externalpc')
                            //if(CONFIG.isConfidentialDetectEnable ) 
                            {
                                loadScript("js/airslib/phash.js");
                                loadScript("js/airslib/confidential.js");
                                //document.getElementById('divWaterMark').style.display="";
                            }
                            else if (CONFIG.isConfidentialDetectEnable && window.globalVar.isDisableInfoSecurity) {
                                document.getElementsByClassName("media-container-VIDEO")[0].style.display = "none";
                                document.getElementById('divWaterMark').style.display = "none";
                            }
                            if (CONFIG.isConfidentialDetectEnable || CONFIG.isExternal)
                                document.getElementById('divWaterMark').style.display = "";
                            if (CONFIG.isAllowIp)
                                document.getElementById('divWaterMark').style.display = "none";

                            try {
                                var navigatorConnection = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
                                navigatorConnection.onchange = updateConnectionStatus;
                            } catch (e) {
                                console.log("wifi error:", e);
                            }

                            if ($VM.currUser.isAllowWebCam == null || $VM.currUser.isAllowMicphone == null)
                                setTimeout($VM.unBlock, 3000);
                            else
                                $VM.unBlock();

                            // **暫不啟用檢查** 待1.3.2的下一版再檢查
                            // $VM.detectSmartPanel(); //偵測智慧看板是否啟動

                            $VM.askUserWhiteboardOpened(); //新進與會者 詢問目前會議白板是否開啟

                            // 2021/10/15 判斷有居家連線(非外部會議 & sourceType=外網 ), 須強制啟動會議錄影
                            if ($VM.triggerRecordSwitchOn && !$VM.isRecordSwitchOn) {
                                if (CONFIG.kmsRecord.recordWfh == "ALL" || CONFIG.kmsRecord.recordWfh.includes($VM.roomInfo.masterDeptId)) {
                                    $VM.TriggerRecordSwitchON();
                                }
                            }
                            //每隔20秒，掃一次onlineUsers，是否有不等於connected
                            // setInterval(function(){ 
                            //     let splst =$VM.onlineSpeakers.filter(x=>x.userId == $VM.currUser.userId);
                            //     //如果自已有發言
                            //     if(splst.length>0)
                            //     {                                                         
                            //         $VM.onlineUsers.forEach(u =>{
                            //             if(u.connectionState!='connected')
                            //             {                                        
                            //                 //$VM.currUser.allvideoState = 'error';
                            //                 //return false;
                            //             }
                            //             else
                            //             {

                            //             }

                            //         });                                
                            //     }

                            // },20000)


                            if ($VM.roomInfo.transType == '2' || $VM.roomInfo.transType == '3') {
                                //--統一用voicechanged event: wait until the voices load
                                //if ($VM.oDetectDevice.isMobileAny)
                                //populateVoiceList('joinroom-mobile');
                                //else{
                                window.speechSynthesis.addEventListener('voiceschanged', populateVoiceList('joinroom-voiceschanged'));
                                //}                                                            
                            }
                        });
                    });
                });
            });
        });
</script>

<script>
    //s2ab for xlsx export 
    function s2ab(s) {
        var buf = new ArrayBuffer(s.length);
        var view = new Uint8Array(buf);
        for (var i = 0; i != s.length; ++i) view[i] = s.charCodeAt(i) & 0xFF;
        return buf;
    }
    //開啟視訊
    function getCameraUrl(kmsid, hasCamera, isHD) {
        // console.log("getCameraUrl 視訊開啟 then send mqtt startSpeak: ", kmsid);
        try {
            $VM.ckDispalyMyWebCam = true;
            $VM.cameraInfo.id = kmsid; //kmsId
            $VM.cameraInfo.userid = $VM.currUser.uid;
            $VM.cameraInfo.empid = $VM.currUser.empId;
            $VM.cameraInfo.hasCamera = hasCamera;
            $VM.cameraInfo.isHD = hasCamera;
            if (isHD) {
                //console.log("2.startSpeakHD")
                send(`startSpeakHD#${connection.userid}#${kmsid}&hasCamera=${hasCamera}`);
                $VM.userState_DashB.speakInfo.isSpeaking = true;
                $VM.userState_DashB.speakInfo.isDisableCamera = !hasCamera;
                $VM.userState_DashB.speakInfo.kmsid_Speak = kmsid;
                $VM.userState_DashB.speakInfo.isLive = true;
                $VM.userState_DashB.speakInfo.liveSource = "webcam";
                $VM.userState_DashB.speakInfo.kmsid_Live = kmsid;
                $VM.writeLog("使用者操作", `[DISPLAYNAME] 開啟視訊直播與發言.${kmsid}&hasCamera=${hasCamera}`);
                $VM.appendHistory("share", `[DISPLAYNAME] ${$VM.$t('lan-his-all-live-on')}`);
            }
            else {
                send(`startSpeak#${connection.userid}#${kmsid}&hasCamera=${hasCamera}`);
                $VM.userState_DashB.speakInfo.isSpeaking = true;
                $VM.userState_DashB.speakInfo.isDisableCamera = !hasCamera;
                $VM.userState_DashB.speakInfo.kmsid_Speak = kmsid;
                $VM.writeLog("使用者操作", `[DISPLAYNAME] 發言.${kmsid}&hasCamera=${hasCamera}`);
                $VM.appendHistory("speak", `[DISPLAYNAME] ${$VM.$t('lan-his-speak')}`);
            }
        } catch (e) {
            console.error(e);
        } finally {
            $VM.unBlock();
        }
    }

    function startViewing(kmsid) //返回視訊者已收到收訊畫面
    {
        $VM.startViewing(kmsid);
    }
    function toggleFullscreen() {
        if ($VM.oDetectDevice.isMobileiOS) return;
        screenfull.toggle();

    }
    // $(document).one("click", () => {
    //     if (!$VM.isHolo) { // HoloLens 不預設全螢幕
    //         toggleFullscreen();
    //         event.stopPropagation();
    //     }
    //     // event.preventDefault();
    // });
    window.$VM = $VM;

    javascript: introJs().addHints();
    document.getElementById('buttonStartIntro').addEventListener('click', function () {
        introJs().setOptions({ skipLabel: 'skip' }).start();
    });
    //進入會議時不再提供精靈式教學 mark 2021/06/13    
    // if(window.globalVar.isShowInfoStep)
    // {
    //     setTimeout(() => {
    //         //introJs().start(); 
    //         introJs().setOptions({skipLabel:'skip'}).start();
    //     }, 1000);

    // }    

    /* 針對iphone keyboard in/out影響頁面之處理 -s.2021/10/28 -*/
    /* 獲取窗口滾動條高度 */
    function getScrollTop() {
        var scrollTop = 0;
        if (document.documentElement && document.documentElement.scrollTop) {
            scrollTop = document.documentElement.scrollTop;
        } else if (document.body) {
            scrollTop = document.body.scrollTop;
        }
        return scrollTop;
    };
    var oldScrollTop = getScrollTop() || 0; // 記錄當前滾動位置           

    /* 在軟鍵盤關閉後，IOS端再將頁面歸位 */
    document.body.addEventListener('focusin', () => {  //軟鍵盤彈起事件
        //console.log("鍵盤彈起");
    });
    document.body.addEventListener('focusout', () => { //軟鍵盤關閉事件
        //console.log("鍵盤收起");        
        var ua = window.navigator.userAgent;
        if (iPhoneDetection()) { //鍵盤收起頁面空白問題
            document.body.scrollTop = oldScrollTop;
            document.documentElement.scrollTop = oldScrollTop;
        }
    });
    /* 針對iphone keyboard in/out影響頁面之處理 -e */

    /* shareFile,shareImage */
    document.querySelector('#shareFile').addEventListener('change', event => {
        handleShareFile(event)
    });
    document.querySelector('#shareImage').addEventListener('change', event => {
        handleShareImage(event)
    });

    const handleShareFile = event => {
        const files = event.target.files; //event.target.files 屬性可以取得該檔案的 Blob 物件
        doUploadFile(files, 'file');
    };
    const handleShareImage = event => {
        const files = event.target.files;
        const imageType = /image.*/;

        //console.log(files[0]);
        // if (!files[0].type.match(imageType)) {
        //     alert('Sorry, only images are allowed');
        //     return;
        // }
        // if (files[0].size > (100*1024)) {
        //     alert('Sorry, the max allowed size for images is 100KB');
        //     return;
        // }        
        if ($VM.userState_DashB.speakInfo.liveSource == "image") {
            let _file = files[0]; // Get the blob of image
            if (!_file || _file.length <= 0 || !_file.type.match(imageType)) {
                $VM.oNotify.ConfirmMsg("", $VM.$t("lan-notify-fileUploadNG"));
                return;
            }
            //console.log("Paste image file="+_file+",file type="+_items[0].type+",file name="+_file.name);
            let _dt = new DataTransfer();
            _dt.items.add(_file);
            let _filelist = _dt.files;
            $VM.beforeLiveImage(_filelist);
        } else {
            doUploadFile(files, 'image');
        }
    };

</script>

</html>